<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surrey League compendium</title>
  <meta property="og:title" content="Surrey League compendium">
  <meta property="og:description" content="Unofficial archive of the world's greatest cross country competition">
  <meta name="description" content="Unofficial archive of the world's greatest cross country competition">
  <meta property="og:image" content="https://s.microlink.io/https://slarchive.org">
  <meta property="og:url" content="https://slarchive.org">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'><path d='M3 0 L6 0 Q7 4 10 5 Q13 4 14 0 L17 0 L17 20 L3 20 Z' fill='white' stroke='%23374151' stroke-width='0.5'/><line x1='6' y1='5' x2='14' y2='15' stroke='%2322c55e' stroke-width='2'/><line x1='14' y1='5' x2='6' y2='15' stroke='%2322c55e' stroke-width='2'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}.loading{display:flex;align-items:center;justify-content:center;height:100vh}[data-tip]{position:relative}[data-tip]:hover::after{content:attr(data-tip);position:absolute;top:100%;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;white-space:nowrap;z-index:50;margin-top:4px;font-weight:normal;text-transform:none}</style>
</head>
<body>
<div id="root"><div class="loading">Loading...</div></div>
<script type="text/babel">
const{useState,useMemo,useEffect}=React;
const getNumericPos=(pos)=>{if(typeof pos==='number')return pos;if(typeof pos==='string')return parseInt(pos.replace('=',''),10);return null;};
const normalizeNameForCompare=(name)=>name?.toLowerCase().trim()||'';
const namesMatch=(a,b)=>normalizeNameForCompare(a)===normalizeNameForCompare(b);
const getSurname=(name)=>{if(!name)return'';const parts=name.split(' ');return parts.length>1?parts[parts.length-1]:name;};
const CLUBS={'BEL':{name:'Belgrave Harriers'},'KEN':{name:'Kent AC'},'THH':{name:'Thames Hare & Hounds'},'HHH':{name:'Herne Hill Harriers'},'H/W':{name:'Hercules Wimbledon'},'SLH':{name:'South London Harriers'},'G&G':{name:'Guildford & Godalming'},'RAN':{name:'Ranelagh Harriers'},'C/C':{name:'Clapham Chasers'},'DUL':{name:'Dulwich Runners'},'HOL':{name:'Holland Sports'},'WAL':{name:'Walton AC'},'CRO':{name:'Croydon Harriers'},'WOK':{name:'Woking AC'},'E&E':{name:'Epsom & Ewell'},'FUL':{name:'Fulham RC'},'SOC':{name:'Striders of Croydon'},'BOX':{name:'Boxhill Racers'},'BOH':{name:'Borough of Hounslow'},'AFD':{name:'Aldershot Farnham & District'},'SUR':{name:'Surrey AC',desc:'Founding member 1962. Men\'s section later merged into Belgrave.'},'MIT':{name:'Mitcham AC',desc:'Founding member 1962. Later merged with Sutton & Cheam to form Sutton & District AC.'},'REI':{name:'Reigate Priory AC'},'DMV':{name:'Dorking & Mole Valley'},'STR':{name:'Stragglers Running Club'},'W4H':{name:'West 4 Harriers'},'W/W':{name:'Wimbledon Windmilers'},'K&P':{name:'Kingston & Polytechnic'},'S&D':{name:'Sutton & District'},'SEL':{name:'Selsonia Ladies AC',defunct:true},'DWN':{name:'Downland',defunct:true},'FOT':{name:'Ful-On Tri'},'LCR':{name:'London City Runners'},'ADV':{name:'Advent Runners',defunct:true},'262':{name:'26.2 Road Runners'},'MPA':{name:'Metropolitan Police AC'},'BAC':{name:'British Airways AC',defunct:true},'OME':{name:'Omega RC',defunct:true},'GUEST':{name:'Guest',hidden:true},'N/S':{name:'Non-scorer',hidden:true},'MOR':{name:'Morden AC',defunct:true},'EAS':{name:'Ealing Southall & Middlesex'},'LIN':{name:'Lingfield RC'},'WAV':{name:'Waverley Harriers'}};

// Division configurations
const DIVISIONS={
  men:{
    id:'men',
    name:"Men's Division 1",
    shortName:'Men',
    foundedYear:1962,
    teamSize:{a:10,b:10},
    historicTeamSize:(season)=>{
      // Men's league has used 10-man A teams throughout recorded history
      // (confirmed from historical documents back to at least 2000/01)
      return {a:10,b:10};
    },
    matchesPerSeason:4,
    relegationSpots:2,
    individualChampionship:'all4',
    dataFile:'data.json',
    color:'#0077b6',
    // Men's penalty: calculated differently per match based on finisher distribution
    // See historical data for specifics - typically higher than women's formula
    penaltyFormula: 'legacy'
  },
  women:{
    id:'women',
    name:"Women's Division 1",
    shortName:'Women',
    foundedYear:1979,
    teamSize:{a:5,b:5},
    matchesPerSeason:4,
    relegationSpots:3,
    individualChampionship:'best3of4',
    dataFile:'data-women.json',
    color:'#9333ea',
    // Women's penalty formula: scoringFinishers + 10
    // - scoringFinishers = total Div 1 finishers EXCLUDING N/S (non-scorer) runners
    // - Same penalty applies to both A and B teams
    // - N/S runners finish the race but don't count for team scoring
    // - Their positions are skipped when calculating scoring positions
    // Example: M4 2024/25 had 205 finishers, 1 N/S = 204 scoring, penalty = 214
    penaltyFormula: 'scoringFinishers+10'
  }
};

// CMS Content - Google Sheet published as CSV
const CMS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRPBDTtNa5mZMaRpVkHIGF26iXZBr1AU6XQpTV3JX8M6MawD8jXlRZbrQlvOqxKjqahHEpamMpYgJBh/pub?gid=389864213&single=true&output=csv';

// Aliases - Google Sheet tab for name aliases
// Format: Canonical, Alias1, Alias2, Alias3, etc.
const ALIASES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRPBDTtNa5mZMaRpVkHIGF26iXZBr1AU6XQpTV3JX8M6MawD8jXlRZbrQlvOqxKjqahHEpamMpYgJBh/pub?gid=1248367953&single=true&output=csv';

// Parse CMS content with simple markdown-like syntax
// *bold* -> <strong>bold</strong>
// [text](url) -> <a href="url">text</a>
// [Name](@athlete:CLUB) -> clickable athlete link
// [Name](@club:CODE) -> clickable club link
// [text](@season:2024/25) -> clickable season link
const ParsedContent=({content,setView})=>{
  if(!content)return null;
  
  // Parse the content into segments
  const parseContent=(text)=>{
    const segments=[];
    let remaining=text;
    
    // Regex patterns
    const patterns=[
      // Internal athlete link: [Name](@athlete:CLUB)
      {regex:/\[([^\]]+)\]\(@athlete:([^)]+)\)/,type:'athlete'},
      // Internal club link: [Name](@club:CODE)
      {regex:/\[([^\]]+)\]\(@club:([^)]+)\)/,type:'club'},
      // Internal season link: [text](@season:YYYY/YY)
      {regex:/\[([^\]]+)\]\(@season:([^)]+)\)/,type:'season'},
      // External link: [text](url)
      {regex:/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/,type:'link'},
      // Bold: *text*
      {regex:/\*([^*]+)\*/,type:'bold'},
    ];
    
    while(remaining.length>0){
      let earliestMatch=null;
      let earliestIndex=remaining.length;
      let matchedPattern=null;
      
      // Find the earliest match among all patterns
      for(const p of patterns){
        const match=remaining.match(p.regex);
        if(match&&match.index<earliestIndex){
          earliestMatch=match;
          earliestIndex=match.index;
          matchedPattern=p;
        }
      }
      
      if(earliestMatch&&matchedPattern){
        // Add text before the match
        if(earliestIndex>0){
          segments.push({type:'text',content:remaining.slice(0,earliestIndex)});
        }
        // Add the matched element
        segments.push({
          type:matchedPattern.type,
          content:earliestMatch[1],
          target:earliestMatch[2]||null,
          full:earliestMatch[0]
        });
        remaining=remaining.slice(earliestIndex+earliestMatch[0].length);
      }else{
        // No more matches, add remaining text
        segments.push({type:'text',content:remaining});
        break;
      }
    }
    return segments;
  };
  
  const segments=parseContent(content);
  
  return<>{segments.map((seg,i)=>{
    switch(seg.type){
      case'text':return<span key={i}>{seg.content}</span>;
      case'bold':return<strong key={i}>{seg.content}</strong>;
      case'link':return<a key={i} href={seg.target} target="_blank" rel="noopener noreferrer" className="text-[#0077b6] hover:underline">{seg.content}</a>;
      case'athlete':return<span key={i} className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:seg.content,club:seg.target}})}>{seg.content}</span>;
      case'club':return<span key={i} className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:seg.target})}>{seg.content}</span>;
      case'season':return<span key={i} className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'home',urlSeason:seg.target})}>{seg.content}</span>;
      default:return<span key={i}>{seg.content}</span>;
    }
  })}</>;
};

// Parse CSV from Google Sheets into content object
// Structure: type, key, division, content
// division can be: men, women, both (or blank = both)
const parseCmsContent=(csvText)=>{
  const lines=csvText.split('\n');
  const content={};
  
  // Parse CSV (handle quoted fields with commas)
  const parseCSVLine=(line)=>{
    const result=[];
    let current='';
    let inQuotes=false;
    
    for(let j=0;j<line.length;j++){
      const char=line[j];
      if(char==='"'){
        if(inQuotes&&line[j+1]==='"'){
          current+='"';
          j++;
        }else{
          inQuotes=!inQuotes;
        }
      }else if(char===','&&!inQuotes){
        result.push(current);
        current='';
      }else{
        current+=char;
      }
    }
    result.push(current);
    return result;
  };
  
  // Skip header row, parse remaining
  for(let i=1;i<lines.length;i++){
    const line=lines[i];
    if(!line.trim())continue;
    
    const fields=parseCSVLine(line);
    const[type,key,division,value]=fields;
    
    if(type&&key){
      if(!content[type])content[type]={};
      // Store with division info: {men: '...', women: '...', both: '...'}
      if(!content[type][key])content[type][key]={};
      const div=(division||'both').toLowerCase().trim();
      content[type][key][div]=value||'';
    }
  }
  
  return content;
};

// Parse aliases CSV: from_name,to_name
const parseAliases=(csvText)=>{
  const lines=csvText.split('\n');
  const aliases={};
  
  // Skip header row
  // Format: Canonical, Alias1, Alias2, Alias3, ...
  for(let i=1;i<lines.length;i++){
    const line=lines[i].trim();
    if(!line)continue;
    
    // Parse CSV properly (handle potential quoted fields)
    const parts=line.split(',').map(p=>p.trim().replace(/^"|"$/g,''));
    if(parts.length<2)continue;
    
    const canonical=parts[0];
    if(!canonical)continue;
    
    // All subsequent columns are aliases
    for(let j=1;j<parts.length;j++){
      const alias=parts[j];
      if(alias){
        // Store lowercase key for matching
        aliases[alias.toLowerCase()]=canonical;
      }
    }
  }
  
  return aliases;
};

// Helper to get CMS content for current division
const getCmsContent=(cmsContent,type,key,division)=>{
  const entry=cmsContent?.[type]?.[key];
  if(!entry)return null;
  // Priority: exact division match, then 'both', then any available
  return entry[division]||entry['both']||entry['']||null;
};

const ClubVest=({club,size=20})=>{
  const id=`v-${club}-${Math.random().toString(36).substr(2,5)}`;
  const p="M3 0 L6 0 Q7 4 10 5 Q13 4 14 0 L17 0 L17 20 L3 20 Z";
  const r=()=>{switch(club){
    case'KEN':return<><path d={p} fill="#2a4d7a"/><path d="M13 5 L15 5.5 L15 7.5 C15 8.5 14 9 13 9.5 C12 9 11 8.5 11 7.5 L11 5.5 Z" fill="#dc2626"/></>;
    case'H/W':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,0 6,0 20,20 14,20" fill="#c41e3a"/></g></>;
    case'HER':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#dc2626"/></g></>;
    case'THH':return<><path d={p} fill="#fff"/><line x1="6" y1="5" x2="14" y2="15" stroke="#1a1a1a" strokeWidth="2"/><line x1="14" y1="5" x2="6" y2="15" stroke="#1a1a1a" strokeWidth="2"/></>;
    case'BEL':return<><path d={p} fill="#7A001D"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="7" width="20" height="4" fill="#CCAD6A"/></g></>;
    case'HHH':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g></>;
    case'G&G':return<path d={p} fill="#228b22"/>;
    case'SLH':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="13" y="0" width="4" height="20" fill="#800020"/></g></>;
    case'DUL':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="2" fill="#1e3a8a"/><rect x="0" y="12" width="20" height="2" fill="#1e3a8a"/></g></>;
    case'HOL':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#fff"/></g></>;
    case'RAN':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'C/C':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="10" width="20" height="10" fill="#1e3a8a"/><rect x="0" y="9" width="20" height="2" fill="#228b22"/></g></>;
    case'WAL':return<><path d={p} fill="#1a1a1a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="2" fill="#f4c430"/><rect x="0" y="8" width="20" height="2" fill="#dc2626"/><rect x="0" y="10" width="20" height="2" fill="#f4c430"/></g></>;
    case'CRO':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="5" width="20" height="2" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="2" fill="#1a1a1a"/></g></>;
    case'WOK':return<><path d={p} fill="#ff6600"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#32CD32"/></g></>;
    case'E&E':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'FUL':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g></>;
    case'SOC':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#228b22"/><rect x="14" y="0" width="3" height="20" fill="#228b22"/></g></>;
    case'BOX':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g></>;
    case'BOH':return<><path d={p} fill="#87CEEB"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g></>;
    case'AFD':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="14" y="0" width="3" height="20" fill="#fff"/><rect x="0" y="6" width="20" height="3" fill="#228b22"/></g></>;
    case'SUR':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="7" width="20" height="1" fill="#1a1a1a"/><rect x="0" y="8" width="20" height="3" fill="#3b82f6"/><rect x="0" y="11" width="20" height="1" fill="#1a1a1a"/></g></>;
    case'MIT':return<><path d={p} fill="#2563eb"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="5" width="20" height="1.5" fill="#fff"/><rect x="0" y="8" width="20" height="3" fill="#fff"/><rect x="0" y="12.5" width="20" height="1.5" fill="#fff"/></g></>;
    case'DMV':return<><path d={p} fill="#A52A2A"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#fff"/><rect x="14" y="0" width="3" height="20" fill="#fff"/></g></>;
    case'REI':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,0 6,0 20,14 20,20 14,20 0,6" fill="#87CEEB"/></g></>;
    case'STR':return<><path d={p} fill="#f4c430"/><text x="10" y="13" textAnchor="middle" fontSize="9" fontWeight="bold" fill="#1a1a1a">S</text></>;
    case'W4H':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="4" fill="#00CED1"/></g></>;
    case'W/W':return<><path d={p} fill="#1a1a1a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="4" fill="#dc2626"/></g></>;
    case'K&P':return<><path d={p} fill="#1E90FF"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="8,0 20,0 20,20 0,20 0,8" fill="#1a1a1a"/><polygon points="0,0 8,0 20,12 20,20 12,20 0,8" fill="#fff"/></g></>;
    case'FOT':return<><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="6" fill="#fff"/><rect x="0" y="6" width="20" height="4" fill="#f4c430"/><rect x="0" y="10" width="20" height="10" fill="#000"/></g></>;
    case'S&D':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'SEL':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="3" fill="#fff"/><rect x="0" y="11" width="20" height="3" fill="#fff"/></g></>;
    case'DWN':return<><path d={p} fill="#228b22"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#fff"/></g></>;
    case'LCR':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#f4c430"/><rect x="14" y="0" width="3" height="20" fill="#f4c430"/></g></>;
    case'ADV':return<><path d={p} fill="#000"/><text x="10" y="14" textAnchor="middle" fill="#dc2626" fontSize="11" fontWeight="bold" fontFamily="sans-serif">A</text></>;
    case'MPA':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,6 6,0 10,0 0,10" fill="#1e3a8a"/><polygon points="0,10 10,0 14,0 0,14" fill="#f4c430"/><polygon points="0,14 14,0 18,0 0,18" fill="#1e3a8a"/></g></>;
    case'BAC':return<><path d={p} fill="#f5f5dc"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><path d="M4 9 Q10 7 16 9 L15 11 Q10 9.5 5 11 Z" fill="#dc2626"/><path d="M15 10 L16 9 L17 10 L16 12 Z" fill="#1e3a8a"/></g></>;
    case'262':return<><path d={p} fill="#2563eb"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="4,0 9,0 20,11 20,16" fill="#fff"/><polygon points="0,4 0,9 11,20 16,20" fill="#fff"/><polygon points="8,0 12,0 20,8 20,12" fill="#dc2626"/><polygon points="0,8 0,12 8,20 12,20" fill="#dc2626"/></g></>;
    case'OME':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="2" height="20" fill="#fff"/><rect x="7" y="0" width="2" height="20" fill="#fff"/><rect x="11" y="0" width="2" height="20" fill="#fff"/><rect x="15" y="0" width="2" height="20" fill="#fff"/></g></>;
    default:return<path d={p} fill="#9ca3af"/>;
  }};
  return<svg width={size} height={size} viewBox="0 0 20 20" className="shrink-0">{r()}<path d={p} fill="none" stroke="#374151" strokeWidth="0.5"/></svg>;
};
const ClubShield=ClubVest;

// Generate club vest SVG as string for favicon
const getClubVestSvg=(club)=>{
  const p="M3 0 L6 0 Q7 4 10 5 Q13 4 14 0 L17 0 L17 20 L3 20 Z";
  const id=`fav-${club}`;
  const vestSvg={
    'KEN':`<path d="${p}" fill="#2a4d7a"/><path d="M13 5 L15 5.5 L15 7.5 C15 8.5 14 9 13 9.5 C12 9 11 8.5 11 7.5 L11 5.5 Z" fill="#dc2626"/>`,
    'H/W':`<path d="${p}" fill="#f4c430"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><polygon points="0,0 6,0 20,20 14,20" fill="#c41e3a"/></g>`,
    'THH':`<path d="${p}" fill="#fff"/><line x1="6" y1="5" x2="14" y2="15" stroke="#1a1a1a" stroke-width="2"/><line x1="14" y1="5" x2="6" y2="15" stroke="#1a1a1a" stroke-width="2"/>`,
    'BEL':`<path d="${p}" fill="#7A001D"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="7" width="20" height="4" fill="#CCAD6A"/></g>`,
    'HHH':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g>`,
    'G&G':`<path d="${p}" fill="#228b22"/>`,
    'SLH':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="13" y="0" width="4" height="20" fill="#800020"/></g>`,
    'DUL':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="6" width="20" height="2" fill="#1e3a8a"/><rect x="0" y="12" width="20" height="2" fill="#1e3a8a"/></g>`,
    'HOL':`<path d="${p}" fill="#1e3a8a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="3" fill="#fff"/></g>`,
    'RAN':`<path d="${p}" fill="#1e3a8a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g>`,
    'C/C':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="10" width="20" height="10" fill="#1e3a8a"/><rect x="0" y="9" width="20" height="2" fill="#228b22"/></g>`,
    'WAL':`<path d="${p}" fill="#1a1a1a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="6" width="20" height="2" fill="#f4c430"/><rect x="0" y="8" width="20" height="2" fill="#dc2626"/><rect x="0" y="10" width="20" height="2" fill="#f4c430"/></g>`,
    'CRO':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="5" width="20" height="2" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="2" fill="#1a1a1a"/></g>`,
    'WOK':`<path d="${p}" fill="#ff6600"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="3" fill="#32CD32"/></g>`,
    'E&E':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g>`,
    'FUL':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g>`,
    'SOC':`<path d="${p}" fill="#f4c430"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#228b22"/><rect x="14" y="0" width="3" height="20" fill="#228b22"/></g>`,
    'BOX':`<path d="${p}" fill="#f4c430"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g>`,
    'BOH':`<path d="${p}" fill="#87CEEB"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g>`,
    'AFD':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="14" y="0" width="3" height="20" fill="#fff"/><rect x="0" y="6" width="20" height="3" fill="#228b22"/></g>`,
    'SUR':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="7" width="20" height="1" fill="#1a1a1a"/><rect x="0" y="8" width="20" height="3" fill="#3b82f6"/><rect x="0" y="11" width="20" height="1" fill="#1a1a1a"/></g>`,
    'MIT':`<path d="${p}" fill="#2563eb"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="5" width="20" height="1.5" fill="#fff"/><rect x="0" y="8" width="20" height="3" fill="#fff"/><rect x="0" y="12.5" width="20" height="1.5" fill="#fff"/></g>`,
    'DMV':`<path d="${p}" fill="#A52A2A"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#fff"/><rect x="14" y="0" width="3" height="20" fill="#fff"/></g>`,
    'REI':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><polygon points="0,0 6,0 20,14 20,20 14,20 0,6" fill="#87CEEB"/></g>`,
    'STR':`<path d="${p}" fill="#f4c430"/><text x="10" y="13" text-anchor="middle" font-size="9" font-weight="bold" fill="#1a1a1a">S</text>`,
    'W4H':`<path d="${p}" fill="#f4c430"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="4" fill="#00CED1"/></g>`,
    'W/W':`<path d="${p}" fill="#1a1a1a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="4" fill="#dc2626"/></g>`,
    'K&P':`<path d="${p}" fill="#1E90FF"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><polygon points="8,0 20,0 20,20 0,20 0,8" fill="#1a1a1a"/><polygon points="0,0 8,0 20,12 20,20 12,20 0,8" fill="#fff"/></g>`,
    'LCR':`<path d="${p}" fill="#1e3a8a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#f4c430"/><rect x="14" y="0" width="3" height="20" fill="#f4c430"/></g>`,
    '262':`<path d="${p}" fill="#1e3a8a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><polygon points="4,0 9,0 20,11 20,16" fill="#fff"/><polygon points="0,4 0,9 11,20 16,20" fill="#fff"/><polygon points="8,0 12,0 20,8 20,12" fill="#dc2626"/><polygon points="0,8 0,12 8,20 12,20" fill="#dc2626"/></g>`,
    'MPA':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><polygon points="0,6 6,0 10,0 0,10" fill="#1e3a8a"/><polygon points="0,10 10,0 14,0 0,14" fill="#f4c430"/><polygon points="0,14 14,0 18,0 0,18" fill="#1e3a8a"/></g>`,
    'BAC':`<path d="${p}" fill="#f5f5dc"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><path d="M4 9 Q10 7 16 9 L15 11 Q10 9.5 5 11 Z" fill="#dc2626"/><path d="M15 10 L16 9 L17 10 L16 12 Z" fill="#1e3a8a"/></g>`,
    'OME':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="2" height="20" fill="#fff"/><rect x="7" y="0" width="2" height="20" fill="#fff"/><rect x="11" y="0" width="2" height="20" fill="#fff"/><rect x="15" y="0" width="2" height="20" fill="#fff"/></g>`
  };
  const content=vestSvg[club]||`<path d="${p}" fill="#9ca3af"/>`;
  return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">${content}<path d="${p}" fill="none" stroke="#374151" stroke-width="0.5"/></svg>`;
};

// Default site metadata
const DEFAULT_TITLE='Surrey League compendium';
const DEFAULT_FAVICON="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'><path d='M3 0 L6 0 Q7 4 10 5 Q13 4 14 0 L17 0 L17 20 L3 20 Z' fill='white' stroke='%23374151' stroke-width='0.5'/><line x1='6' y1='5' x2='14' y2='15' stroke='%2322c55e' stroke-width='2'/><line x1='14' y1='5' x2='6' y2='15' stroke='%2322c55e' stroke-width='2'/></svg>";
const DEFAULT_OG_IMAGE='https://s.microlink.io/https://slarchive.org';
const DEFAULT_OG_DESC="Unofficial archive of the world's greatest cross country competition";

// Hook to manage document metadata (title, favicon, og tags)
const useDocumentMeta=({title,favicon,ogImage,ogDesc})=>{
  useEffect(()=>{
    // Store original values on first run
    if(!window._originalMeta){
      window._originalMeta={
        title:document.title,
        favicon:document.querySelector('link[rel="icon"]')?.href,
        ogTitle:document.querySelector('meta[property="og:title"]')?.content,
        ogImage:document.querySelector('meta[property="og:image"]')?.content,
        ogDesc:document.querySelector('meta[property="og:description"]')?.content
      };
    }
    
    // Update title
    document.title=title||DEFAULT_TITLE;
    
    // Update favicon
    const faviconEl=document.querySelector('link[rel="icon"]');
    if(faviconEl){
      faviconEl.href=favicon||DEFAULT_FAVICON;
    }
    
    // Update OG tags
    const ogTitleEl=document.querySelector('meta[property="og:title"]');
    const ogImageEl=document.querySelector('meta[property="og:image"]');
    const ogDescEl=document.querySelector('meta[property="og:description"]');
    if(ogTitleEl)ogTitleEl.content=title||DEFAULT_TITLE;
    if(ogImageEl)ogImageEl.content=ogImage||DEFAULT_OG_IMAGE;
    if(ogDescEl)ogDescEl.content=ogDesc||DEFAULT_OG_DESC;
    
    // Cleanup: restore defaults when unmounting
    return()=>{
      document.title=DEFAULT_TITLE;
      if(faviconEl)faviconEl.href=DEFAULT_FAVICON;
      if(ogTitleEl)ogTitleEl.content=DEFAULT_TITLE;
      if(ogImageEl)ogImageEl.content=DEFAULT_OG_IMAGE;
      if(ogDescEl)ogDescEl.content=DEFAULT_OG_DESC;
    };
  },[title,favicon,ogImage,ogDesc]);
};

const PositionChange=({change})=>{if(change===0||change===null||change===undefined)return null;if(change>0)return<span className="w-3 text-center text-green-600 text-xs font-bold">‚Üë</span>;return<span className="w-3 text-center text-red-600 text-xs font-bold">‚Üì</span>;};
const ClubName=({club,className=''})=><><span className={`md:hidden ${className}`}>{club}</span><span className={`hidden md:inline ${className}`}>{CLUBS[club]?.name||club}</span></>;
const ChevronLeft=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 18l-6-6 6-6"/></svg>;
const ChevronRight=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>;
const ArrowLeft=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>;
const X=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>;
const ChevronDown=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9l6 6 6-6"/></svg>;
const ChevronUp=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 15l-6-6-6 6"/></svg>;
const Sparkles=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 3v1m0 16v1m-8-9h1m16 0h1m-2.636-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>;
const Send=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>;
const formatDate=(d)=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
const formatDateShort=(d)=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
const formatDateMonthYear=(d)=>new Date(d).toLocaleDateString('en-GB',{month:'short',year:'numeric'});

const DivisionToggle=({division,setDivision})=>{
  return<div className="flex items-center bg-gray-100 rounded-lg p-0.5">
    <button onClick={()=>setDivision('men')} className={`px-2 md:px-3 py-1 rounded-md text-xs md:text-sm font-medium transition-colors ${division==='men'?'bg-white text-gray-900 shadow-sm':'text-gray-500 hover:text-gray-700'}`}>Men</button>
    <button onClick={()=>setDivision('women')} className={`px-2 md:px-3 py-1 rounded-md text-xs md:text-sm font-medium transition-colors ${division==='women'?'bg-white text-gray-900 shadow-sm':'text-gray-500 hover:text-gray-700'}`}>Women</button>
  </div>;
};

const Nav=({setView,division,setDivision})=><><div className="md:hidden bg-white"><div className="max-w-5xl mx-auto px-4 py-3"><span className="font-semibold text-gray-900 cursor-pointer text-lg" style={{fontFamily:"'Fraunces',serif"}} onClick={()=>setView({type:'home'})}>Surrey League compendium üèÜ</span><span className="text-xs text-gray-400 ml-2 cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'origin'})}>since 1962</span></div></div><nav className="border-b border-gray-200 bg-white sticky top-0 z-50"><div className="max-w-5xl mx-auto px-2 md:px-4 flex items-center justify-between h-12"><div className="flex items-center gap-3"><span className="hidden md:inline font-semibold text-gray-900 cursor-pointer text-lg" style={{fontFamily:"'Fraunces',serif"}} onClick={()=>setView({type:'home'})}>Surrey League compendium üèÜ</span><span className="hidden md:inline text-xs text-gray-400 ml-1 cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'origin'})}>since 1962</span><div className="hidden md:block w-4"></div><DivisionToggle division={division} setDivision={setDivision}/></div><div className="flex gap-0.5 md:gap-1 text-xs md:text-sm"><button onClick={()=>setView({type:'home'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Tables</button><button onClick={()=>setView({type:'fixtures'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50"><span className="md:hidden">Races</span><span className="hidden md:inline">Fixtures</span></button><button onClick={()=>setView({type:'seasons'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50"><span className="md:hidden">Wins</span><span className="hidden md:inline">Winners</span></button><button onClick={()=>setView({type:'athletes'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Athletes</button><button onClick={()=>setView({type:'clubs'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Clubs</button></div></div></nav></>;

const SeasonSelector=({season,setSeason,seasons})=>{
  const[showDropdown,setShowDropdown]=useState(false);
  const idx=seasons.indexOf(season);
  const dropdownRef=React.useRef(null);
  
  React.useEffect(()=>{
    const handleClick=(e)=>{if(dropdownRef.current&&!dropdownRef.current.contains(e.target))setShowDropdown(false);};
    document.addEventListener('mousedown',handleClick);
    return()=>document.removeEventListener('mousedown',handleClick);
  },[]);
  
  return<div className="flex items-center gap-2 relative" ref={dropdownRef}>
    <button onClick={()=>idx<seasons.length-1&&setSeason(seasons[seasons.length-1])} className={`text-xs ${idx<seasons.length-1?'text-gray-500 hover:text-gray-900':'text-gray-300 cursor-default'}`}>Earliest</button>
    <div className="flex items-center">
      <button onClick={()=>idx<seasons.length-1&&setSeason(seasons[idx+1])} className={`p-0.5 rounded ${idx<seasons.length-1?'hover:bg-gray-100 text-gray-600':'text-gray-300'}`}><ChevronLeft className="w-5 h-5"/></button>
      <span className="text-base font-semibold text-gray-900 min-w-[5rem] text-center cursor-pointer hover:text-[#0077b6]" onClick={()=>setShowDropdown(!showDropdown)}>{season}</span>
      <button onClick={()=>idx>0&&setSeason(seasons[idx-1])} className={`p-0.5 rounded ${idx>0?'hover:bg-gray-100 text-gray-600':'text-gray-300'}`}><ChevronRight className="w-5 h-5"/></button>
    </div>
    <button onClick={()=>idx>0&&setSeason(seasons[0])} className={`text-xs ${idx>0?'text-gray-500 hover:text-gray-900':'text-gray-300 cursor-default'}`}>Latest</button>
    {showDropdown&&<div className="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto py-1">
      {seasons.map(s=><div key={s} className={`px-4 py-1 text-sm cursor-pointer hover:bg-gray-100 ${s===season?'font-semibold text-[#0077b6]':'text-gray-700'}`} onClick={()=>{setSeason(s);setShowDropdown(false);}}>{s}</div>)}
    </div>}
  </div>;
};

const TeamResultsTable=({results,startPos=1,count=10,finishers,divisionConfig,race})=>{
  const teams=useMemo(()=>{
    const clubScores={};
    const isATeam = startPos === 1;
    
    // For B teams, we need to know which clubs have A teams (and thus could have B teams)
    const aTeamClubs = new Set();
    results.forEach(r=>{
      if(r.pts != null) aTeamClubs.add(r.club);
    });
    
    // Collect scores
    results.forEach(r=>{
      const hasPts = isATeam ? (r.pts != null) : (r.b_pts != null);
      const pts = isATeam ? r.pts : r.b_pts;
      if(hasPts) {
        if(!clubScores[r.club]) clubScores[r.club] = [];
        if(clubScores[r.club].length < count) {
          clubScores[r.club].push(pts);
        }
      }
    });
    
    // For B teams, include clubs that have A teams but no B scorers yet
    if(!isATeam) {
      aTeamClubs.forEach(club => {
        if(!clubScores[club]) clubScores[club] = [];
      });
    }
    
    // Calculate penalty based on division formula
    let penalty;
    if(divisionConfig?.penaltyFormula === 'scoringFinishers+10') {
      // Women's formula: scoringFinishers + 10
      // scoringFinishers excludes N/S runners
      const scoringFinishers = race?.scoringFinishers || results.filter(r => !r.ns).length;
      penalty = scoringFinishers + 10;
    } else {
      // Legacy/men's formula: average of missing positions
      const numTeams = Object.keys(clubScores).length;
      const totalScorers = Object.values(clubScores).reduce((sum, scores) => sum + scores.length, 0);
      const totalMissing = Object.values(clubScores).reduce((sum, scores) => sum + Math.max(0, count - scores.length), 0);
      const missingPositions = Array.from({length: totalMissing}, (_, i) => totalScorers + 1 + i);
      penalty = totalMissing > 0 ? missingPositions.reduce((a,b) => a+b, 0) / totalMissing : 0;
    }
    
    return Object.entries(clubScores).map(([club,scores])=>{
      const missing = count - scores.length;
      const penalties = missing > 0 ? Array(missing).fill(penalty) : [];
      const allScores = [...scores, ...penalties];
      const lastScorer = scores.length > 0 ? scores[scores.length - 1] : Infinity;
      return {club, points: allScores.reduce((a,b)=>a+b,0), scores, penalties, penaltyScore: penalty, complete: scores.length >= count, lastScorer};
    }).filter(t=>t.scores.length>0||t.penalties.length>0).sort((a,b)=>{
      // Sort by points, then by last scorer (tiebreaker)
      if(a.points !== b.points) return a.points - b.points;
      return a.lastScorer - b.lastScorer;
    }).map((t,i)=>({...t,pos:i+1}));
  },[results,startPos,count,finishers,divisionConfig,race]);
  
  const penaltyValue = teams.find(t=>t.penalties.length>0)?.penaltyScore;
  return<div><table className="w-full"><thead><tr className="border-b-2 border-[#0077b6] bg-gray-50"><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-12">Pos</th><th className="w-8"></th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase">Club</th><th className="text-right py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-20">Points</th><th className="text-left py-2 px-4 text-xs font-semibold text-[#0077b6] uppercase">Scores</th></tr></thead><tbody className="divide-y divide-gray-100">{teams.map(team=><tr key={team.club} className="hover:bg-gray-50"><td className="py-2 px-2 text-sm text-gray-700 tabular-nums">{team.pos}</td><td className="py-2 px-1"><ClubShield club={team.club} size={20}/></td><td className="py-2 px-2 text-sm font-medium text-gray-900">{team.club}</td><td className="py-2 px-2 text-sm font-bold text-gray-900 text-right tabular-nums">{Number.isInteger(team.points)?team.points:team.points.toFixed(1)}</td><td className="py-2 px-4"><div className="flex flex-wrap gap-1.5">{team.scores.map((s,i)=><span key={i} className="text-xs text-gray-500 tabular-nums border border-gray-200 px-1 rounded">{s}</span>)}{team.penalties.map((p,i)=><span key={`p${i}`} className="text-xs text-red-400 tabular-nums border border-red-200 px-1 rounded" title="Penalty score">*</span>)}{!team.complete&&team.penalties.length===0&&<span className="text-xs text-gray-300 italic ml-1">incomplete</span>}</div></td></tr>)}</tbody></table>{penaltyValue&&<p className="text-xs text-gray-400 mt-2">* Penalty = {Number.isInteger(penaltyValue)?penaltyValue:penaltyValue.toFixed(1)} pts</p>}</div>;
};

const TeamResultsTableCompact=({results,startPos=1,count=10,finishers,title,divisionConfig,race})=>{
  const teams=useMemo(()=>{
    const clubScores={};
    const isATeam = startPos === 1;
    
    // For B teams, we need to know which clubs have A teams
    const aTeamClubs = new Set();
    results.forEach(r=>{if(r.pts != null) aTeamClubs.add(r.club);});
    
    // Collect scores
    results.forEach(r=>{
      const hasPts = isATeam ? (r.pts != null) : (r.b_pts != null);
      const pts = isATeam ? r.pts : r.b_pts;
      if(hasPts) {
        if(!clubScores[r.club]) clubScores[r.club] = [];
        if(clubScores[r.club].length < count) clubScores[r.club].push(pts);
      }
    });
    
    // For B teams, include clubs that have A teams but no B scorers
    if(!isATeam) {
      aTeamClubs.forEach(club => {
        if(!clubScores[club]) clubScores[club] = [];
      });
    }
    
    // Calculate penalty based on division formula
    let penalty;
    if(divisionConfig?.penaltyFormula === 'scoringFinishers+10') {
      // Women's formula: scoringFinishers + 10
      const scoringFinishers = race?.scoringFinishers || results.filter(r => !r.ns).length;
      penalty = scoringFinishers + 10;
    } else {
      // Legacy/men's formula: average of missing positions
      const totalScorers = Object.values(clubScores).reduce((sum, scores) => sum + scores.length, 0);
      const totalMissing = Object.values(clubScores).reduce((sum, scores) => sum + Math.max(0, count - scores.length), 0);
      const missingPositions = Array.from({length: totalMissing}, (_, i) => totalScorers + 1 + i);
      penalty = totalMissing > 0 ? missingPositions.reduce((a,b) => a+b, 0) / totalMissing : 0;
    }
    
    return Object.entries(clubScores).map(([club,scores])=>{
      const missing = count - scores.length;
      const penalties = missing > 0 ? Array(missing).fill(penalty) : [];
      const allScores = [...scores, ...penalties];
      const lastScorer = scores.length > 0 ? scores[scores.length - 1] : Infinity;
      return {club, points: allScores.reduce((a,b)=>a+b,0), scores, penalties, penaltyScore: penalty, complete: scores.length >= count, lastScorer};
    }).filter(t=>t.scores.length>0||t.penalties.length>0).sort((a,b)=>{
      if(a.points !== b.points) return a.points - b.points;
      return a.lastScorer - b.lastScorer;
    }).map((t,i)=>({...t,pos:i+1}));
  },[results,startPos,count,finishers,divisionConfig,race]);
  
  const penaltyValue = teams.find(t=>t.penalties.length>0)?.penaltyScore;
  return<div><table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 text-xs font-semibold text-gray-900 uppercase tracking-wide" colSpan="3">{title||'Club'}</th><th className="text-right py-1.5 px-2 text-xs text-gray-500 uppercase w-12">Pts</th><th className="text-left py-1.5 pl-2 text-xs text-gray-500 uppercase">Scores</th></tr></thead><tbody className="divide-y divide-gray-50">{teams.map(team=><tr key={team.club}><td className="py-1.5 text-gray-500 w-6 tabular-nums">{team.pos}</td><td className="py-1.5 w-6"><ClubShield club={team.club} size={16}/></td><td className="py-1.5 font-medium text-gray-900">{team.club}</td><td className="py-1.5 px-2 font-bold text-gray-900 text-right tabular-nums">{Number.isInteger(team.points)?team.points:team.points.toFixed(1)}</td><td className="py-1.5 pl-2"><div className="flex flex-wrap gap-x-0.5 tabular-nums text-xs text-gray-500">{team.scores.map((s,i)=><span key={i} className="w-6 text-center">{s}</span>)}{team.penalties.map((p,i)=><span key={`p${i}`} className="w-6 text-center text-red-400">*</span>)}</div></td></tr>)}</tbody></table>{penaltyValue&&<p className="text-xs text-gray-400 mt-2">* Penalty = {Number.isInteger(penaltyValue)?penaltyValue:penaltyValue.toFixed(1)} pts</p>}</div>;
};

const KnownTeamScoresTable=({scores,title})=>{
  if(!scores?.length)return null;
  return<div><table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 text-xs font-semibold text-gray-900 uppercase tracking-wide" colSpan="3">{title||'A Teams'}</th><th className="text-right py-1.5 px-2 text-xs text-gray-500 uppercase w-16">Pts</th></tr></thead><tbody className="divide-y divide-gray-50">{scores.map(team=><tr key={team.club}><td className="py-1.5 text-gray-500 w-6 tabular-nums">{team.pos}</td><td className="py-1.5 w-6"><ClubShield club={team.club} size={16}/></td><td className="py-1.5 font-medium text-gray-900">{CLUBS[team.club]?.name||team.club}</td><td className="py-1.5 px-2 font-bold text-gray-900 text-right tabular-nums">{team.pts}</td></tr>)}</tbody></table><p className="text-xs text-gray-400 mt-2">* From archived results</p></div>;
};

const IndividualResultsTable=({results,clubFilter,setClubFilter,setView,clubMvps,individualChampions})=>{
  const filtered=clubFilter?results.filter(r=>r.club===clubFilter):results;
  const isClubGoat=(name,club)=>{const mvps=clubMvps?.[club];return mvps&&namesMatch(mvps[0]?.name,name);};
  const getChampionStars=(name)=>{const count=individualChampions?.[normalizeNameForCompare(name)]||0;return count>0?'‚≠ê'.repeat(Math.min(count,2)):'';};
  return<div>{clubFilter&&<div className="mb-4 flex items-center gap-2 text-sm"><span className="text-gray-500">Showing:</span><span className="flex items-center gap-2 bg-gray-100 px-2 py-1 rounded"><ClubShield club={clubFilter} size={16}/><span className="font-medium">{CLUBS[clubFilter]?.name||clubFilter}</span><button onClick={()=>setClubFilter(null)} className="text-gray-400 hover:text-gray-600"><X className="w-4 h-4"/></button></span></div>}<table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 text-xs font-semibold text-gray-900 uppercase tracking-wide w-10">Pos</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase w-10">Pts</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase w-16">Club</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase">Name</th><th className="text-right py-1.5 text-xs text-gray-500 uppercase w-14">Time</th></tr></thead><tbody className="divide-y divide-gray-100">{filtered.map((r,i)=><tr key={i} className="hover:bg-blue-50"><td className="py-1.5 text-sm text-gray-700 tabular-nums">{r.pos}</td><td className="py-1.5 px-2 text-sm text-gray-500 tabular-nums">{r.pts||'-'}</td><td className="py-1.5 px-2"><span className="flex items-center gap-1 cursor-pointer" onClick={()=>setClubFilter(r.club)}><ClubShield club={r.club} size={14}/><span className="text-xs text-gray-500">{r.club}</span></span></td><td className="py-1.5 px-2"><span className="text-sm text-gray-900 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:r.name,club:r.club}})}>{r.name}{getChampionStars(r.name)&&<span className="text-xs" title="Has won individual Surrey League title(s)"> {getChampionStars(r.name)}</span>}{isClubGoat(r.name,r.club)&&<span className="text-xs" title={`Is ${CLUBS[r.club]?.name||r.club}'s greatest A-team scorer of all time`}> üêê</span>}{r.ns&&<span className="text-gray-400 ml-1">(N/S)</span>}{r.secondClaim&&<span className="text-gray-400 ml-1">(2C)</span>}</span></td><td className="py-1.5 text-sm text-gray-700 text-right tabular-nums font-mono">{r.time}</td></tr>)}</tbody></table></div>;
};

const RaceDetailView=({race,setView,seasonsData,clubMvps,races,individualChampions,divisionConfig})=>{
  const[tab,setTab]=useState('individual');const[clubFilter,setClubFilter]=useState(null);const[statusHover,setStatusHover]=useState(false);if(!race)return null;
  // Use historic team size for older seasons (men's was 8 until 2013/14)
  const effectiveTeamSize=divisionConfig?.historicTeamSize?.(race.season)||divisionConfig?.teamSize||{a:10,b:10};
  const seasonData=seasonsData[race.season];const matchData=seasonData?.matches?.find(m=>m.num===race.match);const teamWinner=matchData?.teamWinner||race.teamWinner||(race.teamScores?.[0]?.club);
  
  // Format season as yyyy/yy (or yyyy/yyyy for millennium crossover)
  const formatSeasonFull=(s)=>{const p=s.split('/');if(p.length!==2)return s;const y1=p[0].length===4?p[0]:(parseInt(p[0])<50?'20':'19')+p[0];const y2Short=p[1].length===4?p[1].slice(-2):p[1];const y2Full=p[1].length===4?p[1]:(parseInt(p[1])<50?'20':'19')+p[1];const isCrossover=y1.slice(0,2)!==y2Full.slice(0,2);return isCrossover?`${y1}/${y2Full}`:`${y1}/${y2Short}`;};
  
  // Determine results status
  const resultsStatus=race.results?.length>=100?'complete':race.results?.length>=4?'partial':'winners';
  const statusColor=resultsStatus==='complete'?'bg-green-500':resultsStatus==='partial'?'bg-amber-500':'bg-red-500';
  const statusText=resultsStatus==='complete'?'Complete results':resultsStatus==='partial'?'Partial results':'Winners\' data only';
  
  // Check if we have full results with pts field - if so, calculate team scores dynamically
  // Only fall back to knownTeamScores/teamScores if we don't have calculable results
  const hasCalculableResults = race.results?.length > 100 && race.results.some(r => r.pts != null);
  // Prefer seasonsData match scores when available (more accurate for historical data)
  const matchKey = `m${race.match}`;
  const seasonStandingsScores = seasonData?.standings?.filter(s => s[matchKey] != null).map(s => ({club: s.club, pts: s[matchKey]})).sort((a,b) => a.pts - b.pts).map((s,i) => ({...s, pos: i+1}));
  const displayTeamScores = seasonStandingsScores?.length > 0 ? seasonStandingsScores : (hasCalculableResults ? null : (race.knownTeamScores?.map((t,i)=>({club:t.club,pos:t.pos||i+1,pts:t.points||t.pts}))||(race.teamScores?.map((t,i)=>({club:t.club,pos:i+1,pts:t.score})))));
  
  // Find prev/next races
  const sortedRaces=useMemo(()=>[...races].filter(r=>r.results?.length>0).sort((a,b)=>{if(a.season!==b.season)return a.season.localeCompare(b.season);return a.match-b.match;}),[races]);
  const currentIdx=sortedRaces.findIndex(r=>r.season===race.season&&r.match===race.match);
  const prevRace=currentIdx>0?sortedRaces[currentIdx-1]:null;
  const nextRace=currentIdx<sortedRaces.length-1?sortedRaces[currentIdx+1]:null;
  
  // Count individual winner's race wins up to and including this race, and total career wins
  // For dead heats, we need to handle multiple winners
  const winnersData=useMemo(()=>{
    // Check if this is a dead heat with multiple winners
    const winners = race.winners || (race.winner ? [{name: race.winner, club: race.winnerClub}] : []);
    if(winners.length === 0) return [];
    
    return winners.map(w => {
      const winnerName = normalizeNameForCompare(w.name);
      let count = 0, total = 0, foundCurrent = false;
      for(const r of races){
        // Check both single winner and dead heat winners
        const raceWinners = r.winners || (r.winner ? [{name: r.winner}] : []);
        const isWinner = raceWinners.some(rw => normalizeNameForCompare(rw.name) === winnerName);
        if(isWinner){
          total++;
          if(!foundCurrent){
            count++;
            if(r.season===race.season&&r.match===race.match)foundCurrent=true;
          }
        }
      }
      return {name: w.name, club: w.club, winCount: count, totalWins: total};
    });
  },[race,races]);
  
  const getOrdinal=(n)=>{const s=['th','st','nd','rd'];const v=n%100;return n+(s[(v-20)%10]||s[v]||s[0]);};
  
  // Generate the race win text with proper grammar for each winner
  const raceWinTexts=useMemo(()=>{
    return winnersData.map(w => {
      if(w.winCount===0) return null;
      const possessive = w.name.endsWith('s') ? `${w.name}'` : `${w.name}'s`;
      if(w.totalWins===1) return {club: w.club, text: <span><span className="font-medium text-gray-700">{possessive}</span> only win in Div 1</span>};
      return {club: w.club, text: <span><span className="font-medium text-gray-700">{possessive}</span> {getOrdinal(w.winCount)} of {w.totalWins} wins in Div 1</span>};
    }).filter(Boolean);
  },[winnersData]);
  
  return<div className="max-w-6xl mx-auto px-4 py-8">
    <div className="flex items-center justify-between mb-4">
      <button onClick={()=>setView({type:'fixtures'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900"><ArrowLeft className="w-4 h-4"/>Fixtures</button>
      <div className="flex items-center gap-2">
        {prevRace?<button onClick={()=>setView({type:'race',race:prevRace})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 px-2 py-1 rounded hover:bg-gray-100"><ChevronLeft className="w-4 h-4"/><span className="hidden sm:inline">{prevRace.venue}</span><span className="sm:hidden">Prev</span></button>:<span className="w-16"/>}
        {nextRace?<button onClick={()=>setView({type:'race',race:nextRace})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 px-2 py-1 rounded hover:bg-gray-100"><span className="hidden sm:inline">{nextRace.venue}</span><span className="sm:hidden">Next</span><ChevronRight className="w-4 h-4"/></button>:<span className="w-16"/>}
      </div>
    </div>
    <div className="mb-6"><div className="text-sm text-gray-500 mb-1">{race.date&&race.date.includes('-')&&race.date.length>=10?formatDate(race.date):(()=>{const months=['Oct','Nov','Dec','Jan','Feb'];const p=race.season.split('/');if(p.length===2&&race.match>=1&&race.match<=4){const y1=parseInt(p[0]),m=months[race.match-1]||'';return m?m+" '"+(race.match>=4?String(y1+1).slice(-2):String(y1).slice(-2)):race.season;}return race.season;})()} ¬∑ Match {race.match} ¬∑ <span className="cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'home',urlSeason:race.season})}>{formatSeasonFull(race.season)}</span></div><div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4"><div><div className="flex items-center gap-2"><h1 className="text-2xl font-bold text-gray-900">{race.venue}</h1><div className="relative flex items-center gap-2" onMouseEnter={()=>setStatusHover(true)} onMouseLeave={()=>setStatusHover(false)}><span className={`inline-block w-2 h-2 rounded-full ${statusColor}`}></span>{statusHover&&<div className="absolute left-0 bottom-full mb-1 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">{statusText}</div>}{resultsStatus!=='complete'&&<span className="text-xs text-gray-400 hover:text-[#0077b6] cursor-pointer" onClick={()=>setView({type:'submit'})}>Submit more results</span>}</div></div>{teamWinner&&<p className="text-sm text-gray-700 mt-1 flex items-center gap-1.5"><ClubShield club={teamWinner} size={16}/><span><span className="font-medium">{CLUBS[teamWinner]?.name||teamWinner}</span> <span className="text-gray-500">won the match</span></span></p>}{raceWinTexts.map((wt,i)=><p key={i} className="text-sm text-gray-700 mt-1 flex items-center gap-1.5"><ClubShield club={wt.club} size={16}/><span className="text-gray-500">{wt.text}</span></p>)}</div>{race.weather&&<div className="flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-lg border border-gray-200 lg:min-w-[180px]"><span className="text-3xl">{race.weather.icon}</span><div className="flex flex-col"><span className="text-lg font-semibold text-gray-900">{race.weather.temp}¬∞C</span><span className="text-sm text-gray-600">{race.weather.description}</span><span className="text-xs text-gray-500">{race.weather.windSpeed} km/h wind</span></div></div>}</div></div>
    
    {/* Mobile: tabs */}
    <div className="lg:hidden">
      <div className="flex gap-4 mb-6 border-b border-gray-200">{[{id:'individual',label:'Individual'},{id:'a-teams',label:'A Teams'},{id:'b-teams',label:'B Teams'}].map(t=><button key={t.id} onClick={()=>{setTab(t.id);setClubFilter(null);}} className={`pb-2 text-sm font-medium border-b-2 -mb-px transition-colors ${tab===t.id?'border-[#0077b6] text-[#0077b6]':'border-transparent text-gray-500 hover:text-gray-700'}`}>{t.label}</button>)}</div>
      {tab==='a-teams'&&(displayTeamScores?<KnownTeamScoresTable scores={displayTeamScores} title="A Teams"/>:<TeamResultsTable results={race.results} startPos={1} count={effectiveTeamSize.a} finishers={race.finishers} divisionConfig={divisionConfig} race={race}/>)}
      {tab==='b-teams'&&!displayTeamScores&&<TeamResultsTable results={race.results} startPos={effectiveTeamSize.a+1} count={effectiveTeamSize.b} finishers={race.finishers} divisionConfig={divisionConfig} race={race}/>}
      {tab==='b-teams'&&displayTeamScores&&<p className="text-sm text-gray-500">B team scores not available for this race.</p>}
      {tab==='individual'&&<IndividualResultsTable results={race.results} clubFilter={clubFilter} setClubFilter={setClubFilter} setView={setView} clubMvps={clubMvps} individualChampions={individualChampions}/>}
    </div>
    
    {/* Desktop: side by side */}
    <div className="hidden lg:grid lg:grid-cols-2 gap-12">
      <div>
        <IndividualResultsTable results={race.results} clubFilter={clubFilter} setClubFilter={setClubFilter} setView={setView} clubMvps={clubMvps} individualChampions={individualChampions}/>
      </div>
      <div>
        <div className="mb-6">
          {displayTeamScores?<KnownTeamScoresTable scores={displayTeamScores} title="A Teams"/>:<TeamResultsTableCompact results={race.results} startPos={1} count={effectiveTeamSize.a} finishers={race.finishers} title="A Teams" divisionConfig={divisionConfig} race={race}/>}
        </div>
        <div>
          {!displayTeamScores&&<TeamResultsTableCompact results={race.results} startPos={effectiveTeamSize.a+1} count={effectiveTeamSize.b} finishers={race.finishers} title="B Teams" divisionConfig={divisionConfig} race={race}/>}
        </div>
      </div>
    </div>
  </div>;
};

const FixturesView=({setView,races,seasonsData})=>{
  const allFixtures=useMemo(()=>[...races].sort((a,b)=>{if(a.season!==b.season)return b.season.localeCompare(a.season);return a.match-b.match;}),[races]);let lastSeason=null;
  const getChampion=(season)=>{const sd=seasonsData[season];if(!sd?.standings?.[0])return null;const isHist=sd.historical;const hasM4=sd.standings[0].m4!==null||isHist;return hasM4?sd.standings[0].club:null;};
  const completeRaces=allFixtures.filter(r=>r.results?.length>=100).length;
  const partialRaces=allFixtures.filter(r=>r.results?.length>=4&&r.results?.length<100).length;
  const winnersOnly=allFixtures.filter(r=>!r.results?.length||r.results?.length<4).length;
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-4"><h1 className="text-2xl font-bold text-gray-900" style={{fontFamily:"'Fraunces',serif"}}>Fixtures</h1><p className="text-sm text-gray-500">{allFixtures.length} matches since 1962: <span className="inline-flex items-center gap-1"><span className="inline-block w-1.5 h-1.5 rounded-full bg-green-500"></span></span>{completeRaces} with complete results, <span className="inline-flex items-center gap-1"><span className="inline-block w-1.5 h-1.5 rounded-full bg-amber-500"></span></span>{partialRaces} with partial results, <span className="inline-flex items-center gap-1"><span className="inline-block w-1.5 h-1.5 rounded-full bg-red-500"></span></span>{winnersOnly} with winners' data only</p></div><table className="w-full"><tbody>{allFixtures.map((race,i)=>{const show=race.season!==lastSeason;const champ=show?getChampion(race.season):null;lastSeason=race.season;const hasResults=race.results?.length>=4;return<React.Fragment key={`${race.season}-${race.match}`}>{show&&<tr><td colSpan={6} className="pt-6 pb-2"><div className="flex items-center gap-2 text-xs font-semibold text-gray-400 uppercase tracking-wide border-b border-gray-200 pb-1"><span>{race.season}</span>{champ&&<><span className="text-amber-500">üèÜ</span><ClubShield club={champ} size={14}/><span className="text-gray-600 normal-case font-medium">{champ}</span></>}</div></td></tr>}<tr className="border-b border-gray-50"><td className={`py-1.5 pr-2 text-sm text-gray-500 w-20 ${hasResults?'hover:text-[#0077b6] cursor-pointer':''}`} onClick={()=>hasResults&&setView({type:'race',race})}>{race.date?.length<=3?race.date:formatDateShort(race.date)}</td><td className="py-1.5 px-1 w-3 table-cell"><span className={`inline-block w-1.5 h-1.5 rounded-full ${race.results?.length>=100?'bg-green-500':race.results?.length>=4?'bg-amber-500':'bg-red-500'}`} title={race.results?.length>=100?'Complete results':race.results?.length>=4?'Partial results':'Winners\' data only'}></span></td><td className={`py-1.5 px-2 text-sm text-gray-900 ${hasResults?'hover:text-[#0077b6] cursor-pointer':''}`} onClick={()=>hasResults&&setView({type:'race',race})}>{race.venue}</td><td className="py-1.5 px-1 w-28 text-right text-xs text-gray-500">{race.weather&&<span title={`${race.weather.description}, ${race.weather.temp}¬∞C, ${race.weather.windSpeed}km/h wind`}>{race.weather.icon} {race.weather.temp}¬∞ {race.weather.windSpeed}km/h</span>}</td><td className="py-1.5 px-2 w-44">{race.winner&&<div className="flex items-center gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:race.winner.includes('/')?race.winner.split('/')[0].trim():race.winner,club:race.winnerClub}})}><ClubShield club={race.winnerClub} size={14}/><span className="text-sm text-gray-700">{race.winner?.includes('/')?<span className="flex flex-col leading-tight">{race.winner.split('/').map((w,i)=><span key={i}><span className="hidden md:inline">{w.trim()}</span><span className="md:hidden">{w.trim().split(' ').pop()}</span></span>)}</span>:<><span className="hidden md:inline">{race.winner}</span><span className="md:hidden">{race.winner?.split(' ').pop()}</span></>}</span></div>}</td><td className="py-1.5 pl-2 w-24">{race.teamWinner&&<div className="flex items-center gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:race.teamWinner})}><ClubShield club={race.teamWinner} size={14}/><span className="text-sm font-medium text-gray-900">{race.teamWinner}</span></div>}</td></tr></React.Fragment>;})}</tbody></table></div>;
};

const AthletesView=({setView,athletes})=>{
  const[sort,setSort]=useState('wins');const[search,setSearch]=useState('');const[limit,setLimit]=useState(100);
  const filtered=useMemo(()=>{const s=search.toLowerCase();return athletes.filter(a=>!s||a.name.toLowerCase().includes(s)||a.club?.toLowerCase().includes(s));},[athletes,search]);
  const colOrder=['wins','top3','top5','top10','top20','top50','top100','races'];
  const sorted=useMemo(()=>[...filtered].sort((a,b)=>{
    // Primary sort by selected column
    const diff=b[sort]-a[sort];
    if(diff!==0)return diff;
    // Tiebreakers: left to right through columns
    for(const col of colOrder){
      if(col===sort)continue;
      const d=b[col]-a[col];
      if(d!==0)return d;
    }
    return a.name.localeCompare(b.name);
  }),[filtered,sort]);
  const cols=[{f:'wins',l:'W',t:'Race wins'},{f:'top3',l:'T3',t:'Top 3 finishes'},{f:'top5',l:'T5',t:'Top 5 finishes'},{f:'top10',l:'T10',t:'Top 10 finishes'},{f:'top20',l:'T20',t:'Top 20 finishes'},{f:'top50',l:'T50',t:'Top 50 finishes'},{f:'top100',l:'T100',t:'Top 100 finishes'},{f:'races',l:'R',t:'Total races'}];
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><input type="text" placeholder={`Search ${filtered.length.toLocaleString()} athletes...`} value={search} onChange={e=>{setSearch(e.target.value);setLimit(100);}} className="px-3 py-2 border border-gray-300 rounded text-sm w-full sm:w-72 focus:outline-none focus:ring-2 focus:ring-[#0077b6]"/></div><div className="overflow-x-auto"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-2"><span className="text-xs text-gray-500 uppercase">Athlete</span></th>{cols.map(c=><th key={c.f} className="text-right py-1.5 px-1 md:px-2 min-w-[2rem] md:min-w-[2.5rem]"><button onClick={()=>setSort(c.f)} className={`text-xs uppercase ${sort===c.f?'text-[#0077b6] font-semibold':'text-gray-500'}`} data-tip={c.t}>{c.l}</button></th>)}</tr></thead><tbody>{sorted.slice(0,limit).map((a,i)=><tr key={a.name} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-2"><div className="flex items-center gap-1.5 md:gap-2"><span className="text-gray-400 text-sm w-7 text-right tabular-nums flex-shrink-0">{i+1}</span><ClubShield club={a.club} size={14} className="flex-shrink-0"/><span className="text-sm text-gray-900 whitespace-nowrap">{a.name}</span></div></td>{cols.map(c=><td key={c.f} className={`text-right py-1.5 px-1 md:px-2 text-sm tabular-nums ${sort===c.f?'font-semibold text-[#0077b6]':'text-gray-600'} ${a[c.f]===0?'text-gray-300':''}`}>{a[c.f]||'-'}</td>)}</tr>)}</tbody></table></div>{sorted.length>limit&&<div className="mt-4 text-center"><button onClick={()=>setLimit(l=>l+100)} className="px-4 py-2 bg-[#0077b6] text-white rounded text-sm hover:bg-[#005f8a]">Show more ({sorted.length-limit} remaining)</button></div>}</div>;
};

const StatsTable=({stats})=>{
  const[hover,setHover]=React.useState(null);
  const cols=[
    {k:'aScores',l:'A',t:'A team scoring appearances'},
    {k:'wins',l:'W',t:'Race wins'},
    {k:'top3',l:'T3',t:'Top 3 finishes'},
    {k:'top5',l:'T5',t:'Top 5 finishes'},
    {k:'top10',l:'T10',t:'Top 10 finishes'},
    {k:'top20',l:'T20',t:'Top 20 finishes'},
    {k:'top50',l:'T50',t:'Top 50 finishes'},
    {k:'top100',l:'T100',t:'Top 100 finishes'},
    {k:'races',l:'R',t:'Total races'}
  ];
  return<div className="relative mb-6"><table className="w-full table-fixed"><thead><tr className="border-b border-gray-200">{cols.map((c,i)=><th key={c.k} className={`py-1.5 text-xs text-gray-500 uppercase cursor-help ${i===0?'text-left':'text-center'}`} onMouseEnter={()=>setHover(i)} onMouseLeave={()=>setHover(null)}>{c.l}</th>)}</tr></thead><tbody><tr>{cols.map((c,i)=><td key={c.k} className={`py-1.5 text-sm tabular-nums ${i===0?'text-left':'text-center'} ${stats[c.k]>0?'text-gray-900':'text-gray-300'}`}>{stats[c.k]||'-'}</td>)}</tr></tbody></table>{hover!==null&&<div className="absolute bg-gray-800 text-white text-xs px-2 py-1 rounded pointer-events-none whitespace-nowrap z-10" style={{top:-8,left:`${(hover+0.5)/cols.length*100}%`,transform:'translateX(-50%)'}}>{cols[hover].t}</div>}</div>;
};

const PositionChart=({raceHistory,highlightIdx,setHighlightIdx,setView,clubCode})=>{
  const svgRef=React.useRef(null);
  
  // Reverse to show earliest first (left to right = old to new)
  const reversedHistory=[...raceHistory].reverse();
  const positions=reversedHistory.map(r=>getNumericPos(r.pos)).filter(p=>p!=null);
  if(positions.length<2)return null;
  
  const bestPos=Math.min(...positions);
  const maxPos=Math.max(...positions);
  const minPos=Math.min(...positions);
  
  // Get club color for line - use primary unless white, then secondary
  const clubColors={
    'HHH':['#c41e3a','#000'],     // red/black
    'THH':['#000','#fff'],        // black/white
    'BEL':['#8b0000','#ffd700'],  // maroon/gold
    'SLH':['#fff','#c41e3a'],     // white/red -> use red
    'G&G':['#006633','#fff'],     // green/white
    'KEN':['#00205b','#c41e3a'], // navy/red
    'REI':['#87ceeb','#c41e3a'], // light blue/red
    'RAN':['#00205b','#fff'],    // navy/white
    'AFD':['#ff8c00','#006400'], // orange/green
    'H/W':['#ffff00','#c41e3a'], // yellow/red -> use red
    'W4H':['#ffd700','#006400'], // gold/green
    'BOX':['#ff0000','#ffd700'], // red/gold
    'K&P':['#800080','#fff'],    // purple/white
    'WAL':['#000080','#fff'],    // navy/white
    'FUL':['#000','#fff'],       // black/white
    'CRY':['#87ceeb','#fff'],    // light blue/white
    'CAM':['#000080','#87ceeb'], // navy/light blue
    'DMV':['#006400','#fff'],    // green/white
    'BOH':['#ff0000','#fff'],    // red/white
  };
  const colors=clubColors[clubCode]||['#0077b6','#0077b6'];
  const lineColor=(colors[0]==='#fff'||colors[0]==='#ffff00'||colors[0]==='#ffd700')?colors[1]:colors[0];
  
  const height=60;
  const padding={top:8,bottom:8,left:4,right:4};
  const chartHeight=height-padding.top-padding.bottom;
  
  const getX=(i,width)=>padding.left+(i/(positions.length-1))*(width-padding.left-padding.right);
  const getY=(pos)=>padding.top+((pos-minPos)/(maxPos-minPos||1))*chartHeight;
  
  const handleInteraction=(e)=>{
    const svg=svgRef.current;
    if(!svg)return;
    const rect=svg.getBoundingClientRect();
    const clientX=e.touches?e.touches[0].clientX:e.clientX;
    const x=clientX-rect.left;
    const width=rect.width;
    
    // Find nearest point
    let nearestIdx=0;
    let nearestDist=Infinity;
    positions.forEach((_,i)=>{
      const px=getX(i,width);
      const dist=Math.abs(px-x);
      if(dist<nearestDist){nearestDist=dist;nearestIdx=i;}
    });
    
    // Convert back to original raceHistory index (reversed)
    const originalIdx=raceHistory.length-1-nearestIdx;
    setHighlightIdx({chartIdx:nearestIdx,historyIdx:originalIdx,pos:positions[nearestIdx],x:getX(nearestIdx,width)});
  };
  
  const handleClick=(e)=>{
    if(highlightIdx){
      const race=raceHistory[highlightIdx.historyIdx]?.race;
      if(race?.results?.length){
        setView({type:'race',race});
      }
    }
  };
  
  const clearHighlight=()=>setHighlightIdx(null);
  
  return<div className="w-full mb-4 relative">
    <svg ref={svgRef} className="w-full cursor-pointer" style={{height}} onMouseMove={handleInteraction} onMouseLeave={clearHighlight} onClick={handleClick} onTouchStart={handleInteraction} onTouchMove={handleInteraction} onTouchEnd={clearHighlight}>
      <PathRenderer positions={positions} getY={getY} padding={padding} bestPos={bestPos} highlightIdx={highlightIdx?.chartIdx} lineColor={lineColor}/>
    </svg>
    {highlightIdx&&<div className="absolute bg-gray-800 text-white text-xs px-2 py-1 rounded pointer-events-none whitespace-nowrap" style={{left:highlightIdx.x,top:-4,transform:'translateX(-50%)'}}>{highlightIdx.pos}{highlightIdx.pos===1?'st':highlightIdx.pos===2?'nd':highlightIdx.pos===3?'rd':'th'}</div>}
  </div>;
};

const PathRenderer=({positions,getY,padding,bestPos,highlightIdx,lineColor})=>{
  const[width,setWidth]=React.useState(300);
  const pathRef=React.useRef(null);
  
  React.useEffect(()=>{
    const updateWidth=()=>{
      if(pathRef.current?.parentElement){
        setWidth(pathRef.current.parentElement.getBoundingClientRect().width);
      }
    };
    updateWidth();
    window.addEventListener('resize',updateWidth);
    return()=>window.removeEventListener('resize',updateWidth);
  },[]);
  
  const getX=(i)=>padding.left+(i/(positions.length-1))*(width-padding.left-padding.right);
  const points=positions.map((pos,i)=>`${getX(i)},${getY(pos)}`).join(' ');
  
  return<g ref={pathRef}>
    <polyline points={points} fill="none" stroke={lineColor} strokeWidth="1" strokeLinejoin="round"/>
    {positions.map((pos,i)=>{
      const cx=getX(i);
      const cy=getY(pos);
      const isHighlighted=highlightIdx===i;
      const isBest=pos===bestPos;
      if(isBest){
        // Star shape for best position(s) - yellow fill
        const size=isHighlighted?5:4;
        const starPoints=[];
        for(let j=0;j<5;j++){
          const outerAngle=(j*72-90)*Math.PI/180;
          const innerAngle=((j*72)+36-90)*Math.PI/180;
          starPoints.push(`${cx+size*Math.cos(outerAngle)},${cy+size*Math.sin(outerAngle)}`);
          starPoints.push(`${cx+size*0.4*Math.cos(innerAngle)},${cy+size*0.4*Math.sin(innerAngle)}`);
        }
        return<polygon key={i} points={starPoints.join(' ')} fill="#f59e0b" stroke="#d97706" strokeWidth="0.5" className="transition-all"/>;
      }
      return<circle key={i} cx={cx} cy={cy} r={isHighlighted?3:1.5} fill={lineColor} className="transition-all"/>;
    })}
  </g>;
};

const AthleteDetailView=({athlete,setView,athletes,races,clubMvps,seasonsData,mitchellCupWinners,divisionConfig,athleteNee,cmsContent,division})=>{
  const[compareInput,setCompareInput]=useState('');
  const[highlightIdx,setHighlightIdx]=useState(null);
  const[compareFocused,setCompareFocused]=useState(false);
  // Enhanced athlete lookup - match by exact name, or by abbreviated first initial + surname
  const athleteData=useMemo(()=>{
    if(!athlete?.name)return null;
    // First try exact match
    let found=athletes.find(a=>namesMatch(a.name,athlete.name));
    if(found)return found;
    // Try matching abbreviated name (e.g., "S Haughian" matches "Sam Haughian")
    const parts=athlete.name.trim().split(/\s+/);
    if(parts.length>=2&&parts[0].length<=2){
      const initial=parts[0].replace('.','').toLowerCase();
      const surname=parts.slice(1).join(' ').toLowerCase();
      found=athletes.find(a=>{
        const aParts=a.name.trim().split(/\s+/);
        if(aParts.length<2)return false;
        const aInitial=aParts[0][0]?.toLowerCase();
        const aSurname=aParts.slice(1).join(' ').toLowerCase();
        return aInitial===initial[0]&&aSurname===surname&&(!athlete.club||a.club===athlete.club);
      });
    }
    return found||athlete;
  },[athlete,athletes]);
  
  // Update document metadata for athlete page
  const athleteSlug=useMemo(()=>athleteData?.name?.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')||'',[athleteData?.name]);
  useDocumentMeta({
    title:athleteData?.name?`${athleteData.name} Surrey League history`:null,
    favicon:athleteData?.club?`data:image/svg+xml,${encodeURIComponent(getClubVestSvg(athleteData.club))}`:null,
    ogImage:athleteSlug?`https://s.microlink.io/https://slarchive.org/%23athlete/${athleteSlug}`:null,
    ogDesc:athleteData?.name?`Surrey League cross country career of ${athleteData.name}`:null
  });
  
  const sortedByWins=[...athletes].sort((a,b)=>b.wins-a.wins);const allTimeRank=sortedByWins.findIndex(a=>namesMatch(a.name,athleteData?.name))+1;
  
  const raceHistory=useMemo(()=>{
    const h=[];
    const seenRaces=new Set();
    races.forEach(race=>{
      const result=race.results?.find(r=>namesMatch(r.name,athleteData?.name));
      if(result){
        // Skip if we already have this exact race (dedup for athletes appearing twice in same race)
        const raceKey=`${race.season}-${race.match}`;
        if(seenRaces.has(raceKey))return;
        
        // Calculate team scoring position
        let teamScore='';
        if(result.club&&race.results){
          const teamSizeA=divisionConfig?.teamSize?.a||10;
          const teamSizeB=divisionConfig?.teamSize?.b||10;
          const clubRunners=race.results.filter(r=>r.club===result.club);
          const posInClub=clubRunners.findIndex(r=>namesMatch(r.name,result.name))+1;
          if(posInClub>=1&&posInClub<=teamSizeA)teamScore=`A${posInClub}`;
          else if(posInClub>=teamSizeA+1&&posInClub<=teamSizeA+teamSizeB)teamScore=`B${posInClub-teamSizeA}`;
        }
        const hasFullDate=race.date&&race.date.includes('-')&&race.date.length>=10;
        h.push({date:race.date,venue:race.venue,pos:result.pos,time:result.time,club:result.club,race,hasFullDate,season:race.season,teamScore});
        // Track by season+match AND season+venue+pos to catch duplicates
        seenRaces.add(raceKey);
        seenRaces.add(`${race.season}-${race.venue}-${result.pos}`);
      }
    });
    if(athleteData?.historicalRaces){
      athleteData.historicalRaces.forEach(hr=>{
        // Skip if we already have actual results for this race (check both match# and venue+pos)
        if(seenRaces.has(`${hr.season}-${hr.match}`))return;
        if(seenRaces.has(`${hr.season}-${hr.venue}-${hr.pos}`))return;
        const race=races.find(r=>r.season===hr.season&&r.match===hr.match);
        h.push({date:race?.date||hr.season,venue:hr.venue,pos:hr.pos,time:'-',club:hr.club,race,hasFullDate:false,season:hr.season,teamScore:hr.pos===1?'A1':''});
      });
    }
    return h.sort((a,b)=>{const aKey=a.hasFullDate?a.date:a.season;const bKey=b.hasFullDate?b.date:b.season;return bKey.localeCompare(aKey);});
  },[athleteData?.name,athleteData?.historicalRaces,races,divisionConfig]);
  
  // Compute club GOAT rankings dynamically from race history for each club
  const clubRankings=useMemo(()=>{
    if(!raceHistory.length)return [];
    
    // Get unique clubs this athlete has represented (excluding N/S and GUEST)
    const athleteClubs=[...new Set(raceHistory.map(r=>r.club).filter(c=>c&&c!=='N/S'&&c!=='GUEST'))];
    const TEAM_SIZE_A=divisionConfig?.teamSize?.a||10;
    
    // For each club, compute all athletes' Value scores and find this athlete's rank
    const rankings=[];
    athleteClubs.forEach(club=>{
      // Compute Value scores for all athletes at this club from race results
      const clubStats={};
      races.forEach(race=>{
        // Handle races without full results (only have winner info)
        if(!race.results?.length){
          if(race.winners){
            race.winners.forEach(w=>{
              if(w.club===club){
                const key=normalizeNameForCompare(w.name);
                if(!clubStats[key])clubStats[key]={name:w.name,value:0};
                clubStats[key].value+=TEAM_SIZE_A; // A1 gets max points
              }
            });
          }else if(race.winnerClub===club&&race.winner){
            const key=normalizeNameForCompare(race.winner);
            if(!clubStats[key])clubStats[key]={name:race.winner,value:0};
            clubStats[key].value+=TEAM_SIZE_A; // A1 gets max points
          }
          return;
        }
        // Count Value scores properly - A1=max pts down to A10/A5=1pt
        race.results.forEach(r=>{
          if(r.club!==club||r.ns)return;
          const key=normalizeNameForCompare(r.name);
          if(!clubStats[key])clubStats[key]={name:r.name,value:0};
          const clubRunnersInRace=race.results.filter(x=>x.club===club&&!x.ns);
          const posInClub=clubRunnersInRace.findIndex(x=>namesMatch(x.name,r.name))+1;
          if(posInClub>=1&&posInClub<=TEAM_SIZE_A){
            clubStats[key].value+=(TEAM_SIZE_A-posInClub+1); // A1=max, A2=max-1, etc.
          }
        });
      });
      
      // Sort by Value
      const sorted=Object.values(clubStats).sort((a,b)=>b.value-a.value);
      const rank=sorted.findIndex(a=>namesMatch(a.name,athleteData.name))+1;
      
      if(rank>0){
        rankings.push({club,rank});
      }
    });
    
    return rankings.sort((a,b)=>a.rank-b.rank);
  },[raceHistory,races,athleteData?.name,divisionConfig]);
  
  const po10Url=useMemo(()=>{if(!athleteData?.name)return null;const parts=athleteData.name.split(' ');if(parts.length<2)return null;const firstname=parts[0];const surname=parts.slice(1).join(' ');return`https://www.thepowerof10.info/athletes/athleteslookup.aspx?surname=${encodeURIComponent(surname)}&firstname=${encodeURIComponent(firstname)}`;},[athleteData?.name]);
  const bestPos=useMemo(()=>raceHistory.length>0?Math.min(...raceHistory.map(r=>getNumericPos(r.pos)).filter(p=>p!=null)):null,[raceHistory]);
  const showStar=bestPos&&bestPos>1;
  
  // Compute stats dynamically from raceHistory
  const computedStats=useMemo(()=>{
    const stats={wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,races:raceHistory.length,aScores:0};
    let histWins=0;
    raceHistory.forEach(r=>{
      if(r.pos===1||r.pos==='=1'){stats.wins++;if(!r.hasFullDate)histWins++;}
      if(r.pos<=3||r.pos==='=1')stats.top3++;
      if(r.pos<=5||r.pos==='=1')stats.top5++;
      if(r.pos<=10||r.pos==='=1')stats.top10++;
      if(r.pos<=20||r.pos==='=1')stats.top20++;
      if(r.pos<=50||r.pos==='=1')stats.top50++;
      if(r.pos<=100||r.pos==='=1')stats.top100++;
      if(r.teamScore&&r.teamScore.startsWith('A'))stats.aScores++;
    });
    return{...stats,histWins,modernWins:stats.wins-histWins};
  },[raceHistory]);
  
  if(!athleteData)return<div className="max-w-5xl mx-auto px-4 py-8"><p>Athlete not found</p></div>;
  const isHistOnly=athleteData.historicalOnly;
  const stats=[{l:'Wins',v:computedStats.wins,sub:computedStats.histWins>0?`(${computedStats.modernWins}+${computedStats.histWins} hist)`:null},{l:'Top 3',v:computedStats.top3},{l:'Top 5',v:computedStats.top5},{l:'Top 10',v:computedStats.top10},{l:'Top 20',v:computedStats.top20},{l:'Top 50',v:computedStats.top50},{l:'Top 100',v:computedStats.top100},{l:'A Scores',v:computedStats.aScores},{l:'Races',v:computedStats.races}];
  
  // Compute badges dynamically
  const computedBadges=useMemo(()=>{
    const badges=[];
    const getYear=(season)=>{if(!season)return null;const yy=season.split('/')[1];return(parseInt(yy)<50?'20':'19')+yy;};
    
    // Find seasons where athlete scored for the A team of each club
    const seasonClubsWithAScore={};// season -> clubs they scored A-team points for
    raceHistory.forEach(r=>{
      const season=r.race?.season||(!r.hasFullDate?r.season:null);
      // Only count if they scored for A team (teamScore starts with 'A')
      if(season&&r.club&&r.teamScore&&r.teamScore.startsWith('A')){
        if(!seasonClubsWithAScore[season])seasonClubsWithAScore[season]=new Set();
        seasonClubsWithAScore[season].add(r.club);
      }
    });
    
    // Check each season they participated in
    Object.entries(seasonClubsWithAScore).forEach(([season,clubs])=>{
      const sd=seasonsData[season];
      if(!sd?.standings?.length)return;
      const champion=sd.standings[0].club;
      // Check if season is complete
      const isComplete=sd.historical||(sd.standings[0].m4!==null&&sd.standings[0].m4!==undefined);
      if(isComplete&&clubs.has(champion)){
        badges.push({type:'title_winner',season,year:getYear(season)});
      }
    });
    
    // Check for individual champion seasons (from computed rankings)
    // Only award if season is complete (historical, or has results for final scheduled match)
    Object.entries(seasonsData).forEach(([season,sd])=>{
      if(!sd?.individualRankings?.length)return;
      // Historical seasons are always complete (even if only 3 matches due to weather)
      if(sd.historical){
        const champion=sd.individualRankings[0];
        if(namesMatch(champion.name,athleteData.name)){
          badges.push({type:'individual_champion',season,year:getYear(season)});
        }
        return;
      }
      // For non-historical seasons, check if match 4 results exist
      const isComplete=sd.standings?.[0]?.m4!==null&&sd.standings?.[0]?.m4!==undefined;
      if(!isComplete)return;
      const champion=sd.individualRankings[0];
      if(namesMatch(champion.name,athleteData.name)){
        badges.push({type:'individual_champion',season,year:getYear(season)});
      }
    });
    
    // Also check Mitchell Cup historical winners
    if(mitchellCupWinners){
      Object.entries(mitchellCupWinners).forEach(([season,winners])=>{
        // Skip if we already have this season from computed rankings
        if(badges.some(b=>b.type==='individual_champion'&&b.season===season))return;
        // Check if athlete is among the winners (handles joint winners)
        if(winners.some(w=>namesMatch(w.name,athleteData.name))){
          badges.push({type:'individual_champion',season,year:getYear(season)});
        }
      });
    }
    
    return badges;
  },[raceHistory,seasonsData,athleteData.name,mitchellCupWinners]);
  
  const individualChampData=computedBadges.filter(b=>b.type==='individual_champion').map(b=>({year:b.year,season:b.season})).filter(b=>b.year).sort((a,b)=>b.year.localeCompare(a.year));
  const leagueWinnerData=computedBadges.filter(b=>b.type==='title_winner').map(b=>({year:b.year,season:b.season})).filter(b=>b.year).sort((a,b)=>b.year.localeCompare(a.year));
  const renderYearLinks=(data)=>data.map((d,i)=><React.Fragment key={d.season}>{i>0&&<span className="text-gray-400"> ¬∑ </span>}<span className="cursor-pointer hover:text-[#0077b6] hover:underline" onClick={()=>setView({type:'home',urlSeason:d.season})}>{d.year}</span></React.Fragment>);
  const staticBadges=athleteData.badges||[];
  const otherBadges=staticBadges.filter(b=>b.type!=='individual_champion'&&b.type!=='title_winner').map(b=>{
    if(b.type==='all_time_wins_leader')return{label:'#1 All-Time Wins'};
    if(b.type==='most_season_wins')return{label:`Most Wins in Single Season (${b.wins})`};
    if(b.type==='most_team_titles')return{label:`Most Team Titles (${b.count})`};
    return null;
  }).filter(Boolean);
  
  // Get CMS bio for this athlete
  const athleteBio=getCmsContent(cmsContent,'athlete_bio',athleteData?.name,division);
  
  return<div className="max-w-5xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'athletes'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-8">{/* Desktop layout */}<div className="hidden md:flex md:gap-4 md:items-end mb-4"><div className="cursor-pointer" onClick={()=>setView({type:'club',club:athleteData.club})}><ClubShield club={athleteData.club} size={110}/></div><div className="flex flex-col justify-end pb-1"><div className="flex flex-wrap gap-2 mb-2">{allTimeRank>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'athletes'})}><span className="text-xs text-gray-500 uppercase">SL Index üìà</span><span className="text-sm font-bold text-[#0077b6]">#{allTimeRank}</span></div>}{clubRankings.map(cr=><div key={cr.club} className="inline-flex items-center gap-1.5 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'club',club:cr.club})}><ClubShield club={cr.club} size={14}/><span className="text-xs text-gray-500">üêê</span><span className="text-sm font-bold text-[#0077b6]">#{cr.rank}</span></div>)}</div><div className="flex items-center gap-3"><h1 className="text-3xl font-bold text-gray-900" style={{fontFamily:"'Fraunces',serif"}}>{athleteData.name}</h1>{athleteNee?.[athleteData?.name]&&<p className="text-sm text-gray-500 italic mt-1">({athleteData.name.split(' ')[0]} {athleteNee[athleteData.name]})</p>}</div><div className="flex items-center gap-2 mt-1"><p className="text-sm text-gray-500 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:athleteData.club})}>{CLUBS[athleteData.club]?.name||athleteData.club}</p>{po10Url&&<a href={po10Url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-xs text-gray-400 hover:text-[#0077b6]"><span>Power of 10</span><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>}</div></div></div>{/* Desktop badges */}{(individualChampData.length>0||leagueWinnerData.length>0||otherBadges.length>0)&&<div className="hidden md:flex flex-wrap gap-2 mb-4">{individualChampData.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{individualChampData.length}√ó Mitchell Cup üèÖ</span><span className="text-sm font-medium text-gray-700">{renderYearLinks(individualChampData)}</span></div>}{leagueWinnerData.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{leagueWinnerData.length}√ó League Winner üèÜ</span><span className="text-sm font-medium text-gray-700">{renderYearLinks(leagueWinnerData)}</span></div>}{otherBadges.map((b,i)=><div key={i} className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{b.label}</span></div>)}</div>}{/* Athlete bio from CMS */}{athleteBio&&<p className="text-sm text-gray-600 mb-4 hidden md:block"><ParsedContent content={athleteBio} setView={setView}/></p>}{/* Desktop compare */}<div className="hidden md:block mb-4"><div className="relative inline-flex items-center gap-2"><span className="text-xs text-gray-400">Compare to</span><input type="text" value={compareInput} onChange={e=>setCompareInput(e.target.value)} onFocus={()=>setCompareFocused(true)} onBlur={()=>setTimeout(()=>setCompareFocused(false),200)} placeholder="search..." className="w-28 text-sm border-b border-gray-300 focus:border-[#0077b6] outline-none placeholder-gray-300 pb-0.5"/>{compareFocused&&compareInput.length>=2&&(()=>{const suggestions=athletes.filter(a=>!a.historical&&a.name.toLowerCase().includes(compareInput.toLowerCase())&&!namesMatch(a.name,athleteData.name)).slice(0,5);return suggestions.length>0?<div className="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-48">{suggestions.map((a,i)=><div key={i} className="px-3 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2 text-sm" onClick={()=>{setView({type:'h2h',prefill:{athlete1:athleteData,athlete2:a}});}}><ClubShield club={a.club} size={14}/><span>{a.name}</span></div>)}</div>:null;})()}</div></div>{/* Mobile layout */}<div className="md:hidden"><div className="flex items-start gap-3 mb-3"><div className="cursor-pointer" onClick={()=>setView({type:'club',club:athleteData.club})}><ClubShield club={athleteData.club} size={44}/></div><div><h1 className="text-2xl font-bold text-gray-900" style={{fontFamily:"'Fraunces',serif"}}>{athleteData.name}</h1>{athleteNee?.[athleteData?.name]&&<p className="text-xs text-gray-500 italic">({athleteData.name.split(' ')[0]} {athleteNee[athleteData.name]})</p>}<div className="flex items-center gap-2"><p className="text-sm text-gray-500 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:athleteData.club})}>{CLUBS[athleteData.club]?.name||athleteData.club}</p>{po10Url&&<a href={po10Url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-xs text-gray-400 hover:text-[#0077b6]"><span>Power of 10</span><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>}</div></div></div><div className="flex flex-wrap gap-2">{allTimeRank>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'athletes'})}><span className="text-xs text-gray-500 uppercase">SL Index üìà</span><span className="text-sm font-bold text-[#0077b6]">#{allTimeRank}</span></div>}{clubRankings.map(cr=><div key={cr.club} className="inline-flex items-center gap-1.5 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'club',club:cr.club})}><ClubShield club={cr.club} size={14}/><span className="text-xs text-gray-500">üêê</span><span className="text-sm font-bold text-[#0077b6]">#{cr.rank}</span></div>)}</div>{(individualChampData.length>0||leagueWinnerData.length>0||otherBadges.length>0)&&<div className="flex flex-wrap gap-2 mt-2">{otherBadges.map((b,i)=><div key={i} className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{b.label}</span></div>)}{individualChampData.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{individualChampData.length}√ó Mitchell Cup üèÖ</span><span className="text-sm font-medium text-gray-700">{renderYearLinks(individualChampData)}</span></div>}{leagueWinnerData.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{leagueWinnerData.length}√ó League Winner üèÜ</span><span className="text-sm font-medium text-gray-700">{renderYearLinks(leagueWinnerData)}</span></div>}</div>}{/* Mobile athlete bio */}{athleteBio&&<p className="text-sm text-gray-600 mt-3"><ParsedContent content={athleteBio} setView={setView}/></p>}{/* Mobile compare */}<div className="mt-3"><div className="relative inline-flex items-center gap-2"><span className="text-xs text-gray-400">Compare to</span><input type="text" value={compareInput} onChange={e=>setCompareInput(e.target.value)} onFocus={()=>setCompareFocused(true)} onBlur={()=>setTimeout(()=>setCompareFocused(false),200)} placeholder="search..." className="w-28 text-sm border-b border-gray-300 focus:border-[#0077b6] outline-none placeholder-gray-300 pb-0.5"/>{compareFocused&&compareInput.length>=2&&(()=>{const suggestions=athletes.filter(a=>!a.historical&&a.name.toLowerCase().includes(compareInput.toLowerCase())&&!namesMatch(a.name,athleteData.name)).slice(0,5);return suggestions.length>0?<div className="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-48">{suggestions.map((a,i)=><div key={i} className="px-3 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2 text-sm" onClick={()=>{setView({type:'h2h',prefill:{athlete1:athleteData,athlete2:a}});}}><ClubShield club={a.club} size={14}/><span>{a.name}</span></div>)}</div>:null;})()}</div></div></div></div><StatsTable stats={computedStats}/><div>{raceHistory.length>0?<><PositionChart raceHistory={raceHistory} highlightIdx={highlightIdx} setHighlightIdx={setHighlightIdx} setView={setView} clubCode={athleteData.club}/><table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th colSpan="2" className="text-left py-2 pr-2 text-xs text-gray-500 uppercase">Race History</th><th className="text-center py-2 px-1 text-[10px] md:text-xs text-gray-500 uppercase">Club</th><th className="text-right py-2 px-1 text-[10px] md:text-xs text-gray-500 uppercase">Pos</th><th className="text-right py-2 pl-1 text-[10px] md:text-xs text-gray-500 uppercase">Score</th></tr></thead><tbody className="divide-y divide-gray-100">{raceHistory.map((r,i)=>{const scoreNum=r.teamScore?parseInt(r.teamScore.slice(1)):0;const ordinal=scoreNum===1?'st':scoreNum===2?'nd':scoreNum===3?'rd':'th';const scoreTooltip=r.teamScore?`${CLUBS[r.club]?.name||r.club}'s ${scoreNum}${ordinal} scorer for ${r.teamScore[0]} team`:null;const dateObj=r.hasFullDate&&r.date?new Date(r.date):null;const formatSeasonMatch=(season,match)=>{const months=['Oct','Nov','Dec','Jan','Feb'];const p=season.split('/');if(p.length!==2||!match)return season;const y1=parseInt(p[0]),m=months[match-1]||'';return m?m+" '"+(match>=4?String(y1+1).slice(-2):String(y1).slice(-2)):season;};const displayDate=dateObj?dateObj.toLocaleDateString('en-GB',{month:'short'})+" '"+dateObj.getFullYear().toString().slice(-2):formatSeasonMatch(r.season,r.race?.match);const isHighlighted=highlightIdx?.historyIdx===i;return<tr key={i} className={`${isHighlighted?'bg-blue-100':''} ${r.race?.results?.length?'hover:bg-blue-50 cursor-pointer':''} transition-colors`} onClick={()=>r.race?.results?.length&&setView({type:'race',race:r.race})}><td className="py-2 pr-2 text-xs text-gray-400 whitespace-nowrap">{displayDate}</td><td className="py-2 px-1 text-xs md:text-sm text-gray-900">{r.venue}</td><td className="py-2 px-1"><div className="flex justify-center"><ClubShield club={r.club} size={14}/></div></td><td className="py-2 px-1 text-right"><span className={`text-xs md:text-sm font-medium tabular-nums ${getNumericPos(r.pos)===1?'text-[#0077b6]':getNumericPos(r.pos)<=3?'text-gray-900':'text-gray-600'}`}>{(()=>{const numPos=getNumericPos(r.pos);return numPos===1?'ü•á':numPos===2?'ü•à':numPos===3?'ü•â':numPos;})()}{showStar&&getNumericPos(r.pos)===bestPos&&' ‚≠ê'}</span></td><td className="py-2 pl-1 text-xs md:text-sm text-gray-600 text-right tabular-nums font-mono" title={scoreTooltip}>{r.teamScore||'-'}</td></tr>})}</tbody></table></>:<p className="text-sm text-gray-500">No race history</p>}</div></div>;
};

const ChartRoomView=({setView,data,menData,womenData})=>{
  // Full seasons for position chart (starting 07/08)
  const allSeasons=['2007/08','2008/09','2009/10','2010/11','2011/12','2012/13','2013/14','2014/15','2015/16','2016/17','2017/18','2018/19','2019/20','2021/22','2022/23','2023/24','2024/25','2025/26'];
  const allSeasonLabels=['07/08','08/09','09/10','10/11','11/12','12/13','13/14','14/15','15/16','16/17','17/18','18/19','19/20','21/22','22/23','23/24','24/25','25/26'];
  
  // Recent seasons for other charts (starting 14/15)
  const recentSeasons=['2014/15','2015/16','2016/17','2017/18','2018/19','2019/20','2021/22','2022/23','2023/24','2024/25','2025/26'];
  const recentSeasonLabels=['14/15','15/16','16/17','17/18','18/19','19/20','21/22','22/23','23/24','24/25','25/26'];
  
  const primaryClubs=['BEL','KEN','THH','H/W'];
  const clubs=[
    {code:'BEL',color:'#7A001D'},{code:'THH',color:'#374151'},{code:'KEN',color:'#2a4d7a'},
    {code:'HHH',color:'#dc2626'},{code:'H/W',color:'#ca8a04'},{code:'G&G',color:'#16a34a'},
    {code:'SLH',color:'#be185d'},{code:'HOL',color:'#1e40af'},{code:'DUL',color:'#7c3aed'},{code:'C/C',color:'#0891b2'},
    {code:'RAN',color:'#0369a1'},{code:'CRO',color:'#525252'},{code:'DMV',color:'#92400e'},
    {code:'E&E',color:'#b91c1c'},{code:'FUL',color:'#171717'},{code:'REI',color:'#e11d48'},
    {code:'SOC',color:'#65a30d'},{code:'WOK',color:'#ea580c'}
  ];
  
  const getPositions=(club)=>allSeasons.map(s=>{
    const standings=data.seasonsData[s]?.standings||[];
    const idx=standings.findIndex(t=>t.club===club);
    return idx>=0?idx+1:11;
  });
  const hasDiv1History=(club)=>getPositions(club).some(p=>p<=10);
  const activeClubs=clubs.filter(c=>hasDiv1History(c.code));
  
  const [hoveredClub,setHoveredClub]=useState(null);
  const [tappedClub,setTappedClub]=useState(null);
  const [hoveredMatch,setHoveredMatch]=useState(null);
  const [hoveredSeason,setHoveredSeason]=useState(null);
  const [tappedSeason,setTappedSeason]=useState(null);
  const [hoveredSquad,setHoveredSquad]=useState(null);
  const [tappedSquad,setTappedSquad]=useState(null);
  
  const selectedClub=hoveredClub||tappedClub;
  
  // Attendance data with race references
  const getAttendanceData=()=>{
    const byMatch=[];
    data.races.filter(r=>r.season>='2014/15'&&r.finishers).sort((a,b)=>a.date?.localeCompare(b.date)).forEach(r=>{
      byMatch.push({label:`${r.season.slice(2)} M${r.match}`,value:r.finishers,season:r.season,match:r.match,race:r});
    });
    return byMatch;
  };
  const matchData=getAttendanceData();
  const movingAvg=matchData.map((d,i)=>i<3?null:Math.round((matchData[i-3].value+matchData[i-2].value+matchData[i-1].value+matchData[i].value)/4));
  
  // Average team size per season (total finishers / 10 teams / num matches)
  const avgTeamSize=recentSeasons.map(s=>{
    const seasonRaces=data.races.filter(r=>r.season===s&&r.finishers);
    if(seasonRaces.length===0)return{season:s,label:s.slice(2),value:0};
    const totalFinishers=seasonRaces.reduce((sum,r)=>sum+r.finishers,0);
    const avgPerMatch=totalFinishers/seasonRaces.length/10;
    return{season:s,label:s.slice(2),value:Math.round(avgPerMatch*10)/10};
  });
  
  // Squad size data - unique runners per club per season
  const getSquadSizes=()=>{
    const squadData={};
    recentSeasons.forEach(s=>{squadData[s]={};});
    data.races.filter(r=>r.season>='2014/15'&&r.results).forEach(r=>{
      r.results.forEach(res=>{
        if(!squadData[r.season])return;
        if(!squadData[r.season][res.club])squadData[r.season][res.club]=new Set();
        squadData[r.season][res.club].add(res.name);
      });
    });
    return clubs.map(({code,color})=>({
      code,color,
      sizes:recentSeasons.map(s=>{
        const set=squadData[s]?.[code];
        return set?set.size:0;
      })
    })).filter(c=>c.sizes.some(s=>s>0));
  };
  const squadSizes=getSquadSizes();
  const selectedSquad=hoveredSquad||tappedSquad;
  
  const chartW=800,chartH=250,padL=35,padR=80,padT=20,padB=30;
  const plotW=chartW-padL-padR,plotH=chartH-padT-padB;
  const xStep=plotW/(allSeasons.length-1);
  const yScale=(pos)=>padT+(pos-1)*(plotH/10);
  
  // Calculate name frequencies for both divisions
  const nameStats=useMemo(()=>{
    // Group name variants - key is canonical, values are variants that map to it
    const nameGroups={
      // Men's names
      'David':['Dave','Davey','David'],
      'Daniel':['Dan','Danny','Daniel'],
      'Stephen':['Steve','Steven','Stephen','Stevie'],
      'Michael':['Mike','Mick','Mickey','Michael'],
      'Robert':['Rob','Bob','Bobby','Robbie','Robert'],
      'Thomas':['Tom','Tommy','Thomas'],
      'James':['Jim','Jimmy','Jamie','James'],
      'William':['Bill','Billy','Will','Willy','William'],
      'Nicholas':['Nick','Nicky','Nicholas'],
      'Christopher':['Chris','Kit','Christopher'],
      'Matthew':['Matt','Matty','Matthew'],
      'Andrew':['Andy','Drew','Andrew'],
      'Anthony':['Tony','Anthony'],
      'Edward':['Ed','Eddie','Ted','Teddy','Edward'],
      'Alexander':['Alex','Xander','Alexander'],
      'Benjamin':['Ben','Benny','Benjamin'],
      'Joseph':['Joe','Joey','Joseph'],
      'Jonathan':['Jon','Jonny','Johnny','Jonathan'],
      'Samuel':['Sam','Sammy','Samuel'],
      'Philip':['Phil','Phillip','Philip'],
      'Richard':['Rich','Rick','Ricky','Dick','Richard'],
      'Patrick':['Pat','Paddy','Patrick'],
      'Peter':['Pete','Peter'],
      'Geoffrey':['Geoff','Geoffrey'],
      'Jeffrey':['Jeff','Jeffrey'],
      'Gregory':['Greg','Gregory'],
      'Timothy':['Tim','Timmy','Timothy'],
      // Women's names
      'Stephanie':['Steph','Stephie','Stephanie'],
      'Katherine':['Kate','Katie','Katy','Cathy','Cath','Kathy','Katherine','Catherine','Kathryn','Katharine'],
      'Elizabeth':['Liz','Lizzy','Beth','Eliza','Libby','Elizabeth'],
      'Jennifer':['Jenny','Jen','Jenna','Jennifer'],
      'Rebecca':['Becky','Becca','Rebecca'],
      'Samantha':['Sam','Sammy','Samantha'],
      'Alexandra':['Alex','Lexi','Alexandra'],
      'Victoria':['Vicky','Vicki','Victoria'],
      'Margaret':['Meg','Maggie','Peggy','Margaret'],
      'Amanda':['Mandy','Amanda'],
      'Abigail':['Abby','Abbie','Abigail'],
      'Emily':['Em','Emmy','Emily'],
      'Joanne':['Jo','Joanna','Joanne'],
      'Madeleine':['Maddie','Maddy','Madeleine','Madeline'],
      'Eleanor':['Ellie','Elle','Ella','Eleanor'],
      'Isabel':['Izzy','Izzie','Bella','Isabel','Isabella','Isobel'],
      'Nicole':['Nikki','Nicky','Nicole'],
      'Deborah':['Debbie','Deb','Deborah'],
      'Susan':['Sue','Susie','Susan'],
      'Natalie':['Nat','Natalie'],
      'Charlotte':['Charlie','Charley','Lottie','Charlotte'],
      'Louise':['Lou','Louisa','Louise'],
      'Melanie':['Mel','Melanie'],
      'Rachel':['Rach','Rachel']
    };
    
    // Build reverse lookup: variant -> canonical
    const variantToCanonical={};
    Object.entries(nameGroups).forEach(([canonical,variants])=>{
      variants.forEach(v=>{variantToCanonical[v]=canonical;});
    });
    
    const countNames=(athletes,races)=>{
      // Get all unique names - from athletes array or race results
      const allNames=new Set();
      if(athletes?.length){
        athletes.forEach(a=>{if(a.name)allNames.add(a.name);});
      }else if(races?.length){
        races.forEach(r=>{r.results?.forEach(res=>{if(res.name)allNames.add(res.name);});});
      }
      
      const canonicalCounts={};  // canonical name -> total count
      const variantCounts={};    // canonical name -> {variant -> count}
      const surnames={};
      const clubCounts={};
      
      allNames.forEach(name=>{
        const parts=name.split(' ');
        if(parts.length>=2){
          const first=parts[0];
          const last=parts[parts.length-1];
          const canonical=variantToCanonical[first]||first;
          
          canonicalCounts[canonical]=(canonicalCounts[canonical]||0)+1;
          if(!variantCounts[canonical])variantCounts[canonical]={};
          variantCounts[canonical][first]=(variantCounts[canonical][first]||0)+1;
          
          surnames[last]=(surnames[last]||0)+1;
        }
      });
      
      // Count clubs by unique athletes
      if(athletes?.length){
        athletes.forEach(a=>{if(a.club)clubCounts[a.club]=(clubCounts[a.club]||0)+1;});
      }else if(races?.length){
        const athleteClub={};
        races.forEach(r=>{r.results?.forEach(res=>{if(res.name&&res.club)athleteClub[res.name]=res.club;});});
        Object.values(athleteClub).forEach(club=>{clubCounts[club]=(clubCounts[club]||0)+1;});
      }
      
      // For each canonical name, find most common variant
      const getMostCommonVariant=(canonical)=>{
        const variants=variantCounts[canonical]||{};
        let best=canonical,bestCount=0;
        Object.entries(variants).forEach(([v,c])=>{if(c>bestCount){best=v;bestCount=c;}});
        return best;
      };
      
      const sortByCount=obj=>Object.entries(obj).sort((a,b)=>b[1]-a[1]);
      const topFirstNames=sortByCount(canonicalCounts).slice(0,10).map(([canonical,count])=>[getMostCommonVariant(canonical),count]);
      
      return{
        firstNames:topFirstNames,
        surnames:sortByCount(surnames).slice(0,10),
        modalClub:sortByCount(clubCounts)[0]?.[0]||null
      };
    };
    
    const men=menData?countNames(menData.athletes,menData.races):{firstNames:[],surnames:[],modalClub:null};
    const women=womenData?countNames(womenData.athletes,womenData.races):{firstNames:[],surnames:[],modalClub:null};
    
    return{men,women};
  },[menData,womenData]);
  
  return<div className="max-w-5xl mx-auto px-4 py-8">
    <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
    <h1 className="text-2xl font-bold text-gray-900 mb-1" style={{fontFamily:"'Fraunces',serif"}}>üìä Chart room</h1>
    <p className="text-sm text-gray-500 mb-8">League trends and statistics visualised</p>
    
    <div className="space-y-12">
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Club positions by season</h2>
        <div className="bg-gray-50 rounded-lg p-3 overflow-x-auto">
          <svg viewBox={`0 0 ${chartW} ${chartH}`} className="w-full" style={{minWidth:'500px'}}>
            {[1,2,3,4,5,6,7,8,9,10].map(pos=><g key={pos}>
              <line x1={padL} y1={yScale(pos)} x2={chartW-padR} y2={yScale(pos)} stroke="#e5e7eb" strokeWidth="1"/>
              <text x={padL-8} y={yScale(pos)+4} textAnchor="end" fontSize="10" fill="#9ca3af">{pos}</text>
            </g>)}
            <line x1={padL} y1={yScale(11)} x2={chartW-padR} y2={yScale(11)} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4,2"/>
            <text x={padL-8} y={yScale(11)+4} textAnchor="end" fontSize="9" fill="#d1d5db">Div 2</text>
            {allSeasonLabels.map((s,i)=><text key={s} x={padL+i*xStep} y={chartH-8} textAnchor="middle" fontSize="9" fill="#6b7280">{s}</text>)}
            {activeClubs.map(({code,color})=>{
              const positions=getPositions(code);
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selectedClub===code;
              const points=positions.map((pos,i)=>({x:padL+i*xStep,y:yScale(pos),pos,season:allSeasons[i]}));
              const pathD=points.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(' ');
              const baseOpacity=isPrimary?0.8:0.15;
              const opacity=selectedClub?(isSelected?1:0.1):baseOpacity;
              return<g key={code} onMouseEnter={()=>setHoveredClub(code)} onMouseLeave={()=>setHoveredClub(null)} onClick={()=>setTappedClub(tappedClub===code?null:code)} style={{cursor:'pointer'}}>
                <path d={pathD} fill="none" stroke={color} strokeWidth={isSelected?1.5:1} strokeLinecap="round" strokeLinejoin="round" opacity={opacity}/>
                {points.map((p,i)=><circle key={i} cx={p.x} cy={p.y} r={isSelected?3:2} fill={color} opacity={opacity}/>)}
                {isSelected&&<text x={points[points.length-1].x+8} y={points[points.length-1].y+4} fontSize="10" fill={color} fontWeight="600">{CLUBS[code]?.name||code}</text>}
              </g>;
            })}
          </svg>
          <div className="flex flex-wrap justify-center gap-x-3 gap-y-1 mt-3">
            {activeClubs.map(({code,color})=>{
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selectedClub===code;
              return<div key={code} className="flex items-center gap-1 cursor-pointer" onMouseEnter={()=>setHoveredClub(code)} onMouseLeave={()=>setHoveredClub(null)} onClick={()=>setTappedClub(tappedClub===code?null:code)}>
                <div className="w-2 h-2 rounded-full" style={{backgroundColor:color,opacity:isPrimary||isSelected?1:0.3}}/>
                <span className={`text-[10px] ${isPrimary||isSelected?'text-gray-600':'text-gray-400'}`}>{code}</span>
              </div>;
            })}
          </div>
        </div>
      </div>
      
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Match attendance since 2014</h2>
        <div className="bg-gray-50 rounded-lg p-3 overflow-x-auto">
          <svg viewBox="0 0 900 220" className="w-full" style={{minWidth:'600px'}}>
            {[100,150,200,250,300,350].map(v=><g key={v}>
              <line x1="40" y1={190-(v-100)*0.7} x2="870" y2={190-(v-100)*0.7} stroke="#e5e7eb" strokeWidth="1"/>
              <text x="35" y={190-(v-100)*0.7+4} textAnchor="end" fontSize="9" fill="#9ca3af">{v}</text>
            </g>)}
            <path d={matchData.map((d,i)=>`${i===0?'M':'L'}${40+i*19.5},${190-(d.value-100)*0.7}`).join(' ')} fill="none" stroke="#0077b6" strokeWidth="1" opacity="0.3"/>
            <path d={movingAvg.map((v,i)=>v?`${movingAvg.slice(0,i).filter(Boolean).length===0?'M':'L'}${40+i*19.5},${190-(v-100)*0.7}`:``).join(' ')} fill="none" stroke="#0077b6" strokeWidth="1.5"/>
            {matchData.map((d,i)=><circle key={i} cx={40+i*19.5} cy={190-(d.value-100)*0.7} r={hoveredMatch===i?4:2} fill="#0077b6" opacity={hoveredMatch===i?1:0.4} style={{cursor:'pointer'}} onMouseEnter={()=>setHoveredMatch(i)} onMouseLeave={()=>setHoveredMatch(null)} onClick={()=>setView({type:'race',race:d.race})}/>)}
            {hoveredMatch!==null&&(()=>{
              const d=matchData[hoveredMatch];
              if(!d)return null;
              return<g>
                <rect x={40+hoveredMatch*19.5-30} y={190-(d.value-100)*0.7-28} width="60" height="20" fill="#1f2937" rx="3"/>
                <text x={40+hoveredMatch*19.5} y={190-(d.value-100)*0.7-14} textAnchor="middle" fontSize="10" fill="#fff" fontWeight="500">{d.value} ‚Üí</text>
              </g>;
            })()}
            {matchData.filter((_,i)=>i%8===0).map((d,i)=><text key={i} x={40+i*8*19.5} y="208" textAnchor="middle" fontSize="8" fill="#6b7280">{d.label}</text>)}
          </svg>
          <div className="flex justify-center gap-6 mt-2">
            <div className="flex items-center gap-1.5"><div className="w-6 h-0.5 bg-[#0077b6] opacity-30"/><span className="text-xs text-gray-500">Per match</span></div>
            <div className="flex items-center gap-1.5"><div className="w-6 h-0.5 bg-[#0077b6]"/><span className="text-xs text-gray-500">4-match avg</span></div>
          </div>
          <p className="text-xs text-gray-400 mt-2 text-center">Click a data point to view that fixture's results</p>
        </div>
      </div>
      
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Average team size per season</h2>
        <div className="bg-gray-50 rounded-lg p-3">
          <svg viewBox="0 0 600 180" className="w-full">
            {avgTeamSize.map((d,i)=>{
              const isHovered=hoveredSeason===i||tappedSeason===i;
              const barH=d.value*6;
              return<g key={i} style={{cursor:'pointer'}} onMouseEnter={()=>setHoveredSeason(i)} onMouseLeave={()=>setHoveredSeason(null)} onClick={()=>setTappedSeason(tappedSeason===i?null:i)}>
                <rect x={35+i*50} y={160-barH} width="40" height={barH} fill={isHovered?'#005f8a':'#0077b6'} rx="2"/>
                <text x={35+i*50+20} y="175" textAnchor="middle" fontSize="9" fill="#6b7280">{d.label}</text>
                {isHovered&&d.value>0&&<text x={35+i*50+20} y={155-barH} textAnchor="middle" fontSize="10" fill="#1f2937" fontWeight="600">{d.value}</text>}
              </g>;
            })}
          </svg>
          <p className="text-xs text-gray-400 mt-2 text-center">Average runners per club per match. 2025/26 incomplete. 2020/21 cancelled.</p>
        </div>
      </div>
      
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Squad sizes by season</h2>
        <div className="bg-gray-50 rounded-lg p-3 overflow-x-auto">
          {(()=>{
            const squadXStep=plotW/(recentSeasons.length-1);
            return<svg viewBox={`0 0 ${chartW} 220`} className="w-full" style={{minWidth:'500px'}}>
            {[0,20,40,60,80,100].map(v=><g key={v}>
              <line x1={padL} y1={190-v*1.7} x2={chartW-padR} y2={190-v*1.7} stroke="#e5e7eb" strokeWidth="1"/>
              <text x={padL-8} y={190-v*1.7+4} textAnchor="end" fontSize="9" fill="#9ca3af">{v}</text>
            </g>)}
            {recentSeasonLabels.map((s,i)=><text key={s} x={padL+i*squadXStep} y="208" textAnchor="middle" fontSize="9" fill="#6b7280">{s}</text>)}
            {squadSizes.map(({code,color,sizes})=>{
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selectedSquad===code;
              const points=sizes.map((size,i)=>({x:padL+i*squadXStep,y:190-size*1.7,size,season:recentSeasons[i]}));
              const validPoints=points.filter(p=>p.size>0);
              if(validPoints.length<2)return null;
              const pathD=validPoints.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(' ');
              const baseOpacity=isPrimary?0.8:0.15;
              const opacity=selectedSquad?(isSelected?1:0.1):baseOpacity;
              return<g key={code} onMouseEnter={()=>setHoveredSquad(code)} onMouseLeave={()=>setHoveredSquad(null)} onClick={()=>setTappedSquad(tappedSquad===code?null:code)} style={{cursor:'pointer'}}>
                <path d={pathD} fill="none" stroke={color} strokeWidth={isSelected?1.5:1} strokeLinecap="round" strokeLinejoin="round" opacity={opacity}/>
                {validPoints.map((p,i)=><circle key={i} cx={p.x} cy={p.y} r={isSelected?3:2} fill={color} opacity={opacity}/>)}
                {isSelected&&validPoints.length>0&&<text x={validPoints[validPoints.length-1].x+8} y={validPoints[validPoints.length-1].y+4} fontSize="10" fill={color} fontWeight="600">{CLUBS[code]?.name||code}</text>}
              </g>;
            })}
          </svg>;
          })()}
          <div className="flex flex-wrap justify-center gap-x-3 gap-y-1 mt-3">
            {squadSizes.map(({code,color})=>{
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selectedSquad===code;
              return<div key={code} className="flex items-center gap-1 cursor-pointer" onMouseEnter={()=>setHoveredSquad(code)} onMouseLeave={()=>setHoveredSquad(null)} onClick={()=>setTappedSquad(tappedSquad===code?null:code)}>
                <div className="w-2 h-2 rounded-full" style={{backgroundColor:color,opacity:isPrimary||isSelected?1:0.3}}/>
                <span className={`text-[10px] ${isPrimary||isSelected?'text-gray-600':'text-gray-400'}`}>{code}</span>
              </div>;
            })}
          </div>
          <p className="text-xs text-gray-400 mt-2 text-center">Unique runners per club per season. Lines stop when club not in Div 1.</p>
        </div>
      </div>
      
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Venues by usage</h2>
        <div className="bg-gray-50 rounded-lg p-4">
          {(()=>{
            // Normalize venues using aliases
            const venueAliases=data.venueAliases||{};
            const normalizeVenue=(v)=>{
              for(const[canonical,aliases]of Object.entries(venueAliases)){
                if(aliases.includes(v))return canonical;
              }
              return v;
            };
            
            // Count venues
            const venueCounts={};
            data.races.forEach(r=>{
              if(!r.venue)return;
              const v=normalizeVenue(r.venue);
              venueCounts[v]=(venueCounts[v]||0)+1;
            });
            
            // Sort by count and prepare data, grouping rare venues
            const allVenues=Object.entries(venueCounts).sort((a,b)=>b[1]-a[1]);
            const mainVenues=allVenues.filter(([,count])=>count>2).map(([name,count])=>({name,count}));
            const rareVenues=allVenues.filter(([,count])=>count<=2);
            
            // Add "Other" category if there are rare venues
            const venues=[...mainVenues];
            if(rareVenues.length>0){
              const rareCount=rareVenues.reduce((sum,[,c])=>sum+c,0);
              venues.push({name:`Other venues (${rareVenues.length})`,count:rareCount,isOther:true});
            }
            
            const total=venues.reduce((sum,v)=>sum+v.count,0);
            const width=750,height=520;
            const colors=['#0077b6','#005f8a','#023e58','#1a5276','#2874a6','#1b4f72','#0e4d64','#1f618d','#21618c','#2e86ab','#1a3c5c','#154360'];
            
            // Simple slice-and-dice treemap
            const rects=[];
            let x=0,y=0,w=width,h=height;
            let horizontal=true;
            
            venues.forEach((v,i)=>{
              const ratio=v.count/total;
              let rw,rh;
              
              if(horizontal){
                rw=w*ratio/(venues.slice(i).reduce((s,vv)=>s+vv.count,0)/total);
                rh=h;
                rects.push({...v,x,y,width:rw,height:rh,color:v.isOther?'#6b7280':colors[i%colors.length]});
                x+=rw;
                if(i<venues.length-1&&x>width*0.6){
                  horizontal=false;
                  w=width-x;
                  x=width-w;
                  y=0;
                }
              }else{
                rw=w;
                rh=h*ratio/(venues.slice(i).reduce((s,vv)=>s+vv.count,0)/total);
                rects.push({...v,x,y,width:rw,height:rh,color:v.isOther?'#6b7280':colors[i%colors.length]});
                y+=rh;
              }
            });
            
            return<svg viewBox={`0 0 ${width} ${height}`} className="w-full">
              {rects.map((r,i)=><g key={i}>
                <rect x={r.x+1} y={r.y+1} width={Math.max(0,r.width-2)} height={Math.max(0,r.height-2)} fill={r.color} rx="4" className="hover:opacity-90 cursor-default"/>
                {r.width>45&&r.height>28&&<text x={r.x+r.width/2} y={r.y+r.height/2-(r.height>45?8:2)} textAnchor="middle" fontSize={r.width>140?"14":"12"} fill="white" fontWeight="600">{r.name}</text>}
                {r.width>40&&r.height>45&&<text x={r.x+r.width/2} y={r.y+r.height/2+10} textAnchor="middle" fontSize="12" fill="rgba(255,255,255,0.9)">{r.count} races</text>}
              </g>)}
            </svg>;
          })()}
          <p className="text-xs text-gray-400 mt-3 text-center">Size represents number of races hosted at each venue since 1962</p>
        </div>
      </div>
      
      {/* Name Frequency Tables */}
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-4">Most common names</h2>
        <div className="grid md:grid-cols-2 gap-8">
          {/* Men's names */}
          <div className="space-y-4">
            <h3 className="text-xs font-semibold text-gray-700 uppercase tracking-wide pb-1 border-b border-gray-200">Men's first names</h3>
            <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
              {nameStats.men.firstNames.map(([name,count],i)=><div key={name} className="flex justify-between"><span className="text-gray-400 w-4">{i+1}.</span><span className="flex-1 text-gray-900">{name}</span><span className="text-gray-500 tabular-nums">{count}</span></div>)}
            </div>
            <h3 className="text-xs font-semibold text-gray-700 uppercase tracking-wide pb-1 border-b border-gray-200 mt-4">Men's surnames</h3>
            <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
              {nameStats.men.surnames.map(([name,count],i)=><div key={name} className="flex justify-between"><span className="text-gray-400 w-4">{i+1}.</span><span className="flex-1 text-gray-900">{name}</span><span className="text-gray-500 tabular-nums">{count}</span></div>)}
            </div>
          </div>
          {/* Women's names */}
          <div className="space-y-4">
            <h3 className="text-xs font-semibold text-gray-700 uppercase tracking-wide pb-1 border-b border-gray-200">Women's first names</h3>
            <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
              {nameStats.women.firstNames.map(([name,count],i)=><div key={name} className="flex justify-between"><span className="text-gray-400 w-4">{i+1}.</span><span className="flex-1 text-gray-900">{name}</span><span className="text-gray-500 tabular-nums">{count}</span></div>)}
            </div>
            <h3 className="text-xs font-semibold text-gray-700 uppercase tracking-wide pb-1 border-b border-gray-200 mt-4">Women's surnames</h3>
            <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
              {nameStats.women.surnames.map(([name,count],i)=><div key={name} className="flex justify-between"><span className="text-gray-400 w-4">{i+1}.</span><span className="flex-1 text-gray-900">{name}</span><span className="text-gray-500 tabular-nums">{count}</span></div>)}
            </div>
          </div>
        </div>
        
        {/* The Modal Surrey Leaguers */}
        <div className="mt-8 pt-6 border-t border-gray-200">
          <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-4">The modal Surrey Leaguers</h3>
          <p className="text-xs text-gray-500 mb-4">The statistically average competitors - combining the most common first name, surname, and club</p>
          <div className="grid md:grid-cols-2 gap-6">
            {nameStats.men.firstNames[0]&&nameStats.men.surnames[0]&&nameStats.men.modalClub&&<div className="bg-gray-50 rounded-lg p-4 flex items-center gap-4">
              <div className="flex-shrink-0"><ClubShield club={nameStats.men.modalClub} size={48}/></div>
              <div>
                <div className="text-lg font-semibold text-gray-900">{nameStats.men.firstNames[0][0]} {nameStats.men.surnames[0][0]}</div>
                <div className="text-sm text-gray-500">{CLUBS[nameStats.men.modalClub]?.name||nameStats.men.modalClub}</div>
                <div className="text-xs text-gray-400 mt-1">Modal male Surrey Leaguer</div>
              </div>
            </div>}
            {nameStats.women.firstNames[0]&&nameStats.women.surnames[0]&&nameStats.women.modalClub&&<div className="bg-gray-50 rounded-lg p-4 flex items-center gap-4">
              <div className="flex-shrink-0"><ClubShield club={nameStats.women.modalClub} size={48}/></div>
              <div>
                <div className="text-lg font-semibold text-gray-900">{nameStats.women.firstNames[0][0]} {nameStats.women.surnames[0][0]}</div>
                <div className="text-sm text-gray-500">{CLUBS[nameStats.women.modalClub]?.name||nameStats.women.modalClub}</div>
                <div className="text-xs text-gray-400 mt-1">Modal female Surrey Leaguer</div>
              </div>
            </div>}
          </div>
        </div>
      </div>
    </div>
  </div>;
};

const SubmitView=({setView})=>{
  const[submitType,setSubmitType]=useState('url');
  const[url,setUrl]=useState('');
  const[file,setFile]=useState(null);
  const[notes,setNotes]=useState('');
  const[status,setStatus]=useState(null);
  const[submitting,setSubmitting]=useState(false);
  
  const handleSubmit=async(e)=>{
    e.preventDefault();
    setSubmitting(true);
    
    const formData=new FormData();
    formData.append('access_key','7f1557bd-f355-4008-a904-d892da5489b0'); // You'll replace this
    formData.append('subject','Surrey League Archive - Results Submission');
    formData.append('type',submitType);
    if(submitType==='url')formData.append('url',url);
    if(submitType==='file'&&file)formData.append('attachment',file);
    formData.append('notes',notes);
    
    try{
      const res=await fetch('https://api.web3forms.com/submit',{method:'POST',body:formData});
      if(res.ok){setStatus('success');}else{setStatus('error');}
    }catch(err){setStatus('error');}
    setSubmitting(false);
  };
  
  if(status==='success')return<div className="max-w-xl mx-auto px-4 py-8">
    <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
    <div className="text-center py-12">
      <div className="text-5xl mb-4">‚úÖ</div>
      <h1 className="text-2xl font-bold text-gray-900 mb-2">Thanks!</h1>
      <p className="text-gray-600">Your submission has been received. We'll review it and update the archive.</p>
    </div>
  </div>;
  
  return<div className="max-w-xl mx-auto px-4 py-8">
    <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
    <h1 className="text-2xl font-bold text-gray-900 mb-2">Submit Results</h1>
    <p className="text-sm text-gray-500 mb-6">Help us fill in the gaps! Submit a link to results or upload a file (PDF, image, etc).</p>
    
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="flex gap-4">
        <label className={`flex-1 p-4 border-2 rounded-lg cursor-pointer text-center transition-all ${submitType==='url'?'border-[#0077b6] bg-blue-50':'border-gray-200 hover:border-gray-300'}`}>
          <input type="radio" name="type" value="url" checked={submitType==='url'} onChange={()=>setSubmitType('url')} className="sr-only"/>
          <div className="text-2xl mb-1">üîó</div>
          <div className="font-medium">URL</div>
        </label>
        <label className={`flex-1 p-4 border-2 rounded-lg cursor-pointer text-center transition-all ${submitType==='file'?'border-[#0077b6] bg-blue-50':'border-gray-200 hover:border-gray-300'}`}>
          <input type="radio" name="type" value="file" checked={submitType==='file'} onChange={()=>setSubmitType('file')} className="sr-only"/>
          <div className="text-2xl mb-1">üìÑ</div>
          <div className="font-medium">File</div>
        </label>
      </div>
      
      {submitType==='url'&&<div>
        <label className="block text-sm font-medium text-gray-700 mb-1">URL to results</label>
        <input type="url" value={url} onChange={e=>setUrl(e.target.value)} placeholder="https://..." required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0077b6] focus:border-transparent outline-none"/>
      </div>}
      
      {submitType==='file'&&<div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Upload file</label>
        <input type="file" onChange={e=>setFile(e.target.files[0])} accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx,.csv" required className="w-full px-4 py-2 border border-gray-300 rounded-lg"/>
        <p className="text-xs text-gray-400 mt-1">PDF, images, Word, Excel accepted</p>
      </div>}
      
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
        <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="e.g. Season, match number, venue..." rows={3} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0077b6] focus:border-transparent outline-none resize-none"/>
      </div>
      
      {status==='error'&&<p className="text-red-600 text-sm">Something went wrong. Please try again.</p>}
      
      <button type="submit" disabled={submitting} className="w-full py-3 bg-[#0077b6] text-white rounded-lg hover:bg-[#005f8a] font-medium disabled:opacity-50">
        {submitting?'Submitting...':'Submit'}
      </button>
    </form>
  </div>;
};

const PubQuizView=({setView})=>{
  const questions=[
    {q:"Which father/son duo holds the record for best combined score?",opts:["The Ogdens (SLH)","The Sandersons (G&G)","The Clarks (H/W)","The Makkars (SLH)"],ans:0,info:"George Ogden (24th) + David Ogden (82nd) = 106 pts at Lloyd Park, 2021/22 M4"},
    {q:"Since 2014, how many times has a team escaped the relegation zone on the final day?",opts:["0","1","2","3"],ans:1,info:"Just once: Thames Hare & Hounds in 2023/24, overcoming a 15-point deficit to climb from 9th to 8th"},
    {q:"Since 2014, how many times has a team thrown away the lead on the final day?",opts:["0","1","2","3"],ans:2,info:"Twice: H/W lost a 12-point lead to Kent in 2017/18, and G&G lost a 24-point lead to H/W in 2022/23"},
    {q:"Which team recorded the worst single-match score in a 10-team season?",opts:["Ranelagh Harriers","Epsom & Ewell","Clapham Chasers","Woking AC"],ans:2,info:"Clapham Chasers scored 917 points at Beckenham Place Park in 2025/26 M2"},
    {q:"Which team recorded the best single-match score in a 9-team season?",opts:["Hercules Wimbledon","Kent AC","Herne Hill Harriers","Thames Hare & Hounds"],ans:2,info:"Herne Hill Harriers scored 99 points twice in 2011/12 ‚Äì at Wimbledon Common (M1) and Ham Lands (M2)"},
    {q:"How many times have Clapham Chasers been relegated since 2014?",opts:["1 time","2 times","3 times","4 times"],ans:2,info:"Relegated in 2017/18, 2019/20, and 2023/24 ‚Äì never staying up for more than 3 consecutive seasons"},
    {q:"Which brothers hold the record for best combined score?",opts:["The Holts (H/W)","The Malletts (H/W)","The Roberts (HHH)","The Cockerells (BEL)"],ans:0,info:"Bob Holt (=1st) + Dave Holt (=1st) = 3 pts at Morden Park, 1969/70 M3. They dead-heated for the win!"},
    {q:"What is the biggest points swing between two teams in a single match?",opts:["601 points","657 points","703 points","722 points"],ans:3,info:"H/W scored 153 pts while E&E scored 875 pts at Wimbledon Common, 2024/25 M1 ‚Äì a 722-point gap"},
    {q:"Which clubs have won the title despite winning only one match that season?",opts:["Belgrave Harriers only","Hercules Wimbledon and Aldershot only","Three different clubs","No club has ever done this"],ans:2,info:"BOH (1996/97), H/W (1964/65), and AFD (1975/76) all won titles with just 1 match win"},
    {q:"What is the biggest race turnout in Surrey League history?",opts:["312 finishers","327 finishers","341 finishers","354 finishers"],ans:3,info:"354 finishers at Wimbledon Common, 2023/24 M3 ‚Äì the largest field in league history"}
  ];
  const[current,setCurrent]=useState(0);
  const[selected,setSelected]=useState(null);
  const[score,setScore]=useState(0);
  const[showResult,setShowResult]=useState(false);
  const[finished,setFinished]=useState(false);
  
  const handleSelect=(idx)=>{
    if(showResult)return;
    setSelected(idx);
    setShowResult(true);
    if(idx===questions[current].ans)setScore(s=>s+1);
  };
  
  const nextQuestion=()=>{
    if(current<questions.length-1){
      setCurrent(c=>c+1);
      setSelected(null);
      setShowResult(false);
    }else{
      setFinished(true);
    }
  };
  
  const restart=()=>{
    setCurrent(0);
    setSelected(null);
    setScore(0);
    setShowResult(false);
    setFinished(false);
  };
  
  if(finished){
    const comparisons=[
      {min:0,max:0,name:"Clapham's 917-pt meltdown",club:"C/C",desc:"Beckenham Place Park, 2025/26 M2. The worst single-match score on record.",isTeam:true},
      {min:1,max:1,name:"Ranelagh's 907-pt disaster",club:"RAN",desc:"West Horsley Place, 2023/24 M4. A day to forget ‚Äì this one will haunt you for a while.",isTeam:true},
      {min:2,max:2,name:"Dorking's 850-pt collapse",club:"DMV",desc:"Mitcham Common, 2016/17 M3. The day the wheels came off.",isTeam:true},
      {min:3,max:3,name:"Steve Gardner",club:"BEL",desc:"17 races averaging 106th. You clearly care, but that hasn't helped your performance on this terrain."},
      {min:4,max:4,name:"David Ogden",club:"SLH",desc:"42 races averaging 135th. You clearly like this league enough to put your own son through it too."},
      {min:5,max:5,name:"David Grima",club:"H/W",desc:"40 races averaging 111th. Hercules' most persistent pack runner."},
      {min:6,max:6,name:"Jeff Cunningham",club:"HHH",desc:"39 races averaging 56th. Herne Hill's modern-era ironman."},
      {min:7,max:7,name:"Chris Greenwood",club:"KEN",desc:"28 races averaging 18th. Consistent A-team scorer."},
      {min:8,max:8,name:"John Gilbert",club:"KEN",desc:"32 races averaging 7th with 2 wins. Top 10 regular."},
      {min:9,max:9,name:"Jack Millar",club:"THH",desc:"5 wins from 9 races. Elite performer."},
      {min:10,max:10,name:"Paskar Owor",club:"BEL",desc:"The modern-era GOAT. 11 wins from 37 races, averaging 5th place."}
    ];
    const comp=comparisons.find(c=>score>=c.min&&score<=c.max)||comparisons[5];
    return<div className="max-w-2xl mx-auto px-4 py-8">
      <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
      <div className="text-center py-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-4">Quiz Complete!</h1>
        <div className="text-6xl font-bold text-[#0077b6] mb-6">{score}/{questions.length}</div>
        <div className="bg-gray-50 rounded-xl p-6 mb-6">
          <p className="text-sm text-gray-500 uppercase tracking-wide mb-2">You are{comp.isTeam?' equivalent to':' the'}...</p>
          <div className="flex items-center justify-center gap-3 mb-3">
            <ClubShield club={comp.club} size={32}/>
            <span className="text-2xl font-bold text-gray-900">{comp.name}</span>
          </div>
          <p className="text-gray-600">{comp.desc}</p>
        </div>
        <button onClick={restart} className="px-6 py-3 bg-[#0077b6] text-white rounded-lg hover:bg-[#005f8a] font-medium">Try Again</button>
      </div>
    </div>;
  }
  
  const q=questions[current];
  return<div className="max-w-2xl mx-auto px-4 py-8">
    <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
    <div className="mb-6">
      <h1 className="text-2xl font-bold text-gray-900 mb-1">üç∫ Surrey League Pub Quiz</h1>
      <p className="text-sm text-gray-500">Question {current+1} of {questions.length} ‚Ä¢ Score: {score}/{current+(showResult?1:0)}</p>
    </div>
    <div className="bg-gray-50 rounded-xl p-6 mb-6">
      <h2 className="text-lg font-semibold text-gray-900 mb-4">{q.q}</h2>
      <div className="space-y-3">
        {q.opts.map((opt,i)=>{
          let cls="w-full text-left px-4 py-3 rounded-lg border-2 transition-all ";
          if(!showResult){
            cls+=selected===i?"border-[#0077b6] bg-blue-50":"border-gray-200 hover:border-gray-300 bg-white";
          }else{
            if(i===q.ans)cls+="border-green-500 bg-green-50";
            else if(i===selected)cls+="border-red-500 bg-red-50";
            else cls+="border-gray-200 bg-white opacity-50";
          }
          return<button key={i} onClick={()=>handleSelect(i)} className={cls} disabled={showResult}>
            <span className="font-medium">{String.fromCharCode(65+i)}.</span> {opt}
          </button>;
        })}
      </div>
      {showResult&&<div className={`mt-4 p-4 rounded-lg ${selected===q.ans?'bg-green-100 text-green-800':'bg-amber-100 text-amber-800'}`}>
        <p className="font-medium mb-1">{selected===q.ans?'‚úì Correct!':'‚úó Not quite!'}</p>
        <p className="text-sm">{q.info}</p>
      </div>}
    </div>
    {showResult&&<button onClick={nextQuestion} className="w-full py-3 bg-[#0077b6] text-white rounded-lg hover:bg-[#005f8a] font-medium">
      {current<questions.length-1?'Next Question':'See Results'}
    </button>}
  </div>;
};

const OriginStoryView=({setView,cmsContent})=>{
  // Display vest code vs link target (HER shows pre-merger Hercules AC vest, links to H/W)
  const foundingClubs=[
    {vest:'MIT',link:'MIT'},
    {vest:'BEL',link:'BEL'},
    {vest:'WAL',link:'WAL'},
    {vest:'HER',link:'H/W'},  // Pre-merger Hercules AC vest, links to Hercules Wimbledon
    {vest:'HHH',link:'HHH'},
    {vest:'SLH',link:'SLH'}
  ];
  const ClubLink=({code,children})=><span className="cursor-pointer text-[#0077b6] hover:underline" onClick={()=>setView({type:'club',club:code})}>{children}</span>;
  return<div className="max-w-5xl mx-auto px-4 py-8">
    <h1 className="text-2xl font-bold text-gray-900 mb-6" style={{fontFamily:"'Fraunces',serif"}}>Origin story</h1>
    <div className="md:columns-2 md:gap-12 text-gray-700 leading-relaxed">
      <p className="mb-4"><svg width="32" height="20" viewBox="0 0 523.87 325.06" fill="none" className="inline-block mr-2 -mt-1 align-middle"><path fill="#9ca3af" d="M512.63,53.09c-1.82,1.1-3.56,2.3-5.31,3.6-1.77,1.3-3.49,2.72-5.16,4.28-3.36,3.12-6.32,6.83-9.33,11.28-1.29,1.96-2.52,4.08-3.69,6.37.66-3.22,1.29-6.24,1.86-9.04.15-.74.3-1.46.44-2.16.12-.71.23-1.4.35-2.08.23-1.36.44-2.65.65-3.88.33-1.95.62-3.73.89-5.34.3-.45.6-.9.88-1.34.86-1.39,1.59-2.78,2.29-4.16,1.39-2.76,2.54-5.47,3.47-8.14.92-2.67,1.47-5.31,1.93-7.88.42-2.58.7-5.09.74-7.56-.03-4.94-.62-9.64-1.73-14.14-1.21-4.5-2.82-8.78-4.61-12.9-1.94,4.12-3.71,8.27-5.08,12.56-1.48,4.28-2.68,8.7-3.22,13.4-.32,2.35-.58,4.76-.61,7.27-.07,2.5.12,5.11.35,7.82.22,2.71.64,5.54,1.27,8.51.31,1.49.7,3.02,1.09,4.58.12.51.26,1.02.39,1.54-.28,1.58-.58,3.32-.92,5.22-.81,4.76-1.93,10.51-3.44,17.04-.15-2.56-.42-4.98-.82-7.23-.84-5.12-2.67-9.55-4.77-13.36-1.07-1.91-2.25-3.67-3.51-5.3-1.29-1.64-2.72-3.17-4.19-4.58-2.95-2.84-6.16-5.28-9.48-7.5.1,2.02.24,4.04.46,6.07.22,2.02.53,4.05.81,6.06.61,4.02,1.71,8.06,3.27,12.07,1.51,4.01,3.63,8.02,6.58,12.08,2.53,3.52,5.59,7.05,9.46,10.62-1.13,4.33-2.4,8.91-3.86,13.71-1.81,5.94-3.89,12.2-6.29,18.68.07-.78.12-1.56.13-2.32.02-1.39-.02-2.74-.09-4.05-.31-5.23-1.26-9.76-3-13.84-1.67-4.06-3.85-7.59-6.35-10.76-2.57-3.18-5.5-6.01-8.53-8.64-.14,2.01-.21,4.04-.23,6.07-.09,2.01-.11,4.03-.03,6.06.08,2.03.27,4.08.57,6.15.27,2.05.6,4.1,1.12,6.19,2.01,7.77,5.67,15.72,12.83,24.38-3.38,8.35-7.28,16.96-11.76,25.63-.84,1.54-1.69,3.11-2.54,4.66.41-1.97.72-3.87.91-5.7.4-5.23-.06-9.91-1.07-14.11-1.08-4.23-2.85-8.06-4.93-11.53-2.11-3.49-4.49-6.6-7.22-9.63l-.27,1.49-.31,1.46c-.2.98-.38,1.96-.54,2.95-.33,1.98-.59,3.97-.75,6-.12,2.05-.33,4.03-.33,6.09-.02,2.05.08,4.14.33,6.28.12,1.07.3,2.16.47,3.24.16,1.07.37,2.16.61,3.26.49,2.2,1.16,4.47,2.02,6.8.85,2.33,1.93,4.75,3.16,7.21.83,1.69,1.78,3.41,2.83,5.18-.08.14-.17.28-.25.42-1.41,2.33-2.83,4.68-4.25,7.05-1.5,2.32-3.06,4.61-4.6,6.93-.77,1.16-1.55,2.32-2.32,3.48-.78,1.16-1.65,2.26-2.47,3.4-1.47,1.99-2.95,4-4.43,6,.12-.34.23-.67.34-1,.43-1.32.81-2.61,1.12-3.87.63-2.53,1.07-4.93,1.24-7.26.14-2.37.08-4.63-.13-6.8-.77-8.61-4.53-15.99-8.9-22.62-.68,1.85-1.33,3.73-1.9,5.64l-.83,2.88c-.29.94-.56,1.9-.81,2.86-.5,1.93-.9,3.9-1.19,5.94-.15,1.01-.26,2.05-.36,3.09-.12,1.02-.21,2.05-.27,3.1-.12,2.11-.1,4.29.08,6.55.16,2.26.55,4.66.96,7.04.74,4,1.98,8.3,3.81,12.95l-1.78,2.18c-.93,1.07-1.9,2.11-2.84,3.16l-5.7,6.31c-2.01,2-4.01,4-6.02,6-1.01.99-1.99,2.01-3.01,2.98l-2.99,2.68c.76-1.32,1.46-2.62,2.07-3.89,2.06-4.83,3.14-9.36,3.52-13.63.25-4.39-.21-8.51-1.12-12.42-.46-1.96-1.03-3.86-1.69-5.72-.69-1.89-1.48-3.76-2.31-5.58l-1.37,2.6c-.48.84-.95,1.69-1.4,2.56-.9,1.73-1.75,3.5-2.51,5.33-.39.91-.73,1.87-1.1,2.78-.38.91-.73,1.84-1.06,2.79-.66,1.9-1.21,3.88-1.65,5.95-.22,1.04-.41,2.1-.56,3.19-.18,1.06-.35,2.13-.47,3.24-.25,2.22-.36,4.55-.32,7.03.03,2.47.25,5.11.58,7.84.2,1.72.47,3.51.81,5.37-1.47,1.18-2.94,2.36-4.4,3.53-1.09.85-2.14,1.77-3.27,2.57-1.12.8-2.25,1.6-3.37,2.4-2.25,1.58-4.44,3.22-6.7,4.73-2.3,1.45-4.58,2.89-6.85,4.32-.44.27-.88.55-1.31.83.83-1.01,1.6-2.02,2.31-3.02,1.51-2.12,2.76-4.21,3.79-6.28.97-2.15,1.71-4.29,2.27-6.39.56-2.1.92-4.16,1.13-6.19.1-1.02.18-2.02.2-3.03,0-1.03-.02-2.06-.07-3.07-.23-4.06-.94-7.99-1.91-11.83-2.49,2.9-4.75,6.11-7.02,9.21-2.23,3.17-4.1,6.8-5.84,10.51-.84,1.9-1.59,3.92-2.23,6.09-.32,1.08-.62,2.2-.88,3.36-.27,1.15-.55,2.27-.78,3.48-.75,3.85-1.19,8.15-1.27,12.97-.7.39-1.41.78-2.11,1.16-2.33,1.11-4.64,2.22-6.93,3.31-2.29,1.08-4.52,2.22-6.84,3.09-2.29.93-4.55,1.84-6.79,2.75-1.12.43-2.21.95-3.34,1.3-.88.3-1.75.59-2.62.88.85-.66,1.68-1.33,2.45-2,3.8-3.59,6.53-7.39,8.52-11.15,1.94-3.88,3.04-7.92,3.66-11.85.61-3.96.74-7.85.51-11.9-1.43,1.29-2.96,2.39-4.41,3.64-1.46,1.23-2.88,2.54-4.25,3.93-1.35,1.45-2.76,2.73-4.07,4.24-1.32,1.48-2.57,3.08-3.77,4.82-.6.86-1.17,1.79-1.75,2.69-.58.89-1.15,1.81-1.69,2.78-1.09,1.93-2.11,4.03-3.05,6.32-.94,2.27-1.78,4.79-2.57,7.42-.47,1.52-.9,3.13-1.3,4.8-.66.18-1.33.36-1.98.53-2.11.57-4.18,1.13-6.2,1.67-1.01.3-2.02.51-3.03.71-1.01.21-2,.41-2.98.61-1.97.4-3.89.8-5.76,1.18-.94.18-1.85.41-2.78.55-.92.13-1.83.26-2.73.39-3.58.51-6.96,1-10.11,1.45-1.23.1-2.41.2-3.57.3-1.74-7.86-8.74-13.74-17.12-13.74s-15.38,5.88-17.12,13.74c-1.16-.1-2.34-.2-3.57-.3-3.15-.45-6.53-.94-10.11-1.45-.9-.13-1.8-.26-2.73-.39-.92-.14-1.84-.36-2.78-.55-1.87-.39-3.79-.78-5.76-1.18-.98-.2-1.98-.41-2.98-.61-1.01-.2-2.03-.41-3.03-.71-2.03-.55-4.09-1.1-6.2-1.67-.65-.18-1.32-.36-1.98-.53-.4-1.67-.83-3.28-1.3-4.8-.78-2.63-1.63-5.15-2.57-7.42-.94-2.29-1.95-4.39-3.05-6.32-.55-.97-1.11-1.89-1.69-2.78-.58-.9-1.15-1.83-1.74-2.69-1.19-1.74-2.45-3.34-3.77-4.82-1.31-1.51-2.72-2.79-4.07-4.24-1.37-1.39-2.79-2.69-4.25-3.93-1.45-1.25-2.98-2.35-4.41-3.64-.24,4.05-.11,7.94.51,11.9.63,3.93,1.73,7.98,3.66,11.85,1.98,3.76,4.72,7.56,8.52,11.15.77.67,1.59,1.34,2.45,2-.87-.29-1.74-.58-2.62-.88-1.14-.35-2.22-.87-3.34-1.3-2.23-.9-4.5-1.82-6.79-2.75-2.32-.87-4.55-2.02-6.84-3.09-2.28-1.09-4.59-2.2-6.93-3.31-.69-.38-1.4-.77-2.1-1.16-.08-4.82-.52-9.12-1.27-12.97-.23-1.2-.51-2.33-.78-3.48-.27-1.16-.56-2.28-.88-3.36-.64-2.17-1.39-4.19-2.23-6.09-1.74-3.71-3.61-7.34-5.84-10.51-2.27-3.11-4.53-6.31-7.02-9.21-.96,3.84-1.68,7.77-1.9,11.83-.06,1.01-.08,2.04-.08,3.07.02,1.01.09,2.01.2,3.03.21,2.03.58,4.09,1.13,6.19.56,2.09,1.29,4.23,2.27,6.39,1.03,2.07,2.28,4.16,3.79,6.28.71,1,1.49,2.01,2.32,3.03-.44-.28-.88-.56-1.32-.84-2.27-1.43-4.55-2.87-6.85-4.32-2.26-1.51-4.45-3.15-6.7-4.73-1.12-.8-2.24-1.6-3.37-2.4-1.13-.79-2.17-1.71-3.27-2.57-1.46-1.17-2.93-2.35-4.39-3.52.34-1.86.61-3.65.81-5.37.33-2.73.54-5.37.58-7.84.04-2.47-.07-4.81-.32-7.03-.12-1.11-.29-2.18-.47-3.24-.16-1.09-.35-2.15-.56-3.19-.44-2.08-.99-4.05-1.65-5.95-.33-.95-.68-1.88-1.05-2.79-.37-.91-.71-1.87-1.1-2.78-.76-1.83-1.61-3.61-2.51-5.33-.45-.86-.92-1.72-1.4-2.56l-1.37-2.6c-.83,1.82-1.62,3.69-2.31,5.58-.66,1.86-1.23,3.77-1.69,5.72-.91,3.91-1.38,8.03-1.12,12.42.37,4.26,1.46,8.8,3.52,13.63.61,1.28,1.31,2.58,2.07,3.9l-3-2.69c-1.02-.97-2.01-1.99-3.01-2.98-2-2-4.01-4-6.02-6l-5.71-6.31c-.95-1.06-1.91-2.09-2.84-3.16l-1.78-2.18c1.82-4.65,3.07-8.95,3.81-12.95.41-2.38.8-4.78.96-7.04.18-2.27.2-4.45.08-6.55-.06-1.05-.15-2.09-.27-3.1-.1-1.03-.21-2.07-.36-3.09-.29-2.03-.7-4.01-1.19-5.94-.25-.96-.52-1.92-.81-2.86l-.83-2.88c-.58-1.91-1.22-3.78-1.9-5.64-4.36,6.63-8.12,14-8.9,22.62-.22,2.17-.27,4.43-.13,6.8.18,2.34.62,4.73,1.24,7.26.32,1.26.69,2.55,1.12,3.87.11.33.22.67.34,1.01-1.48-2.01-2.96-4.01-4.44-6.01-.82-1.14-1.69-2.24-2.47-3.4-.78-1.16-1.55-2.32-2.33-3.48-1.54-2.32-3.11-4.61-4.6-6.93-1.43-2.36-2.84-4.71-4.25-7.05-.08-.14-.17-.28-.25-.41,1.05-1.77,2-3.5,2.83-5.19,1.24-2.46,2.31-4.88,3.16-7.21.86-2.33,1.52-4.6,2.02-6.8.25-1.1.45-2.19.61-3.26.18-1.08.35-2.17.47-3.24.25-2.14.35-4.23.33-6.28,0-2.06-.21-4.04-.33-6.09-.16-2.03-.42-4.03-.75-6-.16-.99-.35-1.97-.54-2.95l-.31-1.46-.27-1.49c-2.73,3.02-5.11,6.14-7.22,9.63-2.07,3.47-3.85,7.29-4.93,11.53-1.01,4.2-1.47,8.88-1.07,14.11.2,1.83.5,3.73.91,5.71-.85-1.56-1.7-3.13-2.54-4.68-4.48-8.67-8.38-17.28-11.76-25.62,7.16-8.66,10.82-16.6,12.83-24.38.52-2.09.85-4.14,1.12-6.19.31-2.07.49-4.11.57-6.15.08-2.03.07-4.05-.03-6.06-.03-2.03-.1-4.06-.23-6.07-3.03,2.62-5.96,5.45-8.53,8.64-2.5,3.16-4.68,6.69-6.35,10.76-1.74,4.08-2.7,8.61-3,13.84-.08,1.31-.11,2.66-.09,4.05,0,.77.06,1.55.13,2.34-2.4-6.48-4.49-12.75-6.3-18.7-1.46-4.79-2.73-9.37-3.86-13.7,3.87-3.58,6.93-7.1,9.46-10.63,2.95-4.05,5.08-8.07,6.58-12.08,1.56-4.02,2.66-8.05,3.27-12.07.28-2.01.59-4.03.81-6.06.22-2.02.36-4.05.46-6.07-3.32,2.23-6.54,4.66-9.49,7.5-1.47,1.42-2.9,2.94-4.19,4.58-1.27,1.64-2.45,3.4-3.51,5.3-2.11,3.81-3.93,8.24-4.77,13.36-.4,2.26-.68,4.68-.82,7.25-1.51-6.54-2.63-12.29-3.44-17.06-.34-1.91-.64-3.64-.92-5.22.13-.52.27-1.04.39-1.54.39-1.56.79-3.09,1.09-4.58.63-2.98,1.05-5.81,1.27-8.51.23-2.71.42-5.32.35-7.82-.04-2.51-.29-4.92-.61-7.27-.54-4.7-1.74-9.12-3.22-13.4-1.38-4.29-3.14-8.44-5.09-12.56-1.79,4.12-3.4,8.41-4.6,12.9-1.11,4.49-1.7,9.2-1.73,14.14.04,2.47.32,4.98.74,7.56.45,2.57,1.01,5.21,1.92,7.88.93,2.67,2.08,5.39,3.47,8.14.7,1.38,1.43,2.77,2.29,4.16.28.44.58.89.87,1.34.27,1.61.57,3.39.89,5.35.21,1.23.42,2.52.65,3.88.11.68.23,1.37.35,2.08.14.71.29,1.43.44,2.16.58,2.79,1.2,5.81,1.86,9.02-1.17-2.28-2.4-4.4-3.69-6.36-3.01-4.44-5.97-8.16-9.33-11.28-1.66-1.56-3.39-2.98-5.16-4.28-1.75-1.31-3.49-2.5-5.31-3.6-3.62-2.2-7.39-4.04-11.24-5.73.67,2.3,1.39,4.58,2.17,6.82.78,2.24,1.62,4.44,2.68,6.56,2.07,4.26,4.42,8.3,7.48,11.92,3.11,3.61,6.76,6.83,11.13,9.48,3.84,2.3,8.32,4.15,13.4,5.48.18.74.37,1.49.55,2.24.87,3.8,2.09,7.72,3.26,11.84,1.78,6.03,3.84,12.39,6.21,18.97-.53-.71-1.07-1.41-1.57-2.1-.83-1.12-1.68-2.19-2.54-3.2-3.43-4.06-7.13-7.28-10.72-9.99-3.66-2.69-7.49-4.78-11.42-6.5-3.87-1.73-7.8-3.1-11.82-4.3.94,2.21,1.9,4.4,2.95,6.53,1.12,2.12,2.3,4.18,3.57,6.18s2.62,3.92,4.07,5.76c1.5,1.82,3.16,3.54,4.91,5.14,6.42,6,14.99,10.23,26.03,11.65,3.38,8.57,7.3,17.43,11.84,26.35.78,1.46,1.56,2.94,2.35,4.41-1.43-1.45-2.87-2.79-4.32-4.03-3.94-3.55-7.92-6.3-12.01-8.43-4.02-2.16-8.01-3.76-12.13-4.95-4.08-1.2-8.32-1.99-12.39-2.68l.9,1.56.98,1.53c.66,1.01,1.34,2.01,2.02,3,1.38,1.97,2.8,3.88,4.31,5.71,1.47,1.84,3.19,3.53,4.92,5.15,1.75,1.61,3.59,3.11,5.53,4.48.97.68,1.96,1.34,3,1.94,1.06.59,2.15,1.15,3.27,1.67,2.24,1.04,4.59,1.91,7.07,2.6,2.49.68,5.08,1.19,7.87,1.45,1.94.17,3.95.23,6.03.19.16.26.31.53.47.79,1.41,2.39,2.83,4.79,4.26,7.21,1.54,2.35,3.08,4.71,4.64,7.08.78,1.19,1.55,2.37,2.34,3.56.83,1.15,1.67,2.31,2.51,3.47,1.39,1.92,2.78,3.84,4.18,5.77-.29-.22-.59-.44-.87-.65-1.13-.82-2.27-1.59-3.39-2.3-2.25-1.43-4.52-2.64-6.72-3.71-2.16-1.1-4.32-2.02-6.47-2.79-8.72-3.02-17-3.86-25.47-3.97,1.55,1.89,3.13,3.74,4.76,5.52.83.89,1.62,1.78,2.5,2.61.88.83,1.78,1.64,2.69,2.43,1.82,1.57,3.7,3.06,5.65,4.41.98.68,1.96,1.33,2.99,1.94,1.05.59,2.12,1.15,3.22,1.66,2.18,1.04,4.44,1.92,6.79,2.62,2.36.69,4.74,1.25,7.38,1.49,4.33.43,8.92.27,13.8-.6l2.13,2.65,2.88,3.24c1.93,2.16,3.82,4.35,5.78,6.47,2.03,2.06,4.06,4.12,6.09,6.18,1.03,1.01,1.99,2.09,3.07,3.05l2.6,2.37c-1.42-.65-2.82-1.25-4.2-1.78-4.87-2.1-9.56-3.41-14.16-4.13-4.47-.84-8.83-1.09-13.14-.97-2.16.06-4.3.22-6.43.43-2.1.19-4.17.44-6.25.73.91.83,1.81,1.66,2.76,2.44.97.77,1.94,1.53,2.92,2.26,1.97,1.48,3.96,2.87,6,4.17,1.03.64,2.03,1.28,3.11,1.84,1.08.56,2.18,1.08,3.28,1.58,2.21.99,4.47,1.84,6.78,2.52,1.15.34,2.32.64,3.5.9,1.21.23,2.44.4,3.68.52,2.48.25,5.01.3,7.59.13,2.59-.18,5.2-.56,7.92-1.26,1.75-.46,3.52-1.04,5.31-1.72,3.86,3.16,7.65,6.36,11.7,9.15,1.14.83,2.27,1.65,3.4,2.48,1.14.82,2.24,1.67,3.43,2.4,2.34,1.51,4.66,3,6.97,4.48.26.18.53.34.79.51-1.27-.33-2.53-.61-3.77-.86-2.63-.51-5.17-.84-7.65-1.01-2.42-.25-4.76-.36-7.07-.32-2.3.04-4.55.22-6.76.5-1.1.14-2.2.32-3.28.51-1.06.17-2.11.36-3.16.57-4.18.86-8.25,2.08-12.28,3.43,4.33,2.53,8.6,4.99,13.28,6.63,4.62,1.69,9.22,3.07,14.16,3.37,2.44.19,4.89.21,7.35.02,1.23-.1,2.46-.24,3.7-.44,1.24-.21,2.52-.54,3.78-.89,4.07-1.16,8.15-2.94,12.21-5.45.91.51,1.81,1.02,2.72,1.5,2.38,1.16,4.74,2.31,7.07,3.45,1.17.57,2.33,1.13,3.48,1.7,1.16.56,2.35,1,3.52,1.5,4.23,1.74,8.32,3.53,12.44,4.93-1.12,0-2.22,0-3.29.05-5.32.01-10.15.59-14.69,1.71-4.49,1.01-8.61,2.37-12.58,4.13-3.96,1.74-7.77,3.84-11.4,5.87,2.32.94,4.77,1.59,7.18,2.23,2.42.63,4.83,1.18,7.24,1.61,2.39.48,4.88.6,7.32.68,2.45.06,4.88-.03,7.28-.29,1.21-.14,2.4-.28,3.6-.55,1.21-.28,2.41-.6,3.61-.97,2.39-.75,4.74-1.69,7.05-2.88,2.31-1.19,4.56-2.56,6.78-4.3,1.31-1.03,2.59-2.17,3.86-3.38.88.24,1.76.48,2.62.73,2.16.6,4.27,1.19,6.34,1.77,2.08.54,4.15.92,6.15,1.37,3,.63,5.87,1.31,8.67,1.8-34.81,6.71-50.9,25.82-50.9,37.54,1.58,2.03,10.58,2.7,14.17,0,2.98-11.93,21.55-30.13,53.7-33.34,1.82,7.76,8.76,13.54,17.07,13.54s15.26-5.78,17.07-13.54c32.15,3.22,50.72,21.41,53.7,33.34,3.6,2.7,12.6,2.03,14.18,0,0-11.72-16.09-30.83-50.9-37.54,2.79-.5,5.67-1.18,8.67-1.8,2-.45,4.07-.83,6.15-1.37,2.07-.58,4.18-1.17,6.34-1.77.86-.25,1.74-.49,2.62-.73,1.27,1.22,2.55,2.35,3.86,3.38,2.22,1.73,4.47,3.1,6.78,4.3,2.31,1.18,4.66,2.13,7.05,2.88,1.2.37,2.4.7,3.61.97,1.21.26,2.39.41,3.6.55,2.41.26,4.84.35,7.29.29,2.43-.08,4.93-.2,7.32-.68,2.41-.43,4.83-.98,7.24-1.61,2.41-.65,4.86-1.3,7.18-2.23-3.63-2.03-7.44-4.13-11.4-5.87-3.97-1.77-8.09-3.12-12.58-4.13-4.54-1.12-9.36-1.7-14.69-1.71-1.08-.04-2.18-.06-3.29-.05,4.12-1.4,8.22-3.19,12.44-4.93,1.17-.5,2.36-.94,3.52-1.5,1.15-.56,2.31-1.13,3.48-1.7,2.33-1.14,4.69-2.29,7.07-3.45.91-.49,1.82-1,2.72-1.51,4.06,2.51,8.14,4.29,12.21,5.45,1.26.35,2.54.68,3.78.89,1.23.2,2.47.35,3.7.44,2.46.19,4.91.17,7.35-.02,4.94-.3,9.54-1.68,14.16-3.37,4.68-1.63,8.95-4.1,13.28-6.63-4.03-1.35-8.1-2.57-12.28-3.43-1.04-.21-2.1-.41-3.16-.57-1.08-.18-2.18-.36-3.28-.51-2.21-.29-4.46-.46-6.76-.5-2.3-.04-4.64.07-7.06.32-2.48.17-5.03.49-7.65,1.01-1.24.24-2.49.53-3.77.86.26-.17.53-.33.79-.51,2.31-1.48,4.63-2.98,6.97-4.48,1.19-.72,2.29-1.58,3.43-2.4,1.13-.82,2.27-1.65,3.4-2.48,4.05-2.79,7.84-5.99,11.7-9.15,1.79.68,3.56,1.26,5.31,1.72,2.72.7,5.34,1.08,7.93,1.26,2.58.18,5.11.12,7.59-.13,1.24-.13,2.47-.3,3.68-.52,1.18-.26,2.35-.56,3.5-.9,2.31-.68,4.56-1.53,6.78-2.52,1.11-.49,2.2-1.02,3.28-1.58,1.08-.56,2.08-1.2,3.11-1.84,2.04-1.3,4.04-2.69,6.01-4.17.98-.74,1.96-1.49,2.92-2.26.95-.79,1.84-1.62,2.76-2.44-2.08-.29-4.15-.54-6.25-.73-2.13-.22-4.27-.37-6.43-.43-4.31-.13-8.67.13-13.14.97-4.59.72-9.29,2.03-14.16,4.13-1.39.53-2.79,1.12-4.21,1.78l2.6-2.38c1.08-.96,2.04-2.04,3.07-3.05,2.03-2.06,4.06-4.12,6.09-6.18,1.96-2.12,3.86-4.32,5.78-6.47l2.88-3.24,2.14-2.65c4.89.87,9.48,1.03,13.81.6,2.64-.24,5.01-.8,7.38-1.49,2.35-.7,4.61-1.59,6.79-2.62,1.09-.52,2.16-1.07,3.21-1.66,1.03-.6,2.01-1.26,2.99-1.94,1.95-1.36,3.83-2.84,5.65-4.41.91-.79,1.81-1.6,2.69-2.43.89-.83,1.68-1.72,2.5-2.61,1.63-1.78,3.21-3.63,4.76-5.52-8.46.12-16.75.95-25.47,3.97-2.16.77-4.31,1.68-6.47,2.79-2.2,1.07-4.48,2.27-6.72,3.71-1.13.71-2.26,1.48-3.39,2.3-.29.22-.59.44-.88.66,1.4-1.93,2.79-3.85,4.18-5.77.84-1.16,1.67-2.31,2.51-3.47.78-1.19,1.56-2.38,2.33-3.56,1.55-2.37,3.1-4.73,4.64-7.08,1.43-2.42,2.85-4.82,4.26-7.21.16-.26.31-.53.47-.79,2.08.04,4.09-.02,6.03-.19,2.79-.26,5.38-.77,7.87-1.45,2.48-.69,4.83-1.56,7.07-2.6,1.12-.52,2.21-1.08,3.27-1.67,1.05-.6,2.03-1.26,3-1.94,1.94-1.37,3.78-2.87,5.53-4.48,1.73-1.62,3.46-3.31,4.92-5.15,1.51-1.83,2.94-3.74,4.31-5.71.69-.98,1.36-1.98,2.02-3l.98-1.53.9-1.56c-4.07.69-8.31,1.48-12.39,2.68-4.12,1.19-8.11,2.79-12.13,4.95-4.09,2.13-8.07,4.88-12.01,8.43-1.45,1.23-2.89,2.58-4.32,4.03.78-1.47,1.57-2.95,2.35-4.41,4.54-8.92,8.46-17.78,11.84-26.35,11.04-1.42,19.62-5.65,26.03-11.65,1.75-1.61,3.41-3.32,4.91-5.14,1.46-1.83,2.81-3.76,4.07-5.76s2.45-4.06,3.57-6.18c1.05-2.13,2.02-4.32,2.95-6.53-4.01,1.2-7.95,2.57-11.81,4.3-3.93,1.72-7.77,3.81-11.42,6.5-3.59,2.71-7.29,5.93-10.72,9.99-.86,1.01-1.7,2.08-2.54,3.2-.51.69-1.04,1.39-1.58,2.11,2.37-6.59,4.43-12.95,6.21-18.98,1.17-4.12,2.4-8.04,3.26-11.84.19-.76.37-1.5.55-2.24,5.09-1.33,9.57-3.18,13.41-5.48,4.37-2.65,8.02-5.87,11.13-9.48,3.06-3.62,5.41-7.66,7.48-11.92,1.06-2.13,1.9-4.33,2.68-6.56.78-2.24,1.5-4.52,2.17-6.82-3.84,1.69-7.62,3.53-11.24,5.73Z"/></svg>The North Surrey League was born in May 1962 when at a meeting at The Three Kings, Mitcham, the local club <ClubLink code="MIT">Mitcham AC</ClubLink> proposed that a cross country league be formed.</p>
      <p className="mb-4">Because of traditional fixtures the proposal was not over-enthusiastically received by the other six clubs represented at the meeting: <ClubLink code="BEL">Belgrave</ClubLink>, <ClubLink code="WAL">Walton</ClubLink>, <ClubLink code="H/W">Hercules</ClubLink>, <ClubLink code="HHH">Herne Hill</ClubLink> and <ClubLink code="SLH">South London Harriers</ClubLink>. Nevertheless, all except SLH eventually agreed to give the idea a trial. It was an immediate success.</p>
      <p className="mb-4">After just two seasons <ClubLink code="CRO">Croydon Harriers</ClubLink> applied for membership and were accepted by the league, so the number of participating teams rose to seven. By the 1966-67 season the Mid-Surrey League had become 'division two' and the league had its first relegation battle, lost by Herne Hill who went down for a single season and were replaced in the top flight by <ClubLink code="RAN">Ranelagh Harriers</ClubLink>.</p>
      <p className="mb-4">SLH now regretted not taking up a place in the North Surrey League and one of their number, Ferdie Gilson, had even joined Belgrave as a 2nd-claim member just to take part. With a lower division now in place, South London's change of heart meant that they had to go in at the bottom but they won the Mid-Surrey League in 1968-69 and as a result appeared in the North Surrey League in 1969-70. The annual cycle of relegation and promotion was now well under way.</p>
      <p className="mb-4">By 1970 the league had assumed the name of the Surrey Cross Country League with Division Two containing the clubs <ClubLink code="AFD">Aldershot, Farnham & District</ClubLink>, Metropolitan Police AC, <ClubLink code="E&E">Epsom & Ewell</ClubLink> and <ClubLink code="G&G">Guildford & Godalming</ClubLink> together with <ClubLink code="SAC">Surrey AC</ClubLink> and Herne Hill who had temporarily slipped out of Division One.</p>
      <p className="mb-4">For our earlier matches we have mostly shown the results as reported, not having had a chance to work from the original result sheets. There are sometimes discrepancies between the results as shown in Athletics Weekly and those in The Belgravian - and occasionally the Belgrave scores don't correctly tally with the team scores shown. We've tended to leave the team scores as published unless the error is obvious but have flagged scoring anomalies. It is likely that some scoring errors are as a result of published race places being actual positions and not scoring positions. Early results were not always reported in Athletics Weekly.</p>
      <p className="mt-6 text-sm text-gray-500 italic">Contributed by Alan Mead, athletics historian and arguably the most successful team manager in the history of club athletics.</p>
    </div>
    <div className="mt-10 pt-6 border-t border-gray-200">
      <figure className="max-w-3xl mx-auto">
        <img src="1964-wimbledon-common.jpg" alt="Surrey League race at Wimbledon Common, October 1964" className="w-full rounded-lg shadow-md"/>
        <figcaption className="mt-3 text-sm text-gray-600 leading-relaxed">
          <span className="font-medium">October 24th, Wimbledon Common.</span> It's the opening match of the 1964/65 season and <span className="text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:{name:'Geoff North',club:'BEL'}})}>Geoff North</span> (10 <span className="inline-block align-middle"><ClubShield club="BEL" size={12}/></span>) leads <span className="text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:{name:'Mike Gowan',club:'HHH'}})}>Mike Gowan</span> (110 <span className="inline-block align-middle"><ClubShield club="HHH" size={12}/></span>), <span className="text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:{name:'Gerry North',club:'BEL'}})}>Gerry North</span> (obscured), <span className="text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:{name:'Les Presland',club:'SUR'}})}>Les Presland</span> (211 <span className="inline-block align-middle"><ClubShield club="SUR" size={12}/></span>), <span className="text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:{name:'John Thresher',club:'BEL'}})}>John Thresher</span> (3 <span className="inline-block align-middle"><ClubShield club="BEL" size={12}/></span>) and <span className="text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:{name:'Tony Fairclough',club:'BEL'}})}>Tony Fairclough</span> (to Thresher's right). <span className="inline-block align-middle"><ClubShield club="SUR" size={12}/></span> <span className="text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:{name:'John Snowden',club:'SUR'}})}>John Snowden</span> ran out the winner, outkicking Gerry North in a sprint finish. <span className="inline-block align-middle"><ClubShield club="BEL" size={12}/></span> Belgrave (225 pts) took the team race from <span className="inline-block align-middle"><ClubShield club="HER" size={12}/></span> Hercules AC (243 pts) and <span className="inline-block align-middle"><ClubShield club="MIT" size={12}/></span> Mitcham AC (268 pts).
        </figcaption>
      </figure>
    </div>
    <div className="flex justify-center gap-3 mt-10 pt-6 border-t border-gray-200">
      {foundingClubs.map(({vest,link})=><div key={vest} className="cursor-pointer hover:scale-110 transition-transform" onClick={()=>setView({type:'club',club:link})}><ClubShield club={vest} size={40}/></div>)}
    </div>
    <p className="text-center text-xs text-gray-400 mt-2">The founding clubs who met at The Three Kings, Mitcham</p>
  </div>;
};

const ClubsView=({setView,clubAllTime})=>{
  const[sort,setSort]=useState('titles');
  // Filter out hidden clubs (GUEST, N/S, etc.)
  const filteredClubs=clubAllTime.filter(c=>!CLUBS[c.club]?.hidden);
  const sorted=[...filteredClubs].sort((a,b)=>{
    if(sort==='titles')return(b.titles||0)-(a.titles||0)||(b.seconds||0)-(a.seconds||0)||(b.thirds||0)-(a.thirds||0);
    if(sort==='seconds')return(b.seconds||0)-(a.seconds||0)||(b.titles||0)-(a.titles||0)||(b.thirds||0)-(a.thirds||0);
    if(sort==='thirds')return(b.thirds||0)-(a.thirds||0)||(b.titles||0)-(a.titles||0)||(b.seconds||0)-(a.seconds||0);
    if(sort==='seasonCount')return(b.seasonCount||0)-(a.seasonCount||0)||(b.titles||0)-(a.titles||0);
    return 0;
  });
  return<div className="max-w-5xl mx-auto px-4 py-8"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4"><h1 className="text-2xl font-bold text-gray-900" style={{fontFamily:"'Fraunces',serif"}}>All-time clubs</h1></th><th className="text-right py-1.5 px-2 w-12"><button onClick={()=>setSort('titles')} className={`${sort==='titles'?'text-[#0077b6]':'text-gray-500 hover:text-gray-900'}`} title="League titles">üèÜ</button></th><th className="text-right py-1.5 px-2 w-10"><button onClick={()=>setSort('seconds')} className={`${sort==='seconds'?'text-[#0077b6]':'text-gray-500 hover:text-gray-900'}`} title="Second place">ü•à</button></th><th className="text-right py-1.5 px-2 w-10"><button onClick={()=>setSort('thirds')} className={`${sort==='thirds'?'text-[#0077b6]':'text-gray-500 hover:text-gray-900'}`} title="Third place">ü•â</button></th><th className="text-right py-1.5 pl-2 w-12"><button onClick={()=>setSort('seasonCount')} className={`${sort==='seasonCount'?'text-[#0077b6]':'text-gray-500 hover:text-gray-900'}`} title="Seasons in Division 1 in our data">üìÖ</button></th></tr></thead><tbody>{sorted.map((c,i)=><tr key={c.club} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-5 text-right">{i+1}</span><ClubShield club={c.club} size={14}/><span className="text-sm text-gray-900 md:hidden">{c.club}</span><span className="text-sm text-gray-900 hidden md:inline">{CLUBS[c.club]?.name||c.club}</span></div></td><td className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort==='titles'?'font-semibold text-[#0077b6]':'text-gray-900'}`}>{c.titles||'-'}</td><td className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort==='seconds'?'font-semibold text-[#0077b6]':'text-gray-600'}`}>{c.seconds||'-'}</td><td className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort==='thirds'?'font-semibold text-[#0077b6]':'text-gray-500'}`}>{c.thirds||'-'}</td><td className={`text-right py-1.5 pl-2 text-sm tabular-nums ${sort==='seasonCount'?'font-semibold text-[#0077b6]':'text-gray-400'}`}>{c.seasonCount||'-'}</td></tr>)}</tbody></table></div>;
};

const ClubDetailView=({clubCode,setView,athletes,races,clubAllTime,clubMvps,seasonsData,division,cmsContent})=>{
  const[sort,setSort]=useState('value');const clubData=clubAllTime.find(c=>c.club===clubCode);const clubInfo=CLUBS[clubCode];
  const TEAM_SIZE_A=division==='women'?5:10;
  const currentSeason=Object.keys(seasonsData||{}).sort().reverse()[0]||'2025/26';
  
  // Helper to get the actual calendar year of a race from season and match
  const getRaceYear=(season,match,date)=>{
    // If we have a full date, use it
    if(date&&date.length>3){
      const d=new Date(date);
      if(!isNaN(d))return d.getFullYear();
    }
    // Otherwise derive from season and match
    // Season "2001/02" -> first year is 2001, second is 2002
    // Match 1-2 (Oct/Nov) are in first year, Match 3-4 (Jan/Feb) are in second year
    const parts=season.split('/');
    const firstYear=parts[0].length===4?parseInt(parts[0]):(parseInt(parts[0])<50?2000:1900)+parseInt(parts[0]);
    return match>=3?firstYear+1:firstYear;
  };
  
  // Update document metadata for club page
  const divisionLabel=division==='women'?'women':'men';
  useDocumentMeta({
    title:clubInfo?.name?`${clubInfo.name} ${divisionLabel} Surrey League history`:null,
    favicon:clubCode?`data:image/svg+xml,${encodeURIComponent(getClubVestSvg(clubCode))}`:null,
    ogDesc:clubInfo?.name?`${clubInfo.name} Surrey League cross country history`:null
  });
  
  // Compute championship years
  const{titleYears,secondYears,thirdYears}=useMemo(()=>{
    const titles=[],seconds=[],thirds=[];
    Object.entries(seasonsData||{}).forEach(([season,sd])=>{
      if(!sd?.standings?.[0])return;
      const isHist=sd.historical;
      const hasM4=sd.standings[0].m4!==null||isHist;
      if(!hasM4)return;
      const getYear=s=>{const parts=s.split('/');const yy=parts[1];return(parseInt(yy)<50?'20':'19')+yy;};
      if(sd.standings[0]?.club===clubCode)titles.push(getYear(season));
      if(sd.standings[1]?.club===clubCode)seconds.push(getYear(season));
      if(sd.standings[2]?.club===clubCode)thirds.push(getYear(season));
    });
    return{titleYears:titles.sort().reverse(),secondYears:seconds.sort().reverse(),thirdYears:thirds.sort().reverse()};
  },[seasonsData,clubCode]);
  
  // Compute club-specific stats from race results
  const clubAthletes=useMemo(()=>{
    const athleteStats={};
    
    // Helper to ensure athlete entry exists
    const ensureAthlete=(name,club)=>{
      const nameKey=normalizeNameForCompare(name);
      if(!athleteStats[nameKey]){
        athleteStats[nameKey]={
          name:name,
          club:club,
          wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,
          races:0,aScores:0,value:0,
          firstYear:null,lastYear:null,lastSeason:null
        };
      }
      return athleteStats[nameKey];
    };
    
    // Helper to update year range
    const updateYears=(s,race)=>{
      const year=getRaceYear(race.season,race.match,race.date);
      if(!s.firstYear||year<s.firstYear)s.firstYear=year;
      if(!s.lastYear||year>s.lastYear)s.lastYear=year;
      if(!s.lastSeason||race.season>s.lastSeason)s.lastSeason=race.season;
    };
    
    // Go through all races and count stats only when athlete represented this club
    races.forEach(race=>{
      // Handle races without results (only have winner info)
      if(!race.results?.length){
        // Handle dead heats (multiple winners) - each winner has their own club
        if(race.winners){
          race.winners.forEach(w=>{
            if(w.club===clubCode){
              const s=ensureAthlete(w.name,clubCode);
              s.wins++;
              s.top3++;
              s.top5++;
              s.top10++;
              s.races++;
              s.aScores++;
              s.value+=TEAM_SIZE_A; // A1 gets max points
              updateYears(s,race);
            }
          });
        }else if(race.winnerClub===clubCode){
          const s=ensureAthlete(race.winner,clubCode);
          s.wins++;
          s.top3++;
          s.top5++;
          s.top10++;
          s.races++;
          s.aScores++;
          s.value+=TEAM_SIZE_A; // A1 gets max points
          updateYears(s,race);
        }
        return;
      }
      
      race.results.forEach((r,idx)=>{
        if(r.club!==clubCode)return;
        const s=ensureAthlete(r.name,clubCode);
        s.races++;
        updateYears(s,race);
        if(r.pos===1||r.pos==='=1')s.wins++;
        if(r.pos<=3||r.pos==='=1')s.top3++;
        if(r.pos<=5||r.pos==='=1')s.top5++;
        if(r.pos<=10||r.pos==='=1')s.top10++;
        if(r.pos<=20||r.pos==='=1')s.top20++;
        if(r.pos<=50||r.pos==='=1')s.top50++;
        if(r.pos<=100||r.pos==='=1')s.top100++;
        // Count A-team scores - top N finishers for the club (excluding non-scorers)
        if(!r.ns){
          const clubRunnersInRace=race.results.filter(x=>x.club===clubCode&&!x.ns);
          const posInClub=clubRunnersInRace.findIndex(x=>namesMatch(x.name,r.name))+1;
          if(posInClub>=1&&posInClub<=TEAM_SIZE_A){
            s.aScores++;
            s.value+=(TEAM_SIZE_A-posInClub+1); // A1=max points, A2=max-1, etc.
          }
        }
      });
    });
    
    return Object.values(athleteStats).sort((a,b)=>{
      if(sort==='value'){
        if((b.value||0)!==(a.value||0))return(b.value||0)-(a.value||0);
        if((b.aScores||0)!==(a.aScores||0))return(b.aScores||0)-(a.aScores||0);
        return(b.wins||0)-(a.wins||0);
      }
      if(sort==='aScores'){
        if((b.aScores||0)!==(a.aScores||0))return(b.aScores||0)-(a.aScores||0);
        return(b.wins||0)-(a.wins||0);
      }
      if(b[sort]!==a[sort])return(b[sort]||0)-(a[sort]||0);
      if(b.wins!==a.wins)return(b.wins||0)-(a.wins||0);
      if(b.top3!==a.top3)return(b.top3||0)-(a.top3||0);
      return(b.races||0)-(a.races||0);
    });
  },[clubCode,sort,races]);
  
  const mvp=clubAthletes[0];
  const allTimeRank=clubAllTime.findIndex(c=>c.club===clubCode)+1;if(!clubInfo)return<div className="max-w-5xl mx-auto px-4 py-8"><p>Club not found</p></div>;
  const cols=[{f:'value',l:'V',t:TEAM_SIZE_A===5?'Value: 5pts for A1 down to 1pt for A5':'Value: 10pts for A1 down to 1pt for A10'},{f:'aScores',l:'A',t:'A-team scores for this club'},{f:'wins',l:'W',t:'Race wins'},{f:'top3',l:'T3',t:'Top 3 finishes'},{f:'top5',l:'T5',t:'Top 5 finishes'},{f:'top10',l:'T10',t:'Top 10 finishes'},{f:'top20',l:'T20',t:'Top 20 finishes'},{f:'top50',l:'T50',t:'Top 50 finishes'},{f:'top100',l:'T100',t:'Top 100 finishes'},{f:'races',l:'R',t:'Total races'}];
  const yearToSeason=(year)=>{const y=parseInt(year);const yy=(y-1).toString().slice(-2);const yy2=y.toString().slice(-2);return `${y-1>=2000?'':'19'}${yy}/${yy2}`;};
  const renderYears=(years)=>years.map((y,i)=><React.Fragment key={y}>{i>0&&<span className="text-gray-400"> ¬∑ </span>}<span className="cursor-pointer hover:text-[#0077b6] hover:underline" onClick={(e)=>{e.stopPropagation();setView({type:'home',urlSeason:yearToSeason(y)});}}>{y}</span></React.Fragment>);
  // Get CMS bio for this club (falls back to hardcoded desc)
  const clubBio=getCmsContent(cmsContent,'club_bio',clubCode,division);
  
  return<div className="max-w-5xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'clubs'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-8"><div className="flex items-center gap-4 mb-3"><ClubShield club={clubCode} size={48}/><div><h1 className="text-2xl font-bold text-gray-900" style={{fontFamily:"'Fraunces',serif"}}>{clubInfo.name}</h1>{allTimeRank>0&&<p className="text-sm text-gray-500">#{allTimeRank} all-time</p>}{(clubBio||clubInfo.desc)&&<p className="text-sm text-gray-500 italic mt-1">{clubBio?<ParsedContent content={clubBio} setView={setView}/>:clubInfo.desc}</p>}</div></div><div className="flex flex-wrap gap-2">{titleYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{titleYears.length}√ó League Champions üèÜ</span><span className="text-sm font-medium text-gray-700">{renderYears(titleYears)}</span></div>}{secondYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{secondYears.length}√ó Runners-up ü•à</span><span className="text-sm font-medium text-gray-700">{renderYears(secondYears)}</span></div>}{thirdYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{thirdYears.length}√ó Third place ü•â</span><span className="text-sm font-medium text-gray-700">{renderYears(thirdYears)}</span></div>}</div>{mvp&&<p className="mt-3 text-sm text-gray-600">Club üêê: <span className="font-medium text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:mvp})}>{mvp.name}</span></p>}</div><div className="overflow-x-auto"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4"><span className="text-xs text-gray-500 uppercase">Athlete</span></th>{cols.map(c=><th key={c.f} className="py-1.5 px-1 w-10 text-center"><button onClick={()=>setSort(c.f)} className={`text-xs uppercase ${sort===c.f?'text-[#0077b6] font-semibold':'text-gray-500'}`} data-tip={c.t}>{c.l}</button></th>)}</tr></thead><tbody>{clubAthletes.map((a,i)=><tr key={a.name} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-6 text-right">{i+1}</span><span className="text-sm text-gray-900">{a.name}</span>{a.firstYear&&<span className="hidden md:inline text-xs text-gray-400 ml-1">{a.firstYear}-{a.lastSeason===currentSeason?'present':a.lastYear}</span>}</div></td>{cols.map(c=><td key={c.f} className={`py-1.5 px-1 w-10 text-center text-sm tabular-nums ${sort===c.f?'font-semibold text-[#0077b6]':'text-gray-600'} ${a[c.f]===0?'text-gray-300':''}`}>{a[c.f]||'-'}</td>)}</tr>)}</tbody></table></div></div>;
};

const SeasonsView=({setView,seasonsData,races,mitchellCupWinners,division})=>{
  const[expanded,setExpanded]=useState(null);
  const individualLabel=division==='women'?'Individual':'Mitchell Cup';
  
  // Helper to compute individual rankings from race results
  const computeIndividualRankings=(season,seasonRaces)=>{
    const athleteResults={};
    seasonRaces.forEach(r=>{
      if(!r.results)return;
      r.results.forEach(res=>{
        if(!res.pts)return;
        const key=res.name;
        if(!athleteResults[key])athleteResults[key]={name:res.name,club:res.club,runs:[],total:0};
        athleteResults[key].runs.push({match:r.match,pos:res.pos});
      });
    });
    return Object.values(athleteResults)
      .filter(a=>a.runs.length===4)
      .map(a=>{a.total=a.runs.reduce((sum,r)=>sum+r.pos,0);return a;})
      .sort((a,b)=>a.total-b.total);
  };
  
  // Helper to compute B team standings from race results
  const computeBTeamStandings=(season,seasonRaces,numAClubs)=>{
    const clubBScores={};
    seasonRaces.forEach(r=>{
      if(!r.results)return;
      const clubScorers={};
      r.results.forEach(res=>{
        if(!res.pts||!res.club)return;
        if(!clubScorers[res.club])clubScorers[res.club]=[];
        clubScorers[res.club].push(res.pts);
      });
      Object.entries(clubScorers).forEach(([club,pts])=>{
        const bPts=pts.slice(10,20);// B team is scorers 11-20
        if(bPts.length>0){
          if(!clubBScores[club])clubBScores[club]={club,scores:[],total:0};
          const bScore=bPts.reduce((s,p)=>s+p,0);
          // B-team penalty: each missing runner scores (numAClubs √ó 10 + 1)
          // This matches the A-team penalty formula pattern
          const missing=10-bPts.length;
          const penalty=missing>0?missing*(numAClubs*10+1):0;
          clubBScores[club].scores.push(bScore+penalty);
        }
      });
    });
    return Object.values(clubBScores)
      .filter(c=>c.scores.length===4)
      .map(c=>{c.total=c.scores.reduce((s,v)=>s+v,0);return c;})
      .sort((a,b)=>a.total-b.total);
  };
  
  const seasons=useMemo(()=>Object.entries(seasonsData).sort((a,b)=>b[0].localeCompare(a[0])).map(([season,data])=>{
    // Check if cancelled season
    if(data.cancelled)return{season,isComplete:false,isCancelled:true,isHistorical:true,aTeam:[],bTeam:[],individual:[]};
    // Check if we have complete race data (>100 results per race for all 4)
    const seasonRaces=races.filter(r=>r.season===season);
    const racesWithResults=seasonRaces.filter(r=>r.results&&r.results.length>100);
    const hasCompleteRaceData=racesWithResults.length===4;
    // Historical = flagged as historical or has champion but limited standings/no race data
    const isHistorical=data.historical||(!hasCompleteRaceData&&data.champion&&(!data.standings||data.standings.length<=1||!data.standings[0]?.m4));
    // Complete if we have standings with m4, or it's historical with a champion
    const isComplete=isHistorical?(!!data.champion):(data.standings?.[0]?.m4!==null&&data.standings?.[0]?.m4!==undefined);
    // Compute individual/B team if we have complete race data but no stored rankings
    // Fall back to Mitchell Cup historical data if no calculated data available
    let individual=data.individualRankings?.slice(0,3)||(hasCompleteRaceData?computeIndividualRankings(season,seasonRaces).slice(0,3):[]);
    if(individual.length===0&&mitchellCupWinners?.[season]){
      individual=mitchellCupWinners[season].map(w=>({name:w.name,club:w.club,historical:true}));
    }
    const numAClubs=data.standings?.length||9;
    const bTeam=data.bStandings?.slice(0,3)||(hasCompleteRaceData?computeBTeamStandings(season,seasonRaces,numAClubs).slice(0,3):[]);
    // For historical seasons, create aTeam from champion
    const aTeam=isComplete?(data.standings?.length>0?data.standings.slice(0,3):(isHistorical&&data.champion?[{club:data.champion,pos:1}]:[])):[];
    return{season,isComplete,isHistorical,aTeam,bTeam,individual};
  }),[seasonsData,races,mitchellCupWinners]);
  const canExpand=(s)=>s.isComplete&&!s.isHistorical&&(s.bTeam.length>0||(s.individual.length>0&&!s.individual[0]?.historical));
  const shortSeason=(s)=>s.slice(2);// "2024/25" -> "24/25"
  // Render individual winner(s) - handles joint winners from Mitchell Cup data
  const renderIndividual=(ind,isHistorical)=>{
    if(!ind||ind.length===0)return<span className="text-sm text-gray-400">-</span>;
    // Check if this is historical Mitchell Cup data with joint winners
    const isJoint=ind[0]?.historical&&ind.length>1;
    if(isJoint){
      return<div className="flex flex-col gap-0.5">{ind.map((w,i)=><div key={i} className="flex items-center gap-1 md:gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={e=>{e.stopPropagation();setView({type:'athlete',athlete:{name:w.name,club:w.club}});}}><ClubShield club={w.club} size={14}/><span className="text-sm text-gray-700"><span className="hidden md:inline">{w.name}</span><span className="md:hidden">{getSurname(w.name)}</span></span></div>)}</div>;
    }
    const w=ind[0];
    return<div className="flex items-center gap-1 md:gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={e=>{e.stopPropagation();setView({type:'athlete',athlete:{name:w.name,club:w.club}});}}><ClubShield club={w.club} size={14}/><span className="text-sm text-gray-700"><span className="hidden md:inline">{w.name}</span><span className="md:hidden">{getSurname(w.name)}</span></span></div>;
  };
  return<div className="max-w-5xl mx-auto px-4 py-8"><h1 className="text-2xl font-bold text-gray-900 mb-4" style={{fontFamily:"'Fraunces',serif"}}>Winners</h1><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="w-5 md:w-6"></th><th className="text-left py-1.5 pr-2 md:pr-4 text-xs text-gray-500 uppercase">Season</th><th className="text-left py-1.5 px-1 md:px-4 text-xs text-gray-500 uppercase">A Team</th><th className="text-left py-1.5 px-1 md:px-4 text-xs text-gray-500 uppercase">B Team</th><th className="text-left py-1.5 pl-1 md:pl-4 text-xs text-gray-500 uppercase"><span className="cursor-help" title={division==='women'?"Individual champion: Lowest cumulative finishing position from best 3 of 4 races":"Mitchell Cup: Lowest cumulative finishing position across all 4 fixtures. Must complete all fixtures to qualify."}>{individualLabel} <span className="text-gray-400">‚ìò</span></span></th></tr></thead><tbody>{seasons.filter(s=>!s.isCancelled).map(s=><React.Fragment key={s.season}><tr className={`border-b border-gray-50 hover:bg-blue-50 ${canExpand(s)?'cursor-pointer':''}`} onClick={()=>canExpand(s)&&setExpanded(expanded===s.season?null:s.season)}><td className="py-1.5 pr-0.5 md:pr-1">{canExpand(s)&&<span className="text-gray-400">{expanded===s.season?<ChevronUp className="w-4 h-4"/>:<ChevronDown className="w-4 h-4"/>}</span>}</td><td className="py-1.5 pr-2 md:pr-4"><span className="text-sm text-gray-900"><span className="md:hidden">{shortSeason(s.season)}</span><span className="hidden md:inline">{s.season}</span></span></td><td className="py-1.5 px-1 md:px-4">{s.aTeam[0]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.aTeam[0].club} size={14}/><span className="text-sm text-gray-900">{s.aTeam[0].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-1 md:px-4">{s.bTeam[0]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.bTeam[0].club} size={14}/><span className="text-sm text-gray-900">{s.bTeam[0].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-1 md:pl-4">{renderIndividual(s.individual,s.isHistorical)}</td></tr>{expanded===s.season&&<><tr className="bg-gray-50 border-b border-gray-100"><td className="py-1.5 pr-0.5 md:pr-1"></td><td className="py-1.5 pr-2 md:pr-4 text-sm text-gray-400">2nd</td><td className="py-1.5 px-1 md:px-4">{s.aTeam[1]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.aTeam[1].club} size={14}/><span className="text-sm text-gray-600">{s.aTeam[1].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-1 md:px-4">{s.bTeam[1]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.bTeam[1].club} size={14}/><span className="text-sm text-gray-600">{s.bTeam[1].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-1 md:pl-4">{s.individual[1]&&!s.individual[0]?.historical?<div className="flex items-center gap-1 md:gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:s.individual[1].name,club:s.individual[1].club}})}><ClubShield club={s.individual[1].club} size={14}/><span className="text-sm text-gray-600"><span className="hidden md:inline">{s.individual[1].name}</span><span className="md:hidden">{getSurname(s.individual[1].name)}</span></span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr><tr className="bg-gray-50 border-b border-gray-100"><td className="py-1.5 pr-0.5 md:pr-1"></td><td className="py-1.5 pr-2 md:pr-4 text-sm text-gray-400">3rd</td><td className="py-1.5 px-1 md:px-4">{s.aTeam[2]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.aTeam[2].club} size={14}/><span className="text-sm text-gray-600">{s.aTeam[2].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-1 md:px-4">{s.bTeam[2]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.bTeam[2].club} size={14}/><span className="text-sm text-gray-600">{s.bTeam[2].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-1 md:pl-4">{s.individual[2]&&!s.individual[0]?.historical?<div className="flex items-center gap-1 md:gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:s.individual[2].name,club:s.individual[2].club}})}><ClubShield club={s.individual[2].club} size={14}/><span className="text-sm text-gray-600"><span className="hidden md:inline">{s.individual[2].name}</span><span className="md:hidden">{getSurname(s.individual[2].name)}</span></span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr></>}</React.Fragment>)}</tbody></table></div>;
};

const SeasonAnalysis=({season,seasonData,races,standings,allSeasonsData,isComplete,data,setView,setSeason})=>{
  const insights=useMemo(()=>{
    const items=[];
    if(!seasonData||!standings?.length)return items;
    const matches=seasonData.matches||[];
    const seasonRaces=races.filter(r=>r.season===season);
    const currentSeason=data.seasons[0];
    const isCurrentSeason=season===currentSeason;
    const numTeams=standings.length;
    const winningTotal=standings[0]?.total;
    const margin=standings.length>=2&&standings[0].total&&standings[1].total?standings[1].total-standings[0].total:null;
    
    // Notable athletes with achievements
    const notableAthletes={
      'Alex Yee':{accolade:'future Olympic gold medalist',club:'KEN'}
    };
    
    // Confirmed brother pairs
    const brotherPairs=[
      {names:['Bob Holt','Dave Holt'],club:'H/W',surname:'Holt'},
      {names:['Ed Mallett','George Mallett'],club:'H/W',surname:'Mallett'},
      {names:['Edward Mallett','George Mallett'],club:'H/W',surname:'Mallett'},
      {names:['Morgan Roberts','Harry Roberts'],club:'HHH',surname:'Roberts'}
    ];
    
    const findLastTitle=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort().reverse();
      for(const s of seasons){if(s>=season)continue;if(allSeasonsData[s]?.standings?.[0]?.club===club)return s;}
      return null;
    };
    
    const findLastInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort().reverse();
      for(const s of seasons){if(s>=season)continue;if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const findNextInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort();
      for(const s of seasons){if(s<=season)continue;if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const findFirstInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort();
      for(const s of seasons){if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const findLastRelegation=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort().reverse();
      for(const s of seasons){
        if(s>=season)continue;
        const sd=allSeasonsData[s];
        if(!sd?.standings)continue;
        const pos=sd.standings.findIndex(t=>t.club===club)+1;
        const numTeams=sd.standings.length;
        // Check if club was in relegation zone (9th or 10th in a 9 or 10 team league)
        if(pos>=9&&pos===numTeams){
          return{season:s,pos};
        }
        // Also check if club disappeared next season (was relegated)
        const nextSeason=Object.keys(allSeasonsData).sort().find(ns=>ns>s);
        if(nextSeason&&allSeasonsData[nextSeason]?.standings){
          const inNext=allSeasonsData[nextSeason].standings.some(t=>t.club===club);
          if(!inNext&&pos>=8)return{season:s,pos};
        }
      }
      return null;
    };
    
    const findLowestPosition=(club)=>{
      let lowest=null;
      const seasons=Object.keys(allSeasonsData).sort();
      for(const s of seasons){
        if(s>=season)continue;
        const sd=allSeasonsData[s];
        if(!sd?.standings)continue;
        const pos=sd.standings.findIndex(t=>t.club===club)+1;
        if(pos>0&&(!lowest||pos>lowest.pos)){
          lowest={season:s,pos};
        }
      }
      return lowest;
    };
    
    const getYear=(s)=>{const yy=s.split('/')[1];return(parseInt(yy)<50?'20':'19')+yy;};
    
    const countAllFourWins=()=>{
      let count=0;
      for(const[s,sd] of Object.entries(allSeasonsData)){
        if(s>=season)continue;
        const wins={};(sd.matches||[]).forEach(m=>{if(m.teamWinner)wins[m.teamWinner]=(wins[m.teamWinner]||0)+1;});
        if(Object.values(wins).some(v=>v===4))count++;
      }
      return count;
    };
    
    const hasAnyoneWonAll4=()=>{
      for(const[s,sd] of Object.entries(allSeasonsData)){
        const ms=sd.matches||[];if(ms.length<4)continue;
        const wins={};ms.forEach(m=>{if(m.winner)wins[m.winner]=(wins[m.winner]||0)+1;});
        if(Object.values(wins).some(v=>v===4))return true;
      }
      return false;
    };
    
    // Find closest/biggest margins and best totals up to this season
    const getMarginStats=()=>{
      let closest=null,biggest=null,bestTotal9=null,bestTotal10=null;
      for(const[s,sd] of Object.entries(allSeasonsData)){
        if(s>season||!sd?.standings?.length||sd.standings.length<2)continue;
        const st=sd.standings;
        const m=st[1].total&&st[0].total?st[1].total-st[0].total:null;
        const total=st[0].total;
        if(m!==null){
          if(!closest||m<closest.margin)closest={season:s,margin:m};
          if(!biggest||m>biggest.margin)biggest={season:s,margin:m};
        }
        if(total){
          if(st.length===9&&(!bestTotal9||total<bestTotal9.total))bestTotal9={season:s,total};
          if(st.length===10&&(!bestTotal10||total<bestTotal10.total))bestTotal10={season:s,total};
        }
      }
      return{closest,biggest,bestTotal9,bestTotal10};
    };
    
    const indWins={};matches.forEach(m=>{if(m.winner)indWins[m.winner]=(indWins[m.winner]||0)+1;});
    const maxIndWins=Math.max(...Object.values(indWins),0);
    const dominantInd=Object.keys(indWins).find(k=>indWins[k]===maxIndWins);
    const dominantIndClub=matches.find(m=>m.winner===dominantInd)?.winnerClub;
    
    const teamWins={};matches.forEach(m=>{if(m.teamWinner)teamWins[m.teamWinner]=(teamWins[m.teamWinner]||0)+1;});
    const maxTeamWins=Math.max(...Object.values(teamWins),0);
    const dominantTeam=Object.keys(teamWins).find(k=>teamWins[k]===maxTeamWins);
    const completedMatches=matches.filter(m=>m.winner).length;
    
    if(isCurrentSeason){
      if(maxIndWins>=3&&dominantInd&&!hasAnyoneWonAll4()){
        items.push({text:'could become the first athlete to win all 4 races in a single season',athlete:{name:dominantInd,club:dominantIndClub}});
      }else if(maxIndWins>=3&&dominantInd){
        items.push({text:'on course to win all 4 races this season',athlete:{name:dominantInd,club:dominantIndClub}});
      }
      
      const leader=standings[0]?.club;
      const leaderTotal=standings[0]?.total;
      const secondTotal=standings[1]?.total;
      const pointLead=leaderTotal&&secondTotal?leaderTotal-secondTotal:null;
      if(leader){
        const lastTitle=findLastTitle(leader);
        if(lastTitle&&parseInt(lastTitle.split('/')[0])<parseInt(season.split('/')[0])-5){
          items.push({text:`have ${Math.abs(pointLead)}-point lead and could win first title since`,club:leader,linkSeason:lastTitle});
        }else if(!lastTitle){
          items.push({text:`have ${Math.abs(pointLead)}-point lead and are on course for first ever league title`,club:leader});
        }else if(pointLead){
          items.push({text:`lead by ${Math.abs(pointLead)} points`,club:leader});
        }
      }
      
      if(standings.length>=2&&standings[0].total&&standings[1].total){
        const gap=standings[0].total-standings[1].total;
        const matchesLeft=4-completedMatches;
        if(gap<150*matchesLeft&&gap>0&&standings[1].club){
          items.push({text:`${gap} points behind with ${matchesLeft} match${matchesLeft>1?'es':''} to go`,club:standings[1].club});
        }
      }
      
      if(standings.length>=9&&season!=='2022/23'){
        // Relegation zone insight with deficit and yo-yo stats
        const numTeams=standings.length;
        const safePos=numTeams-2;// Position that's safe (e.g. 8th in 10-team league)
        const safeTeam=standings[safePos-1];
        const relZone=[numTeams-1,numTeams];// Bottom 2 relegated
        
        relZone.map(pos=>standings[pos-1]).filter(Boolean).forEach(team=>{
          if(team&&items.length<6){
            const deficit=team.total-safeTeam?.total;
            
            // Check if just promoted back
            const prevSeason=data.seasons[data.seasons.indexOf(season)+1];
            const wasInDiv1Last=prevSeason&&allSeasonsData[prevSeason]?.standings?.some(t=>t.club===team.club);
            const justPromoted=!wasInDiv1Last;
            
            // Count relegations since 2014/15 and max consecutive seasons
            let relegationCount=0;
            const relegationSeasons=[];
            let maxConsecutive=0,currentStreak=0;
            
            data.seasons.filter(s=>s>='2014/15'&&s<season&&s!=='2022/23').forEach(s=>{
              const sd=allSeasonsData[s];
              if(!sd?.standings)return;
              const wasIn=sd.standings.some(t=>t.club===team.club);
              const numT=sd.standings.length;
              const relZ=[numT-1,numT];// Bottom 2
              const pos=sd.standings.findIndex(t=>t.club===team.club)+1;
              if(wasIn){
                currentStreak++;
                maxConsecutive=Math.max(maxConsecutive,currentStreak);
                if(relZ.includes(pos)){relegationCount++;relegationSeasons.push(s);}
              }else{currentStreak=0;}
            });
            
            // Build the insight text
            let text=`have ${deficit}-point deficit to overcome to avoid relegation`;
            if(justPromoted)text+=` after just one season back in the top flight`;
            
            // Add threshold note
            if(deficit>757)text+=` ‚Äì mathematically impossible`;
            else if(deficit>600)text+=` ‚Äì would require a near-record final day swing`;
            else if(deficit<=15)text+=` (record: 15 pts)`;
            
            items.push({text,club:team.club});
          }
        });
        
        // Check for clubs that might have their lowest finish
        standings.slice(3,8).forEach((team,idx)=>{
          const currentPos=idx+4;// positions 4-8
          const lowestEver=findLowestPosition(team.club);
          if(lowestEver&&currentPos>lowestEver.pos&&items.length<6){
            items.push({text:`${currentPos}${currentPos===4?'th':currentPos===5?'th':'th'} place would be their lowest Div 1 finish since ${getYear(lowestEver.season)}`,club:team.club});
          }
        });
      }
      
      const biggestRace=seasonRaces.reduce((max,r)=>(r.finishers||0)>=(max?.finishers||0)?r:max,null);
      if(biggestRace?.finishers>=200){
        const allRacesByFinishers=races.filter(r=>r.finishers).sort((a,b)=>b.finishers-a.finishers);
        const rank=allRacesByFinishers.findIndex(r=>r.season===biggestRace.season&&r.match===biggestRace.match)+1;
        const ordinal=rank===1?'biggest ever':rank===2?'2nd biggest':rank===3?'3rd biggest':rank<=10?`${rank}th biggest`:null;
        if(ordinal)items.push({text:`was the ${ordinal} turnout on record (${biggestRace.finishers})`,race:biggestRace,venueName:biggestRace.venue});
      }
      
    }else if(isComplete){
      const champion=standings[0]?.club;
      const marginStats=getMarginStats();
      
      if(champion){
        const lastTitle=findLastTitle(champion);
        const titleCount=Object.entries(allSeasonsData).filter(([s,sd])=>s<=season&&sd?.standings?.[0]?.club===champion).length;
        if(lastTitle){
          const gap=parseInt(season.split('/')[0])-parseInt(lastTitle.split('/')[0]);
          if(gap>=5)items.push({text:`won first title in ${gap} years, since`,club:champion,linkSeason:lastTitle});
        }
        if(titleCount>1){
          const ordinal=['','','2nd','3rd','4th','5th','6th','7th','8th','9th','10th','11th','12th','13th','14th','15th','16th','17th'][titleCount]||`${titleCount}th`;
          items.push({text:`claimed their ${ordinal} league title`,club:champion});
        }
      }
      
      // Margin records
      if(margin!==null&&marginStats.closest?.season===season&&margin<=20){
        items.push({text:`Closest ever winning margin: just ${margin} points`});
      }else if(margin!==null&&margin<=20){
        items.push({text:`Title decided by just ${margin} points`});
      }
      
      if(margin!==null&&marginStats.biggest?.season===season&&margin>=200){
        items.push({text:`Biggest ever winning margin: ${margin} points`});
      }
      
      // Best totals - only show for current season as it's less meaningful historically
      if(isCurrentSeason&&winningTotal&&numTeams===9&&marginStats.bestTotal9?.season===season){
        items.push({text:`Best ever winning total in a 9-team season: ${winningTotal} points`,club:champion});
      }
      if(isCurrentSeason&&winningTotal&&numTeams===10&&marginStats.bestTotal10?.season===season){
        items.push({text:`Best ever winning total in a 10-team season: ${winningTotal} points`,club:champion});
      }
      
      if(maxIndWins>=3&&dominantInd)items.push({text:`won ${maxIndWins} of 4 races`,athlete:{name:dominantInd,club:dominantIndClub}});
      
      // Check for notable athletes winning races
      matches.forEach(match=>{
        if(match.winner&&notableAthletes[match.winner]){
          const notable=notableAthletes[match.winner];
          const race=seasonRaces.find(r=>r.match===match.num);
          if(race)items.push({text:`Match ${match.num} won by ${notable.accolade}`,athlete:{name:match.winner,club:notable.club},race});
        }
      });
      
      // Check for notable athletes in results (first to score when someone else won)
      seasonRaces.forEach(race=>{
        if(!race.results)return;
        const winner=race.results[0];
        if(winner&&!notableAthletes[winner.name]){
          // Winner isn't notable, check if a notable athlete scored
          race.results.slice(1,20).forEach(r=>{
            if(notableAthletes[r.name]){
              const notable=notableAthletes[r.name];
              items.push({text:`Race won by ${winner.name}; ${notable.accolade}`,athlete:{name:r.name,club:notable.club},textAfter:` was ${r.pos}${r.pos===2?'nd':r.pos===3?'rd':'th'}`,race,venueName:race.venue});
            }
          });
        }
      });
      
      // Check for brother pairs combined scores
      const findBrotherScores=(race)=>{
        if(!race.results)return null;
        for(const pair of brotherPairs){
          const found=pair.names.map(name=>race.results.find(r=>r.name.toLowerCase().includes(name.split(' ')[0].toLowerCase())&&r.name.toLowerCase().includes(name.split(' ')[1].toLowerCase()))).filter(Boolean);
          if(found.length>=2){
            const sorted=found.sort((a,b)=>a.pos-b.pos);
            return{combined:sorted[0].pos+sorted[1].pos,runner1:sorted[0],runner2:sorted[1],surname:pair.surname,club:pair.club};
          }
        }
        return null;
      };
      
      // Find best brother score in this season and all-time up to this season
      let bestThisSeason=null;
      seasonRaces.forEach(race=>{
        const score=findBrotherScores(race);
        if(score&&(!bestThisSeason||score.combined<bestThisSeason.combined)){
          bestThisSeason={...score,race};
        }
      });
      
      if(bestThisSeason){
        // Check if it's the all-time record up to this point
        let allTimeBest=bestThisSeason.combined;
        races.filter(r=>r.season<season).forEach(race=>{
          const score=findBrotherScores(race);
          if(score&&score.combined<allTimeBest)allTimeBest=score.combined;
        });
        
        if(bestThisSeason.combined<=allTimeBest&&bestThisSeason.combined<=50){
          items.push({
            text:`Match ${bestThisSeason.race.match} saw the lowest combined score of any two brothers on record:`,
            race:bestThisSeason.race,
            brothers:[
              {name:bestThisSeason.runner1.name,club:bestThisSeason.club,pos:bestThisSeason.runner1.pos},
              {name:bestThisSeason.runner2.name,club:bestThisSeason.club,pos:bestThisSeason.runner2.pos}
            ],
            brothersTotal:bestThisSeason.combined
          });
        }
      }
      
      if(maxTeamWins===4&&dominantTeam){
        const prevCount=countAllFourWins();
        items.push({text:prevCount===0?'became first club to win all 4 matches':`won all 4 matches ‚Äì only happened ${prevCount} time${prevCount>1?'s':''} before`,club:dominantTeam});
      }else if(maxTeamWins===3&&dominantTeam){
        items.push({text:'won 3 of 4 team races',club:dominantTeam});
      }
      
      const biggestRace=seasonRaces.reduce((max,r)=>(r.finishers||0)>=(max?.finishers||0)?r:max,null);
      if(biggestRace?.finishers>=200){
        const allRacesByFinishers=races.filter(r=>r.finishers&&r.season<=season).sort((a,b)=>b.finishers-a.finishers);
        const rank=allRacesByFinishers.findIndex(r=>r.season===biggestRace.season&&r.match===biggestRace.match)+1;
        if(rank===1){
          items.push({text:`set new league record with ${biggestRace.finishers} finishers`,race:biggestRace,venueName:biggestRace.venue});
        }else{
          const ordinal=rank===2?'2nd':rank===3?'3rd':`${rank}th`;
          if(rank<=10)items.push({text:`was the ${ordinal} biggest turnout on record (${biggestRace.finishers})`,race:biggestRace,venueName:biggestRace.venue});
        }
      }
      
      if(standings.length>=2&&standings[1].club){
        const runnerUp=standings[1].club;
        const prevSeason=data.seasons[data.seasons.indexOf(season)+1];
        const prevChamp=prevSeason&&allSeasonsData[prevSeason]?.standings?.[0]?.club;
        if(prevChamp===runnerUp)items.push({text:'were defending champions but finished 2nd',club:runnerUp});
      }
      
      // 2022/23 league expansion - only one team relegated
      if(season==='2022/23'){
        items.push({text:'League expanded to 10 teams ‚Äì only one team relegated this season'});
      }
      
      // 2007/08 notable debut
      if(season==='2007/08'){
        items.push({text:'made his league debut at just 17, finishing 11th at M2',athlete:{name:'Nick Goolab',club:'BEL'}});
      }
      
      // 2000/01 - Sam Haughian's final SL appearance
      if(season==='2000/01'){
        items.push({text:'Final SL appearance of 3-time race winner Sam Haughian who died in a car crash in South Africa in 2004, while training for the Olympics',link:'https://worldathletics.org/news/news/car-crash-robs-europe-of-rising-distance-star'});
      }
      
      // 2004/05 - AFD's final season
      if(season==='2004/05'){
        items.push({text:`competed in their final Surrey League season before joining the Hampshire League`,club:'AFD'});
      }
      
      // 2005/06 - league contracted to 8 teams
      if(season==='2005/06'){
        items.push({text:'League dropped to 8 teams after AFD left to join the Hampshire League (not through relegation)'});
      }
      
      // Final day relegation escape (not for 2022/23 which only relegated one team)
      if(season!=='2022/23'&&standings.length>=9){
        const afterM3=standings.map(t=>({
          club:t.club,
          totalM3:(t.m1||0)+(t.m2||0)+(t.m3||0),
          final:standings.findIndex(x=>x.club===t.club)+1
        })).sort((a,b)=>a.totalM3-b.totalM3);
        
        const numT=standings.length;
        const relZone=[numT-1,numT];// Bottom 2 relegated
        
        afterM3.forEach((t,i)=>{
          const posAfterM3=i+1;
          if(relZone.includes(posAfterM3)&&!relZone.includes(t.final)){
            // Check if this is unique in our data
            const otherEscapes=Object.entries(allSeasonsData).filter(([s,sd])=>{
              if(s>=season||s==='2022/23'||!sd.standings||sd.standings.length<9)return false;
              if(sd.standings[0].m4===null||sd.standings[0].m4===undefined)return false;
              const numTeams=sd.standings.length;
              const rz=[numTeams-1,numTeams];
              const after=sd.standings.map(x=>({
                club:x.club,
                tot:(x.m1||0)+(x.m2||0)+(x.m3||0),
                fin:sd.standings.findIndex(y=>y.club===x.club)+1
              })).sort((a,b)=>a.tot-b.tot);
              return after.some((x,idx)=>rz.includes(idx+1)&&!rz.includes(x.fin));
            });
            const isFirst=otherEscapes.length===0;
            items.push({text:isFirst?'escaped relegation on the final day ‚Äì the only time in league history':'escaped relegation on the final day',club:t.club});
          }
        });
      }
      
      // First/last appearances
      standings.forEach(team=>{
        if(items.length>=5)return;
        const firstSeason=findFirstInDiv1(team.club);
        const nextSeason=findNextInDiv1(team.club);
        
        // First season in Div 1 (in our data)
        if(firstSeason===season){
          items.push({text:`made their first Div 1 appearance in our records`,club:team.club});
        }
        
        // Last season in Div 1 (in our data)
        if(!nextSeason&&firstSeason!==season){
          items.push({textBefore:`This is the last season `,club:team.club,text:` appear in Div 1 in our records`});
        }
      });
    }
    
    return items.slice(0,5);
  },[season,seasonData,races,standings,allSeasonsData,isComplete,data]);
  
  if(!insights.length&&!seasonData?.punditry&&season!=='1962/63')return null;
  // Special historian note for first season
  if(season==='1962/63'){
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">üìñ Alan Mead üñãÔ∏è</span>The league's first season attracted some fine talent. Belgrave provided three individual winners, but the best race of the series came in Match 3 where, over a snow-covered course, the Bels' <span className="inline-block align-middle mr-0.5"><ClubShield club="BEL" size={12}/></span><span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'Gerry North',club:'BEL'}})}>Gerry North</span> and Surrey's <span className="inline-block align-middle mr-0.5"><ClubShield club="SUR" size={12}/></span><span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'John Snowden',club:'SUR'}})}>John Snowden</span> had a battle royal; the latter eventually gained victory by a single second in the last stride or two. Both were nearly 90 seconds clear of the field. The solid Walton AC team became the first league winners.</p>
    </div>;
  }
  // Special historian note for second season
  if(season==='1963/64'){
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">üìñ Alan Mead üñãÔ∏è</span>A 50-strong <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'BEL'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="BEL" size={12}/></span>Belgrave</span> team took a commanding lead in match 1, and hopes were high for a league win. But <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'WAL'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="WAL" size={12}/></span>Walton AC</span> came back strongly to take the next two matches and although their margin was still only 39 points going into the final race, the Bels could not rise to the task of pulling them back. The individual winner was again <span className="inline-block align-middle mr-0.5"><ClubShield club="WAL" size={12}/></span><span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'Bob Roath',club:'WAL'}})}>Bob Roath</span> with 16 pts.</p>
    </div>;
  }
  // Special historian note for third season
  if(season==='1964/65'){
    const match3=races.find(r=>r.season==='1964/65'&&r.match===3);
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">üìñ Alan Mead üñãÔ∏è</span>The number of teams rose to seven as <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'CRO'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="CRO" size={12}/></span>Croydon Harriers</span> joined the Surrey League. <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'WAL'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="WAL" size={12}/></span>Walton</span> had high hopes for a league hat-trick but crashed badly in Race 2 when they were unable to field a complete team. <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'BEL'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="BEL" size={12}/></span>Belgrave</span> prevailed in the opening two runs before they also turned out a weak {match3?<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'race',race:match3})}>Match 3</span>:'Match 3'} team, which was further hamstrung when some missed the start. This allowed <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'H/W'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="H/W" size={12}/></span>Hercules</span> to take the advantage, overturning a huge points deficit. Even a record low score from Belgrave in the final race was not enough to stop their local rivals from hanging on for the win. That last race saw Tokyo Olympic 5,000m runner <span className="inline-block align-middle mr-0.5"><ClubShield club="MIT" size={12}/></span><span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'Bengt Nadje',club:'MIT'}})}>Bengt Nadje</span> of Sweden become the league's first overseas race victor.</p>
    </div>;
  }
  // Special historian note for 1972/73 - AFD's first title
  if(season==='1972/73'){
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">üìñ Alan Mead üñãÔ∏è</span>It had been hoped that the arrival of <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'AFD'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="AFD" size={12}/></span>Aldershot Farnham & District</span> would inject some excitement into a competition that had become a bit of a procession in the previous seven years. They certainly did! Despite <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'AFD'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="AFD" size={12}/></span>AFD</span> winning two of the first three fixtures, it was the Bels going into the final race with a slim lead of 18 points; but over a Coulsdon course patchy with snow, the west Surrey men were not to be denied and took their first league title. But it was a fairly close thing, just 12 points separating them from the Bels in second spot. The individual winner was <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'Bob Gevers',club:'SLH'}})}><span className="inline-block align-middle mr-0.5"><ClubShield club="SLH" size={12}/></span>Bob Gevers</span> (<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'SLH'})}>South London Harriers</span>).</p>
    </div>;
  }
  // If we have stored punditry for historical seasons, show it
  if(seasonData?.punditry&&insights.length===0){
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">Autopundit üó£Ô∏è</span>{seasonData.punditry}</p>
    </div>;
  }
  return<div className="mt-4">
    <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">Autopundit üó£Ô∏è</span>{insights.map((item,i)=><React.Fragment key={i}>{i>0&&<span className="mx-1.5 text-gray-300">¬∑</span>}{item.textBefore}{item.club&&!item.brothers&&!item.textBefore&&<span className="text-[#0077b6] hover:underline cursor-pointer whitespace-nowrap" onClick={()=>setView({type:'club',club:item.club})}><span className="inline-block align-middle mr-0.5"><ClubShield club={item.club} size={12}/></span>{item.club}</span>}{item.textBefore&&item.club&&<span className="text-[#0077b6] hover:underline cursor-pointer whitespace-nowrap" onClick={()=>setView({type:'club',club:item.club})}><span className="inline-block align-middle mr-0.5"><ClubShield club={item.club} size={12}/></span>{item.club}</span>}{item.athlete&&<span className="text-[#0077b6] hover:underline cursor-pointer whitespace-nowrap" onClick={()=>setView({type:'athlete',athlete:item.athlete})}><span className="inline-block align-middle mr-0.5"><ClubShield club={item.athlete.club} size={12}/></span>{item.athlete.name}</span>}{item.venueName&&!item.brothers&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'race',race:item.race})}>{item.venueName}</span>}{(item.club||item.athlete||item.venueName)&&!item.brothers&&!item.textBefore?' ':''}{item.brothers&&<>{item.text} <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:item.brothers[0].name,club:item.brothers[0].club}})}>{item.brothers[0].name}</span> ({item.brothers[0].pos}) + <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:item.brothers[1].name,club:item.brothers[1].club}})}>{item.brothers[1].name}</span> ({item.brothers[1].pos}) = {item.brothersTotal} pts</>}{!item.brothers&&item.text}{item.link&&<a href={item.link} target="_blank" rel="noopener noreferrer" className="inline-block align-middle ml-1 text-gray-400 hover:text-[#0077b6]"><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>}{item.linkSeason&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setSeason(item.linkSeason)}> {item.linkSeason}</span>}.</React.Fragment>)}</p>
  </div>;
};

const HomeView=({setView,data,initialSeason,division='men',divisionConfig})=>{
  const[season,setSeasonState]=useState(initialSeason&&data.seasons.includes(initialSeason)?initialSeason:data.seasons[0]);
  useEffect(()=>{if(initialSeason&&data.seasons.includes(initialSeason))setSeasonState(initialSeason);},[initialSeason]);
  const setSeason=(s)=>{setSeasonState(s);setView({type:'home',urlSeason:s});};
  const seasonData=data.seasonsData[season];const topWinners=[...data.athletes].sort((a,b)=>b.wins-a.wins).filter(a=>a.wins>0).slice(0,5);
  const findRace=(num)=>data.races.find(r=>r.season===season&&r.match===num);
  
  // Build matches from either seasonData.matches OR from race data
  const seasonRaces=data.races.filter(r=>r.season===season);
  const buildMatchesFromRaces=()=>seasonRaces.map(r=>({
    num:r.match,
    date:r.date||'',
    venue:r.venue,
    winner:r.winner,
    winnerClub:r.winnerClub,
    teamWinner:r.teamWinner
  })).sort((a,b)=>a.num-b.num);
  const matches=seasonData?.matches?.length>0?seasonData.matches:buildMatchesFromRaces();
  
  // Build standings from either seasonData.standings OR from race teamScores
  const buildStandingsFromRaces=()=>{
    const clubTotals={};
    const clubMatchScores={};
    seasonRaces.forEach(r=>{
      if(!r.teamScores)return;
      r.teamScores.forEach(ts=>{
        if(!clubTotals[ts.club]){clubTotals[ts.club]=0;clubMatchScores[ts.club]={};}
        clubTotals[ts.club]+=ts.score;
        clubMatchScores[ts.club][`m${r.match}`]=ts.score;
      });
    });
    return Object.entries(clubTotals).map(([club,total])=>({
      club,total,pos:0,...clubMatchScores[club]
    })).sort((a,b)=>a.total-b.total).map((t,i)=>({...t,pos:i+1}));
  };
  
  // HISTORICAL RECORDS RULE: For seasons before 2013/14, the stored standings from 
  // historical documents are authoritative and must not be overwritten by calculations.
  // We can't rewrite history - if a document says AFD won with 684 points, that's fact.
  // Only compute standings from race data for modern seasons (2013/14 onwards) where
  // we have complete verified results.
  const seasonYear=parseInt(season?.split('/')[0]||'2020');
  const isPreModernEra=seasonYear<2013;
  const hasAuthoritativeStandings=seasonData?.standings?.length>0&&seasonData.standings.some(s=>s.total>0);
  
  // Use stored standings if: (a) pre-modern era with authoritative data, OR (b) any season with stored standings
  // Only fall back to calculation for modern seasons without stored standings
  const standings=(isPreModernEra&&hasAuthoritativeStandings)?seasonData.standings:
    (seasonData?.standings?.length>0?seasonData.standings:buildStandingsFromRaces());
  
  // Season is complete if all 4 races have >100 results each
  const racesWithResults=seasonRaces.filter(r=>r.results&&r.results.length>100);
  const isCurrentSeason=season===data.seasons[0];
  const hasCompleteResults=isCurrentSeason?racesWithResults.length===seasonRaces.filter(r=>r.results?.length>0).length:racesWithResults.length===4;
  // Historical if flagged or has only partial data (races with few results)
  const isHistorical=seasonData?.historical||(!hasCompleteResults&&seasonRaces.every(r=>!r.results||r.results.length<=10));
  // Complete if we have full results, or if historical with a champion
  const isComplete=hasCompleteResults||(isHistorical&&seasonData?.champion);
  // Season is finished (for trophy) only if all 4 matches completed OR historical with champion
  const isSeasonFinished=(racesWithResults.length===4)||(isHistorical&&seasonData?.champion);
  // Show relegation zone for complete seasons with full standings
  const numTeams=standings.length;
  const showRelegation=numTeams>=9&&isComplete;
  // Relegation line position - can be overridden in seasonsData for historical seasons
  const relegationSpots=divisionConfig?.relegationSpots||2;
  const relegationLineAfter=seasonData?.relegationLineAfter!=null?seasonData.relegationLineAfter:(numTeams-1-relegationSpots);
  // Row height alignment - women's table needs tighter spacing due to more teams
  const leftRowPy=division==='women'?'py-[5px]':(numTeams>=10?'py-[7px]':'py-[9px]');
  const rightRowPy='py-[5px]';
  // Division-specific labels
  const individualLabel=division==='women'?'Individual':'Mitchell Cup';
  const teamSize=divisionConfig?.teamSize?.a||10;
  
  const KnownStandingsTable=({knownStandings,setView})=><div>
    <table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th colSpan="3" className="text-left py-[9px] pr-2 text-xs text-gray-500 uppercase">Division 1</th><th className="text-right py-[9px] pr-1 text-xs text-gray-500 uppercase">Tot</th></tr></thead><tbody>{knownStandings.map((team,i)=><tr key={team.club} className="hover:bg-gray-50 border-b border-gray-100"><td className="py-[9px] pr-1 w-6"><span className={`${i===0?'font-bold':'text-gray-600'}`}>{i===0?'üèÜ':team.pos}</span></td><td className="py-[9px] pr-1 w-5"><ClubShield club={team.club} size={16}/></td><td className="py-[9px] pr-2 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:team.club})}><ClubName club={team.club} className={`${i===0?'font-semibold':''}`}/></td><td className="text-right py-[9px] pr-1"><span className={`tabular-nums ${i===0?'font-bold text-[#0077b6]':'font-semibold'}`}>{team.pts}</span></td></tr>)}</tbody></table>
    <p className="text-xs text-gray-400 mt-2 italic">* Final standings from archived results.</p>
  </div>;
  
  const StandingsTable=()=>{
    if(seasonData?.knownStandings)return<KnownStandingsTable knownStandings={seasonData.knownStandings} setView={setView}/>;
    // Determine which match columns to show
    const matchNums=matches.length>0?matches.map(m=>m.num):[1,2,3,4].filter(n=>standings[0]?.[`m${n}`]!=null);
    return<div>
    <table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th colSpan="3" className={`text-left ${leftRowPy} pr-2 text-xs text-gray-500 uppercase`}>Division 1</th><th className={`text-right ${leftRowPy} pr-1 text-xs text-gray-500 uppercase`} title="Total of a team's scores across all matches">Tot</th>{matchNums.map((n,i)=>{const race=findRace(n);return<th key={i} className={`text-right ${leftRowPy} px-0.5 w-9 text-xs text-gray-500 uppercase ${race?'cursor-pointer hover:text-[#0077b6]':''}`} title={`Team score in match ${n}`} onClick={()=>race&&setView({type:'race',race})}>M{n}</th>})}</tr></thead><tbody>{standings.map((team,i)=><tr key={team.club} className={`hover:bg-gray-50 ${showRelegation&&i===relegationLineAfter?'border-b border-dotted border-gray-300':'border-b border-gray-100'}`}><td className={`${leftRowPy} pr-1 w-6`}><div className="flex items-center"><span className={`${i===0?'font-bold':'text-gray-600'}`}>{i===0&&(season==='2025/26'?isSeasonFinished:isComplete)?'üèÜ':team.pos}</span><PositionChange change={team.change}/></div></td><td className={`${leftRowPy} pr-1 w-5`}><ClubShield club={team.club} size={16}/></td><td className={`${leftRowPy} pr-2 cursor-pointer hover:text-[#0077b6]`} onClick={()=>setView({type:'club',club:team.club})}><ClubName club={team.club} className={`${i===0?'font-semibold':''}`}/></td><td className={`text-right ${leftRowPy} pr-1`}><span className={`tabular-nums ${i===0?'font-bold text-[#0077b6]':'font-semibold'}`}>{team.total}</span></td>{matchNums.map((n,mi)=><td key={mi} className={`text-right ${leftRowPy} px-0.5`}><span className="text-gray-600 tabular-nums">{team[`m${n}`]||'-'}</span></td>)}</tr>)}</tbody></table>
    {isHistorical&&<p className="text-xs text-gray-400 mt-2 italic">* Only partial results in for this season. <span className="underline cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'submit'})}>Submit results</span>.</p>}
  </div>;};
  
  const FixturesTable=()=><div>
    <table className="w-full text-sm">
      <thead><tr className="border-b border-gray-200">
        <th colSpan="2" className={`text-left ${rightRowPy} pr-2 text-xs text-gray-500 uppercase`}>Matches</th>
        <th className={`text-left ${rightRowPy} px-2 text-xs text-gray-500 uppercase`}>Winner</th>
        <th className={`text-right ${rightRowPy} pl-2 text-xs text-gray-500 uppercase`}>Team</th>
      </tr></thead>
      <tbody className="divide-y divide-gray-100">{matches.map(match=>{
        const race=findRace(match.num);const upcoming=!match.winner;
        return<tr key={match.num} className={`${upcoming?'opacity-50':'hover:bg-blue-50 cursor-pointer'}`} onClick={()=>!upcoming&&race&&setView({type:'race',race})}>
          <td className={`${rightRowPy} pr-2 text-gray-500 whitespace-nowrap w-14`}>{match.date?.length<=3?match.date:formatDateShort(match.date)}</td>
          <td className={`${rightRowPy} px-2 text-gray-900`}>{match.venue}</td>
          <td className={`${rightRowPy} px-2`}>{upcoming?<span className="text-gray-400 italic">-</span>:<div className="flex items-center gap-1.5"><ClubShield club={match.winnerClub} size={14}/><span className="text-gray-700"><span className="hidden md:inline">{match.winner}</span><span className="md:hidden">{getSurname(match.winner)}</span></span></div>}</td>
          <td className={`${rightRowPy} pl-2 text-right`}>{!upcoming&&match.teamWinner?<div className="inline-flex items-center gap-1.5"><ClubShield club={match.teamWinner} size={14}/><span className="font-medium">{match.teamWinner}</span></div>:'-'}</td>
        </tr>;
      })}</tbody>
    </table>
  </div>;
  
  const IndividualsTable=()=>{
    // For historical seasons, check if we have individualRankings with positions first
    if(isHistorical){
      const indRankings=seasonData?.individualRankings;
      // If we have individualRankings with positions array, show the full breakdown
      if(indRankings?.length>0&&indRankings[0]?.positions){
        const numRaces=indRankings[0].positions.length;
        return<div className="mt-3">
          <table className="w-full text-sm">
            <thead><tr className="border-b border-gray-200">
              <th colSpan="2" className={`text-left ${rightRowPy} pr-2 text-xs text-gray-500 uppercase`} title={division==='women'?"Individual champion":"The Mitchell Cup - Individual champion"}>{individualLabel}</th>
              <th className={`text-right ${rightRowPy} px-1 text-xs text-gray-500 uppercase w-10`} title={division==='women'?"Sum of best 3 finishing positions":"Sum of finishing positions across all races"}>Tot</th>
              {[1,2,3,4].slice(0,numRaces).map(n=><th key={n} className={`text-right ${rightRowPy} px-1 text-xs text-gray-300 uppercase w-8`}></th>)}
            </tr></thead>
            <tbody className="divide-y divide-gray-100">{indRankings.slice(0,5).map((a,i)=>
              <tr key={a.name} className="hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}>
                <td className={`${rightRowPy} pr-2 text-gray-400 w-6`}>{i+1}</td>
                <td className={`${rightRowPy} px-2`}><div className="flex items-center gap-1.5"><ClubShield club={a.club} size={14}/><span className="text-gray-700">{a.name}</span></div></td>
                <td className={`${rightRowPy} px-1 text-right font-medium tabular-nums w-10`}>{a.total}</td>
                {a.positions.map((pos,pi)=><td key={pi} className={`${rightRowPy} px-1 text-right text-gray-400 text-xs tabular-nums w-8`}>{pos}</td>)}
              </tr>
            )}</tbody>
          </table>
        </div>;
      }
      // Fall back to mitchellCupWinners (just names, no positions)
      const mitchellWinners=data.mitchellCupWinners?.[season];
      if(!mitchellWinners||mitchellWinners.length===0)return null;
      const isJoint=mitchellWinners.length>1;
      return<div className="mt-3">
        <table className="w-full text-sm">
          <thead><tr className="border-b border-gray-200">
            <th colSpan="3" className={`text-left ${rightRowPy} pr-2 text-xs text-gray-500 uppercase`} title={division==='women'?"Individual champion":"The Mitchell Cup - Individual champion"}>{individualLabel}</th>
          </tr></thead>
          <tbody className="divide-y divide-gray-100">
            {mitchellWinners.map((w,i)=><tr key={i} className="hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:w.name,club:w.club}})}>
              <td className={`${rightRowPy} pr-2 text-gray-400 w-6`}>{isJoint?'=':(i+1)}</td>
              <td className={`${rightRowPy} px-2`}><div className="flex items-center gap-1.5"><ClubShield club={w.club} size={14}/><span className="text-gray-700">{w.name}</span></div></td>
              <td className={`${rightRowPy} px-1 text-right text-gray-400 text-xs`}></td>
            </tr>)}
          </tbody>
        </table>
      </div>;
    }
    const seasonRacesLocal=data.races.filter(r=>r.season===season&&r.results);
    const numRaces=seasonRacesLocal.length;
    if(numRaces===0)return null;
    const athleteResults={};
    seasonRacesLocal.forEach(r=>{
      r.results.forEach(res=>{
        const key=res.name;
        if(!athleteResults[key])athleteResults[key]={name:res.name,club:res.club,runs:[],total:0};
        athleteResults[key].runs.push({match:r.match,pos:res.pos});
      });
    });
    // Women: best 3 of 4, Men: must complete all 4
    const minRaces=division==='women'?3:numRaces;
    const eligible=Object.values(athleteResults).filter(a=>a.runs.length>=minRaces).map(a=>{
      a.runs.sort((x,y)=>x.match-y.match);
      if(division==='women'&&a.runs.length>=3){
        // Best 3 of 4 for women
        const sortedPositions=[...a.runs].sort((x,y)=>x.pos-y.pos);
        a.total=sortedPositions.slice(0,3).reduce((sum,r)=>sum+r.pos,0);
      }else{
        a.total=a.runs.reduce((sum,r)=>sum+r.pos,0);
      }
      return a;
    }).sort((a,b)=>a.total-b.total).slice(0,5);
    if(eligible.length===0)return null;
    return<div className="mt-3">
      <table className="w-full text-sm">
        <thead><tr className="border-b border-gray-200">
          <th colSpan="2" className={`text-left ${rightRowPy} pr-2 text-xs text-gray-500 uppercase`} title={division==='women'?"Top 5 athletes with 3+ races, ranked by best 3 positions":"Top 5 athletes who raced in all matches, ranked by sum of positions (lowest is best)"}>{individualLabel}</th>
          <th className={`text-right ${rightRowPy} px-1 text-xs text-gray-500 uppercase w-10`} title={division==='women'?"Sum of best 3 finishing positions":"Sum of finishing positions across all races"}>Tot</th>
          {[1,2,3,4].slice(0,numRaces).map(n=><th key={n} className={`text-right ${rightRowPy} px-1 text-xs text-gray-300 uppercase w-8`}></th>)}
        </tr></thead>
        <tbody className="divide-y divide-gray-100">{eligible.map((a,i)=>
          <tr key={a.name} className="hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}>
            <td className={`${rightRowPy} pr-2 text-gray-400 w-6`}>{i+1}</td>
            <td className={`${rightRowPy} px-2`}><div className="flex items-center gap-1.5"><ClubShield club={a.club} size={14}/><span className="text-gray-700">{a.name}</span></div></td>
            <td className={`${rightRowPy} px-1 text-right font-medium tabular-nums w-10`}>{a.total}</td>
            {a.runs.map((r,ri)=><td key={ri} className={`${rightRowPy} px-1 text-right text-gray-400 text-xs tabular-nums w-8`}>{r.pos}</td>)}
          </tr>
        )}</tbody>
      </table>
    </div>;
  };
  
  const allTimeRef=React.useRef(null);
  
  return<div className="max-w-5xl mx-auto px-4 py-8">
    {seasonData?<div className="mb-8">
      <div className="flex items-center gap-2 mb-4"><SeasonSelector season={season} setSeason={setSeason} seasons={data.seasons}/></div>
      <div className="grid md:grid-cols-2 gap-8 items-start">
        <div className="overflow-hidden"><StandingsTable/></div>
        <div><FixturesTable/><IndividualsTable/>{division==='women'&&<SeasonAnalysis season={season} seasonData={seasonData} races={data.races} standings={standings} allSeasonsData={data.seasonsData} isComplete={isComplete} data={data} setView={setView} setSeason={setSeason}/>}</div>
      </div>
      {division!=='women'&&<SeasonAnalysis season={season} seasonData={seasonData} races={data.races} standings={standings} allSeasonsData={data.seasonsData} isComplete={isComplete} data={data} setView={setView} setSeason={setSeason}/>}
    </div>:<p className="text-sm text-gray-500 mb-10">No data</p>}
    
    <div ref={allTimeRef} className="flex items-center justify-center gap-0 mt-6 mb-2">
      <div className="flex-1 h-px bg-gray-200"></div>
      <svg width="40" height="25" viewBox="0 0 523.87 325.06" fill="none" className="mx-3 flex-shrink-0">
        <path fill="#d1d5db" d="M512.63,53.09c-1.82,1.1-3.56,2.3-5.31,3.6-1.77,1.3-3.49,2.72-5.16,4.28-3.36,3.12-6.32,6.83-9.33,11.28-1.29,1.96-2.52,4.08-3.69,6.37.66-3.22,1.29-6.24,1.86-9.04.15-.74.3-1.46.44-2.16.12-.71.23-1.4.35-2.08.23-1.36.44-2.65.65-3.88.33-1.95.62-3.73.89-5.34.3-.45.6-.9.88-1.34.86-1.39,1.59-2.78,2.29-4.16,1.39-2.76,2.54-5.47,3.47-8.14.92-2.67,1.47-5.31,1.93-7.88.42-2.58.7-5.09.74-7.56-.03-4.94-.62-9.64-1.73-14.14-1.21-4.5-2.82-8.78-4.61-12.9-1.94,4.12-3.71,8.27-5.08,12.56-1.48,4.28-2.68,8.7-3.22,13.4-.32,2.35-.58,4.76-.61,7.27-.07,2.5.12,5.11.35,7.82.22,2.71.64,5.54,1.27,8.51.31,1.49.7,3.02,1.09,4.58.12.51.26,1.02.39,1.54-.28,1.58-.58,3.32-.92,5.22-.81,4.76-1.93,10.51-3.44,17.04-.15-2.56-.42-4.98-.82-7.23-.84-5.12-2.67-9.55-4.77-13.36-1.07-1.91-2.25-3.67-3.51-5.3-1.29-1.64-2.72-3.17-4.19-4.58-2.95-2.84-6.16-5.28-9.48-7.5.1,2.02.24,4.04.46,6.07.22,2.02.53,4.05.81,6.06.61,4.02,1.71,8.06,3.27,12.07,1.51,4.01,3.63,8.02,6.58,12.08,2.53,3.52,5.59,7.05,9.46,10.62-1.13,4.33-2.4,8.91-3.86,13.71-1.81,5.94-3.89,12.2-6.29,18.68.07-.78.12-1.56.13-2.32.02-1.39-.02-2.74-.09-4.05-.31-5.23-1.26-9.76-3-13.84-1.67-4.06-3.85-7.59-6.35-10.76-2.57-3.18-5.5-6.01-8.53-8.64-.14,2.01-.21,4.04-.23,6.07-.09,2.01-.11,4.03-.03,6.06.08,2.03.27,4.08.57,6.15.27,2.05.6,4.1,1.12,6.19,2.01,7.77,5.67,15.72,12.83,24.38-3.38,8.35-7.28,16.96-11.76,25.63-.84,1.54-1.69,3.11-2.54,4.66.41-1.97.72-3.87.91-5.7.4-5.23-.06-9.91-1.07-14.11-1.08-4.23-2.85-8.06-4.93-11.53-2.11-3.49-4.49-6.6-7.22-9.63l-.27,1.49-.31,1.46c-.2.98-.38,1.96-.54,2.95-.33,1.98-.59,3.97-.75,6-.12,2.05-.33,4.03-.33,6.09-.02,2.05.08,4.14.33,6.28.12,1.07.3,2.16.47,3.24.16,1.07.37,2.16.61,3.26.49,2.2,1.16,4.47,2.02,6.8.85,2.33,1.93,4.75,3.16,7.21.83,1.69,1.78,3.41,2.83,5.18-.08.14-.17.28-.25.42-1.41,2.33-2.83,4.68-4.25,7.05-1.5,2.32-3.06,4.61-4.6,6.93-.77,1.16-1.55,2.32-2.32,3.48-.78,1.16-1.65,2.26-2.47,3.4-1.47,1.99-2.95,4-4.43,6,.12-.34.23-.67.34-1,.43-1.32.81-2.61,1.12-3.87.63-2.53,1.07-4.93,1.24-7.26.14-2.37.08-4.63-.13-6.8-.77-8.61-4.53-15.99-8.9-22.62-.68,1.85-1.33,3.73-1.9,5.64l-.83,2.88c-.29.94-.56,1.9-.81,2.86-.5,1.93-.9,3.9-1.19,5.94-.15,1.01-.26,2.05-.36,3.09-.12,1.02-.21,2.05-.27,3.1-.12,2.11-.1,4.29.08,6.55.16,2.26.55,4.66.96,7.04.74,4,1.98,8.3,3.81,12.95l-1.78,2.18c-.93,1.07-1.9,2.11-2.84,3.16l-5.7,6.31c-2.01,2-4.01,4-6.02,6-1.01.99-1.99,2.01-3.01,2.98l-2.99,2.68c.76-1.32,1.46-2.62,2.07-3.89,2.06-4.83,3.14-9.36,3.52-13.63.25-4.39-.21-8.51-1.12-12.42-.46-1.96-1.03-3.86-1.69-5.72-.69-1.89-1.48-3.76-2.31-5.58l-1.37,2.6c-.48.84-.95,1.69-1.4,2.56-.9,1.73-1.75,3.5-2.51,5.33-.39.91-.73,1.87-1.1,2.78-.38.91-.73,1.84-1.06,2.79-.66,1.9-1.21,3.88-1.65,5.95-.22,1.04-.41,2.1-.56,3.19-.18,1.06-.35,2.13-.47,3.24-.25,2.22-.36,4.55-.32,7.03.03,2.47.25,5.11.58,7.84.2,1.72.47,3.51.81,5.37-1.47,1.18-2.94,2.36-4.4,3.53-1.09.85-2.14,1.77-3.27,2.57-1.12.8-2.25,1.6-3.37,2.4-2.25,1.58-4.44,3.22-6.7,4.73-2.3,1.45-4.58,2.89-6.85,4.32-.44.27-.88.55-1.31.83.83-1.01,1.6-2.02,2.31-3.02,1.51-2.12,2.76-4.21,3.79-6.28.97-2.15,1.71-4.29,2.27-6.39.56-2.1.92-4.16,1.13-6.19.1-1.02.18-2.02.2-3.03,0-1.03-.02-2.06-.07-3.07-.23-4.06-.94-7.99-1.91-11.83-2.49,2.9-4.75,6.11-7.02,9.21-2.23,3.17-4.1,6.8-5.84,10.51-.84,1.9-1.59,3.92-2.23,6.09-.32,1.08-.62,2.2-.88,3.36-.27,1.15-.55,2.27-.78,3.48-.75,3.85-1.19,8.15-1.27,12.97-.7.39-1.41.78-2.11,1.16-2.33,1.11-4.64,2.22-6.93,3.31-2.29,1.08-4.52,2.22-6.84,3.09-2.29.93-4.55,1.84-6.79,2.75-1.12.43-2.21.95-3.34,1.3-.88.3-1.75.59-2.62.88.85-.66,1.68-1.33,2.45-2,3.8-3.59,6.53-7.39,8.52-11.15,1.94-3.88,3.04-7.92,3.66-11.85.61-3.96.74-7.85.51-11.9-1.43,1.29-2.96,2.39-4.41,3.64-1.46,1.23-2.88,2.54-4.25,3.93-1.35,1.45-2.76,2.73-4.07,4.24-1.32,1.48-2.57,3.08-3.77,4.82-.6.86-1.17,1.79-1.75,2.69-.58.89-1.15,1.81-1.69,2.78-1.09,1.93-2.11,4.03-3.05,6.32-.94,2.27-1.78,4.79-2.57,7.42-.47,1.52-.9,3.13-1.3,4.8-.66.18-1.33.36-1.98.53-2.11.57-4.18,1.13-6.2,1.67-1.01.3-2.02.51-3.03.71-1.01.21-2,.41-2.98.61-1.97.4-3.89.8-5.76,1.18-.94.18-1.85.41-2.78.55-.92.13-1.83.26-2.73.39-3.58.51-6.96,1-10.11,1.45-1.23.1-2.41.2-3.57.3-1.74-7.86-8.74-13.74-17.12-13.74s-15.38,5.88-17.12,13.74c-1.16-.1-2.34-.2-3.57-.3-3.15-.45-6.53-.94-10.11-1.45-.9-.13-1.8-.26-2.73-.39-.92-.14-1.84-.36-2.78-.55-1.87-.39-3.79-.78-5.76-1.18-.98-.2-1.98-.41-2.98-.61-1.01-.2-2.03-.41-3.03-.71-2.03-.55-4.09-1.1-6.2-1.67-.65-.18-1.32-.36-1.98-.53-.4-1.67-.83-3.28-1.3-4.8-.78-2.63-1.63-5.15-2.57-7.42-.94-2.29-1.95-4.39-3.05-6.32-.55-.97-1.11-1.89-1.69-2.78-.58-.9-1.15-1.83-1.74-2.69-1.19-1.74-2.45-3.34-3.77-4.82-1.31-1.51-2.72-2.79-4.07-4.24-1.37-1.39-2.79-2.69-4.25-3.93-1.45-1.25-2.98-2.35-4.41-3.64-.24,4.05-.11,7.94.51,11.9.63,3.93,1.73,7.98,3.66,11.85,1.98,3.76,4.72,7.56,8.52,11.15.77.67,1.59,1.34,2.45,2-.87-.29-1.74-.58-2.62-.88-1.14-.35-2.22-.87-3.34-1.3-2.23-.9-4.5-1.82-6.79-2.75-2.32-.87-4.55-2.02-6.84-3.09-2.28-1.09-4.59-2.2-6.93-3.31-.69-.38-1.4-.77-2.1-1.16-.08-4.82-.52-9.12-1.27-12.97-.23-1.2-.51-2.33-.78-3.48-.27-1.16-.56-2.28-.88-3.36-.64-2.17-1.39-4.19-2.23-6.09-1.74-3.71-3.61-7.34-5.84-10.51-2.27-3.11-4.53-6.31-7.02-9.21-.96,3.84-1.68,7.77-1.9,11.83-.06,1.01-.08,2.04-.08,3.07.02,1.01.09,2.01.2,3.03.21,2.03.58,4.09,1.13,6.19.56,2.09,1.29,4.23,2.27,6.39,1.03,2.07,2.28,4.16,3.79,6.28.71,1,1.49,2.01,2.32,3.03-.44-.28-.88-.56-1.32-.84-2.27-1.43-4.55-2.87-6.85-4.32-2.26-1.51-4.45-3.15-6.7-4.73-1.12-.8-2.24-1.6-3.37-2.4-1.13-.79-2.17-1.71-3.27-2.57-1.46-1.17-2.93-2.35-4.39-3.52.34-1.86.61-3.65.81-5.37.33-2.73.54-5.37.58-7.84.04-2.47-.07-4.81-.32-7.03-.12-1.11-.29-2.18-.47-3.24-.16-1.09-.35-2.15-.56-3.19-.44-2.08-.99-4.05-1.65-5.95-.33-.95-.68-1.88-1.05-2.79-.37-.91-.71-1.87-1.1-2.78-.76-1.83-1.61-3.61-2.51-5.33-.45-.86-.92-1.72-1.4-2.56l-1.37-2.6c-.83,1.82-1.62,3.69-2.31,5.58-.66,1.86-1.23,3.77-1.69,5.72-.91,3.91-1.38,8.03-1.12,12.42.37,4.26,1.46,8.8,3.52,13.63.61,1.28,1.31,2.58,2.07,3.9l-3-2.69c-1.02-.97-2.01-1.99-3.01-2.98-2-2-4.01-4-6.02-6l-5.71-6.31c-.95-1.06-1.91-2.09-2.84-3.16l-1.78-2.18c1.82-4.65,3.07-8.95,3.81-12.95.41-2.38.8-4.78.96-7.04.18-2.27.2-4.45.08-6.55-.06-1.05-.15-2.09-.27-3.1-.1-1.03-.21-2.07-.36-3.09-.29-2.03-.7-4.01-1.19-5.94-.25-.96-.52-1.92-.81-2.86l-.83-2.88c-.58-1.91-1.22-3.78-1.9-5.64-4.36,6.63-8.12,14-8.9,22.62-.22,2.17-.27,4.43-.13,6.8.18,2.34.62,4.73,1.24,7.26.32,1.26.69,2.55,1.12,3.87.11.33.22.67.34,1.01-1.48-2.01-2.96-4.01-4.44-6.01-.82-1.14-1.69-2.24-2.47-3.4-.78-1.16-1.55-2.32-2.33-3.48-1.54-2.32-3.11-4.61-4.6-6.93-1.43-2.36-2.84-4.71-4.25-7.05-.08-.14-.17-.28-.25-.41,1.05-1.77,2-3.5,2.83-5.19,1.24-2.46,2.31-4.88,3.16-7.21.86-2.33,1.52-4.6,2.02-6.8.25-1.1.45-2.19.61-3.26.18-1.08.35-2.17.47-3.24.25-2.14.35-4.23.33-6.28,0-2.06-.21-4.04-.33-6.09-.16-2.03-.42-4.03-.75-6-.16-.99-.35-1.97-.54-2.95l-.31-1.46-.27-1.49c-2.73,3.02-5.11,6.14-7.22,9.63-2.07,3.47-3.85,7.29-4.93,11.53-1.01,4.2-1.47,8.88-1.07,14.11.2,1.83.5,3.73.91,5.71-.85-1.56-1.7-3.13-2.54-4.68-4.48-8.67-8.38-17.28-11.76-25.62,7.16-8.66,10.82-16.6,12.83-24.38.52-2.09.85-4.14,1.12-6.19.31-2.07.49-4.11.57-6.15.08-2.03.07-4.05-.03-6.06-.03-2.03-.1-4.06-.23-6.07-3.03,2.62-5.96,5.45-8.53,8.64-2.5,3.16-4.68,6.69-6.35,10.76-1.74,4.08-2.7,8.61-3,13.84-.08,1.31-.11,2.66-.09,4.05,0,.77.06,1.55.13,2.34-2.4-6.48-4.49-12.75-6.3-18.7-1.46-4.79-2.73-9.37-3.86-13.7,3.87-3.58,6.93-7.1,9.46-10.63,2.95-4.05,5.08-8.07,6.58-12.08,1.56-4.02,2.66-8.05,3.27-12.07.28-2.01.59-4.03.81-6.06.22-2.02.36-4.05.46-6.07-3.32,2.23-6.54,4.66-9.49,7.5-1.47,1.42-2.9,2.94-4.19,4.58-1.27,1.64-2.45,3.4-3.51,5.3-2.11,3.81-3.93,8.24-4.77,13.36-.4,2.26-.68,4.68-.82,7.25-1.51-6.54-2.63-12.29-3.44-17.06-.34-1.91-.64-3.64-.92-5.22.13-.52.27-1.04.39-1.54.39-1.56.79-3.09,1.09-4.58.63-2.98,1.05-5.81,1.27-8.51.23-2.71.42-5.32.35-7.82-.04-2.51-.29-4.92-.61-7.27-.54-4.7-1.74-9.12-3.22-13.4-1.38-4.29-3.14-8.44-5.09-12.56-1.79,4.12-3.4,8.41-4.6,12.9-1.11,4.49-1.7,9.2-1.73,14.14.04,2.47.32,4.98.74,7.56.45,2.57,1.01,5.21,1.92,7.88.93,2.67,2.08,5.39,3.47,8.14.7,1.38,1.43,2.77,2.29,4.16.28.44.58.89.87,1.34.27,1.61.57,3.39.89,5.35.21,1.23.42,2.52.65,3.88.11.68.23,1.37.35,2.08.14.71.29,1.43.44,2.16.58,2.79,1.2,5.81,1.86,9.02-1.17-2.28-2.4-4.4-3.69-6.36-3.01-4.44-5.97-8.16-9.33-11.28-1.66-1.56-3.39-2.98-5.16-4.28-1.75-1.31-3.49-2.5-5.31-3.6-3.62-2.2-7.39-4.04-11.24-5.73.67,2.3,1.39,4.58,2.17,6.82.78,2.24,1.62,4.44,2.68,6.56,2.07,4.26,4.42,8.3,7.48,11.92,3.11,3.61,6.76,6.83,11.13,9.48,3.84,2.3,8.32,4.15,13.4,5.48.18.74.37,1.49.55,2.24.87,3.8,2.09,7.72,3.26,11.84,1.78,6.03,3.84,12.39,6.21,18.97-.53-.71-1.07-1.41-1.57-2.1-.83-1.12-1.68-2.19-2.54-3.2-3.43-4.06-7.13-7.28-10.72-9.99-3.66-2.69-7.49-4.78-11.42-6.5-3.87-1.73-7.8-3.1-11.82-4.3.94,2.21,1.9,4.4,2.95,6.53,1.12,2.12,2.3,4.18,3.57,6.18s2.62,3.92,4.07,5.76c1.5,1.82,3.16,3.54,4.91,5.14,6.42,6,14.99,10.23,26.03,11.65,3.38,8.57,7.3,17.43,11.84,26.35.78,1.46,1.56,2.94,2.35,4.41-1.43-1.45-2.87-2.79-4.32-4.03-3.94-3.55-7.92-6.3-12.01-8.43-4.02-2.16-8.01-3.76-12.13-4.95-4.08-1.2-8.32-1.99-12.39-2.68l.9,1.56.98,1.53c.66,1.01,1.34,2.01,2.02,3,1.38,1.97,2.8,3.88,4.31,5.71,1.47,1.84,3.19,3.53,4.92,5.15,1.75,1.61,3.59,3.11,5.53,4.48.97.68,1.96,1.34,3,1.94,1.06.59,2.15,1.15,3.27,1.67,2.24,1.04,4.59,1.91,7.07,2.6,2.49.68,5.08,1.19,7.87,1.45,1.94.17,3.95.23,6.03.19.16.26.31.53.47.79,1.41,2.39,2.83,4.79,4.26,7.21,1.54,2.35,3.08,4.71,4.64,7.08.78,1.19,1.55,2.37,2.34,3.56.83,1.15,1.67,2.31,2.51,3.47,1.39,1.92,2.78,3.84,4.18,5.77-.29-.22-.59-.44-.87-.65-1.13-.82-2.27-1.59-3.39-2.3-2.25-1.43-4.52-2.64-6.72-3.71-2.16-1.1-4.32-2.02-6.47-2.79-8.72-3.02-17-3.86-25.47-3.97,1.55,1.89,3.13,3.74,4.76,5.52.83.89,1.62,1.78,2.5,2.61.88.83,1.78,1.64,2.69,2.43,1.82,1.57,3.7,3.06,5.65,4.41.98.68,1.96,1.33,2.99,1.94,1.05.59,2.12,1.15,3.22,1.66,2.18,1.04,4.44,1.92,6.79,2.62,2.36.69,4.74,1.25,7.38,1.49,4.33.43,8.92.27,13.8-.6l2.13,2.65,2.88,3.24c1.93,2.16,3.82,4.35,5.78,6.47,2.03,2.06,4.06,4.12,6.09,6.18,1.03,1.01,1.99,2.09,3.07,3.05l2.6,2.37c-1.42-.65-2.82-1.25-4.2-1.78-4.87-2.1-9.56-3.41-14.16-4.13-4.47-.84-8.83-1.09-13.14-.97-2.16.06-4.3.22-6.43.43-2.1.19-4.17.44-6.25.73.91.83,1.81,1.66,2.76,2.44.97.77,1.94,1.53,2.92,2.26,1.97,1.48,3.96,2.87,6,4.17,1.03.64,2.03,1.28,3.11,1.84,1.08.56,2.18,1.08,3.28,1.58,2.21.99,4.47,1.84,6.78,2.52,1.15.34,2.32.64,3.5.9,1.21.23,2.44.4,3.68.52,2.48.25,5.01.3,7.59.13,2.59-.18,5.2-.56,7.92-1.26,1.75-.46,3.52-1.04,5.31-1.72,3.86,3.16,7.65,6.36,11.7,9.15,1.14.83,2.27,1.65,3.4,2.48,1.14.82,2.24,1.67,3.43,2.4,2.34,1.51,4.66,3,6.97,4.48.26.18.53.34.79.51-1.27-.33-2.53-.61-3.77-.86-2.63-.51-5.17-.84-7.65-1.01-2.42-.25-4.76-.36-7.07-.32-2.3.04-4.55.22-6.76.5-1.1.14-2.2.32-3.28.51-1.06.17-2.11.36-3.16.57-4.18.86-8.25,2.08-12.28,3.43,4.33,2.53,8.6,4.99,13.28,6.63,4.62,1.69,9.22,3.07,14.16,3.37,2.44.19,4.89.21,7.35.02,1.23-.1,2.46-.24,3.7-.44,1.24-.21,2.52-.54,3.78-.89,4.07-1.16,8.15-2.94,12.21-5.45.91.51,1.81,1.02,2.72,1.5,2.38,1.16,4.74,2.31,7.07,3.45,1.17.57,2.33,1.13,3.48,1.7,1.16.56,2.35,1,3.52,1.5,4.23,1.74,8.32,3.53,12.44,4.93-1.12,0-2.22,0-3.29.05-5.32.01-10.15.59-14.69,1.71-4.49,1.01-8.61,2.37-12.58,4.13-3.96,1.74-7.77,3.84-11.4,5.87,2.32.94,4.77,1.59,7.18,2.23,2.42.63,4.83,1.18,7.24,1.61,2.39.48,4.88.6,7.32.68,2.45.06,4.88-.03,7.28-.29,1.21-.14,2.4-.28,3.6-.55,1.21-.28,2.41-.6,3.61-.97,2.39-.75,4.74-1.69,7.05-2.88,2.31-1.19,4.56-2.56,6.78-4.3,1.31-1.03,2.59-2.17,3.86-3.38.88.24,1.76.48,2.62.73,2.16.6,4.27,1.19,6.34,1.77,2.08.54,4.15.92,6.15,1.37,3,.63,5.87,1.31,8.67,1.8-34.81,6.71-50.9,25.82-50.9,37.54,1.58,2.03,10.58,2.7,14.17,0,2.98-11.93,21.55-30.13,53.7-33.34,1.82,7.76,8.76,13.54,17.07,13.54s15.26-5.78,17.07-13.54c32.15,3.22,50.72,21.41,53.7,33.34,3.6,2.7,12.6,2.03,14.18,0,0-11.72-16.09-30.83-50.9-37.54,2.79-.5,5.67-1.18,8.67-1.8,2-.45,4.07-.83,6.15-1.37,2.07-.58,4.18-1.17,6.34-1.77.86-.25,1.74-.49,2.62-.73,1.27,1.22,2.55,2.35,3.86,3.38,2.22,1.73,4.47,3.1,6.78,4.3,2.31,1.18,4.66,2.13,7.05,2.88,1.2.37,2.4.7,3.61.97,1.21.26,2.39.41,3.6.55,2.41.26,4.84.35,7.29.29,2.43-.08,4.93-.2,7.32-.68,2.41-.43,4.83-.98,7.24-1.61,2.41-.65,4.86-1.3,7.18-2.23-3.63-2.03-7.44-4.13-11.4-5.87-3.97-1.77-8.09-3.12-12.58-4.13-4.54-1.12-9.36-1.7-14.69-1.71-1.08-.04-2.18-.06-3.29-.05,4.12-1.4,8.22-3.19,12.44-4.93,1.17-.5,2.36-.94,3.52-1.5,1.15-.56,2.31-1.13,3.48-1.7,2.33-1.14,4.69-2.29,7.07-3.45.91-.49,1.82-1,2.72-1.51,4.06,2.51,8.14,4.29,12.21,5.45,1.26.35,2.54.68,3.78.89,1.23.2,2.47.35,3.7.44,2.46.19,4.91.17,7.35-.02,4.94-.3,9.54-1.68,14.16-3.37,4.68-1.63,8.95-4.1,13.28-6.63-4.03-1.35-8.1-2.57-12.28-3.43-1.04-.21-2.1-.41-3.16-.57-1.08-.18-2.18-.36-3.28-.51-2.21-.29-4.46-.46-6.76-.5-2.3-.04-4.64.07-7.06.32-2.48.17-5.03.49-7.65,1.01-1.24.24-2.49.53-3.77.86.26-.17.53-.33.79-.51,2.31-1.48,4.63-2.98,6.97-4.48,1.19-.72,2.29-1.58,3.43-2.4,1.13-.82,2.27-1.65,3.4-2.48,4.05-2.79,7.84-5.99,11.7-9.15,1.79.68,3.56,1.26,5.31,1.72,2.72.7,5.34,1.08,7.93,1.26,2.58.18,5.11.12,7.59-.13,1.24-.13,2.47-.3,3.68-.52,1.18-.26,2.35-.56,3.5-.9,2.31-.68,4.56-1.53,6.78-2.52,1.11-.49,2.2-1.02,3.28-1.58,1.08-.56,2.08-1.2,3.11-1.84,2.04-1.3,4.04-2.69,6.01-4.17.98-.74,1.96-1.49,2.92-2.26.95-.79,1.84-1.62,2.76-2.44-2.08-.29-4.15-.54-6.25-.73-2.13-.22-4.27-.37-6.43-.43-4.31-.13-8.67.13-13.14.97-4.59.72-9.29,2.03-14.16,4.13-1.39.53-2.79,1.12-4.21,1.78l2.6-2.38c1.08-.96,2.04-2.04,3.07-3.05,2.03-2.06,4.06-4.12,6.09-6.18,1.96-2.12,3.86-4.32,5.78-6.47l2.88-3.24,2.14-2.65c4.89.87,9.48,1.03,13.81.6,2.64-.24,5.01-.8,7.38-1.49,2.35-.7,4.61-1.59,6.79-2.62,1.09-.52,2.16-1.07,3.21-1.66,1.03-.6,2.01-1.26,2.99-1.94,1.95-1.36,3.83-2.84,5.65-4.41.91-.79,1.81-1.6,2.69-2.43.89-.83,1.68-1.72,2.5-2.61,1.63-1.78,3.21-3.63,4.76-5.52-8.46.12-16.75.95-25.47,3.97-2.16.77-4.31,1.68-6.47,2.79-2.2,1.07-4.48,2.27-6.72,3.71-1.13.71-2.26,1.48-3.39,2.3-.29.22-.59.44-.88.66,1.4-1.93,2.79-3.85,4.18-5.77.84-1.16,1.67-2.31,2.51-3.47.78-1.19,1.56-2.38,2.33-3.56,1.55-2.37,3.1-4.73,4.64-7.08,1.43-2.42,2.85-4.82,4.26-7.21.16-.26.31-.53.47-.79,2.08.04,4.09-.02,6.03-.19,2.79-.26,5.38-.77,7.87-1.45,2.48-.69,4.83-1.56,7.07-2.6,1.12-.52,2.21-1.08,3.27-1.67,1.05-.6,2.03-1.26,3-1.94,1.94-1.37,3.78-2.87,5.53-4.48,1.73-1.62,3.46-3.31,4.92-5.15,1.51-1.83,2.94-3.74,4.31-5.71.69-.98,1.36-1.98,2.02-3l.98-1.53.9-1.56c-4.07.69-8.31,1.48-12.39,2.68-4.12,1.19-8.11,2.79-12.13,4.95-4.09,2.13-8.07,4.88-12.01,8.43-1.45,1.23-2.89,2.58-4.32,4.03.78-1.47,1.57-2.95,2.35-4.41,4.54-8.92,8.46-17.78,11.84-26.35,11.04-1.42,19.62-5.65,26.03-11.65,1.75-1.61,3.41-3.32,4.91-5.14,1.46-1.83,2.81-3.76,4.07-5.76s2.45-4.06,3.57-6.18c1.05-2.13,2.02-4.32,2.95-6.53-4.01,1.2-7.95,2.57-11.81,4.3-3.93,1.72-7.77,3.81-11.42,6.5-3.59,2.71-7.29,5.93-10.72,9.99-.86,1.01-1.7,2.08-2.54,3.2-.51.69-1.04,1.39-1.58,2.11,2.37-6.59,4.43-12.95,6.21-18.98,1.17-4.12,2.4-8.04,3.26-11.84.19-.76.37-1.5.55-2.24,5.09-1.33,9.57-3.18,13.41-5.48,4.37-2.65,8.02-5.87,11.13-9.48,3.06-3.62,5.41-7.66,7.48-11.92,1.06-2.13,1.9-4.33,2.68-6.56.78-2.24,1.5-4.52,2.17-6.82-3.84,1.69-7.62,3.53-11.24,5.73Z"/>
      </svg>
      <div className="flex-1 h-px bg-gray-200"></div>
    </div>
    <div className="grid md:grid-cols-2 gap-8 md:gap-16 pt-6">
      <div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athletes'})}>All-Time {division==='women'?"Women":"Men"} ‚Üí</h2></th><th className="text-right py-1.5 px-1 text-gray-500 uppercase w-7">W</th><th className="text-right py-1.5 px-1 text-gray-500 uppercase w-7">T3</th><th className="text-right py-1.5 px-1 text-gray-500 uppercase w-7">T10</th><th className="text-right py-1.5 pl-1 text-gray-500 uppercase w-7">R</th></tr></thead><tbody className="divide-y divide-gray-100">{topWinners.map((a,i)=><tr key={a.name} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-1 text-gray-400 w-4 tabular-nums">{i+1}</td><td className="py-1.5 pr-1"><div className="flex items-center gap-1 whitespace-nowrap"><ClubShield club={a.club} size={12}/><span className="text-gray-900">{a.name}</span></div></td><td className="py-1.5 px-1 text-right font-semibold tabular-nums">{a.wins||'-'}</td><td className="py-1.5 px-1 text-right text-gray-600 tabular-nums">{a.top3||'-'}</td><td className="py-1.5 px-1 text-right text-gray-600 tabular-nums">{a.top10||'-'}</td><td className="py-1.5 pl-1 text-right text-gray-400 tabular-nums">{a.races}</td></tr>)}</tbody></table></div>
      <div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide">Combined Titles</h2></th><th className="text-right py-1.5 px-1 text-gray-500 uppercase w-8">Tot</th><th className="text-right py-1.5 px-1 text-gray-500 uppercase w-7">M</th><th className="text-right py-1.5 pl-1 text-gray-500 uppercase w-7">W</th></tr></thead><tbody className="divide-y divide-gray-100">{(data.combinedTitles||[]).map((c,i)=><tr key={c.club} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1.5 pr-1 text-gray-400 w-4 tabular-nums">{i+1}</td><td className="py-1.5 pr-1"><div className="flex items-center gap-1"><ClubShield club={c.club} size={12}/><ClubName club={c.club} className="text-gray-900"/></div></td><td className="py-1.5 px-1 text-right font-semibold tabular-nums">{c.total}</td><td className="py-1.5 px-1 text-right text-gray-600 tabular-nums">{c.m||'-'}</td><td className="py-1.5 pl-1 text-right text-gray-600 tabular-nums">{c.w||'-'}</td></tr>)}</tbody></table></div>
    </div>
    
    {data.achievements&&<><div className="grid md:grid-cols-3 gap-6 md:gap-12 mt-6"><div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'clubs'})}>{division==='women'?"Women's":"Men's"} Clubs ‚Üí</h2></th><th className="text-right py-1.5 px-1 text-gray-500 uppercase">Titles</th><th className="text-right py-1.5 pl-1 text-gray-500 uppercase">2nd</th></tr></thead><tbody className="divide-y divide-gray-100">{data.clubAllTime.slice(0,5).map((c,i)=><tr key={c.club} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1.5 pr-1 text-gray-400 w-4 tabular-nums">{i+1}</td><td className="py-1.5 pr-1"><div className="flex items-center gap-1"><ClubShield club={c.club} size={12}/><ClubName club={c.club} className="text-gray-900"/></div></td><td className="py-1.5 px-1 text-right font-semibold tabular-nums">{c.titles||'-'}</td><td className="py-1.5 pl-1 text-right text-gray-400 tabular-nums">{c.runnerUp||'-'}</td></tr>)}</tbody></table></div><div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide">Consecutive Wins</h2></th><th className="text-right py-1.5 pl-1 text-gray-500 uppercase w-8"></th></tr></thead><tbody className="divide-y divide-gray-100">{data.achievements.mostConsecutiveWins?.map((a,i,arr)=>{const prevVal=i>0?arr[i-1].streak:null;const isTied=prevVal===a.streak;return<tr key={i} className="hover:bg-gray-50"><td className="py-1.5 pr-1 text-gray-400 w-4 tabular-nums">{isTied?'=':i+1}</td><td className="py-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}><div className="flex items-center gap-1"><ClubShield club={a.club} size={12}/><span className="truncate">{a.name}</span></div></td><td className="py-1.5 text-right text-gray-500 tabular-nums w-8">{a.streak}</td></tr>})}</tbody></table></div><div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide">Consecutive Titles</h2></th><th className="text-right py-1.5 pl-1 text-gray-500 uppercase w-8"></th></tr></thead><tbody className="divide-y divide-gray-100">{data.achievements.mostConsecutiveTitles?.map((c,i,arr)=>{const prevVal=i>0?arr[i-1].streak:null;const isTied=prevVal===c.streak;return<tr key={i} className="hover:bg-gray-50"><td className="py-1.5 pr-1 text-gray-400 w-4 tabular-nums">{isTied?'=':i+1}</td><td className="py-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:c.club})}><div className="flex items-center gap-1"><ClubShield club={c.club} size={12}/><span>{c.club}</span></div></td><td className="py-1.5 text-right text-gray-500 tabular-nums w-8">{c.streak}</td></tr>})}</tbody></table></div></div><div className="grid md:grid-cols-2 gap-6 md:gap-16 mt-6"><div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide">Biggest Races</h2></th><th className="text-right py-1.5 pl-1 text-gray-500 uppercase w-10"></th></tr></thead><tbody className="divide-y divide-gray-100">{data.achievements.biggestRaces?.map((r,i,arr)=>{const race=data.races.find(x=>x.season===r.season&&x.match===r.match);const year=r.date?.slice(0,4);const prevVal=i>0?arr[i-1].finishers:null;const isTied=prevVal===r.finishers;return<tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>race&&setView({type:'race',race})}><td className="py-1.5 pr-1 text-gray-400 w-4 tabular-nums">{isTied?'=':i+1}</td><td className="py-1.5"><span>{r.venue} {year}</span></td><td className="py-1.5 text-right text-gray-500 tabular-nums w-10">{r.finishers}</td></tr>;})}</tbody></table></div><div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide">Best Turnout</h2></th><th className="text-right py-1.5 pl-1 text-gray-500 uppercase w-8"></th></tr></thead><tbody className="divide-y divide-gray-100">{data.achievements.biggestTurnouts?.map((t,i,arr)=>{const race=data.races.find(x=>x.season===t.season&&x.match===t.match);const year=t.date?.slice(0,4);const prevVal=i>0?arr[i-1].count:null;const isTied=prevVal===t.count;return<tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>race&&setView({type:'race',race})}><td className="py-1.5 pr-1 text-gray-400 w-4 tabular-nums">{isTied?'=':i+1}</td><td className="py-1.5"><div className="flex items-center gap-1"><ClubShield club={t.club} size={12}/><span>{t.venue} {year}</span></div></td><td className="py-1.5 text-right text-gray-500 tabular-nums w-8">{t.count}</td></tr>;})}</tbody></table></div></div></>}
    
    {(()=>{
      // Use different seasons and clubs based on division
      const seasons=division==='women'
        ?['2014/15','2015/16','2016/17','2017/18','2018/19','2019/20','2021/22','2022/23','2023/24','2024/25','2025/26']
        :['2007/08','2008/09','2009/10','2010/11','2011/12','2012/13','2013/14','2014/15','2015/16','2016/17','2017/18','2018/19','2019/20','2021/22','2022/23','2023/24','2024/25','2025/26'];
      const seasonLabels=division==='women'
        ?['14/15','15/16','16/17','17/18','18/19','19/20','21/22','22/23','23/24','24/25','25/26']
        :['07/08','08/09','09/10','10/11','11/12','12/13','13/14','14/15','15/16','16/17','17/18','18/19','19/20','21/22','22/23','23/24','24/25','25/26'];
      const primaryClubs=division==='women'?['BEL','THH','KEN','HHH']:['BEL','KEN','THH','H/W'];
      const clubs=[
        {code:'BEL',color:'#7A001D'},{code:'THH',color:'#374151'},{code:'KEN',color:'#2a4d7a'},
        {code:'HHH',color:'#dc2626'},{code:'H/W',color:'#ca8a04'},{code:'G&G',color:'#16a34a'},
        {code:'SLH',color:'#be185d'},{code:'HOL',color:'#1e40af'},{code:'DUL',color:'#7c3aed'},{code:'C/C',color:'#0891b2'},
        {code:'RAN',color:'#0369a1'},{code:'CRO',color:'#525252'},{code:'DMV',color:'#92400e'},
        {code:'E&E',color:'#b91c1c'},{code:'FUL',color:'#171717'},{code:'REI',color:'#e11d48'},
        {code:'SOC',color:'#65a30d'},{code:'WOK',color:'#ea580c'},{code:'STR',color:'#facc15'},{code:'W4H',color:'#4ade80'}
      ];
      const getPositions=(club)=>seasons.map(s=>{
        const sd=data.seasonsData[s];
        // For current incomplete season, use current standings
        if(s===data.seasons[0]&&sd?.standings?.length>0){
          const idx=sd.standings.findIndex(t=>t.club===club);
          return idx>=0?idx+1:16;
        }
        const standings=sd?.standings||[];
        const idx=standings.findIndex(t=>t.club===club);
        return idx>=0?idx+1:16;
      });
      const hasDiv1History=(club)=>getPositions(club).some(p=>p<=15);
      const activeClubs=clubs.filter(c=>hasDiv1History(c.code));
      const [hovered,setHovered]=React.useState(null);
      const [tapped,setTapped]=React.useState(null);
      const chartW=800,chartH=250,padL=35,padR=20,padT=20,padB=30;
      const plotW=chartW-padL-padR,plotH=chartH-padT-padB;
      const xStep=plotW/(seasons.length-1);
      const maxPos=division==='women'?15:10;
      const yScale=(pos)=>padT+(Math.min(pos,maxPos+1)-1)*(plotH/maxPos);
      const selected=hovered||tapped;
      return<div className="mt-8 pt-6 border-t border-gray-200">
        <h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'chartroom'})}>Chart room ‚Üí</h3>
        <div className="bg-gray-50 rounded-lg p-3 overflow-x-auto">
          <svg viewBox={`0 0 ${chartW} ${chartH}`} className="w-full min-w-[320px] md:min-w-[500px]">
            {Array.from({length:maxPos},(_, i)=>i+1).map(pos=><g key={pos}>
              <line x1={padL} y1={yScale(pos)} x2={chartW-padR} y2={yScale(pos)} stroke="#e5e7eb" strokeWidth="1"/>
              <text x={padL-8} y={yScale(pos)+4} textAnchor="end" fontSize="10" fill="#9ca3af">{pos}</text>
            </g>)}
            <line x1={padL} y1={yScale(maxPos+1)} x2={chartW-padR} y2={yScale(maxPos+1)} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4,2"/>
            <text x={padL-8} y={yScale(maxPos+1)+4} textAnchor="end" fontSize="9" fill="#d1d5db">Div 2</text>
            {seasonLabels.map((s,i)=><text key={s} x={padL+i*xStep} y={chartH-8} textAnchor="middle" fontSize="9" fill="#6b7280">{s}</text>)}
            {activeClubs.map(({code,color})=>{
              const positions=getPositions(code);
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selected===code;
              const points=positions.map((pos,i)=>({x:padL+i*xStep,y:yScale(pos),pos,season:seasons[i]}));
              const pathD=points.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(' ');
              const baseOpacity=isPrimary?0.8:0.15;
              const opacity=selected?(isSelected?1:0.1):baseOpacity;
              return<g key={code} onMouseEnter={()=>setHovered(code)} onMouseLeave={()=>setHovered(null)} onClick={()=>setTapped(tapped===code?null:code)} style={{cursor:'pointer'}}>
                <path d={pathD} fill="none" stroke={color} strokeWidth={isSelected?1.5:1} strokeLinecap="round" strokeLinejoin="round" opacity={opacity}/>
                {points.map((p,i)=><circle key={i} cx={p.x} cy={p.y} r={isSelected?3:2} fill={color} opacity={opacity}/>)}
                {isSelected&&<text x={points[points.length-1].x+8} y={points[points.length-1].y+4} fontSize="10" fill={color} fontWeight="600">{CLUBS[code]?.name||code}</text>}
              </g>;
            })}
          </svg>
          <div className="flex flex-wrap justify-center gap-x-3 gap-y-1 mt-3">
            {activeClubs.map(({code,color})=>{
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selected===code;
              return<div key={code} className="flex items-center gap-1 cursor-pointer" onMouseEnter={()=>setHovered(code)} onMouseLeave={()=>setHovered(null)} onClick={()=>setTapped(tapped===code?null:code)}>
                <div className="w-2 h-2 rounded-full" style={{backgroundColor:color,opacity:isPrimary||isSelected?1:0.3}}/>
                <span className={`text-[10px] ${isPrimary||isSelected?'text-gray-600':'text-gray-400'}`}>{code}</span>
              </div>;
            })}
          </div>
        </div>
      </div>;
    })()}
  </div>;
};

const Footer=({setView})=><footer className="border-t border-gray-200 mt-12 py-6 text-center text-xs text-gray-400">Vibecoded by Steve. Work in progress. Now <span className="cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'quiz'})}>quiz this</span>. <span className="cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'chartroom'})}>üìä</span><br/><span className="cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'submit'})}>Submit more results</span> ¬∑ <span className="cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'origin'})}>Origin story</span></footer>;

// Hash-based routing utilities
const seasonToCompact=(s)=>s?s.replace('/','').slice(-4):''; // "2013/14" -> "1314"
const compactToSeason=(c)=>{if(!c||c.length!==4)return null;const y1=parseInt(c.slice(0,2));const y2=parseInt(c.slice(2,4));const prefix=y1>=62&&y1<=99?'19':'20';return `${prefix}${c.slice(0,2)}/${c.slice(2,4)}`;};
const nameToSlug=(n)=>n?.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')||'';
const slugToName=(s,athletes)=>{if(!s)return null;const slug=s.toLowerCase();const match=athletes?.find(a=>nameToSlug(a.name)===slug);return match?.name||s.replace(/-/g,' ');};

const parseUrlParams=(athletes)=>{
  const hash=window.location.hash.slice(1).toLowerCase();
  if(!hash)return{type:'home',division:'men'};
  
  // Check for women prefix
  const isWomen=hash.startsWith('women');
  const division=isWomen?'women':'men';
  const cleanHash=isWomen?(hash.startsWith('women/')?hash.slice(6):(hash==='women'?'':hash.slice(5))):hash;
  
  if(!cleanHash)return{type:'home',division};
  const[route,...rest]=cleanHash.split('/');
  const param=rest.join('/');
  switch(route){
    case'season':return{type:'home',urlSeason:compactToSeason(param),division};
    case'athlete':return{type:'athlete',athlete:{name:slugToName(param,athletes),slug:param},division};
    case'club':return{type:'club',club:param.toUpperCase().replace('HW','H/W').replace('GG','G&G').replace('CC','C/C').replace('EE','E&E').replace('SD','S&D'),division};
    case'race':{const[s,m]=param.split('-');return{type:'race',raceKey:{season:compactToSeason(s),match:parseInt(m)},division};}
    case'fixtures':return{type:'fixtures',division};
    case'winners':return{type:'seasons',division};
    case'athletes':return{type:'athletes',division};
    case'clubs':return{type:'clubs',division};
    case'h2h':return{type:'h2h',division};
    case'quiz':return{type:'quiz',division};
    case'chartroom':return{type:'chartroom',division};
    case'origin':return{type:'origin',division};
    default:return{type:'home',division};
  }
};

const updateUrl=(view,division='men')=>{
  const prefix=division==='women'?'#women':'#';
  const sep=division==='women'?'/':'';
  let hash='';
  if(view.type==='home'&&view.urlSeason)hash=prefix+sep+'season/'+seasonToCompact(view.urlSeason);
  else if(view.type==='home'&&division==='women')hash='#women';
  else if(view.type==='athlete'&&view.athlete?.name)hash=prefix+sep+'athlete/'+nameToSlug(view.athlete.name);
  else if(view.type==='club'&&view.club)hash=prefix+sep+'club/'+view.club.toLowerCase().replace('/','').replace('&','');
  else if(view.type==='race'&&view.race)hash=prefix+sep+'race/'+seasonToCompact(view.race.season)+'-'+view.race.match;
  else if(view.type==='fixtures')hash=prefix+sep+'fixtures';
  else if(view.type==='seasons')hash=prefix+sep+'winners';
  else if(view.type==='athletes')hash=prefix+sep+'athletes';
  else if(view.type==='clubs')hash=prefix+sep+'clubs';
  else if(view.type==='h2h')hash=prefix+sep+'h2h';
  else if(view.type==='quiz')hash=prefix+sep+'quiz';
  else if(view.type==='chartroom')hash=prefix+sep+'chartroom';
  else if(view.type==='origin')hash=prefix+sep+'origin';
  if(hash!==window.location.hash)window.history.pushState({},'',hash||window.location.pathname);
};

const AthleteInput=({value,onChange,onSelect,athletes,placeholder})=>{
  const[focused,setFocused]=useState(false);
  const[inputVal,setInputVal]=useState(value?.name||'');
  const suggestions=inputVal.length>=2?athletes.filter(a=>a.name.toLowerCase().includes(inputVal.toLowerCase())).slice(0,8):[];
  useEffect(()=>{setInputVal(value?.name||'');},[value]);
  return<div className="relative flex-1">
    <input type="text" value={inputVal} onChange={e=>{setInputVal(e.target.value);onChange(null);}} onFocus={()=>setFocused(true)} onBlur={()=>setTimeout(()=>setFocused(false),200)} placeholder={placeholder} className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0077b6] focus:border-transparent"/>
    {focused&&suggestions.length>0&&<div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 max-h-64 overflow-y-auto">
      {suggestions.map((a,i)=><div key={i} className="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2" onClick={()=>{onSelect(a);setInputVal(a.name);setFocused(false);}}>
        <ClubShield club={a.club} size={16}/><span className="text-sm text-gray-900">{a.name}</span><span className="text-xs text-gray-400">{CLUBS[a.club]?.name||a.club}</span>
      </div>)}
    </div>}
  </div>;
};

const H2HView=({athletes,races,setView,prefill})=>{
  const[athlete1,setAthlete1]=useState(prefill?.athlete1||null);
  const[athlete2,setAthlete2]=useState(prefill?.athlete2||null);
  
  const getStats=(a)=>{
    if(!a)return null;
    const found=athletes.find(x=>namesMatch(x.name,a.name))||a;
    const allTimeRank=athletes.filter(x=>!x.historical).sort((a,b)=>b.wins-a.wins).findIndex(x=>namesMatch(x.name,found.name))+1;
    const positions=[];
    let bestRace=null;
    let bestPos=Infinity;
    races.filter(r=>r.results?.length).forEach(race=>{
      const result=race.results.find(r=>namesMatch(r.name,a.name));
      if(result){
        positions.push(result.pos);
        if(result.pos<bestPos){bestPos=result.pos;bestRace=race;}
      }
    });
    const avgPos=positions.length>0?positions.reduce((a,b)=>a+b,0)/positions.length:0;
    return{...found,allTimeRank,avgPos,bestPos:bestPos===Infinity?0:bestPos,bestRace};
  };
  
  const computeH2H=()=>{
    if(!athlete1||!athlete2)return null;
    let wins1=0,wins2=0,ties=0;
    const sharedRaces=[];
    races.filter(r=>r.results?.length).forEach(race=>{
      const r1=race.results.find(r=>namesMatch(r.name,athlete1.name));
      const r2=race.results.find(r=>namesMatch(r.name,athlete2.name));
      if(r1&&r2){
        sharedRaces.push({race,pos1:r1.pos,pos2:r2.pos});
        if(r1.pos<r2.pos)wins1++;
        else if(r2.pos<r1.pos)wins2++;
        else ties++;
      }
    });
    return{wins1,wins2,ties,sharedRaces,total:sharedRaces.length};
  };
  
  const stats1=getStats(athlete1);
  const stats2=getStats(athlete2);
  const h2h=computeH2H();
  
  const StatRow=({label,val1,val2,better='lower',onClick1,onClick2})=>{
    const n1=typeof val1==='string'&&val1.startsWith('#')?parseInt(val1.slice(1)):parseFloat(val1);
    const n2=typeof val2==='string'&&val2.startsWith('#')?parseInt(val2.slice(1)):parseFloat(val2);
    const w1=better==='lower'?n1<n2:n1>n2;
    const w2=better==='lower'?n2<n1:n2>n1;
    const color1=w1?'text-green-600':w2?'text-red-500':'text-gray-600';
    const color2=w2?'text-green-600':w1?'text-red-500':'text-gray-600';
    return<tr className="border-b border-gray-100">
      <td className={`py-3 px-4 text-right text-lg font-semibold ${color1} ${onClick1?'cursor-pointer hover:underline':''}`} onClick={onClick1}>{val1}</td>
      <td className="py-3 px-4 text-center text-sm text-gray-500 bg-gray-50">{label}</td>
      <td className={`py-3 px-4 text-left text-lg font-semibold ${color2} ${onClick2?'cursor-pointer hover:underline':''}`} onClick={onClick2}>{val2}</td>
    </tr>;
  };
  
  return<div className="max-w-5xl mx-auto px-4 py-8">
    <h1 className="text-2xl font-bold text-gray-900 mb-6">Head to Head</h1>
    
    <div className="flex gap-4 mb-8">
      <AthleteInput value={athlete1} onChange={setAthlete1} onSelect={setAthlete1} athletes={athletes.filter(a=>!a.historical)} placeholder="Search athlete..."/>
      <div className="flex items-center text-gray-400 font-semibold">vs</div>
      <AthleteInput value={athlete2} onChange={setAthlete2} onSelect={setAthlete2} athletes={athletes.filter(a=>!a.historical)} placeholder="Search athlete..."/>
    </div>
    
    {stats1&&stats2&&h2h&&<div>
      <div className="mb-6 text-center">
        <div className="flex items-center justify-center gap-4 mb-2">
          <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:athlete1})}>
            <ClubShield club={stats1.club} size={24}/>
            <span className="text-lg font-semibold text-gray-900 hover:text-[#0077b6]">{stats1.name}</span>
          </div>
          <span className="text-2xl font-bold text-gray-400">vs</span>
          <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:athlete2})}>
            <span className="text-lg font-semibold text-gray-900 hover:text-[#0077b6]">{stats2.name}</span>
            <ClubShield club={stats2.club} size={24}/>
          </div>
        </div>
        <p className="text-sm text-gray-500">{h2h.total} shared races</p>
      </div>
      
      <table className="w-full mb-8">
        <tbody>
          <tr className="border-b-2 border-gray-200">
            <td className={`py-4 px-4 text-right text-3xl font-bold ${h2h.wins1>h2h.wins2?'text-green-600':h2h.wins1<h2h.wins2?'text-red-500':'text-gray-600'}`}>{h2h.wins1}</td>
            <td className="py-4 px-4 text-center text-sm text-gray-500 bg-gray-50 uppercase">H2H Wins</td>
            <td className={`py-4 px-4 text-left text-3xl font-bold ${h2h.wins2>h2h.wins1?'text-green-600':h2h.wins2<h2h.wins1?'text-red-500':'text-gray-600'}`}>{h2h.wins2}</td>
          </tr>
          <StatRow label="A-Team Scores" val1={stats1.aScores||0} val2={stats2.aScores||0} better="higher"/>
          <StatRow label="Avg Finish" val1={(stats1.avgPos||0).toFixed(1)} val2={(stats2.avgPos||0).toFixed(1)} better="lower"/>
          <StatRow label="Best Finish" val1={stats1.bestPos||'-'} val2={stats2.bestPos||'-'} better="lower" onClick1={stats1.bestRace?()=>setView({type:'race',race:stats1.bestRace}):null} onClick2={stats2.bestRace?()=>setView({type:'race',race:stats2.bestRace}):null}/>
          <StatRow label="Total Races" val1={stats1.races||0} val2={stats2.races||0} better="higher"/>
          <StatRow label="All-Time Rank" val1={stats1.allTimeRank>0?'#'+stats1.allTimeRank:'-'} val2={stats2.allTimeRank>0?'#'+stats2.allTimeRank:'-'} better="lower"/>
        </tbody>
      </table>
      
      {h2h.sharedRaces.length>0&&<div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">Race by Race</h2>
        <table className="w-full">
          <thead><tr className="border-b border-gray-200">
            <th className="text-left py-2 text-xs text-gray-500 uppercase">Race</th>
            <th className="text-right py-2 px-2 text-xs text-gray-500 uppercase w-16">{stats1.name.split(' ')[0]}</th>
            <th className="text-right py-2 px-2 text-xs text-gray-500 uppercase w-16">{stats2.name.split(' ')[0]}</th>
          </tr></thead>
          <tbody className="divide-y divide-gray-100">
            {h2h.sharedRaces.slice().reverse().map((sr,i)=><tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'race',race:sr.race})}>
              <td className="py-2 text-sm text-gray-700">{formatDate(sr.race.date)} ¬∑ {sr.race.venue}</td>
              <td className={`py-2 px-2 text-sm text-right font-medium ${sr.pos1<sr.pos2?'text-green-600':sr.pos1>sr.pos2?'text-red-500':'text-gray-600'}`}>{sr.pos1}</td>
              <td className={`py-2 px-2 text-sm text-right font-medium ${sr.pos2<sr.pos1?'text-green-600':sr.pos2>sr.pos1?'text-red-500':'text-gray-600'}`}>{sr.pos2}</td>
            </tr>)}
          </tbody>
        </table>
      </div>}
    </div>}
    
    {(!athlete1||!athlete2)&&<div className="text-center py-12 text-gray-400">
      <p>Select two athletes to compare</p>
    </div>}
  </div>;
};

const AskView=({data,setView})=>{
  const[query,setQuery]=useState('');
  const[loading,setLoading]=useState(false);
  const[answer,setAnswer]=useState('');
  const[error,setError]=useState('');
  
  const exampleQueries=[
    "Which athlete improved their average position the most from one season to the next?",
    "Who has the best win rate (wins per race)?",
    "Which club has the most athletes with race wins?",
    "What's the closest team race in the database?",
    "Who are the top 5 most consistent athletes (lowest position variance)?",
    "Which venue has produced the most first-time winners?"
  ];
  
  const buildDataSummary=()=>{
    // Create a compact summary of the data for the AI
    const athletes=data.athletes.slice(0,100).map(a=>({
      name:a.name,club:a.club,wins:a.wins,top3:a.top3,top10:a.top10,races:a.races,aScores:a.aScores
    }));
    const seasons=Object.keys(data.seasonsData).sort().reverse();
    const recentRaces=data.races.slice(0,20).map(r=>({
      season:r.season,match:r.match,venue:r.venue,date:r.date,
      top10:r.results.slice(0,10).map(x=>({pos:x.pos,name:x.name,club:x.club}))
    }));
    return{
      stats:data.stats,
      seasons,
      topAthletes:athletes,
      recentRaces,
      clubHonours:data.clubAllTime,
      achievements:data.achievements
    };
  };
  
  const askQuestion=async()=>{
    if(!query.trim())return;
    setLoading(true);
    setError('');
    setAnswer('');
    
    try{
      // Build a summary since full data is too large
      const summary=buildDataSummary();
      
      // For deeper analysis, include race-by-race athlete positions
      const athleteSeasonStats={};
      data.races.forEach(race=>{
        const season=race.season;
        race.results.forEach(r=>{
          const key=r.name;
          if(!athleteSeasonStats[key])athleteSeasonStats[key]={};
          if(!athleteSeasonStats[key][season])athleteSeasonStats[key][season]={positions:[],club:r.club};
          athleteSeasonStats[key][season].positions.push(r.pos);
        });
      });
      
      // Calculate averages per season for each athlete
      const athleteSeasonAvg={};
      Object.entries(athleteSeasonStats).forEach(([name,seasons])=>{
        athleteSeasonAvg[name]={};
        Object.entries(seasons).forEach(([season,data])=>{
          const avg=data.positions.reduce((a,b)=>a+b,0)/data.positions.length;
          athleteSeasonAvg[name][season]={avg:Math.round(avg*10)/10,races:data.positions.length,club:data.club};
        });
      });
      
      const systemPrompt=`You are a helpful assistant analyzing Surrey Cross Country League data. Answer questions about race results, athlete performance, club standings, and statistics. Be specific and cite data. Format answers clearly. When referencing athletes or clubs, be precise with names.

The database contains:
- ${data.stats.totalRaces} races from ${data.stats.seasons} seasons (2014-present with full data)
- ${data.stats.totalAthletes} athletes
- ${data.stats.totalResults} individual results

Key data structures available:
1. Athletes: name, club, wins, top3, top5, top10, top20, races, aScores (A-team finishes)
2. Races: season, match number, venue, date, full results with positions
3. Season standings: club points per match, final standings
4. Club honours: titles, 2nd places, 3rd places all-time`;

      const response=await fetch('https://surrey-league-ai.stephendgardner.workers.dev',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          model:'claude-sonnet-4-20250514',
          max_tokens:1000,
          system:systemPrompt,
          messages:[{
            role:'user',
            content:`Here is a summary of the league data:

TOP 100 ATHLETES:
${JSON.stringify(summary.topAthletes,null,1)}

CLUB HONOURS (ALL-TIME):
${JSON.stringify(summary.clubHonours,null,1)}

ACHIEVEMENTS:
${JSON.stringify(summary.achievements,null,1)}

ATHLETE SEASON AVERAGES (for improvement analysis):
${JSON.stringify(Object.fromEntries(Object.entries(athleteSeasonAvg).filter(([k,v])=>Object.keys(v).length>=2).slice(0,200)),null,1)}

RECENT RACES (top 10 finishers each):
${JSON.stringify(summary.recentRaces,null,1)}

QUESTION: ${query}`
          }]
        })
      });
      
      const result=await response.json();
      if(result.error){
        setError(result.error.message||'API error');
      }else if(result.content&&result.content[0]){
        setAnswer(result.content[0].text);
      }
    }catch(e){
      setError(e.message||'Failed to get answer');
    }finally{
      setLoading(false);
    }
  };
  
  return<div className="max-w-3xl mx-auto px-4 py-8">
    <div className="mb-8">
      <div className="flex items-center gap-2 mb-2">
        <Sparkles className="w-6 h-6 text-[#0077b6]"/>
        <h1 className="text-2xl font-bold text-gray-900">Ask the Archive</h1>
      </div>
      <p className="text-sm text-gray-500">Ask questions about Surrey League history, athlete performance, club records, and more.</p>
    </div>
    
    <div className="mb-6">
      <div className="flex gap-2">
        <input
          type="text"
          value={query}
          onChange={e=>setQuery(e.target.value)}
          onKeyDown={e=>e.key==='Enter'&&!loading&&askQuestion()}
          placeholder="Ask a question about the league..."
          className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0077b6] focus:border-transparent"
        />
        <button
          onClick={askQuestion}
          disabled={loading||!query.trim()}
          className={`px-6 py-3 rounded-lg flex items-center gap-2 ${loading||!query.trim()?'bg-gray-200 text-gray-400':'bg-[#0077b6] text-white hover:bg-[#005f8a]'}`}
        >
          {loading?<span className="animate-pulse">Thinking...</span>:<><Send className="w-4 h-4"/>Ask</>}
        </button>
      </div>
    </div>
    
    {!answer&&!loading&&!error&&<div className="mb-8">
      <p className="text-xs text-gray-500 uppercase tracking-wide mb-3">Example questions</p>
      <div className="flex flex-wrap gap-2">
        {exampleQueries.map((q,i)=><button
          key={i}
          onClick={()=>setQuery(q)}
          className="text-sm px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700"
        >{q}</button>)}
      </div>
    </div>}
    
    {error&&<div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4">{error}</div>}
    
    {answer&&<div className="prose prose-sm max-w-none">
      <div className="p-6 bg-gray-50 rounded-lg border border-gray-200">
        <div className="whitespace-pre-wrap text-gray-800">{answer}</div>
      </div>
      <button onClick={()=>{setAnswer('');setQuery('');}} className="mt-4 text-sm text-[#0077b6] hover:underline">Ask another question</button>
    </div>}
  </div>;
};

// Normalize data to merge case-variant athlete names
// 
// HISTORICAL RECORDS PRINCIPLE:
// For seasons before 2013/14, league standings from historical documents (Athletics Weekly,
// club records, official results sheets) are AUTHORITATIVE and must never be overwritten
// by calculations from individual race results. We can't rewrite history - if a document
// says AFD won 1984/85 with 684 points, that's the official record regardless of what
// our partial individual results might suggest. This is enforced in the standings
// calculation logic which prioritizes seasonsData.standings for pre-modern era seasons.
//
const normalizeData=(data,division='men',liveAliases={})=>{
  const divConfig=DIVISIONS[division];
  
  // Venue name mappings
  const venueMap={
    'Croyden':'Croydon',
    'Moden':'Morden Park',
    'Morden':'Morden Park',
    'Morden Pk':'Morden Park',
    'Beckenham':'Beckenham Place Park',
    'Beckenham Place':'Beckenham Place Park',
    'Brockwell':'Brockwell Park',
    'Richmond':'Richmond Park',
    'Richmond Pk':'Richmond Park',
    'G Richmond Pk':'Richmond Park',
    'Richmond Park (Sheen Rugby Fields)':'Richmond Park',
    'Wimbledon':'Wimbledon Common',
    'Wimbledon (race won by n/s R Dessaix-Chin, Belg)':'Wimbledon Common',
    'Hamlands':'Ham Lands',
    'Lloyd Park, Croydon':'Lloyd Park',
    'Mitcham':'Mitcham Common',
    'Streatham':'Streatham Common',
    'Epsom':'Epsom Downs',
    'Dorking (race won by n/s F Tickner, Wells)':'Dorking',
    'Pol Dorking':'Dorking',
    'Farthing Down, Coulsdon':'Farthing Downs',
    'West Horsley Place, Guildford':'West Horsley Place',
    'W Wickham':'West Wickham'
  };
  
  // Explicit name mappings (aliases to canonical names)
  const nameAliases={
    'jonathan gilbert':'John Gilbert',
    'r holt':'Bob Holt',
    'd holt':'Dave Holt',
    'dave ogden':'David Ogden',
    'd ogden':'David Ogden',
    'd.ogden':'David Ogden',
    'tom austin':'Thomas Austin',
    // Historical abbreviated names - winners with multiple wins
    'g north':'Gerry North',
    'b ford':'Bernie Ford',
    'b whitby':'Benedict Whitby',
    'p owor':'Paskar Owor',
    'p wicks':'Phil Wicks',
    'j mcmullan':'James McMullen',
    'james mcmullan':'James McMullen',
    'f tickner':'Frank Tickner',
    'g staines':'Gary Staines',
    's rayner':'Steve Rayner',
    'd clarke':'Dave Clarke',
    'j snowden':'John Snowden',
    'p adams':'Phil Adams',
    'r gevers':'Bob Gevers',
    'j roberts':'John Roberts',
    'i wheeler':'Ian Wheeler',
    'r richardson':'Bob Richardson',
    'd taylor':'Dave Taylor',
    'a black':'Alan Black',
    'alastair black':'Alan Black',
    'j thresher':'John Thresher',
    'j hogan':'Jim Hogan',
    'p carr-locke':'Peter Carr-Locke',
    'c smith':'Chris Smith',
    'm miles':'Martin Miles',
    'm hicken':'Malcolm Hicken',
    'c hensby':'Chris Hensby',
    'd murphy':'Declan Murphy',
    'k tadesse':'Kidane Tadesse',
    // Name variations to merge
    'steve sharp':'Steven Sharp',
    'william cockerell':'Will Cockerell',
    'w cockerell':'Will Cockerell',
    'cockerell':'Will Cockerell',
    "t o'neill":"Terry O'Neill",
    "t o'neil":"Terry O'Neill",
    'matt sharp':'Matthew Sharp',
    'mat sharp':'Matthew Sharp',
    // Belgrave names
    'p carstairs':'Phil Carstairs',
    'paul carstairs':'Phil Carstairs',
    'p.carstairs v':'Phil Carstairs',
    'donny anderson':'Don Anderson',
    's zealey':'S Zealey',
    'k nash':'Kevin Nash',
    'w lynch':'William Lynch',
    // Other clubs
    's wurr':'Simon Wurr',
    'a weir':'Andy Weir',
    'n altmann':'Nick Altmann',
    'b reynolds':'Ben Reynolds',
    'm tennyson':'Mark Tennyson',
    'tennyson':'Mark Tennyson',
    // Stuart Major variants
    's major':'Stuart Major',
    'steve major':'Stuart Major',
    'major':'Stuart Major'
  };
  
  // Merge athleteAliases from data.json into nameAliases
  // Format in data.json: { "Canonical Name": ["alias1", "alias2"] }
  if(data.athleteAliases){
    Object.entries(data.athleteAliases).forEach(([canonical, aliases])=>{
      aliases.forEach(alias=>{
        nameAliases[normalizeNameForCompare(alias)]=canonical;
      });
    });
  }
  
  // Merge live aliases from Google Sheet (these take precedence)
  if(liveAliases){
    Object.entries(liveAliases).forEach(([alias, canonical])=>{
      nameAliases[alias.toLowerCase()]=canonical;
    });
  }
  
  // Club code aliases (map variant codes to canonical codes)
  const clubAliases={
    'RPR':'REI',  // Reigate Priory
    'REG':'REI',  // Reigate
    'PRP':'REI',  // Reigate Priory (typo)
    'RPR':'REI',  // Reigate Priory (old code)
    'WW':'W/W',   // Wimbledon Windmilers
    'WWM':'W/W',  // Wimbledon Windmilers
    'KPH':'K&P',  // Kingston & Polytechnic
    'WEL':'GUEST', // Wells City -> guest
  };
  
  // Normalize club codes in a value
  const normalizeClub=(code)=>clubAliases[code]||code;
  
  // Handle special dead heat cases - these races have two winners with their clubs
  const deadHeats={
    '1966/67-4':{winner:'Bob Holt / Gerry North',winners:[{name:'Bob Holt',club:'H/W'},{name:'Gerry North',club:'BEL'}]},
    '1967/68-2':{winner:'Gerry North / Bob Holt',winners:[{name:'Gerry North',club:'BEL'},{name:'Bob Holt',club:'H/W'}]},
    '1969/70-3':{winner:'Bob Holt / Dave Holt',winners:[{name:'Bob Holt',club:'H/W'},{name:'Dave Holt',club:'H/W'}]},
    '1974/75-1':{winner:'Bernie Ford / Phil Adams',winners:[{name:'Bernie Ford',club:'AFD'},{name:'Phil Adams',club:'AFD'}]},
    '1997/98-4':{winner:'Kidane Tadesse / Gary Staines',winners:[{name:'Kidane Tadesse',club:'BEL'},{name:'Gary Staines',club:'BEL'}]}
  };
  
  // Pre-process races to handle dead heats and name fixes
  data.races.forEach(race=>{
    const raceKey=`${race.season}-${race.match}`;
    // Apply dead heat data
    if(deadHeats[raceKey]){
      race.winner=deadHeats[raceKey].winner;
      race.winners=deadHeats[raceKey].winners;
      race.deadHeat=true;
    }
    // Normalize winner name using aliases (for non-dead-heat races)
    if(race.winner&&!race.deadHeat){
      const winnerKey=normalizeNameForCompare(race.winner);
      if(nameAliases[winnerKey]){
        race.winner=nameAliases[winnerKey];
      }
    }
  });
  
  // Normalize venue names in races
  data.races.forEach(race=>{
    if(race.venue&&venueMap[race.venue]){
      race.venue=venueMap[race.venue];
    }
    // Normalize club codes
    if(race.winnerClub)race.winnerClub=normalizeClub(race.winnerClub);
    if(race.teamWinner)race.teamWinner=normalizeClub(race.teamWinner);
    (race.results||[]).forEach(r=>{
      if(r.club)r.club=normalizeClub(r.club);
    });
    (race.knownTeamScores||[]).forEach(t=>{
      if(t.club)t.club=normalizeClub(t.club);
    });
  });
  
  // Normalize venue names and club codes in seasonsData
  Object.values(data.seasonsData||{}).forEach(sd=>{
    (sd.matches||[]).forEach(m=>{
      if(m.venue&&venueMap[m.venue]){
        m.venue=venueMap[m.venue];
      }
      if(m.winnerClub)m.winnerClub=normalizeClub(m.winnerClub);
      if(m.teamWinner)m.teamWinner=normalizeClub(m.teamWinner);
    });
    (sd.standings||[]).forEach(t=>{
      if(t.club)t.club=normalizeClub(t.club);
    });
    (sd.bStandings||[]).forEach(t=>{
      if(t.club)t.club=normalizeClub(t.club);
    });
    (sd.individualRankings||[]).forEach(a=>{
      if(a.club)a.club=normalizeClub(a.club);
    });
    (sd.knownStandings||[]).forEach(t=>{
      if(t.club)t.club=normalizeClub(t.club);
    });
  });
  
  // Build a map of normalized name -> preferred display name (first occurrence)
  const nameMap={};
  
  // First, set up all the aliases
  Object.entries(nameAliases).forEach(([alias,canonical])=>{
    nameMap[alias]=canonical;
    // Also ensure the canonical name maps to itself
    const canonicalKey=normalizeNameForCompare(canonical);
    if(!nameMap[canonicalKey])nameMap[canonicalKey]=canonical;
  });
  
  // Then process athletes
  data.athletes.forEach(a=>{
    const key=normalizeNameForCompare(a.name);
    // Don't override if this is an alias or already set
    if(!nameMap[key]){
      nameMap[key]=a.name;
    }
  });
  
  // Also check race results for names not in athletes list
  data.races.forEach(race=>{
    (race.results||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(!nameMap[key])nameMap[key]=r.name;
    });
  });
  
  // Merge duplicate athletes
  const mergedAthletes={};
  data.athletes.forEach(a=>{
    let key=normalizeNameForCompare(a.name);
    // If this name has an alias, use the canonical name as the key
    if(nameAliases[key]){
      key=normalizeNameForCompare(nameAliases[key]);
    }
    // Normalize club code
    if(a.club)a.club=normalizeClub(a.club);
    if(!mergedAthletes[key]){
      mergedAthletes[key]={...a,name:nameMap[normalizeNameForCompare(a.name)]||a.name};
    }else{
      // Merge stats
      const m=mergedAthletes[key];
      m.wins=(m.wins||0)+(a.wins||0);
      m.top3=(m.top3||0)+(a.top3||0);
      m.top5=(m.top5||0)+(a.top5||0);
      m.top10=(m.top10||0)+(a.top10||0);
      m.top20=(m.top20||0)+(a.top20||0);
      m.top50=(m.top50||0)+(a.top50||0);
      m.top100=(m.top100||0)+(a.top100||0);
      m.races=(m.races||0)+(a.races||0);
      m.aScores=(m.aScores||0)+(a.aScores||0);
      // Merge clubs array (normalized)
      if(!m.clubs)m.clubs=[m.club];
      const normClub=normalizeClub(a.club);
      if(normClub&&!m.clubs.includes(normClub))m.clubs.push(normClub);
    }
  });
  data.athletes=Object.values(mergedAthletes);
  
  // Normalize names in race results
  data.races.forEach(race=>{
    (race.results||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(nameMap[key])r.name=nameMap[key];
    });
  });
  
  // Normalize names in seasonsData individualRankings
  Object.values(data.seasonsData||{}).forEach(sd=>{
    (sd.individualRankings||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(nameMap[key])r.name=nameMap[key];
    });
  });
  
  // Normalize names in clubMvps
  Object.keys(data.clubMvps||{}).forEach(club=>{
    data.clubMvps[club].forEach(m=>{
      const key=normalizeNameForCompare(m.name);
      if(nameMap[key])m.name=nameMap[key];
    });
  });
  
  // Recompute athlete stats from ALL race results (including historical)
  const athleteStats={};
  data.races.forEach(race=>{
    (race.results||[]).forEach(r=>{
      if(!r.name)return;
      const key=normalizeNameForCompare(r.name);
      if(!athleteStats[key]){
        athleteStats[key]={name:r.name,club:r.club,wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,races:0,aScores:0,clubs:new Set()};
      }
      const s=athleteStats[key];
      s.races++;
      s.clubs.add(r.club);
      if(r.pos===1||r.pos==='=1')s.wins++;
      if(r.pos<=3||r.pos==='=1')s.top3++;
      if(r.pos<=5||r.pos==='=1')s.top5++;
      if(r.pos<=10||r.pos==='=1')s.top10++;
      if(r.pos<=20||r.pos==='=1')s.top20++;
      if(r.pos<=50||r.pos==='=1')s.top50++;
      if(r.pos<=100||r.pos==='=1')s.top100++;
      // Count A-team scores based on pts field (set for A-team scorers)
      if(r.pts)s.aScores++;
    });
  });
  
  // Also count historical races that aren't in race results
  data.athletes.forEach(a=>{
    if(!a.historicalRaces)return;
    const key=normalizeNameForCompare(a.name);
    a.historicalRaces.forEach(hr=>{
      // Check if this race is already in results
      const race=data.races.find(r=>r.season===hr.season&&r.match===hr.match);
      const alreadyCounted=race?.results?.some(res=>normalizeNameForCompare(res.name)===key);
      if(alreadyCounted)return;
      // Count this historical race
      if(!athleteStats[key]){
        athleteStats[key]={name:a.name,club:hr.club||a.club,wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,races:0,aScores:0,clubs:new Set()};
      }
      const s=athleteStats[key];
      s.races++;
      s.clubs.add(hr.club||a.club);
      if(hr.pos===1){s.wins++;s.top3++;s.top5++;s.top10++;s.top20++;s.top50++;s.top100++;}
      else if(hr.pos<=3){s.top3++;s.top5++;s.top10++;s.top20++;s.top50++;s.top100++;}
      else if(hr.pos<=5){s.top5++;s.top10++;s.top20++;s.top50++;s.top100++;}
      else if(hr.pos<=10){s.top10++;s.top20++;s.top50++;s.top100++;}
      else if(hr.pos<=20){s.top20++;s.top50++;s.top100++;}
      else if(hr.pos<=50){s.top50++;s.top100++;}
      else if(hr.pos<=100){s.top100++;}
    });
  });
  
  // Merge computed stats with existing athletes
  data.athletes.forEach(a=>{
    const key=normalizeNameForCompare(a.name);
    if(athleteStats[key]){
      const s=athleteStats[key];
      // Use computed stats from race results
      a.wins=s.wins;
      a.top3=s.top3;
      a.top5=s.top5;
      a.top10=s.top10;
      a.top20=s.top20;
      a.top50=s.top50;
      a.top100=s.top100;
      a.races=s.races;
      a.aScores=s.aScores;
      // Merge clubs
      if(!a.clubs)a.clubs=[a.club];
      s.clubs.forEach(c=>{if(!a.clubs.includes(c))a.clubs.push(c);});
      delete athleteStats[key]; // Mark as processed
    }
  });
  
  // Add athletes that only exist in race results (not in original athletes array)
  Object.values(athleteStats).forEach(s=>{
    s.clubs=Array.from(s.clubs);
    s.club=s.clubs[0];
    data.athletes.push(s);
  });

  // Ensure clubAllTime is an array (may be empty object in women's data)
  if(!Array.isArray(data.clubAllTime)){
    // Build clubAllTime from race results
    const clubStats={};
    data.races.forEach(race=>{
      (race.results||[]).forEach(r=>{
        if(!clubStats[r.club])clubStats[r.club]={club:r.club,races:0,runners:0};
        clubStats[r.club].runners++;
      });
      if(race.teamWinner){
        if(!clubStats[race.teamWinner])clubStats[race.teamWinner]={club:race.teamWinner,races:0,runners:0};
        clubStats[race.teamWinner].races++;
      }
    });
    data.clubAllTime=Object.values(clubStats);
  }else{
    // clubAllTime exists but may be missing clubs that have runners but weren't in Div 1 standings
    const existingClubs=new Set(data.clubAllTime.map(c=>c.club));
    data.races.forEach(race=>{
      (race.results||[]).forEach(r=>{
        if(r.club&&!existingClubs.has(r.club)){
          data.clubAllTime.push({club:r.club,titles:0,seconds:0,thirds:0,seasonCount:0});
          existingClubs.add(r.club);
        }
      });
    });
  }

  // Recompute all club positions from seasonsData (titles, runnerUp, third, fourth, fifth, sixth)
  const placeCount={};
  const clubSeasons={}; // Track which seasons each club appeared in
  Object.entries(data.seasonsData||{}).forEach(([season,sd])=>{
    // Women's format: has 'champion' field explicitly set (string value, indicates complete season)
    // Men's format: no 'champion' field or champion is null/undefined, uses m4 to determine completeness
    
    const hasChampion = sd.champion && typeof sd.champion === 'string';
    
    // For women (or any format with champion): count if champion is set
    if(hasChampion && sd.standings){
      sd.standings.forEach((team,idx)=>{
        const club = team.club;
        if(!club)return;
        if(!placeCount[club])placeCount[club]={titles:0,runnerUp:0,third:0,fourth:0,fifth:0,sixth:0};
        if(!clubSeasons[club])clubSeasons[club]=new Set();
        clubSeasons[club].add(season);
        if(idx===0)placeCount[club].titles++;
        if(idx===1)placeCount[club].runnerUp++;
        if(idx===2)placeCount[club].third++;
        if(idx===3)placeCount[club].fourth++;
        if(idx===4)placeCount[club].fifth++;
        if(idx===5)placeCount[club].sixth++;
      });
      return;
    }
    // Handle historical format with just champion (no standings)
    if(hasChampion && !sd.standings){
      if(!placeCount[sd.champion])placeCount[sd.champion]={titles:0,runnerUp:0,third:0,fourth:0,fifth:0,sixth:0};
      if(!clubSeasons[sd.champion])clubSeasons[sd.champion]=new Set();
      clubSeasons[sd.champion].add(season);
      placeCount[sd.champion].titles++;
      return;
    }
    // Handle men's format: no champion field, standings array with m1,m2,m3,m4 fields
    if(!sd?.standings)return;
    const isHist=sd.historical;
    const hasM4=sd.standings[0]?.m4!==null&&sd.standings[0]?.m4!==undefined||isHist;
    if(!hasM4)return;// Only count complete seasons
    sd.standings.forEach((team,idx)=>{
      if(!placeCount[team.club])placeCount[team.club]={titles:0,runnerUp:0,third:0,fourth:0,fifth:0,sixth:0};
      if(!clubSeasons[team.club])clubSeasons[team.club]=new Set();
      clubSeasons[team.club].add(season);
      if(idx===0)placeCount[team.club].titles++;
      if(idx===1)placeCount[team.club].runnerUp++;
      if(idx===2)placeCount[team.club].third++;
      if(idx===3)placeCount[team.club].fourth++;
      if(idx===4)placeCount[team.club].fifth++;
      if(idx===5)placeCount[team.club].sixth++;
    });
  });
  // Add any clubs from standings that aren't in clubAllTime yet
  const existingClubsFromStandings=new Set(data.clubAllTime.map(c=>c.club));
  Object.keys(placeCount).forEach(club=>{
    if(!existingClubsFromStandings.has(club)){
      data.clubAllTime.push({club:club,titles:0,seconds:0,thirds:0,seasonCount:0});
    }
  });
  
  data.clubAllTime.forEach(c=>{
    if(placeCount[c.club]){
      c.titles=placeCount[c.club].titles;
      c.runnerUp=placeCount[c.club].runnerUp;
      c.seconds=placeCount[c.club].runnerUp; // Alias for ClubsView
      c.third=placeCount[c.club].third;
      c.thirds=placeCount[c.club].third; // Alias for ClubsView
      c.fourth=placeCount[c.club].fourth;
      c.fifth=placeCount[c.club].fifth;
      c.sixth=placeCount[c.club].sixth;
    }
    if(clubSeasons[c.club]){
      c.seasonCount=clubSeasons[c.club].size;
    }
  });
  // Re-sort clubAllTime by titles desc, then runnerUp desc
  data.clubAllTime.sort((a,b)=>(b.titles||0)-(a.titles||0)||(b.runnerUp||0)-(a.runnerUp||0)||(b.third||0)-(a.third||0));
  
  // Dynamically compute achievements from race data
  const computeAchievements=()=>{
    // Most wins in a single season
    const seasonWins={};
    data.races.forEach(race=>{
      if(!race.winner||race.deadHeat)return;
      const key=`${race.winner}|${race.winnerClub}|${race.season}`;
      seasonWins[key]=(seasonWins[key]||0)+1;
    });
    const mostWinsSeasonAll=Object.entries(seasonWins).map(([k,wins])=>{
      const[name,club,season]=k.split('|');
      return{name,club,season,wins};
    }).sort((a,b)=>b.wins-a.wins||a.season.localeCompare(b.season));
    // Deduplicate by athlete - show only their best season
    const seenAthletes=new Set();
    const mostWinsSeason=mostWinsSeasonAll.filter(a=>{
      const key=normalizeNameForCompare(a.name);
      if(seenAthletes.has(key))return false;
      seenAthletes.add(key);
      return true;
    }).slice(0,5);
    
    // Consecutive wins (across seasons) - sort by season then match, not by date string
    const winnersByDate=data.races.filter(r=>r.winner&&!r.deadHeat).sort((a,b)=>a.season.localeCompare(b.season)||a.match-b.match);
    const streaks={};
    let lastWinner=null;
    winnersByDate.forEach(race=>{
      const key=normalizeNameForCompare(race.winner);
      if(!streaks[key])streaks[key]={name:race.winner,club:race.winnerClub,current:0,max:0};
      if(lastWinner===key){
        streaks[key].current++;
      }else{
        streaks[key].current=1;
      }
      streaks[key].max=Math.max(streaks[key].max,streaks[key].current);
      lastWinner=key;
    });
    const mostConsecutiveWins=Object.values(streaks).map(s=>({name:s.name,club:s.club,streak:s.max})).sort((a,b)=>b.streak-a.streak).slice(0,5);
    
    // Biggest races by finishers
    const biggestRaces=data.races.filter(r=>r.finishers).sort((a,b)=>b.finishers-a.finishers).slice(0,5).map(r=>({venue:r.venue,season:r.season,match:r.match,date:r.date,finishers:r.finishers}));
    
    // Most consecutive titles by club
    const seasonsByYear=Object.keys(data.seasonsData).filter(s=>{
      const sd=data.seasonsData[s];
      return sd?.standings?.length&&(sd.standings[0]?.m4!==null||sd.historical);
    }).sort();
    const clubStreaks={};
    let lastChamp=null;
    seasonsByYear.forEach(season=>{
      const champ=data.seasonsData[season]?.standings?.[0]?.club;
      if(!champ)return;
      if(!clubStreaks[champ])clubStreaks[champ]={current:0,max:0};
      if(lastChamp===champ){
        clubStreaks[champ].current++;
      }else{
        clubStreaks[champ].current=1;
      }
      clubStreaks[champ].max=Math.max(clubStreaks[champ].max,clubStreaks[champ].current);
      lastChamp=champ;
    });
    const mostConsecutiveTitles=Object.entries(clubStreaks).map(([club,s])=>({club,streak:s.max})).sort((a,b)=>b.streak-a.streak).slice(0,5);
    
    // Best turnout by club at a single race
    const turnouts=[];
    data.races.forEach(race=>{
      if(!race.results)return;
      const clubCounts={};
      race.results.forEach(r=>{
        clubCounts[r.club]=(clubCounts[r.club]||0)+1;
      });
      Object.entries(clubCounts).forEach(([club,count])=>{
        turnouts.push({club,count,venue:race.venue,season:race.season,match:race.match,date:race.date});
      });
    });
    const biggestTurnouts=turnouts.sort((a,b)=>b.count-a.count).slice(0,5);
    
    return{mostWinsSeason,mostConsecutiveWins,biggestRaces,mostConsecutiveTitles,biggestTurnouts};
  };
  data.achievements=computeAchievements();
  
  // Dynamically compute club MVPs (GOATs) from race data using value score
  const computeClubMvps=()=>{
    const TEAM_SIZE_A=10;
    const clubAthletes={};
    
    // Go through all races to compute value scores per club
    data.races.forEach(race=>{
      if(!race.results?.length){
        // Handle races without full results (only winner info)
        if(race.winners){
          race.winners.forEach(w=>{
            if(!w.club)return;
            const key=normalizeNameForCompare(w.name);
            if(!clubAthletes[w.club])clubAthletes[w.club]={};
            if(!clubAthletes[w.club][key])clubAthletes[w.club][key]={name:w.name,value:0,aScores:0,races:0};
            clubAthletes[w.club][key].value+=TEAM_SIZE_A;
            clubAthletes[w.club][key].aScores++;
            clubAthletes[w.club][key].races++;
          });
        }else if(race.winner&&race.winnerClub){
          const key=normalizeNameForCompare(race.winner);
          if(!clubAthletes[race.winnerClub])clubAthletes[race.winnerClub]={};
          if(!clubAthletes[race.winnerClub][key])clubAthletes[race.winnerClub][key]={name:race.winner,value:0,aScores:0,races:0};
          clubAthletes[race.winnerClub][key].value+=TEAM_SIZE_A;
          clubAthletes[race.winnerClub][key].aScores++;
          clubAthletes[race.winnerClub][key].races++;
        }
        return;
      }
      
      // Group results by club to determine A-team positions
      const clubResults={};
      race.results.forEach(r=>{
        if(!r.club||r.ns)return;
        if(!clubResults[r.club])clubResults[r.club]=[];
        clubResults[r.club].push(r);
      });
      
      // Assign value to each athlete based on their position within their club
      Object.entries(clubResults).forEach(([club,results])=>{
        if(!clubAthletes[club])clubAthletes[club]={};
        results.forEach((r,posInClub)=>{
          const key=normalizeNameForCompare(r.name);
          if(!clubAthletes[club][key])clubAthletes[club][key]={name:r.name,value:0,aScores:0,races:0};
          clubAthletes[club][key].races++;
          if(posInClub<TEAM_SIZE_A){
            clubAthletes[club][key].aScores++;
            clubAthletes[club][key].value+=(TEAM_SIZE_A-posInClub); // A1=10, A2=9, etc.
          }
        });
      });
    });
    
    // Convert to sorted arrays per club
    const mvps={};
    Object.entries(clubAthletes).forEach(([club,athletes])=>{
      const sorted=Object.values(athletes).sort((a,b)=>b.value-a.value||b.aScores-a.aScores||b.races-a.races);
      mvps[club]=sorted.slice(0,3).map((a,i)=>({...a,mvpRank:i+1}));
    });
    return mvps;
  };
  data.clubMvps=computeClubMvps();
  
  // Compute individual champions with count of titles
  const computeIndividualChampions=()=>{
    const champions={};
    Object.values(data.seasonsData||{}).forEach(sd=>{
      if(sd.individualRankings?.length>0){
        const winner=sd.individualRankings[0];
        if(winner?.name){
          const key=normalizeNameForCompare(winner.name);
          champions[key]=(champions[key]||0)+1;
        }
      }
    });
    return champions;
  };
  data.individualChampions=computeIndividualChampions();
  
  return data;
};

function App(){
  const[view,setViewState]=useState({type:'home'});
  const[division,setDivisionState]=useState('men');
  const[menData,setMenData]=useState(null);
  const[womenData,setWomenData]=useState(null);
  const[cmsContent,setCmsContent]=useState({});
  const[liveAliases,setLiveAliases]=useState({});
  const[loading,setLoading]=useState(true);
  const[error,setError]=useState(null);
  
  // Get current data based on division
  const data=division==='women'?womenData:menData;
  const divisionConfig=DIVISIONS[division];
  
  const setView=(v)=>{setViewState(v);updateUrl(v,division);};
  const setDivision=(d)=>{
    setDivisionState(d);
    // Preserve current view type and context where appropriate
    const preservedTypes = ['home', 'fixtures', 'seasons', 'athletes', 'clubs', 'h2h'];
    let newView;
    if(view.type === 'club' && view.club) {
      // Stay on same club when switching division
      newView = {type: 'club', club: view.club};
    } else if(preservedTypes.includes(view.type)) {
      newView = {type: view.type};
    } else {
      newView = {type: 'home'};
    }
    setViewState(newView);
    updateUrl(newView, d);
  };
  
  // Load men's data on mount
  useEffect(()=>{
    // Load aliases first (if configured), then data
    const loadAliases = ALIASES_URL 
      ? fetch(ALIASES_URL).then(r=>r.text()).then(csv=>parseAliases(csv)).catch(()=>({}))
      : Promise.resolve({});
    
    Promise.all([
      fetch('data.json').then(r=>r.json()),
      loadAliases
    ]).then(([j, aliases])=>{
      setLiveAliases(aliases);
      setMenData(normalizeData(j,'men',aliases));
      setLoading(false);
    }).catch(e=>{setError(e.message);setLoading(false);});
    
    // Load CMS content from Google Sheet if URL is configured
    if(CMS_URL){
      fetch(CMS_URL)
        .then(r=>r.text())
        .then(csv=>setCmsContent(parseCmsContent(csv)))
        .catch(e=>console.warn('CMS content load failed:',e));
    }
  },[]);
  
  // Load women's data when switching to women or viewing chartroom (lazy load)
  useEffect(()=>{
    if((division==='women'||view.type==='chartroom')&&!womenData){
      setLoading(true);
      fetch('data-women.json').then(r=>r.json()).then(j=>{
        setWomenData(normalizeData(j,'women',liveAliases));
        setLoading(false);
      }).catch(e=>{setError(e.message);setLoading(false);});
    }
  },[division,womenData,view.type,liveAliases]);
  
  // Parse URL once data is loaded (needed for athlete name resolution)
  useEffect(()=>{
    if(menData){
      const parsed=parseUrlParams(menData.athletes);
      // Set division from URL
      if(parsed.division&&parsed.division!==division){
        setDivisionState(parsed.division);
      }
      if(parsed.division==='men'||!parsed.division){
        if(parsed.raceKey){
          const race=menData.races.find(r=>r.season===parsed.raceKey.season&&r.match===parsed.raceKey.match);
          if(race)setViewState({type:'race',race});else setViewState(parsed);
        }else{setViewState(parsed);}
      }
    }
  },[menData]);
  
  // Handle women's URL parsing after women's data loads
  useEffect(()=>{
    if(womenData&&division==='women'){
      const parsed=parseUrlParams(womenData.athletes);
      if(parsed.division==='women'){
        if(parsed.raceKey){
          const race=womenData.races.find(r=>r.season===parsed.raceKey.season&&r.match===parsed.raceKey.match);
          if(race)setViewState({type:'race',race});else setViewState(parsed);
        }else{setViewState(parsed);}
      }
    }
  },[womenData,division]);
  
  useEffect(()=>{
    const onPop=()=>{
      const parsed=parseUrlParams(data?.athletes);
      if(parsed.division!==division)setDivisionState(parsed.division||'men');
      if(parsed.raceKey&&data){
        const race=data.races.find(r=>r.season===parsed.raceKey.season&&r.match===parsed.raceKey.match);
        if(race)setViewState({type:'race',race});else setViewState(parsed);
      }else{setViewState(parsed);}
    };
    window.addEventListener('popstate',onPop);
    return()=>window.removeEventListener('popstate',onPop);
  },[data,division]);
  
  useEffect(()=>{
    const onHash=()=>{
      const parsed=parseUrlParams(data?.athletes);
      if(parsed.division!==division)setDivisionState(parsed.division||'men');
      if(parsed.raceKey&&data){
        const race=data.races.find(r=>r.season===parsed.raceKey.season&&r.match===parsed.raceKey.match);
        if(race)setViewState({type:'race',race});else setViewState(parsed);
      }else{setViewState(parsed);}
    };
    window.addEventListener('hashchange',onHash);
    return()=>window.removeEventListener('hashchange',onHash);
  },[data,division]);
  
  if(loading)return<div className="loading text-gray-500">Loading...</div>;
  if(error)return<div className="loading text-red-500">Error: {error}</div>;
  if(!data)return<div className="loading text-gray-500">No data</div>;
  
  return<div className="min-h-screen bg-white flex flex-col">
    <Nav setView={setView} division={division} setDivision={setDivision}/>
    <main className="flex-1">
      {view.type==='home'&&<HomeView setView={setView} data={data} initialSeason={view.urlSeason} division={division} divisionConfig={divisionConfig}/>}
      {view.type==='race'&&<RaceDetailView race={view.race} setView={setView} seasonsData={data.seasonsData} clubMvps={data.clubMvps} races={data.races} individualChampions={data.individualChampions} divisionConfig={divisionConfig}/>}
      {view.type==='fixtures'&&<FixturesView setView={setView} races={data.races} seasonsData={data.seasonsData}/>}
      {view.type==='seasons'&&<SeasonsView setView={setView} seasonsData={data.seasonsData} races={data.races} mitchellCupWinners={data.mitchellCupWinners} division={division}/>}
      {view.type==='athletes'&&<AthletesView setView={setView} athletes={data.athletes}/>}
      {view.type==='athlete'&&<AthleteDetailView athlete={view.athlete} setView={setView} athletes={data.athletes} races={data.races} clubMvps={data.clubMvps} seasonsData={data.seasonsData} mitchellCupWinners={data.mitchellCupWinners} divisionConfig={divisionConfig} athleteNee={data.athleteNee} cmsContent={cmsContent} division={division}/>}
      {view.type==='clubs'&&<ClubsView setView={setView} clubAllTime={data.clubAllTime}/>}
      {view.type==='club'&&<ClubDetailView clubCode={view.club} setView={setView} athletes={data.athletes} races={data.races} clubAllTime={data.clubAllTime} clubMvps={data.clubMvps} seasonsData={data.seasonsData} division={division} cmsContent={cmsContent}/>}
      {view.type==='h2h'&&<H2HView athletes={data.athletes} races={data.races} setView={setView} prefill={view.prefill}/>}
      {view.type==='quiz'&&<PubQuizView setView={setView}/>}
      {view.type==='submit'&&<SubmitView setView={setView}/>}
      {view.type==='chartroom'&&<ChartRoomView setView={setView} data={data} menData={menData} womenData={womenData}/>}
      {view.type==='origin'&&<OriginStoryView setView={setView} cmsContent={cmsContent}/>}
    </main>
    <Footer setView={setView}/>
  </div>;
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
