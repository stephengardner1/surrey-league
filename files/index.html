<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surrey League cross country - the unofficial archive</title>
  <meta property="og:title" content="Surrey League cross country - the unofficial archive">
  <meta property="og:description" content="Men's Division 1 results and statistics 1962-present üêê">
  <meta property="og:image" content="https://s.microlink.io/https://slarchive.org">
  <meta property="og:url" content="https://slarchive.org">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path d='M6 6L26 26M26 6L6 26' stroke='%2322c55e' stroke-width='5' stroke-linecap='round'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}.loading{display:flex;align-items:center;justify-content:center;height:100vh}[data-tip]{position:relative}[data-tip]:hover::after{content:attr(data-tip);position:absolute;top:100%;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;white-space:nowrap;z-index:50;margin-top:4px;font-weight:normal;text-transform:none}</style>
</head>
<body>
<div id="root"><div class="loading">Loading...</div></div>
<script type="text/babel">
const{useState,useMemo,useEffect}=React;
const normalizeNameForCompare=(name)=>name?.toLowerCase().trim()||'';
const namesMatch=(a,b)=>normalizeNameForCompare(a)===normalizeNameForCompare(b);
const getSurname=(name)=>{if(!name)return'';const parts=name.split(' ');return parts.length>1?parts[parts.length-1]:name;};
const CLUBS={'BEL':{name:'Belgrave Harriers'},'KEN':{name:'Kent AC'},'THH':{name:'Thames Hare & Hounds'},'HHH':{name:'Herne Hill Harriers'},'H/W':{name:'Hercules Wimbledon'},'SLH':{name:'South London Harriers'},'G&G':{name:'Guildford & Godalming'},'RAN':{name:'Ranelagh Harriers'},'C/C':{name:'Clapham Chasers'},'DUL':{name:'Dulwich Runners'},'HOL':{name:'Holland Sports'},'WAL':{name:'Walton AC'},'CRO':{name:'Croydon Harriers'},'WOK':{name:'Woking AC'},'E&E':{name:'Epsom & Ewell'},'FUL':{name:'Fulham RC'},'SOC':{name:'Striders of Croydon'},'BOX':{name:'Boxhill Racers'},'BOH':{name:'Borough of Hounslow'},'AFD':{name:'Aldershot Farnham & District'},'SUR':{name:'Surrey AC',desc:'Founding member 1962. Men\'s section later merged into Belgrave.'},'MIT':{name:'Mitcham AC',desc:'Founding member 1962. Later merged with Sutton & Cheam to form Sutton & District AC.'},'REI':{name:'Reigate Priory AC'},'DMV':{name:'Dorking & Mole Valley'},'STR':{name:'Stragglers Running Club'},'W4H':{name:'West 4 Harriers'},'W/W':{name:'Wimbledon Windmilers'},'K&P':{name:'Kingston & Polytechnic'}};

const ClubVest=({club,size=20})=>{
  const id=`v-${club}-${Math.random().toString(36).substr(2,5)}`;
  const p="M3 0 L6 0 Q7 4 10 5 Q13 4 14 0 L17 0 L17 20 L3 20 Z";
  const r=()=>{switch(club){
    case'KEN':return<><path d={p} fill="#2a4d7a"/><path d="M13 5 L15 5.5 L15 7.5 C15 8.5 14 9 13 9.5 C12 9 11 8.5 11 7.5 L11 5.5 Z" fill="#dc2626"/></>;
    case'H/W':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,0 6,0 20,20 14,20" fill="#c41e3a"/></g></>;
    case'THH':return<><path d={p} fill="#fff"/><line x1="6" y1="5" x2="14" y2="15" stroke="#1a1a1a" strokeWidth="2"/><line x1="14" y1="5" x2="6" y2="15" stroke="#1a1a1a" strokeWidth="2"/></>;
    case'BEL':return<><path d={p} fill="#7A001D"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="7" width="20" height="4" fill="#CCAD6A"/></g></>;
    case'HHH':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g></>;
    case'G&G':return<path d={p} fill="#228b22"/>;
    case'SLH':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="13" y="0" width="4" height="20" fill="#800020"/></g></>;
    case'DUL':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="2" fill="#1e3a8a"/><rect x="0" y="12" width="20" height="2" fill="#1e3a8a"/></g></>;
    case'HOL':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#fff"/></g></>;
    case'RAN':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'C/C':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="10" width="20" height="10" fill="#1e3a8a"/><rect x="0" y="9" width="20" height="2" fill="#228b22"/></g></>;
    case'WAL':return<><path d={p} fill="#1a1a1a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="2" fill="#f4c430"/><rect x="0" y="8" width="20" height="2" fill="#dc2626"/><rect x="0" y="10" width="20" height="2" fill="#f4c430"/></g></>;
    case'CRO':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="5" width="20" height="2" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="2" fill="#1a1a1a"/></g></>;
    case'WOK':return<><path d={p} fill="#ff6600"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#32CD32"/></g></>;
    case'E&E':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'FUL':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g></>;
    case'SOC':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#228b22"/><rect x="14" y="0" width="3" height="20" fill="#228b22"/></g></>;
    case'BOX':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g></>;
    case'BOH':return<><path d={p} fill="#87CEEB"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g></>;
    case'AFD':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="14" y="0" width="3" height="20" fill="#fff"/><rect x="0" y="6" width="20" height="3" fill="#228b22"/></g></>;
    case'SUR':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="1.5" fill="#2563eb"/><rect x="0" y="8" width="20" height="1.5" fill="#1a1a1a"/><rect x="0" y="10" width="20" height="1.5" fill="#2563eb"/></g><circle cx="10" cy="8.5" r="2.5" fill="none" stroke="#2563eb" strokeWidth="0.5"/></>;
    case'MIT':return<><path d={p} fill="#2563eb"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="5" width="20" height="1.5" fill="#fff"/><rect x="0" y="8" width="20" height="3" fill="#fff"/><rect x="0" y="12.5" width="20" height="1.5" fill="#fff"/></g></>;
    case'DMV':return<><path d={p} fill="#A52A2A"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#fff"/><rect x="14" y="0" width="3" height="20" fill="#fff"/></g></>;
    case'REI':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,0 6,0 20,14 20,20 14,20 0,6" fill="#87CEEB"/></g></>;
    case'STR':return<><path d={p} fill="#f4c430"/><text x="10" y="13" textAnchor="middle" fontSize="9" fontWeight="bold" fill="#1a1a1a">S</text></>;
    case'W4H':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="4" fill="#00CED1"/></g></>;
    case'W/W':return<><path d={p} fill="#1a1a1a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="4" fill="#dc2626"/></g></>;
    case'K&P':return<><path d={p} fill="#1E90FF"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="8,0 20,0 20,20 0,20 0,8" fill="#1a1a1a"/><polygon points="0,0 8,0 20,12 20,20 12,20 0,8" fill="#fff"/></g></>;
    default:return<path d={p} fill="#9ca3af"/>;
  }};
  return<svg width={size} height={size} viewBox="0 0 20 20" className="shrink-0">{r()}<path d={p} fill="none" stroke="#374151" strokeWidth="0.5"/></svg>;
};
const ClubShield=ClubVest;

// Generate club vest SVG as string for favicon
const getClubVestSvg=(club)=>{
  const p="M3 0 L6 0 Q7 4 10 5 Q13 4 14 0 L17 0 L17 20 L3 20 Z";
  const id=`fav-${club}`;
  const vestSvg={
    'KEN':`<path d="${p}" fill="#2a4d7a"/><path d="M13 5 L15 5.5 L15 7.5 C15 8.5 14 9 13 9.5 C12 9 11 8.5 11 7.5 L11 5.5 Z" fill="#dc2626"/>`,
    'H/W':`<path d="${p}" fill="#f4c430"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><polygon points="0,0 6,0 20,20 14,20" fill="#c41e3a"/></g>`,
    'THH':`<path d="${p}" fill="#fff"/><line x1="6" y1="5" x2="14" y2="15" stroke="#1a1a1a" stroke-width="2"/><line x1="14" y1="5" x2="6" y2="15" stroke="#1a1a1a" stroke-width="2"/>`,
    'BEL':`<path d="${p}" fill="#7A001D"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="7" width="20" height="4" fill="#CCAD6A"/></g>`,
    'HHH':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g>`,
    'G&G':`<path d="${p}" fill="#228b22"/>`,
    'SLH':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="13" y="0" width="4" height="20" fill="#800020"/></g>`,
    'DUL':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="6" width="20" height="2" fill="#1e3a8a"/><rect x="0" y="12" width="20" height="2" fill="#1e3a8a"/></g>`,
    'HOL':`<path d="${p}" fill="#1e3a8a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="3" fill="#fff"/></g>`,
    'RAN':`<path d="${p}" fill="#1e3a8a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g>`,
    'C/C':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="10" width="20" height="10" fill="#1e3a8a"/><rect x="0" y="9" width="20" height="2" fill="#228b22"/></g>`,
    'WAL':`<path d="${p}" fill="#1a1a1a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="6" width="20" height="2" fill="#f4c430"/><rect x="0" y="8" width="20" height="2" fill="#dc2626"/><rect x="0" y="10" width="20" height="2" fill="#f4c430"/></g>`,
    'CRO':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="5" width="20" height="2" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="2" fill="#1a1a1a"/></g>`,
    'WOK':`<path d="${p}" fill="#ff6600"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="3" fill="#32CD32"/></g>`,
    'E&E':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g>`,
    'FUL':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g>`,
    'SOC':`<path d="${p}" fill="#f4c430"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#228b22"/><rect x="14" y="0" width="3" height="20" fill="#228b22"/></g>`,
    'BOX':`<path d="${p}" fill="#f4c430"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g>`,
    'BOH':`<path d="${p}" fill="#87CEEB"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g>`,
    'AFD':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="14" y="0" width="3" height="20" fill="#fff"/><rect x="0" y="6" width="20" height="3" fill="#228b22"/></g>`,
    'SUR':`<path d="${p}" fill="#fff"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="6" width="20" height="1.5" fill="#2563eb"/><rect x="0" y="8" width="20" height="1.5" fill="#1a1a1a"/><rect x="0" y="10" width="20" height="1.5" fill="#2563eb"/></g><circle cx="10" cy="8.5" r="2.5" fill="none" stroke="#2563eb" stroke-width="0.5"/>`,
    'MIT':`<path d="${p}" fill="#2563eb"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="5" width="20" height="1.5" fill="#fff"/><rect x="0" y="8" width="20" height="3" fill="#fff"/><rect x="0" y="12.5" width="20" height="1.5" fill="#fff"/></g>`,
    'DMV':`<path d="${p}" fill="#A52A2A"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="3" y="0" width="3" height="20" fill="#fff"/><rect x="14" y="0" width="3" height="20" fill="#fff"/></g>`,
    'REI':`<path d="${p}" fill="#dc2626"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><polygon points="0,0 6,0 20,14 20,20 14,20 0,6" fill="#87CEEB"/></g>`,
    'STR':`<path d="${p}" fill="#f4c430"/><text x="10" y="13" text-anchor="middle" font-size="9" font-weight="bold" fill="#1a1a1a">S</text>`,
    'W4H':`<path d="${p}" fill="#f4c430"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="4" fill="#00CED1"/></g>`,
    'W/W':`<path d="${p}" fill="#1a1a1a"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><rect x="0" y="8" width="20" height="4" fill="#dc2626"/></g>`,
    'K&P':`<path d="${p}" fill="#1E90FF"/><defs><clipPath id="${id}"><path d="${p}"/></clipPath></defs><g clip-path="url(#${id})"><polygon points="8,0 20,0 20,20 0,20 0,8" fill="#1a1a1a"/><polygon points="0,0 8,0 20,12 20,20 12,20 0,8" fill="#fff"/></g>`
  };
  const content=vestSvg[club]||`<path d="${p}" fill="#9ca3af"/>`;
  return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">${content}<path d="${p}" fill="none" stroke="#374151" stroke-width="0.5"/></svg>`;
};

// Default site metadata
const DEFAULT_TITLE='Surrey League cross country - the unofficial archive';
const DEFAULT_FAVICON="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path d='M6 6L26 26M26 6L6 26' stroke='%2322c55e' stroke-width='5' stroke-linecap='round'/></svg>";
const DEFAULT_OG_IMAGE='https://s.microlink.io/https://slarchive.org';
const DEFAULT_OG_DESC="Men's Division 1 results and statistics 1962-present üêê";

// Hook to manage document metadata (title, favicon, og tags)
const useDocumentMeta=({title,favicon,ogImage,ogDesc})=>{
  useEffect(()=>{
    // Store original values on first run
    if(!window._originalMeta){
      window._originalMeta={
        title:document.title,
        favicon:document.querySelector('link[rel="icon"]')?.href,
        ogTitle:document.querySelector('meta[property="og:title"]')?.content,
        ogImage:document.querySelector('meta[property="og:image"]')?.content,
        ogDesc:document.querySelector('meta[property="og:description"]')?.content
      };
    }
    
    // Update title
    document.title=title||DEFAULT_TITLE;
    
    // Update favicon
    const faviconEl=document.querySelector('link[rel="icon"]');
    if(faviconEl){
      faviconEl.href=favicon||DEFAULT_FAVICON;
    }
    
    // Update OG tags
    const ogTitleEl=document.querySelector('meta[property="og:title"]');
    const ogImageEl=document.querySelector('meta[property="og:image"]');
    const ogDescEl=document.querySelector('meta[property="og:description"]');
    if(ogTitleEl)ogTitleEl.content=title||DEFAULT_TITLE;
    if(ogImageEl)ogImageEl.content=ogImage||DEFAULT_OG_IMAGE;
    if(ogDescEl)ogDescEl.content=ogDesc||DEFAULT_OG_DESC;
    
    // Cleanup: restore defaults when unmounting
    return()=>{
      document.title=DEFAULT_TITLE;
      if(faviconEl)faviconEl.href=DEFAULT_FAVICON;
      if(ogTitleEl)ogTitleEl.content=DEFAULT_TITLE;
      if(ogImageEl)ogImageEl.content=DEFAULT_OG_IMAGE;
      if(ogDescEl)ogDescEl.content=DEFAULT_OG_DESC;
    };
  },[title,favicon,ogImage,ogDesc]);
};

const PositionChange=({change})=>{if(change===0||change===null||change===undefined)return null;if(change>0)return<span className="w-3 text-center text-green-600 text-xs font-bold">‚Üë</span>;return<span className="w-3 text-center text-red-600 text-xs font-bold">‚Üì</span>;};
const ClubName=({club,className=''})=><><span className={`md:hidden ${className}`}>{club}</span><span className={`hidden md:inline ${className}`}>{CLUBS[club]?.name||club}</span></>;
const ChevronLeft=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 18l-6-6 6-6"/></svg>;
const ChevronRight=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>;
const ArrowLeft=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>;
const X=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>;
const ChevronDown=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9l6 6 6-6"/></svg>;
const ChevronUp=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 15l-6-6-6 6"/></svg>;
const Sparkles=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 3v1m0 16v1m-8-9h1m16 0h1m-2.636-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>;
const Send=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>;
const formatDate=(d)=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
const formatDateShort=(d)=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
const formatDateMonthYear=(d)=>new Date(d).toLocaleDateString('en-GB',{month:'short',year:'numeric'});

const Nav=({setView})=><nav className="border-b border-gray-200 bg-white sticky top-0 z-50"><div className="max-w-5xl mx-auto px-2 md:px-4 flex items-center justify-between h-12"><div className="cursor-pointer hidden md:block" onClick={()=>setView({type:'home'})}><span className="text-sm text-gray-500">Unofficial archive of the world's greatest cross country competition</span></div><div className="flex gap-0.5 md:gap-1 text-xs md:text-sm w-full md:w-auto justify-between md:justify-end"><button onClick={()=>setView({type:'home'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50"><span className="md:hidden">Tables</span><span className="hidden md:inline">Standings</span></button><button onClick={()=>setView({type:'fixtures'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50"><span className="md:hidden">Races</span><span className="hidden md:inline">Fixtures</span></button><button onClick={()=>setView({type:'seasons'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Winners</button><button onClick={()=>setView({type:'athletes'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Athletes</button><button onClick={()=>setView({type:'clubs'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Clubs</button><button onClick={()=>setView({type:'h2h'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">H2H</button></div></div></nav>;

const SeasonSelector=({season,setSeason,seasons})=>{
  const[showDropdown,setShowDropdown]=useState(false);
  const idx=seasons.indexOf(season);
  const dropdownRef=React.useRef(null);
  
  React.useEffect(()=>{
    const handleClick=(e)=>{if(dropdownRef.current&&!dropdownRef.current.contains(e.target))setShowDropdown(false);};
    document.addEventListener('mousedown',handleClick);
    return()=>document.removeEventListener('mousedown',handleClick);
  },[]);
  
  return<div className="flex items-center gap-2 relative" ref={dropdownRef}>
    <button onClick={()=>idx<seasons.length-1&&setSeason(seasons[seasons.length-1])} className={`text-xs ${idx<seasons.length-1?'text-gray-500 hover:text-gray-900':'text-gray-300 cursor-default'}`}>Earliest</button>
    <div className="flex items-center">
      <button onClick={()=>idx<seasons.length-1&&setSeason(seasons[idx+1])} className={`p-0.5 rounded ${idx<seasons.length-1?'hover:bg-gray-100 text-gray-600':'text-gray-300'}`}><ChevronLeft className="w-5 h-5"/></button>
      <span className="text-base font-semibold text-gray-900 min-w-[5rem] text-center cursor-pointer hover:text-[#0077b6]" onClick={()=>setShowDropdown(!showDropdown)}>{season}</span>
      <button onClick={()=>idx>0&&setSeason(seasons[idx-1])} className={`p-0.5 rounded ${idx>0?'hover:bg-gray-100 text-gray-600':'text-gray-300'}`}><ChevronRight className="w-5 h-5"/></button>
    </div>
    <button onClick={()=>idx>0&&setSeason(seasons[0])} className={`text-xs ${idx>0?'text-gray-500 hover:text-gray-900':'text-gray-300 cursor-default'}`}>Latest</button>
    {showDropdown&&<div className="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto py-1">
      {seasons.map(s=><div key={s} className={`px-4 py-1 text-sm cursor-pointer hover:bg-gray-100 ${s===season?'font-semibold text-[#0077b6]':'text-gray-700'}`} onClick={()=>{setSeason(s);setShowDropdown(false);}}>{s}</div>)}
    </div>}
  </div>;
};

const TeamResultsTable=({results,startPos=1,count=10,finishers})=>{
  const teams=useMemo(()=>{
    const clubScores={};
    const clubScoringCounts={};
    const aTeamClubs = new Set();
    const isATeam = startPos === 1;
    
    // First pass: count A team clubs (needed for B team penalty calc)
    results.forEach(r=>{
      if(r.pts != null) aTeamClubs.add(r.club);
    });
    
    // Second pass: collect scores
    results.forEach(r=>{
      const hasPts = isATeam ? (r.pts != null) : (r.b_pts != null);
      const pts = isATeam ? r.pts : r.b_pts;
      if(!clubScoringCounts[r.club]) clubScoringCounts[r.club] = 0;
      if(!clubScores[r.club]) clubScores[r.club] = [];
      if(hasPts) {
        clubScoringCounts[r.club]++;
        if(clubScoringCounts[r.club] <= count) {
          clubScores[r.club].push(pts);
        }
      }
    });
    
    /*
     * SURREY LEAGUE PENALTY SCORING FORMULA
     * =====================================
     * When a team fields fewer than 10 eligible runners, they receive penalty points.
     * 
     * The penalty is calculated MATCH-WIDE as follows:
     * 1. Count total actual scorers across all teams (capped at 10 per team)
     * 2. Count total missing positions across all teams (sum of 10 - runners for each incomplete team)
     * 3. The missing positions are: totalScorers+1, totalScorers+2, ..., totalScorers+totalMissing
     * 4. Average all missing positions: (sum of missing positions) / totalMissing
     * 5. Every missing runner (regardless of team) gets this same average as their penalty
     *
     * Examples:
     * - 8-club match, all complete: 80 scorers, no penalties
     * - 8-club match, 1 team missing 1: 79 scorers, missing pos [80], penalty = 80
     * - 8-club match, 2 teams missing 1 each: 78 scorers, missing pos [79,80], penalty = 79.5 each
     * - 8-club match, 1 team missing 2, 1 missing 1: 77 scorers, missing pos [78,79,80], penalty = 79 each
     * - 9-club match, 1 team missing 1: 89 scorers, missing pos [90], penalty = 90
     * - 10-club match, 1 team missing 1: 99 scorers, missing pos [100], penalty = 100
     *
     * This formula scales automatically with the number of clubs in the match.
     */
    const totalScorers = Object.values(clubScores).reduce((sum, scores) => sum + scores.length, 0);
    const totalMissing = Object.values(clubScores).reduce((sum, scores) => sum + Math.max(0, count - scores.length), 0);
    const missingPositions = Array.from({length: totalMissing}, (_, i) => totalScorers + 1 + i);
    const avgPenalty = totalMissing > 0 ? missingPositions.reduce((a,b) => a+b, 0) / totalMissing : 0;
    
    return Object.entries(clubScores).map(([club,scores])=>{
      const missing = count - scores.length;
      const penalties = missing > 0 ? Array(missing).fill(avgPenalty) : [];
      const allScores = [...scores, ...penalties];
      return {club, points: allScores.reduce((a,b)=>a+b,0), scores, penalties, penaltyScore: avgPenalty, complete: scores.length >= count};
    }).filter(t=>t.scores.length>0).sort((a,b)=>a.points-b.points).map((t,i)=>({...t,pos:i+1}));
  },[results,startPos,count,finishers]);
  
  const penaltyValue = teams.find(t=>t.penalties.length>0)?.penaltyScore;
  return<div><table className="w-full"><thead><tr className="border-b-2 border-[#0077b6] bg-gray-50"><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-12">Pos</th><th className="w-8"></th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase">Club</th><th className="text-right py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-20">Points</th><th className="text-left py-2 px-4 text-xs font-semibold text-[#0077b6] uppercase">Scores</th></tr></thead><tbody className="divide-y divide-gray-100">{teams.map(team=><tr key={team.club} className="hover:bg-gray-50"><td className="py-2 px-2 text-sm text-gray-700 tabular-nums">{team.pos}</td><td className="py-2 px-1"><ClubShield club={team.club} size={20}/></td><td className="py-2 px-2 text-sm font-medium text-gray-900">{team.club}</td><td className="py-2 px-2 text-sm font-bold text-gray-900 text-right tabular-nums">{Number.isInteger(team.points)?team.points:team.points.toFixed(1)}</td><td className="py-2 px-4"><div className="flex flex-wrap gap-1.5">{team.scores.map((s,i)=><span key={i} className="text-xs text-gray-500 tabular-nums border border-gray-200 px-1 rounded">{s}</span>)}{team.penalties.map((p,i)=><span key={`p${i}`} className="text-xs text-red-400 tabular-nums border border-red-200 px-1 rounded" title="Penalty score">*</span>)}{!team.complete&&team.penalties.length===0&&<span className="text-xs text-gray-300 italic ml-1">incomplete</span>}</div></td></tr>)}</tbody></table>{penaltyValue&&<p className="text-xs text-gray-400 mt-2">* Penalty = {Number.isInteger(penaltyValue)?penaltyValue:penaltyValue.toFixed(1)} pts each</p>}</div>;
};

const TeamResultsTableCompact=({results,startPos=1,count=10,finishers,title})=>{
  const teams=useMemo(()=>{
    const clubScores={};
    const clubScoringCounts={};
    const aTeamClubs = new Set();
    const isATeam = startPos === 1;
    results.forEach(r=>{if(r.pts != null) aTeamClubs.add(r.club);});
    results.forEach(r=>{
      const hasPts = isATeam ? (r.pts != null) : (r.b_pts != null);
      const pts = isATeam ? r.pts : r.b_pts;
      if(!clubScoringCounts[r.club]) clubScoringCounts[r.club] = 0;
      if(!clubScores[r.club]) clubScores[r.club] = [];
      if(hasPts) {
        clubScoringCounts[r.club]++;
        if(clubScoringCounts[r.club] <= count) clubScores[r.club].push(pts);
      }
    });
    // Surrey League penalty: see full formula documentation in TeamResultsTable above
    // Penalty = average of all missing positions across ALL teams in the match
    const totalScorers = Object.values(clubScores).reduce((sum, scores) => sum + scores.length, 0);
    const totalMissing = Object.values(clubScores).reduce((sum, scores) => sum + Math.max(0, count - scores.length), 0);
    const missingPositions = Array.from({length: totalMissing}, (_, i) => totalScorers + 1 + i);
    const avgPenalty = totalMissing > 0 ? missingPositions.reduce((a,b) => a+b, 0) / totalMissing : 0;
    return Object.entries(clubScores).map(([club,scores])=>{
      const missing = count - scores.length;
      const penalties = missing > 0 ? Array(missing).fill(avgPenalty) : [];
      const allScores = [...scores, ...penalties];
      return {club, points: allScores.reduce((a,b)=>a+b,0), scores, penalties, penaltyScore: avgPenalty, complete: scores.length >= count};
    }).filter(t=>t.scores.length>0).sort((a,b)=>a.points-b.points).map((t,i)=>({...t,pos:i+1}));
  },[results,startPos,count,finishers]);
  
  const penaltyValue = teams.find(t=>t.penalties.length>0)?.penaltyScore;
  return<div><table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 text-xs font-semibold text-gray-900 uppercase tracking-wide" colSpan="3">{title||'Club'}</th><th className="text-right py-1.5 px-2 text-xs text-gray-500 uppercase w-12">Pts</th><th className="text-left py-1.5 pl-2 text-xs text-gray-500 uppercase">Scores</th></tr></thead><tbody className="divide-y divide-gray-50">{teams.map(team=><tr key={team.club}><td className="py-1.5 text-gray-500 w-6 tabular-nums">{team.pos}</td><td className="py-1.5 w-6"><ClubShield club={team.club} size={16}/></td><td className="py-1.5 font-medium text-gray-900">{team.club}</td><td className="py-1.5 px-2 font-bold text-gray-900 text-right tabular-nums">{Number.isInteger(team.points)?team.points:team.points.toFixed(1)}</td><td className="py-1.5 pl-2"><div className="flex flex-wrap gap-x-0.5 tabular-nums text-xs text-gray-500">{team.scores.map((s,i)=><span key={i} className="w-6 text-center">{s}</span>)}{team.penalties.map((p,i)=><span key={`p${i}`} className="w-6 text-center text-red-400">*</span>)}</div></td></tr>)}</tbody></table>{penaltyValue&&<p className="text-xs text-gray-400 mt-2">* Penalty = {Number.isInteger(penaltyValue)?penaltyValue:penaltyValue.toFixed(1)} pts</p>}</div>;
};

const KnownTeamScoresTable=({scores,title})=>{
  if(!scores?.length)return null;
  return<div><table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 text-xs font-semibold text-gray-900 uppercase tracking-wide" colSpan="3">{title||'A Teams'}</th><th className="text-right py-1.5 px-2 text-xs text-gray-500 uppercase w-16">Pts</th></tr></thead><tbody className="divide-y divide-gray-50">{scores.map(team=><tr key={team.club}><td className="py-1.5 text-gray-500 w-6 tabular-nums">{team.pos}</td><td className="py-1.5 w-6"><ClubShield club={team.club} size={16}/></td><td className="py-1.5 font-medium text-gray-900">{CLUBS[team.club]?.name||team.club}</td><td className="py-1.5 px-2 font-bold text-gray-900 text-right tabular-nums">{team.pts}</td></tr>)}</tbody></table><p className="text-xs text-gray-400 mt-2">* From archived results</p></div>;
};

const IndividualResultsTable=({results,clubFilter,setClubFilter,setView,clubMvps,individualChampions})=>{
  const filtered=clubFilter?results.filter(r=>r.club===clubFilter):results;
  const isClubGoat=(name,club)=>{const mvps=clubMvps?.[club];return mvps&&namesMatch(mvps[0]?.name,name);};
  const getChampionStars=(name)=>{const count=individualChampions?.[normalizeNameForCompare(name)]||0;return count>0?'‚≠ê'.repeat(Math.min(count,2)):'';};
  return<div>{clubFilter&&<div className="mb-4 flex items-center gap-2 text-sm"><span className="text-gray-500">Showing:</span><span className="flex items-center gap-2 bg-gray-100 px-2 py-1 rounded"><ClubShield club={clubFilter} size={16}/><span className="font-medium">{CLUBS[clubFilter]?.name||clubFilter}</span><button onClick={()=>setClubFilter(null)} className="text-gray-400 hover:text-gray-600"><X className="w-4 h-4"/></button></span></div>}<table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 text-xs font-semibold text-gray-900 uppercase tracking-wide w-10">Pos</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase w-10">Pts</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase w-16">Club</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase">Name</th><th className="text-right py-1.5 text-xs text-gray-500 uppercase w-14">Time</th></tr></thead><tbody className="divide-y divide-gray-100">{filtered.map((r,i)=><tr key={i} className="hover:bg-blue-50"><td className="py-1.5 text-sm text-gray-700 tabular-nums">{r.pos}</td><td className="py-1.5 px-2 text-sm text-gray-500 tabular-nums">{r.pts||'-'}</td><td className="py-1.5 px-2"><span className="flex items-center gap-1 cursor-pointer" onClick={()=>setClubFilter(r.club)}><ClubShield club={r.club} size={14}/><span className="text-xs text-gray-500">{r.club}</span></span></td><td className="py-1.5 px-2"><span className="text-sm text-gray-900 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:r.name,club:r.club}})}>{r.name}{getChampionStars(r.name)&&<span className="text-xs" title="Has won individual Surrey League title(s)"> {getChampionStars(r.name)}</span>}{isClubGoat(r.name,r.club)&&<span className="text-xs" title={`Is ${CLUBS[r.club]?.name||r.club}'s greatest A-team scorer of all time`}> üêê</span>}{r.ns&&<span className="text-gray-400 ml-1">(N/S)</span>}{r.secondClaim&&<span className="text-gray-400 ml-1">(2C)</span>}</span></td><td className="py-1.5 text-sm text-gray-700 text-right tabular-nums font-mono">{r.time}</td></tr>)}</tbody></table></div>;
};

const RaceDetailView=({race,setView,seasonsData,clubMvps,races,individualChampions})=>{
  const[tab,setTab]=useState('individual');const[clubFilter,setClubFilter]=useState(null);const[statusHover,setStatusHover]=useState(false);if(!race)return null;
  const seasonData=seasonsData[race.season];const matchData=seasonData?.matches?.find(m=>m.num===race.match);const teamWinner=matchData?.teamWinner||race.teamWinner||(race.teamScores?.[0]?.club);
  
  // Format season as yyyy/yy (or yyyy/yyyy for millennium crossover)
  const formatSeasonFull=(s)=>{const p=s.split('/');if(p.length!==2)return s;const y1=p[0].length===4?p[0]:(parseInt(p[0])<50?'20':'19')+p[0];const y2Short=p[1].length===4?p[1].slice(-2):p[1];const y2Full=p[1].length===4?p[1]:(parseInt(p[1])<50?'20':'19')+p[1];const isCrossover=y1.slice(0,2)!==y2Full.slice(0,2);return isCrossover?`${y1}/${y2Full}`:`${y1}/${y2Short}`;};
  
  // Determine results status
  const resultsStatus=race.results?.length>=100?'complete':race.results?.length>=4?'partial':'winners';
  const statusColor=resultsStatus==='complete'?'bg-green-500':resultsStatus==='partial'?'bg-amber-500':'bg-red-500';
  const statusText=resultsStatus==='complete'?'Complete results':resultsStatus==='partial'?'Partial results':'Winners\' data only';
  
  // Check if we have full results with pts field - if so, calculate team scores dynamically
  // Only fall back to knownTeamScores/teamScores if we don't have calculable results
  const hasCalculableResults = race.results?.length > 100 && race.results.some(r => r.pts != null);
  const displayTeamScores = hasCalculableResults ? null : (race.knownTeamScores?.map((t,i)=>({club:t.club,pos:t.pos||i+1,pts:t.points||t.pts}))||(race.teamScores?.map((t,i)=>({club:t.club,pos:i+1,pts:t.score}))));
  
  // Find prev/next races
  const sortedRaces=useMemo(()=>[...races].filter(r=>r.results?.length>0).sort((a,b)=>{if(a.season!==b.season)return a.season.localeCompare(b.season);return a.match-b.match;}),[races]);
  const currentIdx=sortedRaces.findIndex(r=>r.season===race.season&&r.match===race.match);
  const prevRace=currentIdx>0?sortedRaces[currentIdx-1]:null;
  const nextRace=currentIdx<sortedRaces.length-1?sortedRaces[currentIdx+1]:null;
  
  // Count individual winner's race wins up to and including this race, and total career wins
  const {winnerWinCount, winnerTotalWins}=useMemo(()=>{
    if(!race.winner)return {winnerWinCount:0, winnerTotalWins:0};
    const winnerName=normalizeNameForCompare(race.winner);
    let count=0, total=0, foundCurrent=false;
    for(const r of races){
      if(r.winner&&normalizeNameForCompare(r.winner)===winnerName){
        total++;
        if(!foundCurrent){
          count++;
          if(r.season===race.season&&r.match===race.match)foundCurrent=true;
        }
      }
    }
    return {winnerWinCount:count, winnerTotalWins:total};
  },[race,races]);
  
  const getOrdinal=(n)=>{const s=['th','st','nd','rd'];const v=n%100;return n+(s[(v-20)%10]||s[v]||s[0]);};
  
  // Generate the race win text with proper grammar
  const raceWinText=useMemo(()=>{
    if(!race.winner||winnerWinCount===0)return null;
    const name=race.winner;
    const possessive=name.endsWith('s')?`${name}'`:`${name}'s`;
    if(winnerTotalWins===1)return <span><span className="font-medium text-gray-700">{possessive}</span> only win in Div 1</span>;
    return <span><span className="font-medium text-gray-700">{possessive}</span> {getOrdinal(winnerWinCount)} of {winnerTotalWins} wins in Div 1</span>;
  },[race.winner,winnerWinCount,winnerTotalWins]);
  
  return<div className="max-w-6xl mx-auto px-4 py-8">
    <div className="flex items-center justify-between mb-4">
      <button onClick={()=>setView({type:'fixtures'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900"><ArrowLeft className="w-4 h-4"/>Fixtures</button>
      <div className="flex items-center gap-2">
        {prevRace?<button onClick={()=>setView({type:'race',race:prevRace})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 px-2 py-1 rounded hover:bg-gray-100"><ChevronLeft className="w-4 h-4"/><span className="hidden sm:inline">{prevRace.venue}</span><span className="sm:hidden">Prev</span></button>:<span className="w-16"/>}
        {nextRace?<button onClick={()=>setView({type:'race',race:nextRace})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 px-2 py-1 rounded hover:bg-gray-100"><span className="hidden sm:inline">{nextRace.venue}</span><span className="sm:hidden">Next</span><ChevronRight className="w-4 h-4"/></button>:<span className="w-16"/>}
      </div>
    </div>
    <div className="mb-6"><div className="text-sm text-gray-500 mb-1">{race.date&&race.date.includes('-')&&race.date.length>=10?formatDate(race.date):(()=>{const months=['Oct','Nov','Dec','Jan','Feb'];const p=race.season.split('/');if(p.length===2&&race.match>=1&&race.match<=4){const y1=parseInt(p[0]),m=months[race.match-1]||'';return m?m+" '"+(race.match>=4?String(y1+1).slice(-2):String(y1).slice(-2)):race.season;}return race.season;})()} ¬∑ Match {race.match} ¬∑ <span className="cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'home',urlSeason:race.season})}>{formatSeasonFull(race.season)}</span></div><div className="flex items-center gap-2"><h1 className="text-2xl font-bold text-gray-900">{race.venue}</h1><div className="relative flex items-center gap-2" onMouseEnter={()=>setStatusHover(true)} onMouseLeave={()=>setStatusHover(false)}><span className={`inline-block w-2 h-2 rounded-full ${statusColor}`}></span>{statusHover&&<div className="absolute left-0 bottom-full mb-1 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">{statusText}</div>}{resultsStatus!=='complete'&&<span className="text-xs text-gray-400 hover:text-[#0077b6] cursor-pointer" onClick={()=>setView({type:'submit'})}>Submit more results</span>}</div></div>{teamWinner&&<p className="text-sm text-gray-700 mt-1 flex items-center gap-1.5"><ClubShield club={teamWinner} size={16}/><span><span className="font-medium">{CLUBS[teamWinner]?.name||teamWinner}</span> <span className="text-gray-500">won the match</span></span></p>}{raceWinText&&<p className="text-sm text-gray-700 mt-1 flex items-center gap-1.5"><ClubShield club={race.winnerClub} size={16}/><span className="text-gray-500">{raceWinText}</span></p>}</div>
    
    {/* Mobile: tabs */}
    <div className="lg:hidden">
      <div className="flex gap-4 mb-6 border-b border-gray-200">{[{id:'individual',label:'Individual'},{id:'a-teams',label:'A Teams'},{id:'b-teams',label:'B Teams'}].map(t=><button key={t.id} onClick={()=>{setTab(t.id);setClubFilter(null);}} className={`pb-2 text-sm font-medium border-b-2 -mb-px transition-colors ${tab===t.id?'border-[#0077b6] text-[#0077b6]':'border-transparent text-gray-500 hover:text-gray-700'}`}>{t.label}</button>)}</div>
      {tab==='a-teams'&&(displayTeamScores?<KnownTeamScoresTable scores={displayTeamScores} title="A Teams"/>:<TeamResultsTable results={race.results} startPos={1} count={10} finishers={race.finishers}/>)}
      {tab==='b-teams'&&!displayTeamScores&&<TeamResultsTable results={race.results} startPos={11} count={10} finishers={race.finishers}/>}
      {tab==='b-teams'&&displayTeamScores&&<p className="text-sm text-gray-500">B team scores not available for this race.</p>}
      {tab==='individual'&&<IndividualResultsTable results={race.results} clubFilter={clubFilter} setClubFilter={setClubFilter} setView={setView} clubMvps={clubMvps} individualChampions={individualChampions}/>}
    </div>
    
    {/* Desktop: side by side */}
    <div className="hidden lg:grid lg:grid-cols-2 gap-12">
      <div>
        <IndividualResultsTable results={race.results} clubFilter={clubFilter} setClubFilter={setClubFilter} setView={setView} clubMvps={clubMvps} individualChampions={individualChampions}/>
      </div>
      <div>
        <div className="mb-6">
          {displayTeamScores?<KnownTeamScoresTable scores={displayTeamScores} title="A Teams"/>:<TeamResultsTableCompact results={race.results} startPos={1} count={10} finishers={race.finishers} title="A Teams"/>}
        </div>
        <div>
          {!displayTeamScores&&<TeamResultsTableCompact results={race.results} startPos={11} count={10} finishers={race.finishers} title="B Teams"/>}
        </div>
      </div>
    </div>
  </div>;
};

const FixturesView=({setView,races,seasonsData})=>{
  const allFixtures=useMemo(()=>[...races].sort((a,b)=>{if(a.season!==b.season)return b.season.localeCompare(a.season);return a.match-b.match;}),[races]);let lastSeason=null;
  const getChampion=(season)=>{const sd=seasonsData[season];if(!sd?.standings?.[0])return null;const isHist=sd.historical;const hasM4=sd.standings[0].m4!==null||isHist;return hasM4?sd.standings[0].club:null;};
  const completeRaces=allFixtures.filter(r=>r.results?.length>=100).length;
  const partialRaces=allFixtures.filter(r=>r.results?.length>=4&&r.results?.length<100).length;
  const winnersOnly=allFixtures.filter(r=>!r.results?.length||r.results?.length<4).length;
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><h1 className="text-2xl font-bold text-gray-900">Fixtures</h1><p className="text-sm text-gray-500">{allFixtures.length} matches since 1962: <span className="inline-flex items-center gap-1"><span className="inline-block w-1.5 h-1.5 rounded-full bg-green-500"></span></span>{completeRaces} with complete results, <span className="inline-flex items-center gap-1"><span className="inline-block w-1.5 h-1.5 rounded-full bg-amber-500"></span></span>{partialRaces} with partial results, <span className="inline-flex items-center gap-1"><span className="inline-block w-1.5 h-1.5 rounded-full bg-red-500"></span></span>{winnersOnly} with winners' data only</p></div><table className="w-full"><tbody>{allFixtures.map((race,i)=>{const show=race.season!==lastSeason;const champ=show?getChampion(race.season):null;lastSeason=race.season;const hasResults=race.results?.length>=4;return<React.Fragment key={`${race.season}-${race.match}`}>{show&&<tr><td colSpan={5} className="pt-6 pb-2"><div className="flex items-center gap-2 text-xs font-semibold text-gray-400 uppercase tracking-wide border-b border-gray-200 pb-1"><span>{race.season}</span>{champ&&<><span className="text-amber-500">üèÜ</span><ClubShield club={champ} size={14}/><span className="text-gray-600 normal-case font-medium">{champ}</span></>}</div></td></tr>}<tr className={`border-b border-gray-50 ${hasResults?'hover:bg-blue-50 cursor-pointer':''}`} onClick={()=>hasResults&&setView({type:'race',race})}><td className="py-1.5 pr-2 text-sm text-gray-500 w-20">{race.date?.length<=3?race.date:formatDateShort(race.date)}</td><td className="py-1.5 px-1 w-3 table-cell"><span className={`inline-block w-1.5 h-1.5 rounded-full ${race.results?.length>=100?'bg-green-500':race.results?.length>=4?'bg-amber-500':'bg-red-500'}`} title={race.results?.length>=100?'Complete results':race.results?.length>=4?'Partial results':'Winners\' data only'}></span></td><td className="py-1.5 px-2 text-sm text-gray-900">{race.venue}</td><td className="py-1.5 px-2 w-44"><div className="flex items-center gap-1.5"><ClubShield club={race.winnerClub} size={14}/><span className="text-sm text-gray-700">{race.winner?.includes('/')?<span className="flex flex-col leading-tight">{race.winner.split('/').map((w,i)=><span key={i}><span className="hidden md:inline">{w.trim()}</span><span className="md:hidden">{w.trim().split(' ').pop()}</span></span>)}</span>:<><span className="hidden md:inline">{race.winner}</span><span className="md:hidden">{race.winner?.split(' ').pop()}</span></>}</span></div></td><td className="py-1.5 pl-2 w-24">{race.teamWinner&&<div className="flex items-center gap-1.5"><ClubShield club={race.teamWinner} size={14}/><span className="text-sm font-medium text-gray-900">{race.teamWinner}</span></div>}</td></tr></React.Fragment>;})}</tbody></table></div>;
};

const AthletesView=({setView,athletes})=>{
  const[sort,setSort]=useState('wins');const[search,setSearch]=useState('');const[limit,setLimit]=useState(100);
  const filtered=useMemo(()=>{const s=search.toLowerCase();return athletes.filter(a=>!s||a.name.toLowerCase().includes(s)||a.club?.toLowerCase().includes(s));},[athletes,search]);
  const colOrder=['wins','top3','top5','top10','top20','top50','top100','races'];
  const sorted=useMemo(()=>[...filtered].sort((a,b)=>{
    // Primary sort by selected column
    const diff=b[sort]-a[sort];
    if(diff!==0)return diff;
    // Tiebreakers: left to right through columns
    for(const col of colOrder){
      if(col===sort)continue;
      const d=b[col]-a[col];
      if(d!==0)return d;
    }
    return a.name.localeCompare(b.name);
  }),[filtered,sort]);
  const cols=[{f:'wins',l:'W',t:'Race wins'},{f:'top3',l:'T3',t:'Top 3 finishes'},{f:'top5',l:'T5',t:'Top 5 finishes'},{f:'top10',l:'T10',t:'Top 10 finishes'},{f:'top20',l:'T20',t:'Top 20 finishes'},{f:'top50',l:'T50',t:'Top 50 finishes'},{f:'top100',l:'T100',t:'Top 100 finishes'},{f:'races',l:'R',t:'Total races'}];
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><input type="text" placeholder={`Search ${filtered.length.toLocaleString()} athletes...`} value={search} onChange={e=>{setSearch(e.target.value);setLimit(100);}} className="px-3 py-2 border border-gray-300 rounded text-sm w-full sm:w-72 focus:outline-none focus:ring-2 focus:ring-[#0077b6]"/></div><div className="overflow-x-auto"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-2"><span className="text-xs text-gray-500 uppercase">Athlete</span></th>{cols.map(c=><th key={c.f} className="text-right py-1.5 px-1 md:px-2 min-w-[2rem] md:min-w-[2.5rem]"><button onClick={()=>setSort(c.f)} className={`text-xs uppercase ${sort===c.f?'text-[#0077b6] font-semibold':'text-gray-500'}`} data-tip={c.t}>{c.l}</button></th>)}</tr></thead><tbody>{sorted.slice(0,limit).map((a,i)=><tr key={a.name} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-2"><div className="flex items-center gap-1.5 md:gap-2"><span className="text-gray-400 text-sm w-7 text-right tabular-nums flex-shrink-0">{i+1}</span><ClubShield club={a.club} size={14} className="flex-shrink-0"/><span className="text-sm text-gray-900 whitespace-nowrap">{a.name}</span></div></td>{cols.map(c=><td key={c.f} className={`text-right py-1.5 px-1 md:px-2 text-sm tabular-nums ${sort===c.f?'font-semibold text-[#0077b6]':'text-gray-600'} ${a[c.f]===0?'text-gray-300':''}`}>{a[c.f]||'-'}</td>)}</tr>)}</tbody></table></div>{sorted.length>limit&&<div className="mt-4 text-center"><button onClick={()=>setLimit(l=>l+100)} className="px-4 py-2 bg-[#0077b6] text-white rounded text-sm hover:bg-[#005f8a]">Show more ({sorted.length-limit} remaining)</button></div>}</div>;
};

const StatsTable=({stats})=>{
  const[hover,setHover]=React.useState(null);
  const cols=[
    {k:'aScores',l:'A',t:'A team scoring appearances'},
    {k:'wins',l:'W',t:'Race wins'},
    {k:'top3',l:'T3',t:'Top 3 finishes'},
    {k:'top5',l:'T5',t:'Top 5 finishes'},
    {k:'top10',l:'T10',t:'Top 10 finishes'},
    {k:'top20',l:'T20',t:'Top 20 finishes'},
    {k:'top50',l:'T50',t:'Top 50 finishes'},
    {k:'top100',l:'T100',t:'Top 100 finishes'},
    {k:'races',l:'R',t:'Total races'}
  ];
  return<div className="relative mb-6"><table className="w-full table-fixed"><thead><tr className="border-b border-gray-200">{cols.map((c,i)=><th key={c.k} className={`py-1.5 text-xs text-gray-500 uppercase cursor-help ${i===0?'text-left':'text-center'}`} onMouseEnter={()=>setHover(i)} onMouseLeave={()=>setHover(null)}>{c.l}</th>)}</tr></thead><tbody><tr>{cols.map((c,i)=><td key={c.k} className={`py-1.5 text-sm tabular-nums ${i===0?'text-left':'text-center'} ${stats[c.k]>0?'text-gray-900':'text-gray-300'}`}>{stats[c.k]||'-'}</td>)}</tr></tbody></table>{hover!==null&&<div className="absolute bg-gray-800 text-white text-xs px-2 py-1 rounded pointer-events-none whitespace-nowrap z-10" style={{top:-8,left:`${(hover+0.5)/cols.length*100}%`,transform:'translateX(-50%)'}}>{cols[hover].t}</div>}</div>;
};

const PositionChart=({raceHistory,highlightIdx,setHighlightIdx,setView,clubCode})=>{
  const svgRef=React.useRef(null);
  
  // Reverse to show earliest first (left to right = old to new)
  const reversedHistory=[...raceHistory].reverse();
  const positions=reversedHistory.map(r=>r.pos).filter(p=>p!=null);
  if(positions.length<2)return null;
  
  const bestPos=Math.min(...positions);
  const maxPos=Math.max(...positions);
  const minPos=Math.min(...positions);
  
  // Get club color for line - use primary unless white, then secondary
  const clubColors={
    'HHH':['#c41e3a','#000'],     // red/black
    'THH':['#000','#fff'],        // black/white
    'BEL':['#8b0000','#ffd700'],  // maroon/gold
    'SLH':['#fff','#c41e3a'],     // white/red -> use red
    'G&G':['#006633','#fff'],     // green/white
    'KEN':['#00205b','#c41e3a'], // navy/red
    'REI':['#87ceeb','#c41e3a'], // light blue/red
    'RAN':['#00205b','#fff'],    // navy/white
    'AFD':['#ff8c00','#006400'], // orange/green
    'H/W':['#ffff00','#c41e3a'], // yellow/red -> use red
    'W4H':['#ffd700','#006400'], // gold/green
    'BOX':['#ff0000','#ffd700'], // red/gold
    'K&P':['#800080','#fff'],    // purple/white
    'WAL':['#000080','#fff'],    // navy/white
    'FUL':['#000','#fff'],       // black/white
    'CRY':['#87ceeb','#fff'],    // light blue/white
    'CAM':['#000080','#87ceeb'], // navy/light blue
    'DMV':['#006400','#fff'],    // green/white
    'BOH':['#ff0000','#fff'],    // red/white
  };
  const colors=clubColors[clubCode]||['#0077b6','#0077b6'];
  const lineColor=(colors[0]==='#fff'||colors[0]==='#ffff00'||colors[0]==='#ffd700')?colors[1]:colors[0];
  
  const height=60;
  const padding={top:8,bottom:8,left:4,right:4};
  const chartHeight=height-padding.top-padding.bottom;
  
  const getX=(i,width)=>padding.left+(i/(positions.length-1))*(width-padding.left-padding.right);
  const getY=(pos)=>padding.top+((pos-minPos)/(maxPos-minPos||1))*chartHeight;
  
  const handleInteraction=(e)=>{
    const svg=svgRef.current;
    if(!svg)return;
    const rect=svg.getBoundingClientRect();
    const clientX=e.touches?e.touches[0].clientX:e.clientX;
    const x=clientX-rect.left;
    const width=rect.width;
    
    // Find nearest point
    let nearestIdx=0;
    let nearestDist=Infinity;
    positions.forEach((_,i)=>{
      const px=getX(i,width);
      const dist=Math.abs(px-x);
      if(dist<nearestDist){nearestDist=dist;nearestIdx=i;}
    });
    
    // Convert back to original raceHistory index (reversed)
    const originalIdx=raceHistory.length-1-nearestIdx;
    setHighlightIdx({chartIdx:nearestIdx,historyIdx:originalIdx,pos:positions[nearestIdx],x:getX(nearestIdx,width)});
  };
  
  const handleClick=(e)=>{
    if(highlightIdx){
      const race=raceHistory[highlightIdx.historyIdx]?.race;
      if(race?.results?.length){
        setView({type:'race',race});
      }
    }
  };
  
  const clearHighlight=()=>setHighlightIdx(null);
  
  return<div className="w-full mb-4 relative">
    <svg ref={svgRef} className="w-full cursor-pointer" style={{height}} onMouseMove={handleInteraction} onMouseLeave={clearHighlight} onClick={handleClick} onTouchStart={handleInteraction} onTouchMove={handleInteraction} onTouchEnd={clearHighlight}>
      <PathRenderer positions={positions} getY={getY} padding={padding} bestPos={bestPos} highlightIdx={highlightIdx?.chartIdx} lineColor={lineColor}/>
    </svg>
    {highlightIdx&&<div className="absolute bg-gray-800 text-white text-xs px-2 py-1 rounded pointer-events-none whitespace-nowrap" style={{left:highlightIdx.x,top:-4,transform:'translateX(-50%)'}}>{highlightIdx.pos}{highlightIdx.pos===1?'st':highlightIdx.pos===2?'nd':highlightIdx.pos===3?'rd':'th'}</div>}
  </div>;
};

const PathRenderer=({positions,getY,padding,bestPos,highlightIdx,lineColor})=>{
  const[width,setWidth]=React.useState(300);
  const pathRef=React.useRef(null);
  
  React.useEffect(()=>{
    const updateWidth=()=>{
      if(pathRef.current?.parentElement){
        setWidth(pathRef.current.parentElement.getBoundingClientRect().width);
      }
    };
    updateWidth();
    window.addEventListener('resize',updateWidth);
    return()=>window.removeEventListener('resize',updateWidth);
  },[]);
  
  const getX=(i)=>padding.left+(i/(positions.length-1))*(width-padding.left-padding.right);
  const points=positions.map((pos,i)=>`${getX(i)},${getY(pos)}`).join(' ');
  
  return<g ref={pathRef}>
    <polyline points={points} fill="none" stroke={lineColor} strokeWidth="1" strokeLinejoin="round"/>
    {positions.map((pos,i)=>{
      const cx=getX(i);
      const cy=getY(pos);
      const isHighlighted=highlightIdx===i;
      const isBest=pos===bestPos;
      if(isBest){
        // Star shape for best position(s) - yellow fill
        const size=isHighlighted?5:4;
        const starPoints=[];
        for(let j=0;j<5;j++){
          const outerAngle=(j*72-90)*Math.PI/180;
          const innerAngle=((j*72)+36-90)*Math.PI/180;
          starPoints.push(`${cx+size*Math.cos(outerAngle)},${cy+size*Math.sin(outerAngle)}`);
          starPoints.push(`${cx+size*0.4*Math.cos(innerAngle)},${cy+size*0.4*Math.sin(innerAngle)}`);
        }
        return<polygon key={i} points={starPoints.join(' ')} fill="#f59e0b" stroke="#d97706" strokeWidth="0.5" className="transition-all"/>;
      }
      return<circle key={i} cx={cx} cy={cy} r={isHighlighted?3:1.5} fill={lineColor} className="transition-all"/>;
    })}
  </g>;
};

const AthleteDetailView=({athlete,setView,athletes,races,clubMvps,seasonsData,mitchellCupWinners})=>{
  const[compareInput,setCompareInput]=useState('');
  const[highlightIdx,setHighlightIdx]=useState(null);
  const[compareFocused,setCompareFocused]=useState(false);
  // Enhanced athlete lookup - match by exact name, or by abbreviated first initial + surname
  const athleteData=useMemo(()=>{
    if(!athlete?.name)return null;
    // First try exact match
    let found=athletes.find(a=>namesMatch(a.name,athlete.name));
    if(found)return found;
    // Try matching abbreviated name (e.g., "S Haughian" matches "Sam Haughian")
    const parts=athlete.name.trim().split(/\s+/);
    if(parts.length>=2&&parts[0].length<=2){
      const initial=parts[0].replace('.','').toLowerCase();
      const surname=parts.slice(1).join(' ').toLowerCase();
      found=athletes.find(a=>{
        const aParts=a.name.trim().split(/\s+/);
        if(aParts.length<2)return false;
        const aInitial=aParts[0][0]?.toLowerCase();
        const aSurname=aParts.slice(1).join(' ').toLowerCase();
        return aInitial===initial[0]&&aSurname===surname&&(!athlete.club||a.club===athlete.club);
      });
    }
    return found||athlete;
  },[athlete,athletes]);
  
  // Update document metadata for athlete page
  const athleteSlug=useMemo(()=>athleteData?.name?.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')||'',[athleteData?.name]);
  const possessive=athleteData?.name?(athleteData.name.endsWith('s')?`${athleteData.name}'`:`${athleteData.name}'s`):null;
  useDocumentMeta({
    title:possessive?`${possessive} Surrey League history`:null,
    favicon:athleteData?.club?`data:image/svg+xml,${encodeURIComponent(getClubVestSvg(athleteData.club))}`:null,
    ogImage:athleteSlug?`https://s.microlink.io/https://slarchive.org/%23athlete/${athleteSlug}`:null,
    ogDesc:athleteData?.name?`Surrey League cross country career of ${athleteData.name}`:null
  });
  
  const sortedByWins=[...athletes].sort((a,b)=>b.wins-a.wins);const allTimeRank=sortedByWins.findIndex(a=>namesMatch(a.name,athleteData?.name))+1;
  
  const raceHistory=useMemo(()=>{
    const h=[];
    const seenRaces=new Set();
    races.forEach(race=>{
      const result=race.results?.find(r=>namesMatch(r.name,athleteData?.name));
      if(result){
        // Calculate team scoring position
        let teamScore='';
        if(result.club&&race.results){
          const clubRunners=race.results.filter(r=>r.club===result.club);
          const posInClub=clubRunners.findIndex(r=>namesMatch(r.name,result.name))+1;
          if(posInClub>=1&&posInClub<=10)teamScore=`A${posInClub}`;
          else if(posInClub>=11&&posInClub<=20)teamScore=`B${posInClub-10}`;
        }
        const hasFullDate=race.date&&race.date.includes('-')&&race.date.length>=10;
        h.push({date:race.date,venue:race.venue,pos:result.pos,time:result.time,club:result.club,race,hasFullDate,season:race.season,teamScore});
        // Track by season+match AND season+venue+pos to catch duplicates
        seenRaces.add(`${race.season}-${race.match}`);
        seenRaces.add(`${race.season}-${race.venue}-${result.pos}`);
      }
    });
    if(athleteData?.historicalRaces){
      athleteData.historicalRaces.forEach(hr=>{
        // Skip if we already have actual results for this race (check both match# and venue+pos)
        if(seenRaces.has(`${hr.season}-${hr.match}`))return;
        if(seenRaces.has(`${hr.season}-${hr.venue}-${hr.pos}`))return;
        const race=races.find(r=>r.season===hr.season&&r.match===hr.match);
        h.push({date:race?.date||hr.season,venue:hr.venue,pos:hr.pos,time:'-',club:hr.club,race,hasFullDate:false,season:hr.season,teamScore:hr.pos===1?'A1':''});
      });
    }
    return h.sort((a,b)=>{const aKey=a.hasFullDate?a.date:a.season;const bKey=b.hasFullDate?b.date:b.season;return bKey.localeCompare(aKey);});
  },[athleteData?.name,athleteData?.historicalRaces,races]);
  
  // Compute club GOAT rankings dynamically from race history for each club
  const clubRankings=useMemo(()=>{
    if(!raceHistory.length)return [];
    
    // Get unique clubs this athlete has represented (excluding N/S and GUEST)
    const athleteClubs=[...new Set(raceHistory.map(r=>r.club).filter(c=>c&&c!=='N/S'&&c!=='GUEST'))];
    
    // For each club, compute all athletes' A-scores and find this athlete's rank
    const rankings=[];
    athleteClubs.forEach(club=>{
      // Compute A-scores for all athletes at this club from race results
      const clubStats={};
      races.forEach(race=>{
        // Handle races without full results (only have winner info)
        if(!race.results?.length){
          if(race.winners){
            race.winners.forEach(w=>{
              if(w.club===club){
                const key=normalizeNameForCompare(w.name);
                if(!clubStats[key])clubStats[key]={name:w.name,aScores:0};
                clubStats[key].aScores++;
              }
            });
          }else if(race.winnerClub===club&&race.winner){
            const key=normalizeNameForCompare(race.winner);
            if(!clubStats[key])clubStats[key]={name:race.winner,aScores:0};
            clubStats[key].aScores++;
          }
          return;
        }
        const clubRunners=race.results.filter(r=>r.club===club);
        clubRunners.slice(0,10).forEach((r,i)=>{
          const key=normalizeNameForCompare(r.name);
          if(!clubStats[key])clubStats[key]={name:r.name,aScores:0};
          clubStats[key].aScores++;
        });
      });
      
      // Sort by A-scores
      const sorted=Object.values(clubStats).sort((a,b)=>b.aScores-a.aScores);
      const rank=sorted.findIndex(a=>namesMatch(a.name,athleteData.name))+1;
      
      if(rank>0){
        rankings.push({club,rank});
      }
    });
    
    return rankings.sort((a,b)=>a.rank-b.rank);
  },[raceHistory,races,athleteData?.name]);
  
  const po10Url=useMemo(()=>{if(!athleteData?.name)return null;const parts=athleteData.name.split(' ');if(parts.length<2)return null;const firstname=parts[0];const surname=parts.slice(1).join(' ');return`https://www.thepowerof10.info/athletes/athleteslookup.aspx?surname=${encodeURIComponent(surname)}&firstname=${encodeURIComponent(firstname)}`;},[athleteData?.name]);
  const bestPos=useMemo(()=>raceHistory.length>0?Math.min(...raceHistory.map(r=>r.pos)):null,[raceHistory]);
  const showStar=bestPos&&bestPos>1;
  
  // Compute stats dynamically from raceHistory
  const computedStats=useMemo(()=>{
    const stats={wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,races:raceHistory.length,aScores:0};
    let histWins=0;
    raceHistory.forEach(r=>{
      if(r.pos===1){stats.wins++;if(!r.hasFullDate)histWins++;}
      if(r.pos<=3)stats.top3++;
      if(r.pos<=5)stats.top5++;
      if(r.pos<=10)stats.top10++;
      if(r.pos<=20)stats.top20++;
      if(r.pos<=50)stats.top50++;
      if(r.pos<=100)stats.top100++;
      if(r.teamScore&&r.teamScore.startsWith('A'))stats.aScores++;
    });
    return{...stats,histWins,modernWins:stats.wins-histWins};
  },[raceHistory]);
  
  if(!athleteData)return<div className="max-w-4xl mx-auto px-4 py-8"><p>Athlete not found</p></div>;
  const isHistOnly=athleteData.historicalOnly;
  const stats=[{l:'Wins',v:computedStats.wins,sub:computedStats.histWins>0?`(${computedStats.modernWins}+${computedStats.histWins} hist)`:null},{l:'Top 3',v:computedStats.top3},{l:'Top 5',v:computedStats.top5},{l:'Top 10',v:computedStats.top10},{l:'Top 20',v:computedStats.top20},{l:'Top 50',v:computedStats.top50},{l:'Top 100',v:computedStats.top100},{l:'A Scores',v:computedStats.aScores},{l:'Races',v:computedStats.races}];
  
  // Compute badges dynamically
  const computedBadges=useMemo(()=>{
    const badges=[];
    const getYear=(season)=>{if(!season)return null;const yy=season.split('/')[1];return(parseInt(yy)<50?'20':'19')+yy;};
    
    // Find seasons where athlete scored for the A team of each club
    const seasonClubsWithAScore={};// season -> clubs they scored A-team points for
    raceHistory.forEach(r=>{
      const season=r.race?.season||(!r.hasFullDate?r.season:null);
      // Only count if they scored for A team (teamScore starts with 'A')
      if(season&&r.club&&r.teamScore&&r.teamScore.startsWith('A')){
        if(!seasonClubsWithAScore[season])seasonClubsWithAScore[season]=new Set();
        seasonClubsWithAScore[season].add(r.club);
      }
    });
    
    // Check each season they participated in
    Object.entries(seasonClubsWithAScore).forEach(([season,clubs])=>{
      const sd=seasonsData[season];
      if(!sd?.standings?.length)return;
      const champion=sd.standings[0].club;
      // Check if season is complete
      const isComplete=sd.historical||(sd.standings[0].m4!==null&&sd.standings[0].m4!==undefined);
      if(isComplete&&clubs.has(champion)){
        badges.push({type:'title_winner',season,year:getYear(season)});
      }
    });
    
    // Check for individual champion seasons (from computed rankings)
    // Only award if season is complete (historical, or has results for final scheduled match)
    Object.entries(seasonsData).forEach(([season,sd])=>{
      if(!sd?.individualRankings?.length)return;
      // Historical seasons are always complete (even if only 3 matches due to weather)
      if(sd.historical){
        const champion=sd.individualRankings[0];
        if(namesMatch(champion.name,athleteData.name)){
          badges.push({type:'individual_champion',season,year:getYear(season)});
        }
        return;
      }
      // For non-historical seasons, check if match 4 results exist
      const isComplete=sd.standings?.[0]?.m4!==null&&sd.standings?.[0]?.m4!==undefined;
      if(!isComplete)return;
      const champion=sd.individualRankings[0];
      if(namesMatch(champion.name,athleteData.name)){
        badges.push({type:'individual_champion',season,year:getYear(season)});
      }
    });
    
    // Also check Mitchell Cup historical winners
    if(mitchellCupWinners){
      Object.entries(mitchellCupWinners).forEach(([season,winners])=>{
        // Skip if we already have this season from computed rankings
        if(badges.some(b=>b.type==='individual_champion'&&b.season===season))return;
        // Check if athlete is among the winners (handles joint winners)
        if(winners.some(w=>namesMatch(w.name,athleteData.name))){
          badges.push({type:'individual_champion',season,year:getYear(season)});
        }
      });
    }
    
    return badges;
  },[raceHistory,seasonsData,athleteData.name,mitchellCupWinners]);
  
  const individualChampData=computedBadges.filter(b=>b.type==='individual_champion').map(b=>({year:b.year,season:b.season})).filter(b=>b.year).sort((a,b)=>b.year.localeCompare(a.year));
  const leagueWinnerData=computedBadges.filter(b=>b.type==='title_winner').map(b=>({year:b.year,season:b.season})).filter(b=>b.year).sort((a,b)=>b.year.localeCompare(a.year));
  const renderYearLinks=(data)=>data.map((d,i)=><React.Fragment key={d.season}>{i>0&&<span className="text-gray-400"> ¬∑ </span>}<span className="cursor-pointer hover:text-[#0077b6] hover:underline" onClick={()=>setView({type:'home',urlSeason:d.season})}>{d.year}</span></React.Fragment>);
  const staticBadges=athleteData.badges||[];
  const otherBadges=staticBadges.filter(b=>b.type!=='individual_champion'&&b.type!=='title_winner').map(b=>{
    if(b.type==='all_time_wins_leader')return{label:'#1 All-Time Wins'};
    if(b.type==='most_season_wins')return{label:`Most Wins in Single Season (${b.wins})`};
    if(b.type==='most_team_titles')return{label:`Most Team Titles (${b.count})`};
    return null;
  }).filter(Boolean);
  return<div className="max-w-4xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'athletes'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-8"><div className="hidden md:flex md:gap-4 md:items-end mb-4"><div className="cursor-pointer" onClick={()=>setView({type:'club',club:athleteData.club})}><ClubShield club={athleteData.club} size={110}/></div><div className="flex flex-col justify-end pb-1"><div className="flex flex-wrap gap-2 mb-2">{allTimeRank>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'athletes'})}><span className="text-xs text-gray-500 uppercase">SL Index üìà</span><span className="text-sm font-bold text-[#0077b6]">#{allTimeRank}</span></div>}{clubRankings.map(cr=><div key={cr.club} className="inline-flex items-center gap-1.5 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'club',club:cr.club})}><ClubShield club={cr.club} size={14}/><span className="text-xs text-gray-500">üêê</span><span className="text-sm font-bold text-[#0077b6]">#{cr.rank}</span></div>)}</div><div className="flex items-center gap-3"><h1 className="text-3xl font-bold text-gray-900" style={{fontFamily:"'Fraunces',serif"}}>{athleteData.name}</h1><div className="relative inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">Compare to</span><input type="text" value={compareInput} onChange={e=>setCompareInput(e.target.value)} onFocus={()=>setCompareFocused(true)} onBlur={()=>setTimeout(()=>setCompareFocused(false),200)} placeholder="Search..." className="w-24 text-sm bg-transparent border-none outline-none placeholder-gray-400"/>{compareFocused&&compareInput.length>=2&&(()=>{const suggestions=athletes.filter(a=>!a.historical&&a.name.toLowerCase().includes(compareInput.toLowerCase())&&!namesMatch(a.name,athleteData.name)).slice(0,5);return suggestions.length>0?<div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10">{suggestions.map((a,i)=><div key={i} className="px-3 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2 text-sm" onClick={()=>{setView({type:'h2h',prefill:{athlete1:athleteData,athlete2:a}});}}><ClubShield club={a.club} size={14}/><span>{a.name}</span></div>)}</div>:null;})()}</div></div><div className="flex items-center gap-2 mt-1"><p className="text-sm text-gray-500 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:athleteData.club})}>{CLUBS[athleteData.club]?.name||athleteData.club}</p>{po10Url&&<a href={po10Url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-xs text-gray-400 hover:text-[#0077b6]"><span>Power of 10</span><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>}</div></div></div>{(individualChampData.length>0||leagueWinnerData.length>0||otherBadges.length>0)&&<div className="flex flex-wrap gap-2 mb-4">{individualChampData.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{individualChampData.length}√ó Mitchell Cup üèÖ</span><span className="text-sm font-medium text-gray-700">{renderYearLinks(individualChampData)}</span></div>}{leagueWinnerData.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{leagueWinnerData.length}√ó League Winner üèÜ</span><span className="text-sm font-medium text-gray-700">{renderYearLinks(leagueWinnerData)}</span></div>}{otherBadges.map((b,i)=><div key={i} className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{b.label}</span></div>)}</div>}<div className="md:hidden"><div className="flex items-start gap-3 mb-3"><div className="cursor-pointer" onClick={()=>setView({type:'club',club:athleteData.club})}><ClubShield club={athleteData.club} size={44}/></div><div><h1 className="text-2xl font-bold text-gray-900" style={{fontFamily:"'Fraunces',serif"}}>{athleteData.name}</h1><p className="text-sm text-gray-500 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:athleteData.club})}>{CLUBS[athleteData.club]?.name||athleteData.club}</p></div></div><div className="flex flex-wrap gap-2">{allTimeRank>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'athletes'})}><span className="text-xs text-gray-500 uppercase">SL Index üìà</span><span className="text-sm font-bold text-[#0077b6]">#{allTimeRank}</span></div>}{clubRankings.map(cr=><div key={cr.club} className="inline-flex items-center gap-1.5 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'club',club:cr.club})}><ClubShield club={cr.club} size={14}/><span className="text-xs text-gray-500">üêê</span><span className="text-sm font-bold text-[#0077b6]">#{cr.rank}</span></div>)}{otherBadges.map((b,i)=><div key={i} className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{b.label}</span></div>)}</div>{(individualChampData.length>0||leagueWinnerData.length>0)&&<div className="flex flex-wrap gap-2 mt-2">{individualChampData.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{individualChampData.length}√ó Mitchell Cup üèÖ</span><span className="text-sm font-medium text-gray-700">{renderYearLinks(individualChampData)}</span></div>}{leagueWinnerData.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{leagueWinnerData.length}√ó League Winner üèÜ</span><span className="text-sm font-medium text-gray-700">{renderYearLinks(leagueWinnerData)}</span></div>}</div>}<div className="flex flex-wrap items-center gap-2 mt-2"><div className="relative inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">Compare to</span><input type="text" value={compareInput} onChange={e=>setCompareInput(e.target.value)} onFocus={()=>setCompareFocused(true)} onBlur={()=>setTimeout(()=>setCompareFocused(false),200)} placeholder="Search..." className="w-24 text-sm bg-transparent border-none outline-none placeholder-gray-400"/>{compareFocused&&compareInput.length>=2&&(()=>{const suggestions=athletes.filter(a=>!a.historical&&a.name.toLowerCase().includes(compareInput.toLowerCase())&&!namesMatch(a.name,athleteData.name)).slice(0,5);return suggestions.length>0?<div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10">{suggestions.map((a,i)=><div key={i} className="px-3 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2 text-sm" onClick={()=>{setView({type:'h2h',prefill:{athlete1:athleteData,athlete2:a}});}}><ClubShield club={a.club} size={14}/><span>{a.name}</span></div>)}</div>:null;})()}</div>{po10Url&&<a href={po10Url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-xs text-gray-500 hover:text-[#0077b6]"><span>Power of 10</span><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>}</div></div></div><StatsTable stats={computedStats}/><div>{raceHistory.length>0?<><PositionChart raceHistory={raceHistory} highlightIdx={highlightIdx} setHighlightIdx={setHighlightIdx} setView={setView} clubCode={athleteData.club}/><table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th colSpan="2" className="text-left py-2 pr-2 text-xs text-gray-500 uppercase">Race History</th><th className="text-center py-2 px-1 text-[10px] md:text-xs text-gray-500 uppercase">Club</th><th className="text-right py-2 px-1 text-[10px] md:text-xs text-gray-500 uppercase">Pos</th><th className="text-right py-2 pl-1 text-[10px] md:text-xs text-gray-500 uppercase">Score</th></tr></thead><tbody className="divide-y divide-gray-100">{raceHistory.map((r,i)=>{const scoreNum=r.teamScore?parseInt(r.teamScore.slice(1)):0;const ordinal=scoreNum===1?'st':scoreNum===2?'nd':scoreNum===3?'rd':'th';const scoreTooltip=r.teamScore?`${CLUBS[r.club]?.name||r.club}'s ${scoreNum}${ordinal} scorer for ${r.teamScore[0]} team`:null;const dateObj=r.hasFullDate&&r.date?new Date(r.date):null;const formatSeasonMatch=(season,match)=>{const months=['Oct','Nov','Dec','Jan','Feb'];const p=season.split('/');if(p.length!==2||!match)return season;const y1=parseInt(p[0]),m=months[match-1]||'';return m?m+" '"+(match>=4?String(y1+1).slice(-2):String(y1).slice(-2)):season;};const displayDate=dateObj?dateObj.toLocaleDateString('en-GB',{month:'short'})+" '"+dateObj.getFullYear().toString().slice(-2):formatSeasonMatch(r.season,r.race?.match);const isHighlighted=highlightIdx?.historyIdx===i;return<tr key={i} className={`${isHighlighted?'bg-blue-100':''} ${r.race?.results?.length?'hover:bg-blue-50 cursor-pointer':''} transition-colors`} onClick={()=>r.race?.results?.length&&setView({type:'race',race:r.race})}><td className="py-2 pr-2 text-xs text-gray-400 whitespace-nowrap">{displayDate}</td><td className="py-2 px-1 text-xs md:text-sm text-gray-900">{r.venue}</td><td className="py-2 px-1"><div className="flex justify-center"><ClubShield club={r.club} size={14}/></div></td><td className="py-2 px-1 text-right"><span className={`text-xs md:text-sm font-medium tabular-nums ${r.pos===1?'text-[#0077b6]':r.pos<=3?'text-gray-900':'text-gray-600'}`}>{r.pos===1?'ü•á':r.pos===2?'ü•à':r.pos===3?'ü•â':r.pos}{showStar&&r.pos===bestPos&&' ‚≠ê'}</span></td><td className="py-2 pl-1 text-xs md:text-sm text-gray-600 text-right tabular-nums font-mono" title={scoreTooltip}>{r.teamScore||'-'}</td></tr>})}</tbody></table></>:<p className="text-sm text-gray-500">No race history</p>}</div></div>;
};

const ChartRoomView=({setView,data})=>{
  // Full seasons for position chart (starting 07/08)
  const allSeasons=['2007/08','2008/09','2009/10','2010/11','2011/12','2012/13','2013/14','2014/15','2015/16','2016/17','2017/18','2018/19','2019/20','2021/22','2022/23','2023/24','2024/25','2025/26'];
  const allSeasonLabels=['07/08','08/09','09/10','10/11','11/12','12/13','13/14','14/15','15/16','16/17','17/18','18/19','19/20','21/22','22/23','23/24','24/25','25/26'];
  
  // Recent seasons for other charts (starting 14/15)
  const recentSeasons=['2014/15','2015/16','2016/17','2017/18','2018/19','2019/20','2021/22','2022/23','2023/24','2024/25','2025/26'];
  const recentSeasonLabels=['14/15','15/16','16/17','17/18','18/19','19/20','21/22','22/23','23/24','24/25','25/26'];
  
  const primaryClubs=['BEL','KEN','THH','H/W'];
  const clubs=[
    {code:'BEL',color:'#7A001D'},{code:'THH',color:'#374151'},{code:'KEN',color:'#2a4d7a'},
    {code:'HHH',color:'#dc2626'},{code:'H/W',color:'#ca8a04'},{code:'G&G',color:'#16a34a'},
    {code:'SLH',color:'#be185d'},{code:'HOL',color:'#1e40af'},{code:'DUL',color:'#7c3aed'},{code:'C/C',color:'#0891b2'},
    {code:'RAN',color:'#0369a1'},{code:'CRO',color:'#525252'},{code:'DMV',color:'#92400e'},
    {code:'E&E',color:'#b91c1c'},{code:'FUL',color:'#171717'},{code:'REI',color:'#e11d48'},
    {code:'SOC',color:'#65a30d'},{code:'WOK',color:'#ea580c'}
  ];
  
  const getPositions=(club)=>allSeasons.map(s=>{
    const standings=data.seasonsData[s]?.standings||[];
    const idx=standings.findIndex(t=>t.club===club);
    return idx>=0?idx+1:11;
  });
  const hasDiv1History=(club)=>getPositions(club).some(p=>p<=10);
  const activeClubs=clubs.filter(c=>hasDiv1History(c.code));
  
  const [hoveredClub,setHoveredClub]=useState(null);
  const [tappedClub,setTappedClub]=useState(null);
  const [hoveredMatch,setHoveredMatch]=useState(null);
  const [hoveredSeason,setHoveredSeason]=useState(null);
  const [tappedSeason,setTappedSeason]=useState(null);
  const [hoveredSquad,setHoveredSquad]=useState(null);
  const [tappedSquad,setTappedSquad]=useState(null);
  
  const selectedClub=hoveredClub||tappedClub;
  
  // Attendance data with race references
  const getAttendanceData=()=>{
    const byMatch=[];
    data.races.filter(r=>r.season>='2014/15'&&r.finishers).sort((a,b)=>a.date?.localeCompare(b.date)).forEach(r=>{
      byMatch.push({label:`${r.season.slice(2)} M${r.match}`,value:r.finishers,season:r.season,match:r.match,race:r});
    });
    return byMatch;
  };
  const matchData=getAttendanceData();
  const movingAvg=matchData.map((d,i)=>i<3?null:Math.round((matchData[i-3].value+matchData[i-2].value+matchData[i-1].value+matchData[i].value)/4));
  
  // Average team size per season (total finishers / 10 teams / num matches)
  const avgTeamSize=recentSeasons.map(s=>{
    const seasonRaces=data.races.filter(r=>r.season===s&&r.finishers);
    if(seasonRaces.length===0)return{season:s,label:s.slice(2),value:0};
    const totalFinishers=seasonRaces.reduce((sum,r)=>sum+r.finishers,0);
    const avgPerMatch=totalFinishers/seasonRaces.length/10;
    return{season:s,label:s.slice(2),value:Math.round(avgPerMatch*10)/10};
  });
  
  // Squad size data - unique runners per club per season
  const getSquadSizes=()=>{
    const squadData={};
    recentSeasons.forEach(s=>{squadData[s]={};});
    data.races.filter(r=>r.season>='2014/15'&&r.results).forEach(r=>{
      r.results.forEach(res=>{
        if(!squadData[r.season])return;
        if(!squadData[r.season][res.club])squadData[r.season][res.club]=new Set();
        squadData[r.season][res.club].add(res.name);
      });
    });
    return clubs.map(({code,color})=>({
      code,color,
      sizes:recentSeasons.map(s=>{
        const set=squadData[s]?.[code];
        return set?set.size:0;
      })
    })).filter(c=>c.sizes.some(s=>s>0));
  };
  const squadSizes=getSquadSizes();
  const selectedSquad=hoveredSquad||tappedSquad;
  
  const chartW=800,chartH=250,padL=35,padR=80,padT=20,padB=30;
  const plotW=chartW-padL-padR,plotH=chartH-padT-padB;
  const xStep=plotW/(allSeasons.length-1);
  const yScale=(pos)=>padT+(pos-1)*(plotH/10);
  
  return<div className="max-w-5xl mx-auto px-4 py-8">
    <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
    <h1 className="text-2xl font-bold text-gray-900 mb-1">üìä Chart room</h1>
    <p className="text-sm text-gray-500 mb-8">League trends and statistics visualised</p>
    
    <div className="space-y-12">
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Club positions by season</h2>
        <div className="bg-gray-50 rounded-lg p-3 overflow-x-auto">
          <svg viewBox={`0 0 ${chartW} ${chartH}`} className="w-full" style={{minWidth:'500px'}}>
            {[1,2,3,4,5,6,7,8,9,10].map(pos=><g key={pos}>
              <line x1={padL} y1={yScale(pos)} x2={chartW-padR} y2={yScale(pos)} stroke="#e5e7eb" strokeWidth="1"/>
              <text x={padL-8} y={yScale(pos)+4} textAnchor="end" fontSize="10" fill="#9ca3af">{pos}</text>
            </g>)}
            <line x1={padL} y1={yScale(11)} x2={chartW-padR} y2={yScale(11)} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4,2"/>
            <text x={padL-8} y={yScale(11)+4} textAnchor="end" fontSize="9" fill="#d1d5db">Div 2</text>
            {allSeasonLabels.map((s,i)=><text key={s} x={padL+i*xStep} y={chartH-8} textAnchor="middle" fontSize="9" fill="#6b7280">{s}</text>)}
            {activeClubs.map(({code,color})=>{
              const positions=getPositions(code);
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selectedClub===code;
              const points=positions.map((pos,i)=>({x:padL+i*xStep,y:yScale(pos),pos,season:allSeasons[i]}));
              const pathD=points.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(' ');
              const baseOpacity=isPrimary?0.8:0.15;
              const opacity=selectedClub?(isSelected?1:0.1):baseOpacity;
              return<g key={code} onMouseEnter={()=>setHoveredClub(code)} onMouseLeave={()=>setHoveredClub(null)} onClick={()=>setTappedClub(tappedClub===code?null:code)} style={{cursor:'pointer'}}>
                <path d={pathD} fill="none" stroke={color} strokeWidth={isSelected?1.5:1} strokeLinecap="round" strokeLinejoin="round" opacity={opacity}/>
                {points.map((p,i)=><circle key={i} cx={p.x} cy={p.y} r={isSelected?3:2} fill={color} opacity={opacity}/>)}
                {isSelected&&<text x={points[points.length-1].x+8} y={points[points.length-1].y+4} fontSize="10" fill={color} fontWeight="600">{CLUBS[code]?.name||code}</text>}
              </g>;
            })}
          </svg>
          <div className="flex flex-wrap justify-center gap-x-3 gap-y-1 mt-3">
            {activeClubs.map(({code,color})=>{
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selectedClub===code;
              return<div key={code} className="flex items-center gap-1 cursor-pointer" onMouseEnter={()=>setHoveredClub(code)} onMouseLeave={()=>setHoveredClub(null)} onClick={()=>setTappedClub(tappedClub===code?null:code)}>
                <div className="w-2 h-2 rounded-full" style={{backgroundColor:color,opacity:isPrimary||isSelected?1:0.3}}/>
                <span className={`text-[10px] ${isPrimary||isSelected?'text-gray-600':'text-gray-400'}`}>{code}</span>
              </div>;
            })}
          </div>
        </div>
      </div>
      
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Match attendance since 2014</h2>
        <div className="bg-gray-50 rounded-lg p-3 overflow-x-auto">
          <svg viewBox="0 0 900 220" className="w-full" style={{minWidth:'600px'}}>
            {[100,150,200,250,300,350].map(v=><g key={v}>
              <line x1="40" y1={190-(v-100)*0.7} x2="870" y2={190-(v-100)*0.7} stroke="#e5e7eb" strokeWidth="1"/>
              <text x="35" y={190-(v-100)*0.7+4} textAnchor="end" fontSize="9" fill="#9ca3af">{v}</text>
            </g>)}
            <path d={matchData.map((d,i)=>`${i===0?'M':'L'}${40+i*19.5},${190-(d.value-100)*0.7}`).join(' ')} fill="none" stroke="#0077b6" strokeWidth="1" opacity="0.3"/>
            <path d={movingAvg.map((v,i)=>v?`${movingAvg.slice(0,i).filter(Boolean).length===0?'M':'L'}${40+i*19.5},${190-(v-100)*0.7}`:``).join(' ')} fill="none" stroke="#0077b6" strokeWidth="1.5"/>
            {matchData.map((d,i)=><circle key={i} cx={40+i*19.5} cy={190-(d.value-100)*0.7} r={hoveredMatch===i?4:2} fill="#0077b6" opacity={hoveredMatch===i?1:0.4} style={{cursor:'pointer'}} onMouseEnter={()=>setHoveredMatch(i)} onMouseLeave={()=>setHoveredMatch(null)} onClick={()=>setView({type:'race',race:d.race})}/>)}
            {hoveredMatch!==null&&(()=>{
              const d=matchData[hoveredMatch];
              if(!d)return null;
              return<g>
                <rect x={40+hoveredMatch*19.5-30} y={190-(d.value-100)*0.7-28} width="60" height="20" fill="#1f2937" rx="3"/>
                <text x={40+hoveredMatch*19.5} y={190-(d.value-100)*0.7-14} textAnchor="middle" fontSize="10" fill="#fff" fontWeight="500">{d.value} ‚Üí</text>
              </g>;
            })()}
            {matchData.filter((_,i)=>i%8===0).map((d,i)=><text key={i} x={40+i*8*19.5} y="208" textAnchor="middle" fontSize="8" fill="#6b7280">{d.label}</text>)}
          </svg>
          <div className="flex justify-center gap-6 mt-2">
            <div className="flex items-center gap-1.5"><div className="w-6 h-0.5 bg-[#0077b6] opacity-30"/><span className="text-xs text-gray-500">Per match</span></div>
            <div className="flex items-center gap-1.5"><div className="w-6 h-0.5 bg-[#0077b6]"/><span className="text-xs text-gray-500">4-match avg</span></div>
          </div>
          <p className="text-xs text-gray-400 mt-2 text-center">Click a data point to view that fixture's results</p>
        </div>
      </div>
      
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Average team size per season</h2>
        <div className="bg-gray-50 rounded-lg p-3">
          <svg viewBox="0 0 600 180" className="w-full">
            {avgTeamSize.map((d,i)=>{
              const isHovered=hoveredSeason===i||tappedSeason===i;
              const barH=d.value*6;
              return<g key={i} style={{cursor:'pointer'}} onMouseEnter={()=>setHoveredSeason(i)} onMouseLeave={()=>setHoveredSeason(null)} onClick={()=>setTappedSeason(tappedSeason===i?null:i)}>
                <rect x={35+i*50} y={160-barH} width="40" height={barH} fill={isHovered?'#005f8a':'#0077b6'} rx="2"/>
                <text x={35+i*50+20} y="175" textAnchor="middle" fontSize="9" fill="#6b7280">{d.label}</text>
                {isHovered&&d.value>0&&<text x={35+i*50+20} y={155-barH} textAnchor="middle" fontSize="10" fill="#1f2937" fontWeight="600">{d.value}</text>}
              </g>;
            })}
          </svg>
          <p className="text-xs text-gray-400 mt-2 text-center">Average runners per club per match. 2025/26 incomplete. 2020/21 cancelled.</p>
        </div>
      </div>
      
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Squad sizes by season</h2>
        <div className="bg-gray-50 rounded-lg p-3 overflow-x-auto">
          {(()=>{
            const squadXStep=plotW/(recentSeasons.length-1);
            return<svg viewBox={`0 0 ${chartW} 220`} className="w-full" style={{minWidth:'500px'}}>
            {[0,20,40,60,80,100].map(v=><g key={v}>
              <line x1={padL} y1={190-v*1.7} x2={chartW-padR} y2={190-v*1.7} stroke="#e5e7eb" strokeWidth="1"/>
              <text x={padL-8} y={190-v*1.7+4} textAnchor="end" fontSize="9" fill="#9ca3af">{v}</text>
            </g>)}
            {recentSeasonLabels.map((s,i)=><text key={s} x={padL+i*squadXStep} y="208" textAnchor="middle" fontSize="9" fill="#6b7280">{s}</text>)}
            {squadSizes.map(({code,color,sizes})=>{
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selectedSquad===code;
              const points=sizes.map((size,i)=>({x:padL+i*squadXStep,y:190-size*1.7,size,season:recentSeasons[i]}));
              const validPoints=points.filter(p=>p.size>0);
              if(validPoints.length<2)return null;
              const pathD=validPoints.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(' ');
              const baseOpacity=isPrimary?0.8:0.15;
              const opacity=selectedSquad?(isSelected?1:0.1):baseOpacity;
              return<g key={code} onMouseEnter={()=>setHoveredSquad(code)} onMouseLeave={()=>setHoveredSquad(null)} onClick={()=>setTappedSquad(tappedSquad===code?null:code)} style={{cursor:'pointer'}}>
                <path d={pathD} fill="none" stroke={color} strokeWidth={isSelected?1.5:1} strokeLinecap="round" strokeLinejoin="round" opacity={opacity}/>
                {validPoints.map((p,i)=><circle key={i} cx={p.x} cy={p.y} r={isSelected?3:2} fill={color} opacity={opacity}/>)}
                {isSelected&&validPoints.length>0&&<text x={validPoints[validPoints.length-1].x+8} y={validPoints[validPoints.length-1].y+4} fontSize="10" fill={color} fontWeight="600">{CLUBS[code]?.name||code}</text>}
              </g>;
            })}
          </svg>;
          })()}
          <div className="flex flex-wrap justify-center gap-x-3 gap-y-1 mt-3">
            {squadSizes.map(({code,color})=>{
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selectedSquad===code;
              return<div key={code} className="flex items-center gap-1 cursor-pointer" onMouseEnter={()=>setHoveredSquad(code)} onMouseLeave={()=>setHoveredSquad(null)} onClick={()=>setTappedSquad(tappedSquad===code?null:code)}>
                <div className="w-2 h-2 rounded-full" style={{backgroundColor:color,opacity:isPrimary||isSelected?1:0.3}}/>
                <span className={`text-[10px] ${isPrimary||isSelected?'text-gray-600':'text-gray-400'}`}>{code}</span>
              </div>;
            })}
          </div>
          <p className="text-xs text-gray-400 mt-2 text-center">Unique runners per club per season. Lines stop when club not in Div 1.</p>
        </div>
      </div>
      
      <div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Venues by usage</h2>
        <div className="bg-gray-50 rounded-lg p-4">
          {(()=>{
            // Normalize venues using aliases
            const venueAliases=data.venueAliases||{};
            const normalizeVenue=(v)=>{
              for(const[canonical,aliases]of Object.entries(venueAliases)){
                if(aliases.includes(v))return canonical;
              }
              return v;
            };
            
            // Count venues
            const venueCounts={};
            data.races.forEach(r=>{
              if(!r.venue)return;
              const v=normalizeVenue(r.venue);
              venueCounts[v]=(venueCounts[v]||0)+1;
            });
            
            // Sort by count and prepare data, grouping rare venues
            const allVenues=Object.entries(venueCounts).sort((a,b)=>b[1]-a[1]);
            const mainVenues=allVenues.filter(([,count])=>count>2).map(([name,count])=>({name,count}));
            const rareVenues=allVenues.filter(([,count])=>count<=2);
            
            // Add "Other" category if there are rare venues
            const venues=[...mainVenues];
            if(rareVenues.length>0){
              const rareCount=rareVenues.reduce((sum,[,c])=>sum+c,0);
              venues.push({name:`Other venues (${rareVenues.length})`,count:rareCount,isOther:true});
            }
            
            const total=venues.reduce((sum,v)=>sum+v.count,0);
            const width=750,height=520;
            const colors=['#0077b6','#005f8a','#023e58','#1a5276','#2874a6','#1b4f72','#0e4d64','#1f618d','#21618c','#2e86ab','#1a3c5c','#154360'];
            
            // Simple slice-and-dice treemap
            const rects=[];
            let x=0,y=0,w=width,h=height;
            let horizontal=true;
            
            venues.forEach((v,i)=>{
              const ratio=v.count/total;
              let rw,rh;
              
              if(horizontal){
                rw=w*ratio/(venues.slice(i).reduce((s,vv)=>s+vv.count,0)/total);
                rh=h;
                rects.push({...v,x,y,width:rw,height:rh,color:v.isOther?'#6b7280':colors[i%colors.length]});
                x+=rw;
                if(i<venues.length-1&&x>width*0.6){
                  horizontal=false;
                  w=width-x;
                  x=width-w;
                  y=0;
                }
              }else{
                rw=w;
                rh=h*ratio/(venues.slice(i).reduce((s,vv)=>s+vv.count,0)/total);
                rects.push({...v,x,y,width:rw,height:rh,color:v.isOther?'#6b7280':colors[i%colors.length]});
                y+=rh;
              }
            });
            
            return<svg viewBox={`0 0 ${width} ${height}`} className="w-full">
              {rects.map((r,i)=><g key={i}>
                <rect x={r.x+1} y={r.y+1} width={Math.max(0,r.width-2)} height={Math.max(0,r.height-2)} fill={r.color} rx="4" className="hover:opacity-90 cursor-default"/>
                {r.width>45&&r.height>28&&<text x={r.x+r.width/2} y={r.y+r.height/2-(r.height>45?8:2)} textAnchor="middle" fontSize={r.width>140?"14":"12"} fill="white" fontWeight="600">{r.name}</text>}
                {r.width>40&&r.height>45&&<text x={r.x+r.width/2} y={r.y+r.height/2+10} textAnchor="middle" fontSize="12" fill="rgba(255,255,255,0.9)">{r.count} races</text>}
              </g>)}
            </svg>;
          })()}
          <p className="text-xs text-gray-400 mt-3 text-center">Size represents number of races hosted at each venue since 1962</p>
        </div>
      </div>
    </div>
  </div>;
};

const SubmitView=({setView})=>{
  const[submitType,setSubmitType]=useState('url');
  const[url,setUrl]=useState('');
  const[file,setFile]=useState(null);
  const[notes,setNotes]=useState('');
  const[status,setStatus]=useState(null);
  const[submitting,setSubmitting]=useState(false);
  
  const handleSubmit=async(e)=>{
    e.preventDefault();
    setSubmitting(true);
    
    const formData=new FormData();
    formData.append('access_key','7f1557bd-f355-4008-a904-d892da5489b0'); // You'll replace this
    formData.append('subject','Surrey League Archive - Results Submission');
    formData.append('type',submitType);
    if(submitType==='url')formData.append('url',url);
    if(submitType==='file'&&file)formData.append('attachment',file);
    formData.append('notes',notes);
    
    try{
      const res=await fetch('https://api.web3forms.com/submit',{method:'POST',body:formData});
      if(res.ok){setStatus('success');}else{setStatus('error');}
    }catch(err){setStatus('error');}
    setSubmitting(false);
  };
  
  if(status==='success')return<div className="max-w-xl mx-auto px-4 py-8">
    <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
    <div className="text-center py-12">
      <div className="text-5xl mb-4">‚úÖ</div>
      <h1 className="text-2xl font-bold text-gray-900 mb-2">Thanks!</h1>
      <p className="text-gray-600">Your submission has been received. We'll review it and update the archive.</p>
    </div>
  </div>;
  
  return<div className="max-w-xl mx-auto px-4 py-8">
    <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
    <h1 className="text-2xl font-bold text-gray-900 mb-2">Submit Results</h1>
    <p className="text-sm text-gray-500 mb-6">Help us fill in the gaps! Submit a link to results or upload a file (PDF, image, etc).</p>
    
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="flex gap-4">
        <label className={`flex-1 p-4 border-2 rounded-lg cursor-pointer text-center transition-all ${submitType==='url'?'border-[#0077b6] bg-blue-50':'border-gray-200 hover:border-gray-300'}`}>
          <input type="radio" name="type" value="url" checked={submitType==='url'} onChange={()=>setSubmitType('url')} className="sr-only"/>
          <div className="text-2xl mb-1">üîó</div>
          <div className="font-medium">URL</div>
        </label>
        <label className={`flex-1 p-4 border-2 rounded-lg cursor-pointer text-center transition-all ${submitType==='file'?'border-[#0077b6] bg-blue-50':'border-gray-200 hover:border-gray-300'}`}>
          <input type="radio" name="type" value="file" checked={submitType==='file'} onChange={()=>setSubmitType('file')} className="sr-only"/>
          <div className="text-2xl mb-1">üìÑ</div>
          <div className="font-medium">File</div>
        </label>
      </div>
      
      {submitType==='url'&&<div>
        <label className="block text-sm font-medium text-gray-700 mb-1">URL to results</label>
        <input type="url" value={url} onChange={e=>setUrl(e.target.value)} placeholder="https://..." required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0077b6] focus:border-transparent outline-none"/>
      </div>}
      
      {submitType==='file'&&<div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Upload file</label>
        <input type="file" onChange={e=>setFile(e.target.files[0])} accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx,.csv" required className="w-full px-4 py-2 border border-gray-300 rounded-lg"/>
        <p className="text-xs text-gray-400 mt-1">PDF, images, Word, Excel accepted</p>
      </div>}
      
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
        <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="e.g. Season, match number, venue..." rows={3} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0077b6] focus:border-transparent outline-none resize-none"/>
      </div>
      
      {status==='error'&&<p className="text-red-600 text-sm">Something went wrong. Please try again.</p>}
      
      <button type="submit" disabled={submitting} className="w-full py-3 bg-[#0077b6] text-white rounded-lg hover:bg-[#005f8a] font-medium disabled:opacity-50">
        {submitting?'Submitting...':'Submit'}
      </button>
    </form>
  </div>;
};

const PubQuizView=({setView})=>{
  const questions=[
    {q:"Which father/son duo holds the record for best combined score?",opts:["The Ogdens (SLH)","The Sandersons (G&G)","The Clarks (H/W)","The Makkars (SLH)"],ans:0,info:"George Ogden (24th) + David Ogden (82nd) = 106 pts at Lloyd Park, 2021/22 M4"},
    {q:"Since 2014, how many times has a team escaped the relegation zone on the final day?",opts:["0","1","2","3"],ans:1,info:"Just once: Thames Hare & Hounds in 2023/24, overcoming a 15-point deficit to climb from 9th to 8th"},
    {q:"Since 2014, how many times has a team thrown away the lead on the final day?",opts:["0","1","2","3"],ans:2,info:"Twice: H/W lost a 12-point lead to Kent in 2017/18, and G&G lost a 24-point lead to H/W in 2022/23"},
    {q:"Which team recorded the worst single-match score in a 10-team season?",opts:["Ranelagh Harriers","Epsom & Ewell","Clapham Chasers","Woking AC"],ans:2,info:"Clapham Chasers scored 917 points at Beckenham Place Park in 2025/26 M2"},
    {q:"Which team recorded the best single-match score in a 9-team season?",opts:["Hercules Wimbledon","Kent AC","Herne Hill Harriers","Thames Hare & Hounds"],ans:2,info:"Herne Hill Harriers scored 99 points twice in 2011/12 ‚Äì at Wimbledon Common (M1) and Ham Lands (M2)"},
    {q:"How many times have Clapham Chasers been relegated since 2014?",opts:["1 time","2 times","3 times","4 times"],ans:2,info:"Relegated in 2017/18, 2019/20, and 2023/24 ‚Äì never staying up for more than 3 consecutive seasons"},
    {q:"Which brothers hold the record for best combined score?",opts:["The Holts (H/W)","The Malletts (H/W)","The Roberts (HHH)","The Cockerells (BEL)"],ans:0,info:"Bob Holt (=1st) + Dave Holt (=1st) = 3 pts at Morden Park, 1969/70 M3. They dead-heated for the win!"},
    {q:"What is the biggest points swing between two teams in a single match?",opts:["601 points","657 points","703 points","722 points"],ans:3,info:"H/W scored 153 pts while E&E scored 875 pts at Wimbledon Common, 2024/25 M1 ‚Äì a 722-point gap"},
    {q:"Which clubs have won the title despite winning only one match that season?",opts:["Belgrave Harriers only","Hercules Wimbledon and Aldershot only","Three different clubs","No club has ever done this"],ans:2,info:"BOH (1996/97), H/W (1964/65), and AFD (1975/76) all won titles with just 1 match win"},
    {q:"What is the biggest race turnout in Surrey League history?",opts:["312 finishers","327 finishers","341 finishers","354 finishers"],ans:3,info:"354 finishers at Wimbledon Common, 2023/24 M3 ‚Äì the largest field in league history"}
  ];
  const[current,setCurrent]=useState(0);
  const[selected,setSelected]=useState(null);
  const[score,setScore]=useState(0);
  const[showResult,setShowResult]=useState(false);
  const[finished,setFinished]=useState(false);
  
  const handleSelect=(idx)=>{
    if(showResult)return;
    setSelected(idx);
    setShowResult(true);
    if(idx===questions[current].ans)setScore(s=>s+1);
  };
  
  const nextQuestion=()=>{
    if(current<questions.length-1){
      setCurrent(c=>c+1);
      setSelected(null);
      setShowResult(false);
    }else{
      setFinished(true);
    }
  };
  
  const restart=()=>{
    setCurrent(0);
    setSelected(null);
    setScore(0);
    setShowResult(false);
    setFinished(false);
  };
  
  if(finished){
    const comparisons=[
      {min:0,max:0,name:"Clapham's 917-pt meltdown",club:"C/C",desc:"Beckenham Place Park, 2025/26 M2. The worst single-match score on record.",isTeam:true},
      {min:1,max:1,name:"Ranelagh's 907-pt disaster",club:"RAN",desc:"West Horsley Place, 2023/24 M4. A day to forget ‚Äì this one will haunt you for a while.",isTeam:true},
      {min:2,max:2,name:"Dorking's 850-pt collapse",club:"DMV",desc:"Mitcham Common, 2016/17 M3. The day the wheels came off.",isTeam:true},
      {min:3,max:3,name:"Steve Gardner",club:"BEL",desc:"17 races averaging 106th. You clearly care, but that hasn't helped your performance on this terrain."},
      {min:4,max:4,name:"David Ogden",club:"SLH",desc:"42 races averaging 135th. You clearly like this league enough to put your own son through it too."},
      {min:5,max:5,name:"David Grima",club:"H/W",desc:"40 races averaging 111th. Hercules' most persistent pack runner."},
      {min:6,max:6,name:"Jeff Cunningham",club:"HHH",desc:"39 races averaging 56th. Herne Hill's modern-era ironman."},
      {min:7,max:7,name:"Chris Greenwood",club:"KEN",desc:"28 races averaging 18th. Consistent A-team scorer."},
      {min:8,max:8,name:"John Gilbert",club:"KEN",desc:"32 races averaging 7th with 2 wins. Top 10 regular."},
      {min:9,max:9,name:"Jack Millar",club:"THH",desc:"5 wins from 9 races. Elite performer."},
      {min:10,max:10,name:"Paskar Owor",club:"BEL",desc:"The modern-era GOAT. 11 wins from 37 races, averaging 5th place."}
    ];
    const comp=comparisons.find(c=>score>=c.min&&score<=c.max)||comparisons[5];
    return<div className="max-w-2xl mx-auto px-4 py-8">
      <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
      <div className="text-center py-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-4">Quiz Complete!</h1>
        <div className="text-6xl font-bold text-[#0077b6] mb-6">{score}/{questions.length}</div>
        <div className="bg-gray-50 rounded-xl p-6 mb-6">
          <p className="text-sm text-gray-500 uppercase tracking-wide mb-2">You are{comp.isTeam?' equivalent to':' the'}...</p>
          <div className="flex items-center justify-center gap-3 mb-3">
            <ClubShield club={comp.club} size={32}/>
            <span className="text-2xl font-bold text-gray-900">{comp.name}</span>
          </div>
          <p className="text-gray-600">{comp.desc}</p>
        </div>
        <button onClick={restart} className="px-6 py-3 bg-[#0077b6] text-white rounded-lg hover:bg-[#005f8a] font-medium">Try Again</button>
      </div>
    </div>;
  }
  
  const q=questions[current];
  return<div className="max-w-2xl mx-auto px-4 py-8">
    <button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button>
    <div className="mb-6">
      <h1 className="text-2xl font-bold text-gray-900 mb-1">üç∫ Surrey League Pub Quiz</h1>
      <p className="text-sm text-gray-500">Question {current+1} of {questions.length} ‚Ä¢ Score: {score}/{current+(showResult?1:0)}</p>
    </div>
    <div className="bg-gray-50 rounded-xl p-6 mb-6">
      <h2 className="text-lg font-semibold text-gray-900 mb-4">{q.q}</h2>
      <div className="space-y-3">
        {q.opts.map((opt,i)=>{
          let cls="w-full text-left px-4 py-3 rounded-lg border-2 transition-all ";
          if(!showResult){
            cls+=selected===i?"border-[#0077b6] bg-blue-50":"border-gray-200 hover:border-gray-300 bg-white";
          }else{
            if(i===q.ans)cls+="border-green-500 bg-green-50";
            else if(i===selected)cls+="border-red-500 bg-red-50";
            else cls+="border-gray-200 bg-white opacity-50";
          }
          return<button key={i} onClick={()=>handleSelect(i)} className={cls} disabled={showResult}>
            <span className="font-medium">{String.fromCharCode(65+i)}.</span> {opt}
          </button>;
        })}
      </div>
      {showResult&&<div className={`mt-4 p-4 rounded-lg ${selected===q.ans?'bg-green-100 text-green-800':'bg-amber-100 text-amber-800'}`}>
        <p className="font-medium mb-1">{selected===q.ans?'‚úì Correct!':'‚úó Not quite!'}</p>
        <p className="text-sm">{q.info}</p>
      </div>}
    </div>
    {showResult&&<button onClick={nextQuestion} className="w-full py-3 bg-[#0077b6] text-white rounded-lg hover:bg-[#005f8a] font-medium">
      {current<questions.length-1?'Next Question':'See Results'}
    </button>}
  </div>;
};

const ClubsView=({setView,clubAllTime})=>{
  const[sort,setSort]=useState('titles');
  const sorted=[...clubAllTime].sort((a,b)=>{
    if(sort==='titles')return(b.titles||0)-(a.titles||0)||(b.seconds||0)-(a.seconds||0)||(b.thirds||0)-(a.thirds||0);
    if(sort==='seconds')return(b.seconds||0)-(a.seconds||0)||(b.titles||0)-(a.titles||0)||(b.thirds||0)-(a.thirds||0);
    if(sort==='thirds')return(b.thirds||0)-(a.thirds||0)||(b.titles||0)-(a.titles||0)||(b.seconds||0)-(a.seconds||0);
    if(sort==='seasonCount')return(b.seasonCount||0)-(a.seasonCount||0)||(b.titles||0)-(a.titles||0);
    return 0;
  });
  return<div className="max-w-5xl mx-auto px-4 py-8"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4 text-sm text-gray-900 font-semibold">All-time clubs</th><th className="text-right py-1.5 px-2 w-12"><button onClick={()=>setSort('titles')} className={`${sort==='titles'?'text-[#0077b6]':'text-gray-500 hover:text-gray-900'}`} title="League titles">üèÜ</button></th><th className="text-right py-1.5 px-2 w-10"><button onClick={()=>setSort('seconds')} className={`${sort==='seconds'?'text-[#0077b6]':'text-gray-500 hover:text-gray-900'}`} title="Second place">ü•à</button></th><th className="text-right py-1.5 px-2 w-10"><button onClick={()=>setSort('thirds')} className={`${sort==='thirds'?'text-[#0077b6]':'text-gray-500 hover:text-gray-900'}`} title="Third place">ü•â</button></th><th className="text-right py-1.5 pl-2 w-12"><button onClick={()=>setSort('seasonCount')} className={`${sort==='seasonCount'?'text-[#0077b6]':'text-gray-500 hover:text-gray-900'}`} title="Seasons in Division 1 in our data">üìÖ</button></th></tr></thead><tbody>{sorted.map((c,i)=><tr key={c.club} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-5 text-right">{i+1}</span><ClubShield club={c.club} size={14}/><span className="text-sm text-gray-900 md:hidden">{c.club}</span><span className="text-sm text-gray-900 hidden md:inline">{CLUBS[c.club]?.name||c.club}</span></div></td><td className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort==='titles'?'font-semibold text-[#0077b6]':'text-gray-900'}`}>{c.titles||'-'}</td><td className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort==='seconds'?'font-semibold text-[#0077b6]':'text-gray-600'}`}>{c.seconds||'-'}</td><td className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort==='thirds'?'font-semibold text-[#0077b6]':'text-gray-500'}`}>{c.thirds||'-'}</td><td className={`text-right py-1.5 pl-2 text-sm tabular-nums ${sort==='seasonCount'?'font-semibold text-[#0077b6]':'text-gray-400'}`}>{c.seasonCount||'-'}</td></tr>)}</tbody></table></div>;
};

const ClubDetailView=({clubCode,setView,athletes,races,clubAllTime,clubMvps,seasonsData})=>{
  const[sort,setSort]=useState('aScores');const clubData=clubAllTime.find(c=>c.club===clubCode);const clubInfo=CLUBS[clubCode];
  
  // Compute championship years
  const{titleYears,secondYears,thirdYears}=useMemo(()=>{
    const titles=[],seconds=[],thirds=[];
    Object.entries(seasonsData||{}).forEach(([season,sd])=>{
      if(!sd?.standings?.[0])return;
      const isHist=sd.historical;
      const hasM4=sd.standings[0].m4!==null||isHist;
      if(!hasM4)return;
      const getYear=s=>{const parts=s.split('/');const yy=parts[1];return(parseInt(yy)<50?'20':'19')+yy;};
      if(sd.standings[0]?.club===clubCode)titles.push(getYear(season));
      if(sd.standings[1]?.club===clubCode)seconds.push(getYear(season));
      if(sd.standings[2]?.club===clubCode)thirds.push(getYear(season));
    });
    return{titleYears:titles.sort().reverse(),secondYears:seconds.sort().reverse(),thirdYears:thirds.sort().reverse()};
  },[seasonsData,clubCode]);
  
  // Compute club-specific stats from race results
  const clubAthletes=useMemo(()=>{
    const athleteStats={};
    
    // Helper to ensure athlete entry exists
    const ensureAthlete=(name,club)=>{
      const nameKey=normalizeNameForCompare(name);
      if(!athleteStats[nameKey]){
        athleteStats[nameKey]={
          name:name,
          club:club,
          wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,
          races:0,aScores:0
        };
      }
      return athleteStats[nameKey];
    };
    
    // Go through all races and count stats only when athlete represented this club
    races.forEach(race=>{
      // Handle races without results (only have winner info)
      if(!race.results?.length){
        // Handle dead heats (multiple winners) - each winner has their own club
        if(race.winners){
          race.winners.forEach(w=>{
            if(w.club===clubCode){
              const s=ensureAthlete(w.name,clubCode);
              s.wins++;
              s.top3++;
              s.top5++;
              s.top10++;
              s.races++;
              s.aScores++;
            }
          });
        }else if(race.winnerClub===clubCode){
          const s=ensureAthlete(race.winner,clubCode);
          s.wins++;
          s.top3++;
          s.top5++;
          s.top10++;
          s.races++;
          s.aScores++;
        }
        return;
      }
      
      race.results.forEach((r,idx)=>{
        if(r.club!==clubCode)return;
        const s=ensureAthlete(r.name,clubCode);
        s.races++;
        if(r.pos===1)s.wins++;
        if(r.pos<=3)s.top3++;
        if(r.pos<=5)s.top5++;
        if(r.pos<=10)s.top10++;
        if(r.pos<=20)s.top20++;
        if(r.pos<=50)s.top50++;
        if(r.pos<=100)s.top100++;
        // Count A-team scores (first 10 finishers for this club in this race)
        const clubRunnersInRace=race.results.filter(x=>x.club===clubCode);
        const posInClub=clubRunnersInRace.findIndex(x=>namesMatch(x.name,r.name))+1;
        if(posInClub>=1&&posInClub<=10)s.aScores++;
      });
    });
    
    return Object.values(athleteStats).sort((a,b)=>{
      if(sort==='aScores'){
        if((b.aScores||0)!==(a.aScores||0))return(b.aScores||0)-(a.aScores||0);
        return(b.wins||0)-(a.wins||0);
      }
      if(b[sort]!==a[sort])return(b[sort]||0)-(a[sort]||0);
      if(b.wins!==a.wins)return(b.wins||0)-(a.wins||0);
      if(b.top3!==a.top3)return(b.top3||0)-(a.top3||0);
      return(b.races||0)-(a.races||0);
    });
  },[clubCode,sort,races]);
  
  const mvp=clubAthletes[0];
  const allTimeRank=clubAllTime.findIndex(c=>c.club===clubCode)+1;if(!clubInfo)return<div className="max-w-4xl mx-auto px-4 py-8"><p>Club not found</p></div>;
  const cols=[{f:'aScores',l:'A',t:'A-team scores for this club'},{f:'wins',l:'W',t:'Race wins'},{f:'top3',l:'T3',t:'Top 3 finishes'},{f:'top5',l:'T5',t:'Top 5 finishes'},{f:'top10',l:'T10',t:'Top 10 finishes'},{f:'top20',l:'T20',t:'Top 20 finishes'},{f:'top50',l:'T50',t:'Top 50 finishes'},{f:'top100',l:'T100',t:'Top 100 finishes'},{f:'races',l:'R',t:'Total races'}];
  const yearToSeason=(year)=>{const y=parseInt(year);const yy=(y-1).toString().slice(-2);const yy2=y.toString().slice(-2);return `${y-1>=2000?'':'19'}${yy}/${yy2}`;};
  const renderYears=(years)=>years.map((y,i)=><React.Fragment key={y}>{i>0&&<span className="text-gray-400"> ¬∑ </span>}<span className="cursor-pointer hover:text-[#0077b6] hover:underline" onClick={(e)=>{e.stopPropagation();setView({type:'home',urlSeason:yearToSeason(y)});}}>{y}</span></React.Fragment>);
  return<div className="max-w-5xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'clubs'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-8"><div className="flex items-center gap-4 mb-3"><ClubShield club={clubCode} size={48}/><div><h1 className="text-2xl font-bold text-gray-900" style={{fontFamily:"'Fraunces',serif"}}>{clubInfo.name}</h1>{allTimeRank>0&&<p className="text-sm text-gray-500">#{allTimeRank} all-time</p>}{clubInfo.desc&&<p className="text-sm text-gray-500 italic mt-1">{clubInfo.desc}</p>}</div></div><div className="flex flex-wrap gap-2">{titleYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{titleYears.length}√ó League Champions üèÜ</span><span className="text-sm font-medium text-gray-700">{renderYears(titleYears)}</span></div>}{secondYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{secondYears.length}√ó Runners-up ü•à</span><span className="text-sm font-medium text-gray-700">{renderYears(secondYears)}</span></div>}{thirdYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{thirdYears.length}√ó Third place ü•â</span><span className="text-sm font-medium text-gray-700">{renderYears(thirdYears)}</span></div>}</div>{mvp&&<p className="mt-3 text-sm text-gray-600">Club üêê: <span className="font-medium text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:mvp})}>{mvp.name}</span></p>}</div><div className="overflow-x-auto"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4"><span className="text-xs text-gray-500 uppercase">Athlete</span></th>{cols.map(c=><th key={c.f} className="py-1.5 px-1 w-10 text-center"><button onClick={()=>setSort(c.f)} className={`text-xs uppercase ${sort===c.f?'text-[#0077b6] font-semibold':'text-gray-500'}`} title={c.t}>{c.l}</button></th>)}</tr></thead><tbody>{clubAthletes.map((a,i)=><tr key={a.name} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-6 text-right">{i+1}</span><span className="text-sm text-gray-900">{a.name}</span></div></td>{cols.map(c=><td key={c.f} className={`py-1.5 px-1 w-10 text-center text-sm tabular-nums ${sort===c.f?'font-semibold text-[#0077b6]':'text-gray-600'} ${a[c.f]===0?'text-gray-300':''}`}>{a[c.f]||'-'}</td>)}</tr>)}</tbody></table></div></div>;
};

const SeasonsView=({setView,seasonsData,races,mitchellCupWinners})=>{
  const[expanded,setExpanded]=useState(null);
  
  // Helper to compute individual rankings from race results
  const computeIndividualRankings=(season,seasonRaces)=>{
    const athleteResults={};
    seasonRaces.forEach(r=>{
      if(!r.results)return;
      r.results.forEach(res=>{
        if(!res.pts)return;
        const key=res.name;
        if(!athleteResults[key])athleteResults[key]={name:res.name,club:res.club,runs:[],total:0};
        athleteResults[key].runs.push({match:r.match,pos:res.pos});
      });
    });
    return Object.values(athleteResults)
      .filter(a=>a.runs.length===4)
      .map(a=>{a.total=a.runs.reduce((sum,r)=>sum+r.pos,0);return a;})
      .sort((a,b)=>a.total-b.total);
  };
  
  // Helper to compute B team standings from race results
  const computeBTeamStandings=(season,seasonRaces,numAClubs)=>{
    const clubBScores={};
    seasonRaces.forEach(r=>{
      if(!r.results)return;
      const clubScorers={};
      r.results.forEach(res=>{
        if(!res.pts||!res.club)return;
        if(!clubScorers[res.club])clubScorers[res.club]=[];
        clubScorers[res.club].push(res.pts);
      });
      Object.entries(clubScorers).forEach(([club,pts])=>{
        const bPts=pts.slice(10,20);// B team is scorers 11-20
        if(bPts.length>0){
          if(!clubBScores[club])clubBScores[club]={club,scores:[],total:0};
          const bScore=bPts.reduce((s,p)=>s+p,0);
          // B-team penalty: each missing runner scores (numAClubs √ó 10 + 1)
          // This matches the A-team penalty formula pattern
          const missing=10-bPts.length;
          const penalty=missing>0?missing*(numAClubs*10+1):0;
          clubBScores[club].scores.push(bScore+penalty);
        }
      });
    });
    return Object.values(clubBScores)
      .filter(c=>c.scores.length===4)
      .map(c=>{c.total=c.scores.reduce((s,v)=>s+v,0);return c;})
      .sort((a,b)=>a.total-b.total);
  };
  
  const seasons=useMemo(()=>Object.entries(seasonsData).sort((a,b)=>b[0].localeCompare(a[0])).map(([season,data])=>{
    const storedHistorical=data.historical||false;
    // Check if we have complete race data (>100 results per race for all 4)
    const seasonRaces=races.filter(r=>r.season===season);
    const racesWithResults=seasonRaces.filter(r=>r.results&&r.results.length>100);
    const hasCompleteRaceData=racesWithResults.length===4;
    // Modern seasons need m4 to be set, historical can be complete with standings only
    const isComplete=storedHistorical?true:(data.standings?.[0]?.m4!==null&&data.standings?.[0]?.m4!==undefined);
    // Compute individual/B team if we have complete race data but no stored rankings
    // Fall back to Mitchell Cup historical data if no calculated data available
    let individual=data.individualRankings?.slice(0,3)||(hasCompleteRaceData?computeIndividualRankings(season,seasonRaces).slice(0,3):[]);
    if(individual.length===0&&mitchellCupWinners?.[season]){
      individual=mitchellCupWinners[season].map(w=>({name:w.name,club:w.club,historical:true}));
    }
    const numAClubs=data.standings?.length||9;
    const bTeam=data.bStandings?.slice(0,3)||(hasCompleteRaceData?computeBTeamStandings(season,seasonRaces,numAClubs).slice(0,3):[]);
    return{season,isComplete,isHistorical:storedHistorical&&!hasCompleteRaceData,aTeam:isComplete?data.standings?.slice(0,3):[],bTeam,individual};
  }),[seasonsData,races,mitchellCupWinners]);
  const canExpand=(s)=>s.isComplete&&!s.isHistorical&&(s.bTeam.length>0||(s.individual.length>0&&!s.individual[0]?.historical));
  const shortSeason=(s)=>s.slice(2);// "2024/25" -> "24/25"
  // Render individual winner(s) - handles joint winners from Mitchell Cup data
  const renderIndividual=(ind,isHistorical)=>{
    if(!ind||ind.length===0)return<span className="text-sm text-gray-400">-</span>;
    // Check if this is historical Mitchell Cup data with joint winners
    const isJoint=ind[0]?.historical&&ind.length>1;
    if(isJoint){
      return<div className="flex flex-col gap-0.5">{ind.map((w,i)=><div key={i} className="flex items-center gap-1 md:gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={e=>{e.stopPropagation();setView({type:'athlete',athlete:{name:w.name,club:w.club}});}}><ClubShield club={w.club} size={14}/><span className="text-sm text-gray-700"><span className="hidden md:inline">{w.name}</span><span className="md:hidden">{getSurname(w.name)}</span></span></div>)}</div>;
    }
    const w=ind[0];
    return<div className="flex items-center gap-1 md:gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={e=>{e.stopPropagation();setView({type:'athlete',athlete:{name:w.name,club:w.club}});}}><ClubShield club={w.club} size={14}/><span className="text-sm text-gray-700"><span className="hidden md:inline">{w.name}</span><span className="md:hidden">{getSurname(w.name)}</span></span></div>;
  };
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><h1 className="text-2xl font-bold text-gray-900">Winners</h1><p className="text-sm text-gray-500">{seasons.filter(s=>s.isComplete).length} completed seasons since 1962</p><p className="text-xs text-gray-400 mt-1">Mitchell Cup: Lowest cumulative position. Must complete all fixtures.</p></div><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="w-5 md:w-6"></th><th className="text-left py-1.5 pr-2 md:pr-4 text-xs text-gray-500 uppercase">Season</th><th className="text-left py-1.5 px-1 md:px-4 text-xs text-gray-500 uppercase">A Team</th><th className="text-left py-1.5 px-1 md:px-4 text-xs text-gray-500 uppercase">B Team</th><th className="text-left py-1.5 pl-1 md:pl-4 text-xs text-gray-500 uppercase">Mitchell Cup</th></tr></thead><tbody>{seasons.map(s=><React.Fragment key={s.season}><tr className={`border-b border-gray-50 hover:bg-blue-50 ${canExpand(s)?'cursor-pointer':''}`} onClick={()=>canExpand(s)&&setExpanded(expanded===s.season?null:s.season)}><td className="py-1.5 pr-0.5 md:pr-1">{canExpand(s)&&<span className="text-gray-400">{expanded===s.season?<ChevronUp className="w-4 h-4"/>:<ChevronDown className="w-4 h-4"/>}</span>}</td><td className="py-1.5 pr-2 md:pr-4"><span className="text-sm text-gray-900"><span className="md:hidden">{shortSeason(s.season)}</span><span className="hidden md:inline">{s.season}</span></span></td><td className="py-1.5 px-1 md:px-4">{s.aTeam[0]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.aTeam[0].club} size={14}/><span className="text-sm text-gray-900">{s.aTeam[0].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-1 md:px-4">{s.bTeam[0]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.bTeam[0].club} size={14}/><span className="text-sm text-gray-900">{s.bTeam[0].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-1 md:pl-4">{renderIndividual(s.individual,s.isHistorical)}</td></tr>{expanded===s.season&&<><tr className="bg-gray-50 border-b border-gray-100"><td className="py-1.5 pr-0.5 md:pr-1"></td><td className="py-1.5 pr-2 md:pr-4 text-sm text-gray-400">2nd</td><td className="py-1.5 px-1 md:px-4">{s.aTeam[1]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.aTeam[1].club} size={14}/><span className="text-sm text-gray-600">{s.aTeam[1].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-1 md:px-4">{s.bTeam[1]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.bTeam[1].club} size={14}/><span className="text-sm text-gray-600">{s.bTeam[1].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-1 md:pl-4">{s.individual[1]&&!s.individual[0]?.historical?<div className="flex items-center gap-1 md:gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:s.individual[1].name,club:s.individual[1].club}})}><ClubShield club={s.individual[1].club} size={14}/><span className="text-sm text-gray-600"><span className="hidden md:inline">{s.individual[1].name}</span><span className="md:hidden">{getSurname(s.individual[1].name)}</span></span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr><tr className="bg-gray-50 border-b border-gray-100"><td className="py-1.5 pr-0.5 md:pr-1"></td><td className="py-1.5 pr-2 md:pr-4 text-sm text-gray-400">3rd</td><td className="py-1.5 px-1 md:px-4">{s.aTeam[2]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.aTeam[2].club} size={14}/><span className="text-sm text-gray-600">{s.aTeam[2].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-1 md:px-4">{s.bTeam[2]?<div className="flex items-center gap-1 md:gap-1.5"><ClubShield club={s.bTeam[2].club} size={14}/><span className="text-sm text-gray-600">{s.bTeam[2].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-1 md:pl-4">{s.individual[2]&&!s.individual[0]?.historical?<div className="flex items-center gap-1 md:gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:s.individual[2].name,club:s.individual[2].club}})}><ClubShield club={s.individual[2].club} size={14}/><span className="text-sm text-gray-600"><span className="hidden md:inline">{s.individual[2].name}</span><span className="md:hidden">{getSurname(s.individual[2].name)}</span></span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr></>}</React.Fragment>)}</tbody></table></div>;
};

const SeasonAnalysis=({season,seasonData,races,standings,allSeasonsData,isComplete,data,setView,setSeason})=>{
  const insights=useMemo(()=>{
    const items=[];
    if(!seasonData||!standings?.length)return items;
    const matches=seasonData.matches||[];
    const seasonRaces=races.filter(r=>r.season===season);
    const currentSeason=data.seasons[0];
    const isCurrentSeason=season===currentSeason;
    const numTeams=standings.length;
    const winningTotal=standings[0]?.total;
    const margin=standings.length>=2&&standings[0].total&&standings[1].total?standings[1].total-standings[0].total:null;
    
    // Notable athletes with achievements
    const notableAthletes={
      'Alex Yee':{accolade:'future Olympic gold medalist',club:'KEN'}
    };
    
    // Confirmed brother pairs
    const brotherPairs=[
      {names:['Bob Holt','Dave Holt'],club:'H/W',surname:'Holt'},
      {names:['Ed Mallett','George Mallett'],club:'H/W',surname:'Mallett'},
      {names:['Edward Mallett','George Mallett'],club:'H/W',surname:'Mallett'},
      {names:['Morgan Roberts','Harry Roberts'],club:'HHH',surname:'Roberts'}
    ];
    
    const findLastTitle=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort().reverse();
      for(const s of seasons){if(s>=season)continue;if(allSeasonsData[s]?.standings?.[0]?.club===club)return s;}
      return null;
    };
    
    const findLastInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort().reverse();
      for(const s of seasons){if(s>=season)continue;if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const findNextInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort();
      for(const s of seasons){if(s<=season)continue;if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const findFirstInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort();
      for(const s of seasons){if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const findLastRelegation=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort().reverse();
      for(const s of seasons){
        if(s>=season)continue;
        const sd=allSeasonsData[s];
        if(!sd?.standings)continue;
        const pos=sd.standings.findIndex(t=>t.club===club)+1;
        const numTeams=sd.standings.length;
        // Check if club was in relegation zone (9th or 10th in a 9 or 10 team league)
        if(pos>=9&&pos===numTeams){
          return{season:s,pos};
        }
        // Also check if club disappeared next season (was relegated)
        const nextSeason=Object.keys(allSeasonsData).sort().find(ns=>ns>s);
        if(nextSeason&&allSeasonsData[nextSeason]?.standings){
          const inNext=allSeasonsData[nextSeason].standings.some(t=>t.club===club);
          if(!inNext&&pos>=8)return{season:s,pos};
        }
      }
      return null;
    };
    
    const findLowestPosition=(club)=>{
      let lowest=null;
      const seasons=Object.keys(allSeasonsData).sort();
      for(const s of seasons){
        if(s>=season)continue;
        const sd=allSeasonsData[s];
        if(!sd?.standings)continue;
        const pos=sd.standings.findIndex(t=>t.club===club)+1;
        if(pos>0&&(!lowest||pos>lowest.pos)){
          lowest={season:s,pos};
        }
      }
      return lowest;
    };
    
    const getYear=(s)=>{const yy=s.split('/')[1];return(parseInt(yy)<50?'20':'19')+yy;};
    
    const countAllFourWins=()=>{
      let count=0;
      for(const[s,sd] of Object.entries(allSeasonsData)){
        if(s>=season)continue;
        const wins={};(sd.matches||[]).forEach(m=>{if(m.teamWinner)wins[m.teamWinner]=(wins[m.teamWinner]||0)+1;});
        if(Object.values(wins).some(v=>v===4))count++;
      }
      return count;
    };
    
    const hasAnyoneWonAll4=()=>{
      for(const[s,sd] of Object.entries(allSeasonsData)){
        const ms=sd.matches||[];if(ms.length<4)continue;
        const wins={};ms.forEach(m=>{if(m.winner)wins[m.winner]=(wins[m.winner]||0)+1;});
        if(Object.values(wins).some(v=>v===4))return true;
      }
      return false;
    };
    
    // Find closest/biggest margins and best totals up to this season
    const getMarginStats=()=>{
      let closest=null,biggest=null,bestTotal9=null,bestTotal10=null;
      for(const[s,sd] of Object.entries(allSeasonsData)){
        if(s>season||!sd?.standings?.length||sd.standings.length<2)continue;
        const st=sd.standings;
        const m=st[1].total&&st[0].total?st[1].total-st[0].total:null;
        const total=st[0].total;
        if(m!==null){
          if(!closest||m<closest.margin)closest={season:s,margin:m};
          if(!biggest||m>biggest.margin)biggest={season:s,margin:m};
        }
        if(total){
          if(st.length===9&&(!bestTotal9||total<bestTotal9.total))bestTotal9={season:s,total};
          if(st.length===10&&(!bestTotal10||total<bestTotal10.total))bestTotal10={season:s,total};
        }
      }
      return{closest,biggest,bestTotal9,bestTotal10};
    };
    
    const indWins={};matches.forEach(m=>{if(m.winner)indWins[m.winner]=(indWins[m.winner]||0)+1;});
    const maxIndWins=Math.max(...Object.values(indWins),0);
    const dominantInd=Object.keys(indWins).find(k=>indWins[k]===maxIndWins);
    const dominantIndClub=matches.find(m=>m.winner===dominantInd)?.winnerClub;
    
    const teamWins={};matches.forEach(m=>{if(m.teamWinner)teamWins[m.teamWinner]=(teamWins[m.teamWinner]||0)+1;});
    const maxTeamWins=Math.max(...Object.values(teamWins),0);
    const dominantTeam=Object.keys(teamWins).find(k=>teamWins[k]===maxTeamWins);
    const completedMatches=matches.filter(m=>m.winner).length;
    
    if(isCurrentSeason){
      if(maxIndWins>=3&&dominantInd&&!hasAnyoneWonAll4()){
        items.push({text:'could become the first athlete to win all 4 races in a single season',athlete:{name:dominantInd,club:dominantIndClub}});
      }else if(maxIndWins>=3&&dominantInd){
        items.push({text:'on course to win all 4 races this season',athlete:{name:dominantInd,club:dominantIndClub}});
      }
      
      const leader=standings[0]?.club;
      const leaderTotal=standings[0]?.total;
      const secondTotal=standings[1]?.total;
      const pointLead=leaderTotal&&secondTotal?leaderTotal-secondTotal:null;
      if(leader){
        const lastTitle=findLastTitle(leader);
        if(lastTitle&&parseInt(lastTitle.split('/')[0])<parseInt(season.split('/')[0])-5){
          items.push({text:`have ${Math.abs(pointLead)}-point lead and could win first title since`,club:leader,linkSeason:lastTitle});
        }else if(!lastTitle){
          items.push({text:`have ${Math.abs(pointLead)}-point lead and are on course for first ever league title`,club:leader});
        }else if(pointLead){
          items.push({text:`lead by ${Math.abs(pointLead)} points`,club:leader});
        }
      }
      
      if(standings.length>=2&&standings[0].total&&standings[1].total){
        const gap=standings[0].total-standings[1].total;
        const matchesLeft=4-completedMatches;
        if(gap<150*matchesLeft&&gap>0&&standings[1].club){
          items.push({text:`${gap} points behind with ${matchesLeft} match${matchesLeft>1?'es':''} to go`,club:standings[1].club});
        }
      }
      
      if(standings.length>=9&&season!=='2022/23'){
        // Relegation zone insight with deficit and yo-yo stats
        const numTeams=standings.length;
        const safePos=numTeams-2;// Position that's safe (e.g. 8th in 10-team league)
        const safeTeam=standings[safePos-1];
        const relZone=[numTeams-1,numTeams];// Bottom 2 relegated
        
        relZone.map(pos=>standings[pos-1]).filter(Boolean).forEach(team=>{
          if(team&&items.length<6){
            const deficit=team.total-safeTeam?.total;
            
            // Check if just promoted back
            const prevSeason=data.seasons[data.seasons.indexOf(season)+1];
            const wasInDiv1Last=prevSeason&&allSeasonsData[prevSeason]?.standings?.some(t=>t.club===team.club);
            const justPromoted=!wasInDiv1Last;
            
            // Count relegations since 2014/15 and max consecutive seasons
            let relegationCount=0;
            const relegationSeasons=[];
            let maxConsecutive=0,currentStreak=0;
            
            data.seasons.filter(s=>s>='2014/15'&&s<season&&s!=='2022/23').forEach(s=>{
              const sd=allSeasonsData[s];
              if(!sd?.standings)return;
              const wasIn=sd.standings.some(t=>t.club===team.club);
              const numT=sd.standings.length;
              const relZ=[numT-1,numT];// Bottom 2
              const pos=sd.standings.findIndex(t=>t.club===team.club)+1;
              if(wasIn){
                currentStreak++;
                maxConsecutive=Math.max(maxConsecutive,currentStreak);
                if(relZ.includes(pos)){relegationCount++;relegationSeasons.push(s);}
              }else{currentStreak=0;}
            });
            
            // Build the insight text
            let text=`have ${deficit}-point deficit to overcome to avoid relegation`;
            if(justPromoted)text+=` after just one season back in the top flight`;
            
            // Add threshold note
            if(deficit>757)text+=` ‚Äì mathematically impossible`;
            else if(deficit>600)text+=` ‚Äì would require a near-record final day swing`;
            else if(deficit<=15)text+=` (record: 15 pts)`;
            
            items.push({text,club:team.club});
          }
        });
        
        // Check for clubs that might have their lowest finish
        standings.slice(3,8).forEach((team,idx)=>{
          const currentPos=idx+4;// positions 4-8
          const lowestEver=findLowestPosition(team.club);
          if(lowestEver&&currentPos>lowestEver.pos&&items.length<6){
            items.push({text:`${currentPos}${currentPos===4?'th':currentPos===5?'th':'th'} place would be their lowest Div 1 finish since ${getYear(lowestEver.season)}`,club:team.club});
          }
        });
      }
      
      const biggestRace=seasonRaces.reduce((max,r)=>(r.finishers||0)>=(max?.finishers||0)?r:max,null);
      if(biggestRace?.finishers>=200){
        const allRacesByFinishers=races.filter(r=>r.finishers).sort((a,b)=>b.finishers-a.finishers);
        const rank=allRacesByFinishers.findIndex(r=>r.season===biggestRace.season&&r.match===biggestRace.match)+1;
        const ordinal=rank===1?'biggest ever':rank===2?'2nd biggest':rank===3?'3rd biggest':rank<=10?`${rank}th biggest`:null;
        if(ordinal)items.push({text:`was the ${ordinal} turnout on record (${biggestRace.finishers})`,race:biggestRace,venueName:biggestRace.venue});
      }
      
    }else if(isComplete){
      const champion=standings[0]?.club;
      const marginStats=getMarginStats();
      
      if(champion){
        const lastTitle=findLastTitle(champion);
        const titleCount=Object.entries(allSeasonsData).filter(([s,sd])=>s<=season&&sd?.standings?.[0]?.club===champion).length;
        if(lastTitle){
          const gap=parseInt(season.split('/')[0])-parseInt(lastTitle.split('/')[0]);
          if(gap>=5)items.push({text:`won first title in ${gap} years, since`,club:champion,linkSeason:lastTitle});
        }
        if(titleCount>1){
          const ordinal=['','','2nd','3rd','4th','5th','6th','7th','8th','9th','10th','11th','12th','13th','14th','15th','16th','17th'][titleCount]||`${titleCount}th`;
          items.push({text:`claimed their ${ordinal} league title`,club:champion});
        }
      }
      
      // Margin records
      if(margin!==null&&marginStats.closest?.season===season&&margin<=20){
        items.push({text:`Closest ever winning margin: just ${margin} points`});
      }else if(margin!==null&&margin<=20){
        items.push({text:`Title decided by just ${margin} points`});
      }
      
      if(margin!==null&&marginStats.biggest?.season===season&&margin>=200){
        items.push({text:`Biggest ever winning margin: ${margin} points`});
      }
      
      // Best totals - only show for current season as it's less meaningful historically
      if(isCurrentSeason&&winningTotal&&numTeams===9&&marginStats.bestTotal9?.season===season){
        items.push({text:`Best ever winning total in a 9-team season: ${winningTotal} points`,club:champion});
      }
      if(isCurrentSeason&&winningTotal&&numTeams===10&&marginStats.bestTotal10?.season===season){
        items.push({text:`Best ever winning total in a 10-team season: ${winningTotal} points`,club:champion});
      }
      
      if(maxIndWins>=3&&dominantInd)items.push({text:`won ${maxIndWins} of 4 races`,athlete:{name:dominantInd,club:dominantIndClub}});
      
      // Check for notable athletes winning races
      matches.forEach(match=>{
        if(match.winner&&notableAthletes[match.winner]){
          const notable=notableAthletes[match.winner];
          const race=seasonRaces.find(r=>r.match===match.num);
          if(race)items.push({text:`Match ${match.num} won by ${notable.accolade}`,athlete:{name:match.winner,club:notable.club},race});
        }
      });
      
      // Check for notable athletes in results (first to score when someone else won)
      seasonRaces.forEach(race=>{
        if(!race.results)return;
        const winner=race.results[0];
        if(winner&&!notableAthletes[winner.name]){
          // Winner isn't notable, check if a notable athlete scored
          race.results.slice(1,20).forEach(r=>{
            if(notableAthletes[r.name]){
              const notable=notableAthletes[r.name];
              items.push({text:`Race won by ${winner.name}; ${notable.accolade}`,athlete:{name:r.name,club:notable.club},textAfter:` was ${r.pos}${r.pos===2?'nd':r.pos===3?'rd':'th'}`,race,venueName:race.venue});
            }
          });
        }
      });
      
      // Check for brother pairs combined scores
      const findBrotherScores=(race)=>{
        if(!race.results)return null;
        for(const pair of brotherPairs){
          const found=pair.names.map(name=>race.results.find(r=>r.name.toLowerCase().includes(name.split(' ')[0].toLowerCase())&&r.name.toLowerCase().includes(name.split(' ')[1].toLowerCase()))).filter(Boolean);
          if(found.length>=2){
            const sorted=found.sort((a,b)=>a.pos-b.pos);
            return{combined:sorted[0].pos+sorted[1].pos,runner1:sorted[0],runner2:sorted[1],surname:pair.surname,club:pair.club};
          }
        }
        return null;
      };
      
      // Find best brother score in this season and all-time up to this season
      let bestThisSeason=null;
      seasonRaces.forEach(race=>{
        const score=findBrotherScores(race);
        if(score&&(!bestThisSeason||score.combined<bestThisSeason.combined)){
          bestThisSeason={...score,race};
        }
      });
      
      if(bestThisSeason){
        // Check if it's the all-time record up to this point
        let allTimeBest=bestThisSeason.combined;
        races.filter(r=>r.season<season).forEach(race=>{
          const score=findBrotherScores(race);
          if(score&&score.combined<allTimeBest)allTimeBest=score.combined;
        });
        
        if(bestThisSeason.combined<=allTimeBest&&bestThisSeason.combined<=50){
          items.push({
            text:`Match ${bestThisSeason.race.match} saw the lowest combined score of any two brothers on record:`,
            race:bestThisSeason.race,
            brothers:[
              {name:bestThisSeason.runner1.name,club:bestThisSeason.club,pos:bestThisSeason.runner1.pos},
              {name:bestThisSeason.runner2.name,club:bestThisSeason.club,pos:bestThisSeason.runner2.pos}
            ],
            brothersTotal:bestThisSeason.combined
          });
        }
      }
      
      if(maxTeamWins===4&&dominantTeam){
        const prevCount=countAllFourWins();
        items.push({text:prevCount===0?'became first club to win all 4 matches':`won all 4 matches ‚Äì only happened ${prevCount} time${prevCount>1?'s':''} before`,club:dominantTeam});
      }else if(maxTeamWins===3&&dominantTeam){
        items.push({text:'won 3 of 4 team races',club:dominantTeam});
      }
      
      const biggestRace=seasonRaces.reduce((max,r)=>(r.finishers||0)>=(max?.finishers||0)?r:max,null);
      if(biggestRace?.finishers>=200){
        const allRacesByFinishers=races.filter(r=>r.finishers&&r.season<=season).sort((a,b)=>b.finishers-a.finishers);
        const rank=allRacesByFinishers.findIndex(r=>r.season===biggestRace.season&&r.match===biggestRace.match)+1;
        if(rank===1){
          items.push({text:`set new league record with ${biggestRace.finishers} finishers`,race:biggestRace,venueName:biggestRace.venue});
        }else{
          const ordinal=rank===2?'2nd':rank===3?'3rd':`${rank}th`;
          if(rank<=10)items.push({text:`was the ${ordinal} biggest turnout on record (${biggestRace.finishers})`,race:biggestRace,venueName:biggestRace.venue});
        }
      }
      
      if(standings.length>=2&&standings[1].club){
        const runnerUp=standings[1].club;
        const prevSeason=data.seasons[data.seasons.indexOf(season)+1];
        const prevChamp=prevSeason&&allSeasonsData[prevSeason]?.standings?.[0]?.club;
        if(prevChamp===runnerUp)items.push({text:'were defending champions but finished 2nd',club:runnerUp});
      }
      
      // 2022/23 league expansion - only one team relegated
      if(season==='2022/23'){
        items.push({text:'League expanded to 10 teams ‚Äì only one team relegated this season'});
      }
      
      // 2007/08 notable debut
      if(season==='2007/08'){
        items.push({text:'made his league debut at just 17, finishing 11th at M2',athlete:{name:'Nick Goolab',club:'BEL'}});
      }
      
      // 2000/01 - Sam Haughian's final SL appearance
      if(season==='2000/01'){
        items.push({text:'Final SL appearance of 3-time race winner Sam Haughian who died in a car crash in South Africa in 2004, while training for the Olympics',link:'https://worldathletics.org/news/news/car-crash-robs-europe-of-rising-distance-star'});
      }
      
      // 2004/05 - AFD's final season
      if(season==='2004/05'){
        items.push({text:`competed in their final Surrey League season before joining the Hampshire League`,club:'AFD'});
      }
      
      // 2005/06 - league contracted to 8 teams
      if(season==='2005/06'){
        items.push({text:'League dropped to 8 teams after AFD left to join the Hampshire League (not through relegation)'});
      }
      
      // Final day relegation escape (not for 2022/23 which only relegated one team)
      if(season!=='2022/23'&&standings.length>=9){
        const afterM3=standings.map(t=>({
          club:t.club,
          totalM3:(t.m1||0)+(t.m2||0)+(t.m3||0),
          final:standings.findIndex(x=>x.club===t.club)+1
        })).sort((a,b)=>a.totalM3-b.totalM3);
        
        const numT=standings.length;
        const relZone=[numT-1,numT];// Bottom 2 relegated
        
        afterM3.forEach((t,i)=>{
          const posAfterM3=i+1;
          if(relZone.includes(posAfterM3)&&!relZone.includes(t.final)){
            // Check if this is unique in our data
            const otherEscapes=Object.entries(allSeasonsData).filter(([s,sd])=>{
              if(s>=season||s==='2022/23'||!sd.standings||sd.standings.length<9)return false;
              if(sd.standings[0].m4===null||sd.standings[0].m4===undefined)return false;
              const numTeams=sd.standings.length;
              const rz=[numTeams-1,numTeams];
              const after=sd.standings.map(x=>({
                club:x.club,
                tot:(x.m1||0)+(x.m2||0)+(x.m3||0),
                fin:sd.standings.findIndex(y=>y.club===x.club)+1
              })).sort((a,b)=>a.tot-b.tot);
              return after.some((x,idx)=>rz.includes(idx+1)&&!rz.includes(x.fin));
            });
            const isFirst=otherEscapes.length===0;
            items.push({text:isFirst?'escaped relegation on the final day ‚Äì the only time in league history':'escaped relegation on the final day',club:t.club});
          }
        });
      }
      
      // First/last appearances
      standings.forEach(team=>{
        if(items.length>=5)return;
        const firstSeason=findFirstInDiv1(team.club);
        const nextSeason=findNextInDiv1(team.club);
        
        // First season in Div 1 (in our data)
        if(firstSeason===season){
          items.push({text:`made their first Div 1 appearance in our records`,club:team.club});
        }
        
        // Last season in Div 1 (in our data)
        if(!nextSeason&&firstSeason!==season){
          items.push({textBefore:`This is the last season `,club:team.club,text:` appear in Div 1 in our records`});
        }
      });
    }
    
    return items.slice(0,5);
  },[season,seasonData,races,standings,allSeasonsData,isComplete,data]);
  
  if(!insights.length&&!seasonData?.punditry&&season!=='1962/63')return null;
  // Special historian note for first season
  if(season==='1962/63'){
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">üìñ Alan Mead üñãÔ∏è</span>The league's first season attracted some fine talent. Belgrave provided three individual winners, but the best race of the series came in Match 3 where, over a snow-covered course, the Bels' <span className="inline-block align-middle mr-0.5"><ClubShield club="BEL" size={12}/></span><span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'Gerry North',club:'BEL'}})}>Gerry North</span> and Surrey's <span className="inline-block align-middle mr-0.5"><ClubShield club="SUR" size={12}/></span><span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'John Snowden',club:'SUR'}})}>John Snowden</span> had a battle royal; the latter eventually gained victory by a single second in the last stride or two. Both were nearly 90 seconds clear of the field. The solid Walton AC team became the first league winners.</p>
    </div>;
  }
  // Special historian note for second season
  if(season==='1963/64'){
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">üìñ Alan Mead üñãÔ∏è</span>A 50-strong <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'BEL'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="BEL" size={12}/></span>Belgrave</span> team took a commanding lead in match 1, and hopes were high for a league win. But <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'WAL'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="WAL" size={12}/></span>Walton AC</span> came back strongly to take the next two matches and although their margin was still only 39 points going into the final race, the Bels could not rise to the task of pulling them back. The individual winner was again <span className="inline-block align-middle mr-0.5"><ClubShield club="WAL" size={12}/></span><span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'Bob Roath',club:'WAL'}})}>Bob Roath</span> with 16 pts.</p>
    </div>;
  }
  // Special historian note for third season
  if(season==='1964/65'){
    const match3=races.find(r=>r.season==='1964/65'&&r.match===3);
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">üìñ Alan Mead üñãÔ∏è</span>The number of teams rose to seven as <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'CRO'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="CRO" size={12}/></span>Croydon Harriers</span> joined the Surrey League. <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'WAL'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="WAL" size={12}/></span>Walton</span> had high hopes for a league hat-trick but crashed badly in Race 2 when they were unable to field a complete team. <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'BEL'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="BEL" size={12}/></span>Belgrave</span> prevailed in the opening two runs before they also turned out a weak {match3?<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'race',race:match3})}>Match 3</span>:'Match 3'} team, which was further hamstrung when some missed the start. This allowed <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:'H/W'})}><span className="inline-block align-middle mr-0.5"><ClubShield club="H/W" size={12}/></span>Hercules</span> to take the advantage, overturning a huge points deficit. Even a record low score from Belgrave in the final race was not enough to stop their local rivals from hanging on for the win. That last race saw Tokyo Olympic 5,000m runner <span className="inline-block align-middle mr-0.5"><ClubShield club="MIT" size={12}/></span><span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:'Bengt Nadje',club:'MIT'}})}>Bengt Nadje</span> of Sweden become the league's first overseas race victor.</p>
    </div>;
  }
  // If we have stored punditry for historical seasons, show it
  if(seasonData?.punditry&&insights.length===0){
    return<div className="mt-4">
      <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">Autopundit üó£Ô∏è</span>{seasonData.punditry}</p>
    </div>;
  }
  return<div className="mt-4">
    <p className="text-xs text-gray-600 leading-relaxed"><span className="text-xs text-gray-500 uppercase mr-2">Autopundit üó£Ô∏è</span>{insights.map((item,i)=><React.Fragment key={i}>{i>0&&<span className="mx-1.5 text-gray-300">¬∑</span>}{item.textBefore}{item.club&&!item.brothers&&!item.textBefore&&<span className="text-[#0077b6] hover:underline cursor-pointer whitespace-nowrap" onClick={()=>setView({type:'club',club:item.club})}><span className="inline-block align-middle mr-0.5"><ClubShield club={item.club} size={12}/></span>{item.club}</span>}{item.textBefore&&item.club&&<span className="text-[#0077b6] hover:underline cursor-pointer whitespace-nowrap" onClick={()=>setView({type:'club',club:item.club})}><span className="inline-block align-middle mr-0.5"><ClubShield club={item.club} size={12}/></span>{item.club}</span>}{item.athlete&&<span className="text-[#0077b6] hover:underline cursor-pointer whitespace-nowrap" onClick={()=>setView({type:'athlete',athlete:item.athlete})}><span className="inline-block align-middle mr-0.5"><ClubShield club={item.athlete.club} size={12}/></span>{item.athlete.name}</span>}{item.venueName&&!item.brothers&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'race',race:item.race})}>{item.venueName}</span>}{(item.club||item.athlete||item.venueName)&&!item.brothers&&!item.textBefore?' ':''}{item.brothers&&<>{item.text} <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:item.brothers[0].name,club:item.brothers[0].club}})}>{item.brothers[0].name}</span> ({item.brothers[0].pos}) + <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:item.brothers[1].name,club:item.brothers[1].club}})}>{item.brothers[1].name}</span> ({item.brothers[1].pos}) = {item.brothersTotal} pts</>}{!item.brothers&&item.text}{item.link&&<a href={item.link} target="_blank" rel="noopener noreferrer" className="inline-block align-middle ml-1 text-gray-400 hover:text-[#0077b6]"><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>}{item.linkSeason&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setSeason(item.linkSeason)}> {item.linkSeason}</span>}.</React.Fragment>)}</p>
  </div>;
};

const HomeView=({setView,data,initialSeason})=>{
  const[season,setSeasonState]=useState(initialSeason&&data.seasons.includes(initialSeason)?initialSeason:data.seasons[0]);
  useEffect(()=>{if(initialSeason&&data.seasons.includes(initialSeason))setSeasonState(initialSeason);},[initialSeason]);
  const setSeason=(s)=>{setSeasonState(s);setView({type:'home',urlSeason:s});};
  const seasonData=data.seasonsData[season];const topWinners=[...data.athletes].sort((a,b)=>b.wins-a.wins).filter(a=>a.wins>0).slice(0,5);
  const findRace=(num)=>data.races.find(r=>r.season===season&&r.match===num);const matches=seasonData?.matches||[];const standings=seasonData?.standings||[];
  // Season is complete if all 4 races have >100 results each
  const seasonRaces=data.races.filter(r=>r.season===season);
  const racesWithResults=seasonRaces.filter(r=>r.results&&r.results.length>100);
  const isCurrentSeason=season===data.seasons[0];
  const hasCompleteResults=isCurrentSeason?racesWithResults.length===seasonRaces.filter(r=>r.results?.length>0).length:racesWithResults.length===4;
  const isHistorical=!hasCompleteResults;
  const isComplete=isCurrentSeason?(seasonRaces.length>=4&&standings[0]?.m4!==null&&standings[0]?.m4!==undefined):true;
  // Show relegation zone for complete seasons with full standings (2022/23 only relegated 1 team for expansion)
  const numTeams=standings.length;
  const showRelegation=numTeams>=9;
  // Relegation line position: 2022/23 only relegated 1 team (to expand to 10), all other seasons relegate 2
  const relegationLineAfter=season==='2022/23'?numTeams-2:numTeams-3;
  // Row height alignment: Left has numTeams rows, Right has 4+5=9 rows (plus headers and gap)
  // For 10 teams: left py-[7px], right py-[5px]
  // For 9 teams: left py-[9px], right py-[5px]
  const leftRowPy=numTeams>=10?'py-[7px]':'py-[9px]';
  const rightRowPy='py-[5px]';
  
  const KnownStandingsTable=({knownStandings,setView})=><div>
    <table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th colSpan="3" className="text-left py-[9px] pr-2 text-xs text-gray-500 uppercase">Division 1</th><th className="text-right py-[9px] pr-1 text-xs text-gray-500 uppercase">Tot</th></tr></thead><tbody>{knownStandings.map((team,i)=><tr key={team.club} className="hover:bg-gray-50 border-b border-gray-100"><td className="py-[9px] pr-1 w-6"><span className={`${i===0?'font-bold':'text-gray-600'}`}>{i===0?'üèÜ':team.pos}</span></td><td className="py-[9px] pr-1 w-5"><ClubShield club={team.club} size={16}/></td><td className="py-[9px] pr-2 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:team.club})}><ClubName club={team.club} className={`${i===0?'font-semibold':''}`}/></td><td className="text-right py-[9px] pr-1"><span className={`tabular-nums ${i===0?'font-bold text-[#0077b6]':'font-semibold'}`}>{team.pts}</span></td></tr>)}</tbody></table>
    <p className="text-xs text-gray-400 mt-2 italic">* Final standings from archived results.</p>
  </div>;
  
  const StandingsTable=()=>{
    if(seasonData?.knownStandings)return<KnownStandingsTable knownStandings={seasonData.knownStandings} setView={setView}/>;
    return<div>
    <table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th colSpan="3" className={`text-left ${leftRowPy} pr-2 text-xs text-gray-500 uppercase`}>Division 1</th><th className={`text-right ${leftRowPy} pr-1 text-xs text-gray-500 uppercase`} title="Total of a team's scores across all matches">Tot</th>{matches.map((m,i)=>{const race=findRace(m.num);return<th key={i} className={`text-right ${leftRowPy} px-0.5 w-9 text-xs text-gray-500 uppercase ${race?'cursor-pointer hover:text-[#0077b6]':''}`} title={`Sum of a team's top 10 scoring positions in match ${m.num}`} onClick={()=>race&&setView({type:'race',race})}>M{m.num}</th>})}</tr></thead><tbody>{standings.map((team,i)=><tr key={team.club} className={`hover:bg-gray-50 ${showRelegation&&i===relegationLineAfter?'border-b border-dotted border-gray-300':'border-b border-gray-100'}`}><td className={`${leftRowPy} pr-1 w-6`}><div className="flex items-center"><span className={`${i===0?'font-bold':'text-gray-600'}`}>{i===0&&isComplete?'üèÜ':team.pos}</span><PositionChange change={team.change}/></div></td><td className={`${leftRowPy} pr-1 w-5`}><ClubShield club={team.club} size={16}/></td><td className={`${leftRowPy} pr-2 cursor-pointer hover:text-[#0077b6]`} onClick={()=>setView({type:'club',club:team.club})}><ClubName club={team.club} className={`${i===0?'font-semibold':''}`}/></td><td className={`text-right ${leftRowPy} pr-1`}><span className={`tabular-nums ${i===0?'font-bold text-[#0077b6]':'font-semibold'}`}>{team.total}</span></td>{matches.map((m,mi)=><td key={mi} className={`text-right ${leftRowPy} px-0.5`}><span className="text-gray-600 tabular-nums">{team[`m${m.num}`]||'-'}</span></td>)}</tr>)}</tbody></table>
    {isHistorical&&<p className="text-xs text-gray-400 mt-2 italic">* Only partial results in for this season. <span className="underline cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'submit'})}>Submit results</span>.</p>}
  </div>;};
  
  const FixturesTable=()=><div>
    <table className="w-full text-sm">
      <thead><tr className="border-b border-gray-200">
        <th colSpan="2" className={`text-left ${rightRowPy} pr-2 text-xs text-gray-500 uppercase`}>Matches</th>
        <th className={`text-left ${rightRowPy} px-2 text-xs text-gray-500 uppercase`}>Winner</th>
        <th className={`text-right ${rightRowPy} pl-2 text-xs text-gray-500 uppercase`}>Team</th>
      </tr></thead>
      <tbody className="divide-y divide-gray-100">{matches.map(match=>{
        const race=findRace(match.num);const upcoming=!match.winner;
        return<tr key={match.num} className={`${upcoming?'opacity-50':'hover:bg-blue-50 cursor-pointer'}`} onClick={()=>!upcoming&&race&&setView({type:'race',race})}>
          <td className={`${rightRowPy} pr-2 text-gray-500 whitespace-nowrap w-14`}>{match.date?.length<=3?match.date:formatDateShort(match.date)}</td>
          <td className={`${rightRowPy} px-2 text-gray-900`}>{match.venue}</td>
          <td className={`${rightRowPy} px-2`}>{upcoming?<span className="text-gray-400 italic">-</span>:<div className="flex items-center gap-1.5"><ClubShield club={match.winnerClub} size={14}/><span className="text-gray-700"><span className="hidden md:inline">{match.winner}</span><span className="md:hidden">{getSurname(match.winner)}</span></span></div>}</td>
          <td className={`${rightRowPy} pl-2 text-right`}>{!upcoming&&match.teamWinner?<div className="inline-flex items-center gap-1.5"><ClubShield club={match.teamWinner} size={14}/><span className="font-medium">{match.teamWinner}</span></div>:'-'}</td>
        </tr>;
      })}</tbody>
    </table>
  </div>;
  
  const IndividualsTable=()=>{
    // For historical seasons without race data, show Mitchell Cup winner if available
    if(isHistorical){
      const mitchellWinners=data.mitchellCupWinners?.[season];
      if(!mitchellWinners||mitchellWinners.length===0)return null;
      const isJoint=mitchellWinners.length>1;
      return<div className="mt-3">
        <table className="w-full text-sm">
          <thead><tr className="border-b border-gray-200">
            <th colSpan="3" className={`text-left ${rightRowPy} pr-2 text-xs text-gray-500 uppercase`} title="The Mitchell Cup - Individual champion">Mitchell Cup</th>
          </tr></thead>
          <tbody className="divide-y divide-gray-100">
            {mitchellWinners.map((w,i)=><tr key={i} className="hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:w.name,club:w.club}})}>
              <td className={`${rightRowPy} pr-2 text-gray-400 w-6`}>{isJoint?'=':(i+1)}</td>
              <td className={`${rightRowPy} px-2`}><div className="flex items-center gap-1.5"><ClubShield club={w.club} size={14}/><span className="text-gray-700">{w.name}</span></div></td>
              <td className={`${rightRowPy} px-1 text-right text-gray-400 text-xs`}></td>
            </tr>)}
          </tbody>
        </table>
      </div>;
    }
    const seasonRaces=data.races.filter(r=>r.season===season&&r.results);
    const numRaces=seasonRaces.length;
    if(numRaces===0)return null;
    const athleteResults={};
    seasonRaces.forEach(r=>{
      r.results.forEach(res=>{
        const key=res.name;
        if(!athleteResults[key])athleteResults[key]={name:res.name,club:res.club,runs:[],total:0};
        athleteResults[key].runs.push({match:r.match,pos:res.pos});
      });
    });
    const eligible=Object.values(athleteResults).filter(a=>a.runs.length===numRaces).map(a=>{
      a.runs.sort((x,y)=>x.match-y.match);
      a.total=a.runs.reduce((sum,r)=>sum+r.pos,0);
      return a;
    }).sort((a,b)=>a.total-b.total).slice(0,5);
    if(eligible.length===0)return null;
    return<div className="mt-3">
      <table className="w-full text-sm">
        <thead><tr className="border-b border-gray-200">
          <th colSpan="2" className={`text-left ${rightRowPy} pr-2 text-xs text-gray-500 uppercase`} title="Top 5 athletes who raced in all matches, ranked by sum of positions (lowest is best)">Mitchell Cup</th>
          <th className={`text-right ${rightRowPy} px-1 text-xs text-gray-500 uppercase w-10`} title="Sum of finishing positions across all races">Tot</th>
          {[1,2,3,4].slice(0,numRaces).map(n=><th key={n} className={`text-right ${rightRowPy} px-1 text-xs text-gray-300 uppercase w-8`}></th>)}
        </tr></thead>
        <tbody className="divide-y divide-gray-100">{eligible.map((a,i)=>
          <tr key={a.name} className="hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}>
            <td className={`${rightRowPy} pr-2 text-gray-400 w-6`}>{i+1}</td>
            <td className={`${rightRowPy} px-2`}><div className="flex items-center gap-1.5"><ClubShield club={a.club} size={14}/><span className="text-gray-700">{a.name}</span></div></td>
            <td className={`${rightRowPy} px-1 text-right font-medium tabular-nums w-10`}>{a.total}</td>
            {a.runs.map((r,ri)=><td key={ri} className={`${rightRowPy} px-1 text-right text-gray-400 text-xs tabular-nums w-8`}>{r.pos}</td>)}
          </tr>
        )}</tbody>
      </table>
    </div>;
  };
  
  const allTimeRef=React.useRef(null);
  
  return<div className="max-w-5xl mx-auto px-4 py-8">
    <div className="mb-6">
      <h1 className="text-2xl font-bold text-gray-900 mb-1" style={{fontFamily:"'Fraunces',serif"}}>Surrey League compendium üèÜ</h1>
      <p className="text-sm text-gray-500">Men's Division 1 ¬∑ <span className="cursor-pointer hover:text-[#0077b6] underline" onClick={()=>setView({type:'submit'})}>Partial data 1962‚Äì2014</span> ¬∑ Complete 2014‚Äìpresent</p>
    </div>
    
    {seasonData?<div className="mb-8">
      <div className="flex items-center gap-2 mb-4"><SeasonSelector season={season} setSeason={setSeason} seasons={data.seasons}/></div>
      <div className="grid md:grid-cols-2 gap-8">
        <div className="overflow-hidden"><StandingsTable/></div>
        <div><FixturesTable/><IndividualsTable/></div>
      </div>
      <SeasonAnalysis season={season} seasonData={seasonData} races={data.races} standings={standings} allSeasonsData={data.seasonsData} isComplete={isComplete} data={data} setView={setView} setSeason={setSeason}/>
    </div>:<p className="text-sm text-gray-500 mb-10">No data</p>}
    
    <div ref={allTimeRef} className="border-t border-gray-200 mt-4"></div>
    <div className="grid md:grid-cols-2 gap-8 md:gap-16 pt-6">
      <div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athletes'})}>All-Time Athletes ‚Üí</h2></th><th className="text-right py-1 px-1 text-gray-500 uppercase w-7">W</th><th className="text-right py-1 px-1 text-gray-500 uppercase w-7">T3</th><th className="text-right py-1 px-1 text-gray-500 uppercase w-7">T10</th><th className="text-right py-1 pl-1 text-gray-500 uppercase w-7">R</th></tr></thead><tbody className="divide-y divide-gray-100">{topWinners.map((a,i)=><tr key={a.name} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1 pr-1 text-gray-400 w-4 tabular-nums">{i+1}</td><td className="py-1 pr-1"><div className="flex items-center gap-1 whitespace-nowrap"><ClubShield club={a.club} size={12}/><span className="text-gray-900">{a.name}</span></div></td><td className="py-1 px-1 text-right font-semibold tabular-nums">{a.wins||'-'}</td><td className="py-1 px-1 text-right text-gray-600 tabular-nums">{a.top3||'-'}</td><td className="py-1 px-1 text-right text-gray-600 tabular-nums">{a.top10||'-'}</td><td className="py-1 pl-1 text-right text-gray-400 tabular-nums">{a.races}</td></tr>)}</tbody></table></div>
      <div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'clubs'})}>All-Time Clubs ‚Üí</h2></th><th className="text-right py-1 px-1 text-gray-500 uppercase w-12">Titles</th><th className="text-right py-1 pl-1 text-gray-500 uppercase w-8">2nd</th></tr></thead><tbody className="divide-y divide-gray-100">{data.clubAllTime.slice(0,5).map((c,i)=><tr key={c.club} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1 pr-1 text-gray-400 w-4 tabular-nums">{i+1}</td><td className="py-1 pr-1"><div className="flex items-center gap-1"><ClubShield club={c.club} size={12}/><ClubName club={c.club} className="text-gray-900"/></div></td><td className="py-1 px-1 text-right font-semibold tabular-nums">{c.titles||'-'}</td><td className="py-1 pl-1 text-right text-gray-400 tabular-nums">{c.runnerUp||'-'}</td></tr>)}</tbody></table></div>
    </div>
    
    {data.achievements&&<><div className="grid md:grid-cols-3 gap-6 md:gap-12 mt-6"><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Most Wins in Season</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostWinsSeason?.map((a,i,arr)=>{const prevVal=i>0?arr[i-1].wins:null;const isTied=prevVal===a.wins;return<tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{isTied?'=':i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}><div className="flex items-center gap-1"><ClubShield club={a.club} size={12}/><span className="truncate">{a.name}</span><span className="text-gray-400 ml-1">{a.season.slice(0,4)}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{a.wins}</td></tr>})}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Consecutive Wins</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostConsecutiveWins?.map((a,i,arr)=>{const prevVal=i>0?arr[i-1].streak:null;const isTied=prevVal===a.streak;return<tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{isTied?'=':i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}><div className="flex items-center gap-1"><ClubShield club={a.club} size={12}/><span className="truncate">{a.name}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{a.streak}</td></tr>})}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Consecutive Titles</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostConsecutiveTitles?.map((c,i,arr)=>{const prevVal=i>0?arr[i-1].streak:null;const isTied=prevVal===c.streak;return<tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{isTied?'=':i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:c.club})}><div className="flex items-center gap-1"><ClubShield club={c.club} size={12}/><span>{c.club}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{c.streak}</td></tr>})}</tbody></table></div></div><div className="grid md:grid-cols-2 gap-6 md:gap-16 mt-6"><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Biggest Races</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.biggestRaces?.map((r,i,arr)=>{const race=data.races.find(x=>x.season===r.season&&x.match===r.match);const year=r.date?.slice(0,4);const prevVal=i>0?arr[i-1].finishers:null;const isTied=prevVal===r.finishers;return<tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>race&&setView({type:'race',race})}><td className="py-1 pr-1 text-gray-400 w-4">{isTied?'=':i+1}</td><td className="py-1"><span>{r.venue} {year}</span></td><td className="py-1 text-right text-gray-500 w-10">{r.finishers}</td></tr>;})}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Best Turnout</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.biggestTurnouts?.map((t,i,arr)=>{const race=data.races.find(x=>x.season===t.season&&x.match===t.match);const year=t.date?.slice(0,4);const prevVal=i>0?arr[i-1].count:null;const isTied=prevVal===t.count;return<tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>race&&setView({type:'race',race})}><td className="py-1 pr-1 text-gray-400 w-4">{isTied?'=':i+1}</td><td className="py-1"><div className="flex items-center gap-1"><ClubShield club={t.club} size={12}/><span>{t.venue} {year}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{t.count}</td></tr>;})}</tbody></table></div></div></>}
    
    {(()=>{
      const seasons=['2007/08','2008/09','2009/10','2010/11','2011/12','2012/13','2013/14','2014/15','2015/16','2016/17','2017/18','2018/19','2019/20','2021/22','2022/23','2023/24','2024/25','2025/26'];
      const seasonLabels=['07/08','08/09','09/10','10/11','11/12','12/13','13/14','14/15','15/16','16/17','17/18','18/19','19/20','21/22','22/23','23/24','24/25','25/26'];
      const primaryClubs=['BEL','KEN','THH','H/W'];
      const clubs=[
        {code:'BEL',color:'#7A001D'},{code:'THH',color:'#374151'},{code:'KEN',color:'#2a4d7a'},
        {code:'HHH',color:'#dc2626'},{code:'H/W',color:'#ca8a04'},{code:'G&G',color:'#16a34a'},
        {code:'SLH',color:'#be185d'},{code:'HOL',color:'#1e40af'},{code:'DUL',color:'#7c3aed'},{code:'C/C',color:'#0891b2'},
        {code:'RAN',color:'#0369a1'},{code:'CRO',color:'#525252'},{code:'DMV',color:'#92400e'},
        {code:'E&E',color:'#b91c1c'},{code:'FUL',color:'#171717'},{code:'REI',color:'#e11d48'},
        {code:'SOC',color:'#65a30d'},{code:'WOK',color:'#ea580c'}
      ];
      const getPositions=(club)=>seasons.map(s=>{
        const standings=data.seasonsData[s]?.standings||[];
        const idx=standings.findIndex(t=>t.club===club);
        return idx>=0?idx+1:11;
      });
      const hasDiv1History=(club)=>getPositions(club).some(p=>p<=10);
      const activeClubs=clubs.filter(c=>hasDiv1History(c.code));
      const [hovered,setHovered]=React.useState(null);
      const [tapped,setTapped]=React.useState(null);
      const chartW=800,chartH=250,padL=35,padR=20,padT=20,padB=30;
      const plotW=chartW-padL-padR,plotH=chartH-padT-padB;
      const xStep=plotW/(seasons.length-1);
      const yScale=(pos)=>padT+(pos-1)*(plotH/10);
      const selected=hovered||tapped;
      return<div className="mt-8 pt-6 border-t border-gray-200">
        <h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'chartroom'})}>Chart room ‚Üí</h3>
        <div className="bg-gray-50 rounded-lg p-3 overflow-x-auto">
          <svg viewBox={`0 0 ${chartW} ${chartH}`} className="w-full min-w-[320px] md:min-w-[500px]">
            {[1,2,3,4,5,6,7,8,9,10].map(pos=><g key={pos}>
              <line x1={padL} y1={yScale(pos)} x2={chartW-padR} y2={yScale(pos)} stroke="#e5e7eb" strokeWidth="1"/>
              <text x={padL-8} y={yScale(pos)+4} textAnchor="end" fontSize="10" fill="#9ca3af">{pos}</text>
            </g>)}
            <line x1={padL} y1={yScale(11)} x2={chartW-padR} y2={yScale(11)} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4,2"/>
            <text x={padL-8} y={yScale(11)+4} textAnchor="end" fontSize="9" fill="#d1d5db">Div 2</text>
            {seasonLabels.map((s,i)=><text key={s} x={padL+i*xStep} y={chartH-8} textAnchor="middle" fontSize="9" fill="#6b7280">{s}</text>)}
            {activeClubs.map(({code,color})=>{
              const positions=getPositions(code);
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selected===code;
              const points=positions.map((pos,i)=>({x:padL+i*xStep,y:yScale(pos),pos,season:seasons[i]}));
              const pathD=points.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(' ');
              const baseOpacity=isPrimary?0.8:0.15;
              const opacity=selected?(isSelected?1:0.1):baseOpacity;
              return<g key={code} onMouseEnter={()=>setHovered(code)} onMouseLeave={()=>setHovered(null)} onClick={()=>setTapped(tapped===code?null:code)} style={{cursor:'pointer'}}>
                <path d={pathD} fill="none" stroke={color} strokeWidth={isSelected?1.5:1} strokeLinecap="round" strokeLinejoin="round" opacity={opacity}/>
                {points.map((p,i)=><circle key={i} cx={p.x} cy={p.y} r={isSelected?3:2} fill={color} opacity={opacity}/>)}
                {isSelected&&<text x={points[points.length-1].x+8} y={points[points.length-1].y+4} fontSize="10" fill={color} fontWeight="600">{CLUBS[code]?.name||code}</text>}
              </g>;
            })}
          </svg>
          <div className="flex flex-wrap justify-center gap-x-3 gap-y-1 mt-3">
            {activeClubs.map(({code,color})=>{
              const isPrimary=primaryClubs.includes(code);
              const isSelected=selected===code;
              return<div key={code} className="flex items-center gap-1 cursor-pointer" onMouseEnter={()=>setHovered(code)} onMouseLeave={()=>setHovered(null)} onClick={()=>setTapped(tapped===code?null:code)}>
                <div className="w-2 h-2 rounded-full" style={{backgroundColor:color,opacity:isPrimary||isSelected?1:0.3}}/>
                <span className={`text-[10px] ${isPrimary||isSelected?'text-gray-600':'text-gray-400'}`}>{code}</span>
              </div>;
            })}
          </div>
        </div>
      </div>;
    })()}
  </div>;
};

const Footer=({setView})=><footer className="border-t border-gray-200 mt-12 py-6 text-center text-xs text-gray-400">Vibecoded by Steve. Work in progress. Now <span className="cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'quiz'})}>quiz this</span>. <span className="cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'chartroom'})}>üìä</span><br/><span className="cursor-pointer hover:text-gray-600" onClick={()=>setView({type:'submit'})}>Submit more results</span></footer>;

// Hash-based routing utilities
const seasonToCompact=(s)=>s?s.replace('/','').slice(-4):''; // "2013/14" -> "1314"
const compactToSeason=(c)=>{if(!c||c.length!==4)return null;const y1=parseInt(c.slice(0,2));const y2=parseInt(c.slice(2,4));const prefix=y1>=62&&y1<=99?'19':'20';return `${prefix}${c.slice(0,2)}/${c.slice(2,4)}`;};
const nameToSlug=(n)=>n?.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')||'';
const slugToName=(s,athletes)=>{if(!s)return null;const slug=s.toLowerCase();const match=athletes?.find(a=>nameToSlug(a.name)===slug);return match?.name||s.replace(/-/g,' ');};

const parseUrlParams=(athletes)=>{
  const hash=window.location.hash.slice(1).toLowerCase();
  if(!hash)return{type:'home'};
  const[route,...rest]=hash.split('/');
  const param=rest.join('/');
  switch(route){
    case'season':return{type:'home',urlSeason:compactToSeason(param)};
    case'athlete':return{type:'athlete',athlete:{name:slugToName(param,athletes),slug:param}};
    case'club':return{type:'club',club:param.toUpperCase().replace('HW','H/W').replace('GG','G&G').replace('CC','C/C').replace('EE','E&E')};
    case'race':{const[s,m]=param.split('-');return{type:'race',raceKey:{season:compactToSeason(s),match:parseInt(m)}};}
    case'fixtures':return{type:'fixtures'};
    case'winners':return{type:'seasons'};
    case'athletes':return{type:'athletes'};
    case'clubs':return{type:'clubs'};
    case'h2h':return{type:'h2h'};
    case'quiz':return{type:'quiz'};
    case'chartroom':return{type:'chartroom'};
    default:return{type:'home'};
  }
};

const updateUrl=(view)=>{
  let hash='';
  if(view.type==='home'&&view.urlSeason)hash='#season/'+seasonToCompact(view.urlSeason);
  else if(view.type==='athlete'&&view.athlete?.name)hash='#athlete/'+nameToSlug(view.athlete.name);
  else if(view.type==='club'&&view.club)hash='#club/'+view.club.toLowerCase().replace('/','').replace('&','');
  else if(view.type==='race'&&view.race)hash='#race/'+seasonToCompact(view.race.season)+'-'+view.race.match;
  else if(view.type==='fixtures')hash='#fixtures';
  else if(view.type==='seasons')hash='#winners';
  else if(view.type==='athletes')hash='#athletes';
  else if(view.type==='clubs')hash='#clubs';
  else if(view.type==='h2h')hash='#h2h';
  else if(view.type==='quiz')hash='#quiz';
  else if(view.type==='chartroom')hash='#chartroom';
  if(hash!==window.location.hash)window.history.pushState({},'',hash||window.location.pathname);
};

const AthleteInput=({value,onChange,onSelect,athletes,placeholder})=>{
  const[focused,setFocused]=useState(false);
  const[inputVal,setInputVal]=useState(value?.name||'');
  const suggestions=inputVal.length>=2?athletes.filter(a=>a.name.toLowerCase().includes(inputVal.toLowerCase())).slice(0,8):[];
  useEffect(()=>{setInputVal(value?.name||'');},[value]);
  return<div className="relative flex-1">
    <input type="text" value={inputVal} onChange={e=>{setInputVal(e.target.value);onChange(null);}} onFocus={()=>setFocused(true)} onBlur={()=>setTimeout(()=>setFocused(false),200)} placeholder={placeholder} className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0077b6] focus:border-transparent"/>
    {focused&&suggestions.length>0&&<div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 max-h-64 overflow-y-auto">
      {suggestions.map((a,i)=><div key={i} className="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2" onClick={()=>{onSelect(a);setInputVal(a.name);setFocused(false);}}>
        <ClubShield club={a.club} size={16}/><span className="text-sm text-gray-900">{a.name}</span><span className="text-xs text-gray-400">{CLUBS[a.club]?.name||a.club}</span>
      </div>)}
    </div>}
  </div>;
};

const H2HView=({athletes,races,setView,prefill})=>{
  const[athlete1,setAthlete1]=useState(prefill?.athlete1||null);
  const[athlete2,setAthlete2]=useState(prefill?.athlete2||null);
  
  const getStats=(a)=>{
    if(!a)return null;
    const found=athletes.find(x=>namesMatch(x.name,a.name))||a;
    const allTimeRank=athletes.filter(x=>!x.historical).sort((a,b)=>b.wins-a.wins).findIndex(x=>namesMatch(x.name,found.name))+1;
    const positions=[];
    let bestRace=null;
    let bestPos=Infinity;
    races.filter(r=>r.results?.length).forEach(race=>{
      const result=race.results.find(r=>namesMatch(r.name,a.name));
      if(result){
        positions.push(result.pos);
        if(result.pos<bestPos){bestPos=result.pos;bestRace=race;}
      }
    });
    const avgPos=positions.length>0?positions.reduce((a,b)=>a+b,0)/positions.length:0;
    return{...found,allTimeRank,avgPos,bestPos:bestPos===Infinity?0:bestPos,bestRace};
  };
  
  const computeH2H=()=>{
    if(!athlete1||!athlete2)return null;
    let wins1=0,wins2=0,ties=0;
    const sharedRaces=[];
    races.filter(r=>r.results?.length).forEach(race=>{
      const r1=race.results.find(r=>namesMatch(r.name,athlete1.name));
      const r2=race.results.find(r=>namesMatch(r.name,athlete2.name));
      if(r1&&r2){
        sharedRaces.push({race,pos1:r1.pos,pos2:r2.pos});
        if(r1.pos<r2.pos)wins1++;
        else if(r2.pos<r1.pos)wins2++;
        else ties++;
      }
    });
    return{wins1,wins2,ties,sharedRaces,total:sharedRaces.length};
  };
  
  const stats1=getStats(athlete1);
  const stats2=getStats(athlete2);
  const h2h=computeH2H();
  
  const StatRow=({label,val1,val2,better='lower',onClick1,onClick2})=>{
    const n1=typeof val1==='string'&&val1.startsWith('#')?parseInt(val1.slice(1)):parseFloat(val1);
    const n2=typeof val2==='string'&&val2.startsWith('#')?parseInt(val2.slice(1)):parseFloat(val2);
    const w1=better==='lower'?n1<n2:n1>n2;
    const w2=better==='lower'?n2<n1:n2>n1;
    const color1=w1?'text-green-600':w2?'text-red-500':'text-gray-600';
    const color2=w2?'text-green-600':w1?'text-red-500':'text-gray-600';
    return<tr className="border-b border-gray-100">
      <td className={`py-3 px-4 text-right text-lg font-semibold ${color1} ${onClick1?'cursor-pointer hover:underline':''}`} onClick={onClick1}>{val1}</td>
      <td className="py-3 px-4 text-center text-sm text-gray-500 bg-gray-50">{label}</td>
      <td className={`py-3 px-4 text-left text-lg font-semibold ${color2} ${onClick2?'cursor-pointer hover:underline':''}`} onClick={onClick2}>{val2}</td>
    </tr>;
  };
  
  return<div className="max-w-4xl mx-auto px-4 py-8">
    <h1 className="text-2xl font-bold text-gray-900 mb-6">Head to Head</h1>
    
    <div className="flex gap-4 mb-8">
      <AthleteInput value={athlete1} onChange={setAthlete1} onSelect={setAthlete1} athletes={athletes.filter(a=>!a.historical)} placeholder="Search athlete..."/>
      <div className="flex items-center text-gray-400 font-semibold">vs</div>
      <AthleteInput value={athlete2} onChange={setAthlete2} onSelect={setAthlete2} athletes={athletes.filter(a=>!a.historical)} placeholder="Search athlete..."/>
    </div>
    
    {stats1&&stats2&&h2h&&<div>
      <div className="mb-6 text-center">
        <div className="flex items-center justify-center gap-4 mb-2">
          <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:athlete1})}>
            <ClubShield club={stats1.club} size={24}/>
            <span className="text-lg font-semibold text-gray-900 hover:text-[#0077b6]">{stats1.name}</span>
          </div>
          <span className="text-2xl font-bold text-gray-400">vs</span>
          <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:athlete2})}>
            <span className="text-lg font-semibold text-gray-900 hover:text-[#0077b6]">{stats2.name}</span>
            <ClubShield club={stats2.club} size={24}/>
          </div>
        </div>
        <p className="text-sm text-gray-500">{h2h.total} shared races</p>
      </div>
      
      <table className="w-full mb-8">
        <tbody>
          <tr className="border-b-2 border-gray-200">
            <td className={`py-4 px-4 text-right text-3xl font-bold ${h2h.wins1>h2h.wins2?'text-green-600':h2h.wins1<h2h.wins2?'text-red-500':'text-gray-600'}`}>{h2h.wins1}</td>
            <td className="py-4 px-4 text-center text-sm text-gray-500 bg-gray-50 uppercase">H2H Wins</td>
            <td className={`py-4 px-4 text-left text-3xl font-bold ${h2h.wins2>h2h.wins1?'text-green-600':h2h.wins2<h2h.wins1?'text-red-500':'text-gray-600'}`}>{h2h.wins2}</td>
          </tr>
          <StatRow label="A-Team Scores" val1={stats1.aScores||0} val2={stats2.aScores||0} better="higher"/>
          <StatRow label="Avg Finish" val1={(stats1.avgPos||0).toFixed(1)} val2={(stats2.avgPos||0).toFixed(1)} better="lower"/>
          <StatRow label="Best Finish" val1={stats1.bestPos||'-'} val2={stats2.bestPos||'-'} better="lower" onClick1={stats1.bestRace?()=>setView({type:'race',race:stats1.bestRace}):null} onClick2={stats2.bestRace?()=>setView({type:'race',race:stats2.bestRace}):null}/>
          <StatRow label="Total Races" val1={stats1.races||0} val2={stats2.races||0} better="higher"/>
          <StatRow label="All-Time Rank" val1={stats1.allTimeRank>0?'#'+stats1.allTimeRank:'-'} val2={stats2.allTimeRank>0?'#'+stats2.allTimeRank:'-'} better="lower"/>
        </tbody>
      </table>
      
      {h2h.sharedRaces.length>0&&<div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">Race by Race</h2>
        <table className="w-full">
          <thead><tr className="border-b border-gray-200">
            <th className="text-left py-2 text-xs text-gray-500 uppercase">Race</th>
            <th className="text-right py-2 px-2 text-xs text-gray-500 uppercase w-16">{stats1.name.split(' ')[0]}</th>
            <th className="text-right py-2 px-2 text-xs text-gray-500 uppercase w-16">{stats2.name.split(' ')[0]}</th>
          </tr></thead>
          <tbody className="divide-y divide-gray-100">
            {h2h.sharedRaces.slice().reverse().map((sr,i)=><tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'race',race:sr.race})}>
              <td className="py-2 text-sm text-gray-700">{formatDate(sr.race.date)} ¬∑ {sr.race.venue}</td>
              <td className={`py-2 px-2 text-sm text-right font-medium ${sr.pos1<sr.pos2?'text-green-600':sr.pos1>sr.pos2?'text-red-500':'text-gray-600'}`}>{sr.pos1}</td>
              <td className={`py-2 px-2 text-sm text-right font-medium ${sr.pos2<sr.pos1?'text-green-600':sr.pos2>sr.pos1?'text-red-500':'text-gray-600'}`}>{sr.pos2}</td>
            </tr>)}
          </tbody>
        </table>
      </div>}
    </div>}
    
    {(!athlete1||!athlete2)&&<div className="text-center py-12 text-gray-400">
      <p>Select two athletes to compare</p>
    </div>}
  </div>;
};

const AskView=({data,setView})=>{
  const[query,setQuery]=useState('');
  const[loading,setLoading]=useState(false);
  const[answer,setAnswer]=useState('');
  const[error,setError]=useState('');
  
  const exampleQueries=[
    "Which athlete improved their average position the most from one season to the next?",
    "Who has the best win rate (wins per race)?",
    "Which club has the most athletes with race wins?",
    "What's the closest team race in the database?",
    "Who are the top 5 most consistent athletes (lowest position variance)?",
    "Which venue has produced the most first-time winners?"
  ];
  
  const buildDataSummary=()=>{
    // Create a compact summary of the data for the AI
    const athletes=data.athletes.slice(0,100).map(a=>({
      name:a.name,club:a.club,wins:a.wins,top3:a.top3,top10:a.top10,races:a.races,aScores:a.aScores
    }));
    const seasons=Object.keys(data.seasonsData).sort().reverse();
    const recentRaces=data.races.slice(0,20).map(r=>({
      season:r.season,match:r.match,venue:r.venue,date:r.date,
      top10:r.results.slice(0,10).map(x=>({pos:x.pos,name:x.name,club:x.club}))
    }));
    return{
      stats:data.stats,
      seasons,
      topAthletes:athletes,
      recentRaces,
      clubHonours:data.clubAllTime,
      achievements:data.achievements
    };
  };
  
  const askQuestion=async()=>{
    if(!query.trim())return;
    setLoading(true);
    setError('');
    setAnswer('');
    
    try{
      // Build a summary since full data is too large
      const summary=buildDataSummary();
      
      // For deeper analysis, include race-by-race athlete positions
      const athleteSeasonStats={};
      data.races.forEach(race=>{
        const season=race.season;
        race.results.forEach(r=>{
          const key=r.name;
          if(!athleteSeasonStats[key])athleteSeasonStats[key]={};
          if(!athleteSeasonStats[key][season])athleteSeasonStats[key][season]={positions:[],club:r.club};
          athleteSeasonStats[key][season].positions.push(r.pos);
        });
      });
      
      // Calculate averages per season for each athlete
      const athleteSeasonAvg={};
      Object.entries(athleteSeasonStats).forEach(([name,seasons])=>{
        athleteSeasonAvg[name]={};
        Object.entries(seasons).forEach(([season,data])=>{
          const avg=data.positions.reduce((a,b)=>a+b,0)/data.positions.length;
          athleteSeasonAvg[name][season]={avg:Math.round(avg*10)/10,races:data.positions.length,club:data.club};
        });
      });
      
      const systemPrompt=`You are a helpful assistant analyzing Surrey Cross Country League data. Answer questions about race results, athlete performance, club standings, and statistics. Be specific and cite data. Format answers clearly. When referencing athletes or clubs, be precise with names.

The database contains:
- ${data.stats.totalRaces} races from ${data.stats.seasons} seasons (2014-present with full data)
- ${data.stats.totalAthletes} athletes
- ${data.stats.totalResults} individual results

Key data structures available:
1. Athletes: name, club, wins, top3, top5, top10, top20, races, aScores (A-team finishes)
2. Races: season, match number, venue, date, full results with positions
3. Season standings: club points per match, final standings
4. Club honours: titles, 2nd places, 3rd places all-time`;

      const response=await fetch('https://surrey-league-ai.stephendgardner.workers.dev',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          model:'claude-sonnet-4-20250514',
          max_tokens:1000,
          system:systemPrompt,
          messages:[{
            role:'user',
            content:`Here is a summary of the league data:

TOP 100 ATHLETES:
${JSON.stringify(summary.topAthletes,null,1)}

CLUB HONOURS (ALL-TIME):
${JSON.stringify(summary.clubHonours,null,1)}

ACHIEVEMENTS:
${JSON.stringify(summary.achievements,null,1)}

ATHLETE SEASON AVERAGES (for improvement analysis):
${JSON.stringify(Object.fromEntries(Object.entries(athleteSeasonAvg).filter(([k,v])=>Object.keys(v).length>=2).slice(0,200)),null,1)}

RECENT RACES (top 10 finishers each):
${JSON.stringify(summary.recentRaces,null,1)}

QUESTION: ${query}`
          }]
        })
      });
      
      const result=await response.json();
      if(result.error){
        setError(result.error.message||'API error');
      }else if(result.content&&result.content[0]){
        setAnswer(result.content[0].text);
      }
    }catch(e){
      setError(e.message||'Failed to get answer');
    }finally{
      setLoading(false);
    }
  };
  
  return<div className="max-w-3xl mx-auto px-4 py-8">
    <div className="mb-8">
      <div className="flex items-center gap-2 mb-2">
        <Sparkles className="w-6 h-6 text-[#0077b6]"/>
        <h1 className="text-2xl font-bold text-gray-900">Ask the Archive</h1>
      </div>
      <p className="text-sm text-gray-500">Ask questions about Surrey League history, athlete performance, club records, and more.</p>
    </div>
    
    <div className="mb-6">
      <div className="flex gap-2">
        <input
          type="text"
          value={query}
          onChange={e=>setQuery(e.target.value)}
          onKeyDown={e=>e.key==='Enter'&&!loading&&askQuestion()}
          placeholder="Ask a question about the league..."
          className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0077b6] focus:border-transparent"
        />
        <button
          onClick={askQuestion}
          disabled={loading||!query.trim()}
          className={`px-6 py-3 rounded-lg flex items-center gap-2 ${loading||!query.trim()?'bg-gray-200 text-gray-400':'bg-[#0077b6] text-white hover:bg-[#005f8a]'}`}
        >
          {loading?<span className="animate-pulse">Thinking...</span>:<><Send className="w-4 h-4"/>Ask</>}
        </button>
      </div>
    </div>
    
    {!answer&&!loading&&!error&&<div className="mb-8">
      <p className="text-xs text-gray-500 uppercase tracking-wide mb-3">Example questions</p>
      <div className="flex flex-wrap gap-2">
        {exampleQueries.map((q,i)=><button
          key={i}
          onClick={()=>setQuery(q)}
          className="text-sm px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700"
        >{q}</button>)}
      </div>
    </div>}
    
    {error&&<div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4">{error}</div>}
    
    {answer&&<div className="prose prose-sm max-w-none">
      <div className="p-6 bg-gray-50 rounded-lg border border-gray-200">
        <div className="whitespace-pre-wrap text-gray-800">{answer}</div>
      </div>
      <button onClick={()=>{setAnswer('');setQuery('');}} className="mt-4 text-sm text-[#0077b6] hover:underline">Ask another question</button>
    </div>}
  </div>;
};

// Normalize data to merge case-variant athlete names
const normalizeData=(data)=>{
  // Venue name mappings
  const venueMap={
    'Croyden':'Croydon',
    'Moden':'Morden Park',
    'Morden':'Morden Park',
    'Morden Pk':'Morden Park',
    'Beckenham':'Beckenham Place Park',
    'Beckenham Place':'Beckenham Place Park',
    'Brockwell':'Brockwell Park',
    'Richmond':'Richmond Park',
    'Richmond Pk':'Richmond Park',
    'G Richmond Pk':'Richmond Park',
    'Richmond Park (Sheen Rugby Fields)':'Richmond Park',
    'Wimbledon':'Wimbledon Common',
    'Wimbledon (race won by n/s R Dessaix-Chin, Belg)':'Wimbledon Common',
    'Hamlands':'Ham Lands',
    'Lloyd Park, Croydon':'Lloyd Park',
    'Mitcham':'Mitcham Common',
    'Streatham':'Streatham Common',
    'Epsom':'Epsom Downs',
    'Dorking (race won by n/s F Tickner, Wells)':'Dorking',
    'Pol Dorking':'Dorking',
    'Farthing Down, Coulsdon':'Farthing Downs',
    'West Horsley Place, Guildford':'West Horsley Place',
    'W Wickham':'West Wickham'
  };
  
  // Explicit name mappings (aliases to canonical names)
  const nameAliases={
    'jonathan gilbert':'John Gilbert',
    'r holt':'Bob Holt',
    'd holt':'Dave Holt',
    'dave ogden':'David Ogden',
    'd ogden':'David Ogden',
    'd.ogden':'David Ogden',
    'tom austin':'Thomas Austin',
    // Historical abbreviated names - winners with multiple wins
    'g north':'Gerry North',
    'b ford':'Bernie Ford',
    'b whitby':'Benedict Whitby',
    'p owor':'Paskar Owor',
    'p wicks':'Phil Wicks',
    'j mcmullan':'James McMullen',
    'james mcmullan':'James McMullen',
    'f tickner':'Frank Tickner',
    'g staines':'Gary Staines',
    's rayner':'Steve Rayner',
    'd clarke':'Dave Clarke',
    'j snowden':'John Snowden',
    'p adams':'Phil Adams',
    'r gevers':'Bob Gevers',
    'j roberts':'John Roberts',
    'i wheeler':'Ian Wheeler',
    'r richardson':'Bob Richardson',
    'd taylor':'Dave Taylor',
    'a black':'Alan Black',
    'alastair black':'Alan Black',
    'j thresher':'John Thresher',
    'j hogan':'Jim Hogan',
    'p carr-locke':'Peter Carr-Locke',
    'c smith':'Chris Smith',
    'm miles':'Martin Miles',
    'm hicken':'Malcolm Hicken',
    'c hensby':'Chris Hensby',
    'd murphy':'Declan Murphy',
    'k tadesse':'Kidane Tadesse',
    // Name variations to merge
    'steve sharp':'Steven Sharp',
    'william cockerell':'Will Cockerell',
    'w cockerell':'Will Cockerell',
    'cockerell':'Will Cockerell',
    "t o'neill":"Terry O'Neill",
    "t o'neil":"Terry O'Neill",
    'matt sharp':'Matthew Sharp',
    'mat sharp':'Matthew Sharp',
    // Belgrave names
    'p carstairs':'Phil Carstairs',
    'paul carstairs':'Phil Carstairs',
    'p.carstairs v':'Phil Carstairs',
    'donny anderson':'Don Anderson',
    's zealey':'S Zealey',
    'k nash':'Kevin Nash',
    'w lynch':'William Lynch',
    // Other clubs
    's wurr':'Simon Wurr',
    'a weir':'Andy Weir',
    'n altmann':'Nick Altmann',
    'b reynolds':'Ben Reynolds',
    'm tennyson':'Mark Tennyson',
    'tennyson':'Mark Tennyson',
    // Stuart Major variants
    's major':'Stuart Major',
    'steve major':'Stuart Major',
    'major':'Stuart Major'
  };
  
  // Merge athleteAliases from data.json into nameAliases
  // Format in data.json: { "Canonical Name": ["alias1", "alias2"] }
  if(data.athleteAliases){
    Object.entries(data.athleteAliases).forEach(([canonical, aliases])=>{
      aliases.forEach(alias=>{
        nameAliases[normalizeNameForCompare(alias)]=canonical;
      });
    });
  }
  
  // Club code aliases (map variant codes to canonical codes)
  const clubAliases={
    'RPR':'REI',  // Reigate Priory
    'REG':'REI',  // Reigate
    'PRP':'REI',  // Reigate Priory (typo)
    'RPR':'REI',  // Reigate Priory (old code)
    'WW':'W/W',   // Wimbledon Windmilers
    'WWM':'W/W',  // Wimbledon Windmilers
    'KPH':'K&P',  // Kingston & Polytechnic
    'WEL':'GUEST', // Wells City -> guest
  };
  
  // Normalize club codes in a value
  const normalizeClub=(code)=>clubAliases[code]||code;
  
  // Handle special dead heat cases - these races have two winners with their clubs
  const deadHeats={
    '1966/67-4':{winner:'Bob Holt / Gerry North',winners:[{name:'Bob Holt',club:'H/W'},{name:'Gerry North',club:'BEL'}]},
    '1967/68-2':{winner:'Gerry North / Bob Holt',winners:[{name:'Gerry North',club:'BEL'},{name:'Bob Holt',club:'H/W'}]},
    '1969/70-3':{winner:'Bob Holt / Dave Holt',winners:[{name:'Bob Holt',club:'H/W'},{name:'Dave Holt',club:'H/W'}]},
    '1974/75-1':{winner:'Bernie Ford / Phil Adams',winners:[{name:'Bernie Ford',club:'AFD'},{name:'Phil Adams',club:'AFD'}]},
    '1997/98-4':{winner:'Kidane Tadesse / Gary Staines',winners:[{name:'Kidane Tadesse',club:'BEL'},{name:'Gary Staines',club:'BEL'}]}
  };
  
  // Pre-process races to handle dead heats and name fixes
  data.races.forEach(race=>{
    const raceKey=`${race.season}-${race.match}`;
    // Apply dead heat data
    if(deadHeats[raceKey]){
      race.winner=deadHeats[raceKey].winner;
      race.winners=deadHeats[raceKey].winners;
      race.deadHeat=true;
    }
    // Normalize winner name using aliases (for non-dead-heat races)
    if(race.winner&&!race.deadHeat){
      const winnerKey=normalizeNameForCompare(race.winner);
      if(nameAliases[winnerKey]){
        race.winner=nameAliases[winnerKey];
      }
    }
  });
  
  // Normalize venue names in races
  data.races.forEach(race=>{
    if(race.venue&&venueMap[race.venue]){
      race.venue=venueMap[race.venue];
    }
    // Normalize club codes
    if(race.winnerClub)race.winnerClub=normalizeClub(race.winnerClub);
    if(race.teamWinner)race.teamWinner=normalizeClub(race.teamWinner);
    (race.results||[]).forEach(r=>{
      if(r.club)r.club=normalizeClub(r.club);
    });
    (race.knownTeamScores||[]).forEach(t=>{
      if(t.club)t.club=normalizeClub(t.club);
    });
  });
  
  // Normalize venue names and club codes in seasonsData
  Object.values(data.seasonsData||{}).forEach(sd=>{
    (sd.matches||[]).forEach(m=>{
      if(m.venue&&venueMap[m.venue]){
        m.venue=venueMap[m.venue];
      }
      if(m.winnerClub)m.winnerClub=normalizeClub(m.winnerClub);
      if(m.teamWinner)m.teamWinner=normalizeClub(m.teamWinner);
    });
    (sd.standings||[]).forEach(t=>{
      if(t.club)t.club=normalizeClub(t.club);
    });
    (sd.bStandings||[]).forEach(t=>{
      if(t.club)t.club=normalizeClub(t.club);
    });
    (sd.individualRankings||[]).forEach(a=>{
      if(a.club)a.club=normalizeClub(a.club);
    });
    (sd.knownStandings||[]).forEach(t=>{
      if(t.club)t.club=normalizeClub(t.club);
    });
  });
  
  // Build a map of normalized name -> preferred display name (first occurrence)
  const nameMap={};
  
  // First, set up all the aliases
  Object.entries(nameAliases).forEach(([alias,canonical])=>{
    nameMap[alias]=canonical;
    // Also ensure the canonical name maps to itself
    const canonicalKey=normalizeNameForCompare(canonical);
    if(!nameMap[canonicalKey])nameMap[canonicalKey]=canonical;
  });
  
  // Then process athletes
  data.athletes.forEach(a=>{
    const key=normalizeNameForCompare(a.name);
    // Don't override if this is an alias or already set
    if(!nameMap[key]){
      nameMap[key]=a.name;
    }
  });
  
  // Also check race results for names not in athletes list
  data.races.forEach(race=>{
    (race.results||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(!nameMap[key])nameMap[key]=r.name;
    });
  });
  
  // Merge duplicate athletes
  const mergedAthletes={};
  data.athletes.forEach(a=>{
    let key=normalizeNameForCompare(a.name);
    // If this name has an alias, use the canonical name as the key
    if(nameAliases[key]){
      key=normalizeNameForCompare(nameAliases[key]);
    }
    // Normalize club code
    if(a.club)a.club=normalizeClub(a.club);
    if(!mergedAthletes[key]){
      mergedAthletes[key]={...a,name:nameMap[normalizeNameForCompare(a.name)]||a.name};
    }else{
      // Merge stats
      const m=mergedAthletes[key];
      m.wins=(m.wins||0)+(a.wins||0);
      m.top3=(m.top3||0)+(a.top3||0);
      m.top5=(m.top5||0)+(a.top5||0);
      m.top10=(m.top10||0)+(a.top10||0);
      m.top20=(m.top20||0)+(a.top20||0);
      m.top50=(m.top50||0)+(a.top50||0);
      m.top100=(m.top100||0)+(a.top100||0);
      m.races=(m.races||0)+(a.races||0);
      m.aScores=(m.aScores||0)+(a.aScores||0);
      // Merge clubs array (normalized)
      if(!m.clubs)m.clubs=[m.club];
      const normClub=normalizeClub(a.club);
      if(normClub&&!m.clubs.includes(normClub))m.clubs.push(normClub);
    }
  });
  data.athletes=Object.values(mergedAthletes);
  
  // Normalize names in race results
  data.races.forEach(race=>{
    (race.results||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(nameMap[key])r.name=nameMap[key];
    });
  });
  
  // Normalize names in seasonsData individualRankings
  Object.values(data.seasonsData||{}).forEach(sd=>{
    (sd.individualRankings||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(nameMap[key])r.name=nameMap[key];
    });
  });
  
  // Normalize names in clubMvps
  Object.keys(data.clubMvps||{}).forEach(club=>{
    data.clubMvps[club].forEach(m=>{
      const key=normalizeNameForCompare(m.name);
      if(nameMap[key])m.name=nameMap[key];
    });
  });
  
  // Recompute athlete stats from ALL race results (including historical)
  const athleteStats={};
  data.races.forEach(race=>{
    (race.results||[]).forEach(r=>{
      if(!r.name)return;
      const key=normalizeNameForCompare(r.name);
      if(!athleteStats[key]){
        athleteStats[key]={name:r.name,club:r.club,wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,races:0,aScores:0,clubs:new Set()};
      }
      const s=athleteStats[key];
      s.races++;
      s.clubs.add(r.club);
      if(r.pos===1)s.wins++;
      if(r.pos<=3)s.top3++;
      if(r.pos<=5)s.top5++;
      if(r.pos<=10){s.top10++;s.aScores++;}
      if(r.pos<=20)s.top20++;
      if(r.pos<=50)s.top50++;
      if(r.pos<=100)s.top100++;
    });
  });
  
  // Also count historical races that aren't in race results
  data.athletes.forEach(a=>{
    if(!a.historicalRaces)return;
    const key=normalizeNameForCompare(a.name);
    a.historicalRaces.forEach(hr=>{
      // Check if this race is already in results
      const race=data.races.find(r=>r.season===hr.season&&r.match===hr.match);
      const alreadyCounted=race?.results?.some(res=>normalizeNameForCompare(res.name)===key);
      if(alreadyCounted)return;
      // Count this historical race
      if(!athleteStats[key]){
        athleteStats[key]={name:a.name,club:hr.club||a.club,wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,races:0,aScores:0,clubs:new Set()};
      }
      const s=athleteStats[key];
      s.races++;
      s.clubs.add(hr.club||a.club);
      if(hr.pos===1){s.wins++;s.top3++;s.top5++;s.top10++;s.top20++;s.top50++;s.top100++;s.aScores++;}
      else if(hr.pos<=3){s.top3++;s.top5++;s.top10++;s.top20++;s.top50++;s.top100++;s.aScores++;}
      else if(hr.pos<=5){s.top5++;s.top10++;s.top20++;s.top50++;s.top100++;s.aScores++;}
      else if(hr.pos<=10){s.top10++;s.top20++;s.top50++;s.top100++;s.aScores++;}
      else if(hr.pos<=20){s.top20++;s.top50++;s.top100++;}
      else if(hr.pos<=50){s.top50++;s.top100++;}
      else if(hr.pos<=100){s.top100++;}
    });
  });
  
  // Merge computed stats with existing athletes
  data.athletes.forEach(a=>{
    const key=normalizeNameForCompare(a.name);
    if(athleteStats[key]){
      const s=athleteStats[key];
      // Use computed stats from race results
      a.wins=s.wins;
      a.top3=s.top3;
      a.top5=s.top5;
      a.top10=s.top10;
      a.top20=s.top20;
      a.top50=s.top50;
      a.top100=s.top100;
      a.races=s.races;
      a.aScores=s.aScores;
      // Merge clubs
      if(!a.clubs)a.clubs=[a.club];
      s.clubs.forEach(c=>{if(!a.clubs.includes(c))a.clubs.push(c);});
      delete athleteStats[key]; // Mark as processed
    }
  });
  
  // Add athletes that only exist in race results (not in original athletes array)
  Object.values(athleteStats).forEach(s=>{
    s.clubs=Array.from(s.clubs);
    s.club=s.clubs[0];
    data.athletes.push(s);
  });

  // Recompute all club positions from seasonsData (titles, runnerUp, third, fourth, fifth, sixth)
  const placeCount={};
  Object.values(data.seasonsData||{}).forEach(sd=>{
    if(!sd?.standings)return;
    const isHist=sd.historical;
    const hasM4=sd.standings[0]?.m4!==null||isHist;
    if(!hasM4)return;// Only count complete seasons
    sd.standings.forEach((team,idx)=>{
      if(!placeCount[team.club])placeCount[team.club]={titles:0,runnerUp:0,third:0,fourth:0,fifth:0,sixth:0};
      if(idx===0)placeCount[team.club].titles++;
      if(idx===1)placeCount[team.club].runnerUp++;
      if(idx===2)placeCount[team.club].third++;
      if(idx===3)placeCount[team.club].fourth++;
      if(idx===4)placeCount[team.club].fifth++;
      if(idx===5)placeCount[team.club].sixth++;
    });
  });
  data.clubAllTime.forEach(c=>{
    if(placeCount[c.club]){
      c.titles=placeCount[c.club].titles;
      c.runnerUp=placeCount[c.club].runnerUp;
      c.third=placeCount[c.club].third;
      c.fourth=placeCount[c.club].fourth;
      c.fifth=placeCount[c.club].fifth;
      c.sixth=placeCount[c.club].sixth;
    }
  });
  // Re-sort clubAllTime by titles desc, then runnerUp desc
  data.clubAllTime.sort((a,b)=>(b.titles||0)-(a.titles||0)||(b.runnerUp||0)-(a.runnerUp||0)||(b.third||0)-(a.third||0));
  
  // Dynamically compute achievements from race data
  const computeAchievements=()=>{
    // Most wins in a single season
    const seasonWins={};
    data.races.forEach(race=>{
      if(!race.winner||race.deadHeat)return;
      const key=`${race.winner}|${race.winnerClub}|${race.season}`;
      seasonWins[key]=(seasonWins[key]||0)+1;
    });
    const mostWinsSeasonAll=Object.entries(seasonWins).map(([k,wins])=>{
      const[name,club,season]=k.split('|');
      return{name,club,season,wins};
    }).sort((a,b)=>b.wins-a.wins||a.season.localeCompare(b.season));
    // Deduplicate by athlete - show only their best season
    const seenAthletes=new Set();
    const mostWinsSeason=mostWinsSeasonAll.filter(a=>{
      const key=normalizeNameForCompare(a.name);
      if(seenAthletes.has(key))return false;
      seenAthletes.add(key);
      return true;
    }).slice(0,5);
    
    // Consecutive wins (across seasons) - sort by season then match, not by date string
    const winnersByDate=data.races.filter(r=>r.winner&&!r.deadHeat).sort((a,b)=>a.season.localeCompare(b.season)||a.match-b.match);
    const streaks={};
    let lastWinner=null;
    winnersByDate.forEach(race=>{
      const key=normalizeNameForCompare(race.winner);
      if(!streaks[key])streaks[key]={name:race.winner,club:race.winnerClub,current:0,max:0};
      if(lastWinner===key){
        streaks[key].current++;
      }else{
        streaks[key].current=1;
      }
      streaks[key].max=Math.max(streaks[key].max,streaks[key].current);
      lastWinner=key;
    });
    const mostConsecutiveWins=Object.values(streaks).map(s=>({name:s.name,club:s.club,streak:s.max})).sort((a,b)=>b.streak-a.streak).slice(0,5);
    
    // Biggest races by finishers
    const biggestRaces=data.races.filter(r=>r.finishers).sort((a,b)=>b.finishers-a.finishers).slice(0,5).map(r=>({venue:r.venue,season:r.season,match:r.match,date:r.date,finishers:r.finishers}));
    
    // Most consecutive titles by club
    const seasonsByYear=Object.keys(data.seasonsData).filter(s=>{
      const sd=data.seasonsData[s];
      return sd?.standings?.length&&(sd.standings[0]?.m4!==null||sd.historical);
    }).sort();
    const clubStreaks={};
    let lastChamp=null;
    seasonsByYear.forEach(season=>{
      const champ=data.seasonsData[season]?.standings?.[0]?.club;
      if(!champ)return;
      if(!clubStreaks[champ])clubStreaks[champ]={current:0,max:0};
      if(lastChamp===champ){
        clubStreaks[champ].current++;
      }else{
        clubStreaks[champ].current=1;
      }
      clubStreaks[champ].max=Math.max(clubStreaks[champ].max,clubStreaks[champ].current);
      lastChamp=champ;
    });
    const mostConsecutiveTitles=Object.entries(clubStreaks).map(([club,s])=>({club,streak:s.max})).sort((a,b)=>b.streak-a.streak).slice(0,5);
    
    // Best turnout by club at a single race
    const turnouts=[];
    data.races.forEach(race=>{
      if(!race.results)return;
      const clubCounts={};
      race.results.forEach(r=>{
        clubCounts[r.club]=(clubCounts[r.club]||0)+1;
      });
      Object.entries(clubCounts).forEach(([club,count])=>{
        turnouts.push({club,count,venue:race.venue,season:race.season,match:race.match,date:race.date});
      });
    });
    const biggestTurnouts=turnouts.sort((a,b)=>b.count-a.count).slice(0,5);
    
    return{mostWinsSeason,mostConsecutiveWins,biggestRaces,mostConsecutiveTitles,biggestTurnouts};
  };
  data.achievements=computeAchievements();
  
  // Dynamically compute club MVPs (GOATs) from athlete data
  const computeClubMvps=()=>{
    const clubAthletes={};
    data.athletes.forEach(a=>{
      const clubs=a.clubs||[a.club];
      clubs.forEach(club=>{
        if(!club)return;
        if(!clubAthletes[club])clubAthletes[club]=[];
        clubAthletes[club].push({name:a.name,aScores:a.aScores||0,races:a.races||0});
      });
    });
    const mvps={};
    Object.entries(clubAthletes).forEach(([club,athletes])=>{
      const sorted=athletes.sort((a,b)=>b.aScores-a.aScores||b.races-a.races);
      mvps[club]=sorted.slice(0,3).map((a,i)=>({...a,mvpRank:i+1}));
    });
    return mvps;
  };
  data.clubMvps=computeClubMvps();
  
  // Compute individual champions with count of titles
  const computeIndividualChampions=()=>{
    const champions={};
    Object.values(data.seasonsData||{}).forEach(sd=>{
      if(sd.individualRankings?.length>0){
        const winner=sd.individualRankings[0];
        if(winner?.name){
          const key=normalizeNameForCompare(winner.name);
          champions[key]=(champions[key]||0)+1;
        }
      }
    });
    return champions;
  };
  data.individualChampions=computeIndividualChampions();
  
  return data;
};

function App(){
  const[view,setViewState]=useState({type:'home'});const[data,setData]=useState(null);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);
  const setView=(v)=>{setViewState(v);updateUrl(v);};
  useEffect(()=>{fetch('data.json').then(r=>r.json()).then(j=>{setData(normalizeData(j));setLoading(false);}).catch(e=>{setError(e.message);setLoading(false);});},[]);
  // Parse URL once data is loaded (needed for athlete name resolution)
  useEffect(()=>{if(data){const parsed=parseUrlParams(data.athletes);if(parsed.raceKey){const race=data.races.find(r=>r.season===parsed.raceKey.season&&r.match===parsed.raceKey.match);if(race)setViewState({type:'race',race});else setViewState(parsed);}else{setViewState(parsed);}}},[data]);
  useEffect(()=>{const onPop=()=>{const parsed=parseUrlParams(data?.athletes);if(parsed.raceKey&&data){const race=data.races.find(r=>r.season===parsed.raceKey.season&&r.match===parsed.raceKey.match);if(race)setViewState({type:'race',race});else setViewState(parsed);}else{setViewState(parsed);}};window.addEventListener('popstate',onPop);return()=>window.removeEventListener('popstate',onPop);},[data]);
  useEffect(()=>{const onHash=()=>{const parsed=parseUrlParams(data?.athletes);if(parsed.raceKey&&data){const race=data.races.find(r=>r.season===parsed.raceKey.season&&r.match===parsed.raceKey.match);if(race)setViewState({type:'race',race});else setViewState(parsed);}else{setViewState(parsed);}};window.addEventListener('hashchange',onHash);return()=>window.removeEventListener('hashchange',onHash);},[data]);
  if(loading)return<div className="loading text-gray-500">Loading...</div>;if(error)return<div className="loading text-red-500">Error: {error}</div>;if(!data)return<div className="loading text-gray-500">No data</div>;
  return<div className="min-h-screen bg-white flex flex-col"><Nav setView={setView}/><main className="flex-1">{view.type==='home'&&<HomeView setView={setView} data={data} initialSeason={view.urlSeason}/>}{view.type==='race'&&<RaceDetailView race={view.race} setView={setView} seasonsData={data.seasonsData} clubMvps={data.clubMvps} races={data.races} individualChampions={data.individualChampions}/>}{view.type==='fixtures'&&<FixturesView setView={setView} races={data.races} seasonsData={data.seasonsData}/>}{view.type==='seasons'&&<SeasonsView setView={setView} seasonsData={data.seasonsData} races={data.races} mitchellCupWinners={data.mitchellCupWinners}/>}{view.type==='athletes'&&<AthletesView setView={setView} athletes={data.athletes}/>}{view.type==='athlete'&&<AthleteDetailView athlete={view.athlete} setView={setView} athletes={data.athletes} races={data.races} clubMvps={data.clubMvps} seasonsData={data.seasonsData} mitchellCupWinners={data.mitchellCupWinners}/>}{view.type==='clubs'&&<ClubsView setView={setView} clubAllTime={data.clubAllTime}/>}{view.type==='club'&&<ClubDetailView clubCode={view.club} setView={setView} athletes={data.athletes} races={data.races} clubAllTime={data.clubAllTime} clubMvps={data.clubMvps} seasonsData={data.seasonsData}/>}{view.type==='h2h'&&<H2HView athletes={data.athletes} races={data.races} setView={setView} prefill={view.prefill}/>}{view.type==='quiz'&&<PubQuizView setView={setView}/>}{view.type==='submit'&&<SubmitView setView={setView}/>}{view.type==='chartroom'&&<ChartRoomView setView={setView} data={data}/>}</main><Footer setView={setView}/></div>;
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
