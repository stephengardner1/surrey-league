<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unofficial Surrey League archive</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path d='M6 6L26 26M26 6L6 26' stroke='%2322c55e' stroke-width='5' stroke-linecap='round'/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}.loading{display:flex;align-items:center;justify-content:center;height:100vh}[data-tip]{position:relative}[data-tip]:hover::after{content:attr(data-tip);position:absolute;top:100%;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;white-space:nowrap;z-index:50;margin-top:4px;font-weight:normal;text-transform:none}</style>
</head>
<body>
<div id="root"><div class="loading">Loading...</div></div>
<script type="text/babel">
const{useState,useMemo,useEffect}=React;
const normalizeNameForCompare=(name)=>name?.toLowerCase().trim()||'';
const namesMatch=(a,b)=>normalizeNameForCompare(a)===normalizeNameForCompare(b);
const CLUBS={'BEL':{name:'Belgrave Harriers'},'KEN':{name:'Kent AC'},'THH':{name:'Thames Hare & Hounds'},'HHH':{name:'Herne Hill Harriers'},'H/W':{name:'Hercules Wimbledon'},'SLH':{name:'South London Harriers'},'G&G':{name:'Guildford & Godalming'},'RAN':{name:'Ranelagh Harriers'},'C/C':{name:'Clapham Chasers'},'DUL':{name:'Dulwich Runners'},'HOL':{name:'Holland Sports'},'WAL':{name:'Walton AC'},'CRO':{name:'Croydon Harriers'},'WOK':{name:'Woking AC'},'E&E':{name:'Epsom & Ewell'},'FUL':{name:'Fulham RC'},'SOC':{name:'Striders of Croydon'},'BOX':{name:'Boxhill Racers'},'BOH':{name:'Borough of Hounslow'},'AFD':{name:'Aldershot Farnham & District'},'SUR':{name:'Surrey AC'},'MIT':{name:'Mitcham AC'},'REI':{name:'Reigate Priory AC'},'DMV':{name:'Dorking & Mole Valley'},'STR':{name:'Stragglers Running Club'},'W4H':{name:'West 4 Harriers'}};

const ClubVest=({club,size=20})=>{
  const id=`v-${club}-${Math.random().toString(36).substr(2,5)}`;
  const p="M3 0 L7 0 L8 3 L12 3 L13 0 L17 0 L17 20 L3 20 Z";
  const r=()=>{switch(club){
    case'KEN':return<><path d={p} fill="#2a4d7a"/><path d="M13 5 L15 5.5 L15 7.5 C15 8.5 14 9 13 9.5 C12 9 11 8.5 11 7.5 L11 5.5 Z" fill="#dc2626"/></>;
    case'H/W':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,0 6,0 20,20 14,20" fill="#c41e3a"/></g></>;
    case'THH':return<><path d={p} fill="#fff"/><line x1="6" y1="5" x2="14" y2="15" stroke="#1a1a1a" strokeWidth="2"/><line x1="14" y1="5" x2="6" y2="15" stroke="#1a1a1a" strokeWidth="2"/></>;
    case'BEL':return<><path d={p} fill="#7A001D"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="7" width="20" height="4" fill="#CCAD6A"/></g></>;
    case'HHH':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g></>;
    case'G&G':return<path d={p} fill="#228b22"/>;
    case'SLH':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="13" y="0" width="4" height="20" fill="#800020"/></g></>;
    case'DUL':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="2" fill="#1e3a8a"/><rect x="0" y="12" width="20" height="2" fill="#1e3a8a"/></g></>;
    case'HOL':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#fff"/></g></>;
    case'RAN':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'C/C':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="10" width="20" height="10" fill="#1e3a8a"/><rect x="0" y="9" width="20" height="2" fill="#228b22"/></g></>;
    case'WAL':return<><path d={p} fill="#1a1a1a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="2" fill="#f4c430"/><rect x="0" y="8" width="20" height="2" fill="#dc2626"/><rect x="0" y="10" width="20" height="2" fill="#f4c430"/></g></>;
    case'CRO':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="5" width="20" height="2" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="2" fill="#1a1a1a"/></g></>;
    case'WOK':return<><path d={p} fill="#ff6600"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#32CD32"/></g></>;
    case'E&E':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'FUL':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g></>;
    case'SOC':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#228b22"/><rect x="14" y="0" width="3" height="20" fill="#228b22"/></g></>;
    case'BOX':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g></>;
    case'BOH':return<><path d={p} fill="#87CEEB"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g></>;
    case'AFD':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="14" y="0" width="3" height="20" fill="#fff"/><rect x="0" y="6" width="20" height="3" fill="#228b22"/></g></>;
    case'SUR':return<path d={p} fill="#f4c430"/>;
    case'DMV':return<><path d={p} fill="#A52A2A"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#fff"/><rect x="14" y="0" width="3" height="20" fill="#fff"/></g></>;
    case'REI':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,0 6,0 20,14 20,20 14,20 0,6" fill="#87CEEB"/></g></>;
    case'STR':return<><path d={p} fill="#f4c430"/><text x="10" y="13" textAnchor="middle" fontSize="9" fontWeight="bold" fill="#1a1a1a">S</text></>;
    case'W4H':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="4" fill="#00CED1"/></g></>;
    default:return<path d={p} fill="#9ca3af"/>;
  }};
  return<svg width={size} height={size} viewBox="0 0 20 20" className="shrink-0">{r()}<path d={p} fill="none" stroke="#374151" strokeWidth="0.5"/></svg>;
};
const ClubShield=ClubVest;
const PositionChange=({change})=>{if(change===0||change===null||change===undefined)return null;if(change>0)return<span className="w-3 text-center text-green-600 text-xs font-bold">‚Üë</span>;return<span className="w-3 text-center text-red-600 text-xs font-bold">‚Üì</span>;};
const ClubName=({club,className=''})=><><span className={`md:hidden ${className}`}>{club}</span><span className={`hidden md:inline ${className}`}>{CLUBS[club]?.name||club}</span></>;
const ChevronLeft=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 18l-6-6 6-6"/></svg>;
const ChevronRight=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>;
const ArrowLeft=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>;
const X=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>;
const ChevronDown=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9l6 6 6-6"/></svg>;
const ChevronUp=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 15l-6-6-6 6"/></svg>;
const Sparkles=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 3v1m0 16v1m-8-9h1m16 0h1m-2.636-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>;
const Send=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>;
const formatDate=(d)=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
const formatDateShort=(d)=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
const formatDateMonthYear=(d)=>new Date(d).toLocaleDateString('en-GB',{month:'short',year:'numeric'});

const Nav=({setView})=><nav className="border-b border-gray-200 bg-white sticky top-0 z-50"><div className="max-w-5xl mx-auto px-2 md:px-4 flex items-center justify-between h-12"><div className="cursor-pointer hidden md:block" onClick={()=>setView({type:'home'})}><span className="text-sm text-gray-500">Unofficial Surrey League archive</span></div><div className="flex gap-0.5 md:gap-1 text-xs md:text-sm w-full md:w-auto justify-between md:justify-end"><button onClick={()=>setView({type:'home'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50"><span className="md:hidden">Tables</span><span className="hidden md:inline">Standings</span></button><button onClick={()=>setView({type:'fixtures'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50"><span className="md:hidden">Races</span><span className="hidden md:inline">Fixtures</span></button><button onClick={()=>setView({type:'seasons'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Winners</button><button onClick={()=>setView({type:'athletes'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Athletes</button><button onClick={()=>setView({type:'clubs'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Clubs</button><button onClick={()=>setView({type:'h2h'})} className="px-1.5 md:px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">H2H</button></div></div></nav>;

const SeasonSelector=({season,setSeason,seasons})=>{
  const[showDropdown,setShowDropdown]=useState(false);
  const idx=seasons.indexOf(season);
  const dropdownRef=React.useRef(null);
  
  React.useEffect(()=>{
    const handleClick=(e)=>{if(dropdownRef.current&&!dropdownRef.current.contains(e.target))setShowDropdown(false);};
    document.addEventListener('mousedown',handleClick);
    return()=>document.removeEventListener('mousedown',handleClick);
  },[]);
  
  return<div className="flex items-center relative" ref={dropdownRef}>
    <button onClick={()=>idx<seasons.length-1&&setSeason(seasons[idx+1])} className={`p-0.5 rounded ${idx<seasons.length-1?'hover:bg-gray-100 text-gray-600':'text-gray-300'}`}><ChevronLeft className="w-5 h-5"/></button>
    <span className="text-base font-semibold text-gray-900 min-w-[5rem] text-center cursor-pointer hover:text-[#0077b6]" onClick={()=>setShowDropdown(!showDropdown)}>{season}</span>
    <button onClick={()=>idx>0&&setSeason(seasons[idx-1])} className={`p-0.5 rounded ${idx>0?'hover:bg-gray-100 text-gray-600':'text-gray-300'}`}><ChevronRight className="w-5 h-5"/></button>
    {showDropdown&&<div className="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto py-1">
      {seasons.map(s=><div key={s} className={`px-4 py-1 text-sm cursor-pointer hover:bg-gray-100 ${s===season?'font-semibold text-[#0077b6]':'text-gray-700'}`} onClick={()=>{setSeason(s);setShowDropdown(false);}}>{s}</div>)}
    </div>}
  </div>;
};

const TeamResultsTable=({results,startPos=1,count=10})=>{
  const teams=useMemo(()=>{
    const clubScores={};
    const clubScoringCounts={};
    // For A team (startPos=1): count runners with pts, take first 10
    // For B team (startPos=11): count runners with b_pts, take first 10
    const isATeam = startPos === 1;
    results.forEach(r=>{
      const hasPts = isATeam ? (r.pts != null) : (r.b_pts != null);
      const pts = isATeam ? r.pts : r.b_pts;
      if(!clubScoringCounts[r.club]) clubScoringCounts[r.club] = 0;
      if(!clubScores[r.club]) clubScores[r.club] = [];
      if(hasPts) {
        clubScoringCounts[r.club]++;
        if(clubScoringCounts[r.club] <= count) {
          clubScores[r.club].push(pts);
        }
      }
    });
    return Object.entries(clubScores).map(([club,scores])=>({club,points:scores.reduce((a,b)=>a+b,0),scores,complete:scores.length>=count})).filter(t=>t.scores.length>0).sort((a,b)=>{if(a.complete&&!b.complete)return-1;if(!a.complete&&b.complete)return 1;return a.points-b.points;}).map((t,i)=>({...t,pos:i+1}));
  },[results,startPos,count]);
  return<div><table className="w-full"><thead><tr className="border-b-2 border-[#0077b6] bg-gray-50"><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-12">Pos</th><th className="w-8"></th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase">Club</th><th className="text-right py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-20">Points</th><th className="text-left py-2 px-4 text-xs font-semibold text-[#0077b6] uppercase">Scores</th></tr></thead><tbody className="divide-y divide-gray-100">{teams.map(team=><tr key={team.club} className="hover:bg-gray-50"><td className="py-2 px-2 text-sm text-gray-700">{team.pos}</td><td className="py-2 px-1"><ClubShield club={team.club} size={20}/></td><td className="py-2 px-2 text-sm font-medium text-gray-900">{team.club}</td><td className="py-2 px-2 text-sm font-bold text-gray-900 text-right">{team.points}</td><td className="py-2 px-4"><div className="flex flex-wrap gap-1.5">{team.scores.map((s,i)=><span key={i} className="text-xs text-gray-400 tabular-nums">{s}</span>)}{!team.complete&&<span className="text-xs text-gray-300 italic ml-1">incomplete</span>}</div></td></tr>)}</tbody></table></div>;
};

const IndividualResultsTable=({results,clubFilter,setClubFilter,setView,clubMvps})=>{
  const filtered=clubFilter?results.filter(r=>r.club===clubFilter):results;
  const isClubGoat=(name,club)=>{const mvps=clubMvps?.[club];return mvps&&namesMatch(mvps[0]?.name,name);};
  return<div>{clubFilter&&<div className="mb-4 flex items-center gap-2 text-sm"><span className="text-gray-500">Showing:</span><span className="flex items-center gap-2 bg-gray-100 px-2 py-1 rounded"><ClubShield club={clubFilter} size={16}/><span className="font-medium">{CLUBS[clubFilter]?.name||clubFilter}</span><button onClick={()=>setClubFilter(null)} className="text-gray-400 hover:text-gray-600"><X className="w-4 h-4"/></button></span></div>}<table className="w-full"><thead><tr className="border-b-2 border-[#0077b6] bg-gray-50"><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-12">Pos</th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-12">Pts</th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-20">Club</th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase">Name</th><th className="text-right py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-16">Time</th></tr></thead><tbody className="divide-y divide-gray-100">{filtered.map((r,i)=><tr key={i} className="hover:bg-blue-50"><td className="py-1.5 px-2 text-sm text-gray-700">{r.pos}</td><td className="py-1.5 px-2 text-sm text-gray-500">{r.pts||'-'}</td><td className="py-1.5 px-2"><span className="flex items-center gap-1 cursor-pointer" onClick={()=>setClubFilter(r.club)}><ClubShield club={r.club} size={14}/><span className="text-xs text-gray-500">{r.club}</span></span></td><td className="py-1.5 px-2"><span className="text-sm text-gray-900 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:r.name,club:r.club}})}>{r.name}{isClubGoat(r.name,r.club)&&' üêê'}{r.ns&&<span className="text-gray-400 ml-1">(N/S)</span>}{r.secondClaim&&<span className="text-gray-400 ml-1">(2C)</span>}</span></td><td className="py-1.5 px-2 text-sm text-gray-700 text-right font-mono">{r.time}</td></tr>)}</tbody></table></div>;
};

const RaceDetailView=({race,setView,seasonsData,clubMvps,races})=>{
  const[tab,setTab]=useState('individual');const[clubFilter,setClubFilter]=useState(null);if(!race)return null;
  const seasonData=seasonsData[race.season];const matchData=seasonData?.matches?.find(m=>m.num===race.match);const teamWinner=matchData?.teamWinner||race.teamWinner;
  
  // Find prev/next races
  const sortedRaces=useMemo(()=>[...races].filter(r=>r.results?.length>0).sort((a,b)=>{if(a.season!==b.season)return a.season.localeCompare(b.season);return a.match-b.match;}),[races]);
  const currentIdx=sortedRaces.findIndex(r=>r.season===race.season&&r.match===race.match);
  const prevRace=currentIdx>0?sortedRaces[currentIdx-1]:null;
  const nextRace=currentIdx<sortedRaces.length-1?sortedRaces[currentIdx+1]:null;
  
  return<div className="max-w-5xl mx-auto px-4 py-8">
    <div className="flex items-center justify-between mb-4">
      <button onClick={()=>setView({type:'fixtures'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900"><ArrowLeft className="w-4 h-4"/>Fixtures</button>
      <div className="flex items-center gap-2">
        {prevRace?<button onClick={()=>setView({type:'race',race:prevRace})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 px-2 py-1 rounded hover:bg-gray-100"><ChevronLeft className="w-4 h-4"/><span className="hidden sm:inline">{prevRace.venue}</span><span className="sm:hidden">Prev</span></button>:<span className="w-16"/>}
        {nextRace?<button onClick={()=>setView({type:'race',race:nextRace})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 px-2 py-1 rounded hover:bg-gray-100"><span className="hidden sm:inline">{nextRace.venue}</span><span className="sm:hidden">Next</span><ChevronRight className="w-4 h-4"/></button>:<span className="w-16"/>}
      </div>
    </div>
    <div className="mb-6"><div className="text-sm text-gray-500 mb-1">{formatDate(race.date)} ¬∑ {race.season} ¬∑ Match {race.match}</div><h1 className="text-2xl font-bold text-gray-900">{race.venue}</h1>{teamWinner&&<p className="text-sm text-gray-700 mt-1 flex items-center gap-2"><ClubShield club={teamWinner} size={16}/><span className="font-medium">{CLUBS[teamWinner]?.name||teamWinner}</span><span className="text-gray-500">win the match</span></p>}</div><div className="flex gap-4 mb-6 border-b border-gray-200">{[{id:'individual',label:'Individual'},{id:'a-teams',label:'A Teams'},{id:'b-teams',label:'B Teams'}].map(t=><button key={t.id} onClick={()=>{setTab(t.id);setClubFilter(null);}} className={`pb-2 text-sm font-medium border-b-2 -mb-px transition-colors ${tab===t.id?'border-[#0077b6] text-[#0077b6]':'border-transparent text-gray-500 hover:text-gray-700'}`}>{t.label}</button>)}</div>{tab==='a-teams'&&<TeamResultsTable results={race.results} startPos={1} count={10}/>}{tab==='b-teams'&&<TeamResultsTable results={race.results} startPos={11} count={10}/>}{tab==='individual'&&<IndividualResultsTable results={race.results} clubFilter={clubFilter} setClubFilter={setClubFilter} setView={setView} clubMvps={clubMvps}/>}</div>;
};

const FixturesView=({setView,races,seasonsData})=>{
  const allFixtures=useMemo(()=>[...races].sort((a,b)=>{if(a.season!==b.season)return b.season.localeCompare(a.season);return a.match-b.match;}),[races]);let lastSeason=null;
  const getChampion=(season)=>{const sd=seasonsData[season];if(!sd?.standings?.[0])return null;const isHist=sd.historical;const hasM4=sd.standings[0].m4!==null||isHist;return hasM4?sd.standings[0].club:null;};
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><h1 className="text-2xl font-bold text-gray-900">Fixtures</h1><p className="text-sm text-gray-500">{allFixtures.length} matches since 1962</p></div><table className="w-full"><tbody>{allFixtures.map((race,i)=>{const show=race.season!==lastSeason;const champ=show?getChampion(race.season):null;lastSeason=race.season;const isHist=race.historical;return<React.Fragment key={`${race.season}-${race.match}`}>{show&&<tr><td colSpan={4} className="pt-6 pb-2"><div className="flex items-center gap-2 text-xs font-semibold text-gray-400 uppercase tracking-wide border-b border-gray-200 pb-1"><span>{race.season}</span>{champ&&<><span className="text-amber-500">üèÜ</span><ClubShield club={champ} size={14}/><span className="text-gray-600 normal-case font-medium">{champ}</span></>}</div></td></tr>}<tr className={`border-b border-gray-50 ${isHist?'':'hover:bg-blue-50 cursor-pointer'}`} onClick={()=>!isHist&&setView({type:'race',race})}><td className="py-1.5 pr-2 text-sm text-gray-500 w-20">{race.date?.length<=3?race.date:formatDateShort(race.date)}</td><td className="py-1.5 px-2 text-sm text-gray-900">{race.venue}</td><td className="py-1.5 px-2 w-44"><div className="flex items-center gap-1.5"><ClubShield club={race.winnerClub} size={14}/><span className="text-sm text-gray-700">{race.winner}</span></div></td><td className="py-1.5 pl-2 w-24">{race.teamWinner&&<div className="flex items-center gap-1.5"><ClubShield club={race.teamWinner} size={14}/><span className="text-sm font-medium text-gray-900">{race.teamWinner}</span></div>}</td></tr></React.Fragment>;})}</tbody></table></div>;
};

const AthletesView=({setView,athletes})=>{
  const[sort,setSort]=useState('wins');const[search,setSearch]=useState('');const[limit,setLimit]=useState(100);
  const filtered=useMemo(()=>{const s=search.toLowerCase();return athletes.filter(a=>!s||a.name.toLowerCase().includes(s)||a.club?.toLowerCase().includes(s));},[athletes,search]);
  const sorted=useMemo(()=>[...filtered].sort((a,b)=>b[sort]-a[sort]),[filtered,sort]);
  const cols=[{f:'wins',l:'W',t:'Race wins'},{f:'top3',l:'T3',t:'Top 3 finishes'},{f:'top5',l:'T5',t:'Top 5 finishes'},{f:'top10',l:'T10',t:'Top 10 finishes'},{f:'top20',l:'T20',t:'Top 20 finishes'},{f:'top50',l:'T50',t:'Top 50 finishes'},{f:'top100',l:'T100',t:'Top 100 finishes'},{f:'races',l:'R',t:'Total races'}];
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><input type="text" placeholder={`Search ${filtered.length.toLocaleString()} athletes...`} value={search} onChange={e=>{setSearch(e.target.value);setLimit(100);}} className="px-3 py-2 border border-gray-300 rounded text-sm w-full sm:w-72 focus:outline-none focus:ring-2 focus:ring-[#0077b6]"/></div><div className="overflow-x-auto"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4"><span className="text-xs text-gray-500 uppercase">Athlete</span></th>{cols.map(c=><th key={c.f} className="text-right py-1.5 px-2 min-w-[2.5rem]"><button onClick={()=>setSort(c.f)} className={`text-xs uppercase ${sort===c.f?'text-[#0077b6] font-semibold':'text-gray-500'}`} data-tip={c.t}>{c.l}</button></th>)}</tr></thead><tbody>{sorted.slice(0,limit).map((a,i)=><tr key={a.name} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-6 text-right">{i+1}</span><ClubShield club={a.club} size={14}/><span className="text-sm text-gray-900">{a.name}</span></div></td>{cols.map(c=><td key={c.f} className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort===c.f?'font-semibold text-[#0077b6]':'text-gray-600'} ${a[c.f]===0?'text-gray-300':''}`}>{a[c.f]||'-'}</td>)}</tr>)}</tbody></table></div>{sorted.length>limit&&<div className="mt-4 text-center"><button onClick={()=>setLimit(l=>l+100)} className="px-4 py-2 bg-[#0077b6] text-white rounded text-sm hover:bg-[#005f8a]">Show more ({sorted.length-limit} remaining)</button></div>}</div>;
};

const AthleteDetailView=({athlete,setView,athletes,races,clubMvps,seasonsData})=>{
  const[compareInput,setCompareInput]=useState('');
  const[compareFocused,setCompareFocused]=useState(false);
  // Enhanced athlete lookup - match by exact name, or by abbreviated first initial + surname
  const athleteData=useMemo(()=>{
    if(!athlete?.name)return null;
    // First try exact match
    let found=athletes.find(a=>namesMatch(a.name,athlete.name));
    if(found)return found;
    // Try matching abbreviated name (e.g., "S Haughian" matches "Sam Haughian")
    const parts=athlete.name.trim().split(/\s+/);
    if(parts.length>=2&&parts[0].length<=2){
      const initial=parts[0].replace('.','').toLowerCase();
      const surname=parts.slice(1).join(' ').toLowerCase();
      found=athletes.find(a=>{
        const aParts=a.name.trim().split(/\s+/);
        if(aParts.length<2)return false;
        const aInitial=aParts[0][0]?.toLowerCase();
        const aSurname=aParts.slice(1).join(' ').toLowerCase();
        return aInitial===initial[0]&&aSurname===surname&&(!athlete.club||a.club===athlete.club);
      });
    }
    return found||athlete;
  },[athlete,athletes]);
  const sortedByWins=[...athletes].sort((a,b)=>b.wins-a.wins);const allTimeRank=sortedByWins.findIndex(a=>namesMatch(a.name,athleteData?.name))+1;
  
  const raceHistory=useMemo(()=>{
    const h=[];
    const seenRaces=new Set();
    races.forEach(race=>{
      const result=race.results?.find(r=>namesMatch(r.name,athleteData?.name));
      if(result){
        // Calculate team scoring position
        let teamScore='';
        if(result.club&&race.results){
          const clubRunners=race.results.filter(r=>r.club===result.club);
          const posInClub=clubRunners.findIndex(r=>namesMatch(r.name,result.name))+1;
          if(posInClub>=1&&posInClub<=10)teamScore=`A${posInClub}`;
          else if(posInClub>=11&&posInClub<=20)teamScore=`B${posInClub-10}`;
        }
        h.push({date:race.date,venue:race.venue,pos:result.pos,time:result.time,club:result.club,race,historical:false,teamScore});
        // Track by season+match AND season+venue+pos to catch duplicates
        seenRaces.add(`${race.season}-${race.match}`);
        seenRaces.add(`${race.season}-${race.venue}-${result.pos}`);
      }
    });
    if(athleteData?.historicalRaces){
      athleteData.historicalRaces.forEach(hr=>{
        // Skip if we already have actual results for this race (check both match# and venue+pos)
        if(seenRaces.has(`${hr.season}-${hr.match}`))return;
        if(seenRaces.has(`${hr.season}-${hr.venue}-${hr.pos}`))return;
        const race=races.find(r=>r.season===hr.season&&r.match===hr.match);
        h.push({date:race?.date||hr.season,venue:hr.venue,pos:hr.pos,time:'-',club:hr.club,race,historical:true,season:hr.season,teamScore:hr.pos===1?'A1':''});
      });
    }
    return h.sort((a,b)=>{const aKey=a.historical?a.season:a.date;const bKey=b.historical?b.season:b.date;return bKey.localeCompare(aKey);});
  },[athleteData?.name,athleteData?.historicalRaces,races]);
  
  // Compute club GOAT rankings dynamically from race history for each club
  const clubRankings=useMemo(()=>{
    if(!raceHistory.length)return [];
    
    // Get unique clubs this athlete has represented (excluding N/S)
    const athleteClubs=[...new Set(raceHistory.map(r=>r.club).filter(c=>c&&c!=='N/S'))];
    
    // For each club, compute all athletes' A-scores and find this athlete's rank
    const rankings=[];
    athleteClubs.forEach(club=>{
      // Compute A-scores for all athletes at this club from race results
      const clubStats={};
      races.forEach(race=>{
        if(!race.results)return;
        const clubRunners=race.results.filter(r=>r.club===club);
        clubRunners.slice(0,10).forEach((r,i)=>{
          const key=r.name.toLowerCase();
          if(!clubStats[key])clubStats[key]={name:r.name,aScores:0};
          clubStats[key].aScores++;
        });
      });
      
      // Sort by A-scores
      const sorted=Object.values(clubStats).sort((a,b)=>b.aScores-a.aScores);
      const rank=sorted.findIndex(a=>namesMatch(a.name,athleteData.name))+1;
      
      if(rank>0){
        rankings.push({club,rank});
      }
    });
    
    return rankings.sort((a,b)=>a.rank-b.rank);
  },[raceHistory,races,athleteData?.name]);
  
  const po10Url=useMemo(()=>{if(!athleteData?.name)return null;const parts=athleteData.name.split(' ');if(parts.length<2)return null;const firstname=parts[0];const surname=parts.slice(1).join(' ');return`https://www.thepowerof10.info/athletes/athleteslookup.aspx?surname=${encodeURIComponent(surname)}&firstname=${encodeURIComponent(firstname)}`;},[athleteData?.name]);
  const bestPos=useMemo(()=>raceHistory.length>0?Math.min(...raceHistory.map(r=>r.pos)):null,[raceHistory]);
  const showStar=bestPos&&bestPos>1;
  
  // Compute stats dynamically from raceHistory
  const computedStats=useMemo(()=>{
    const stats={wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,races:raceHistory.length,aScores:0};
    let histWins=0;
    raceHistory.forEach(r=>{
      if(r.pos===1){stats.wins++;if(r.historical)histWins++;}
      if(r.pos<=3)stats.top3++;
      if(r.pos<=5)stats.top5++;
      if(r.pos<=10)stats.top10++;
      if(r.pos<=20)stats.top20++;
      if(r.pos<=50)stats.top50++;
      if(r.pos<=100)stats.top100++;
      if(r.teamScore&&r.teamScore.startsWith('A'))stats.aScores++;
    });
    return{...stats,histWins,modernWins:stats.wins-histWins};
  },[raceHistory]);
  
  if(!athleteData)return<div className="max-w-4xl mx-auto px-4 py-8"><p>Athlete not found</p></div>;
  const isHistOnly=athleteData.historicalOnly;
  const stats=[{l:'Wins',v:computedStats.wins,sub:computedStats.histWins>0?`(${computedStats.modernWins}+${computedStats.histWins} hist)`:null},{l:'Top 3',v:computedStats.top3},{l:'Top 5',v:computedStats.top5},{l:'Top 10',v:computedStats.top10},{l:'Top 20',v:computedStats.top20},{l:'Top 50',v:computedStats.top50},{l:'Top 100',v:computedStats.top100},{l:'A Scores',v:computedStats.aScores},{l:'Races',v:computedStats.races}];
  
  // Compute badges dynamically
  const computedBadges=useMemo(()=>{
    const badges=[];
    const getYear=(season)=>season?'20'+season.split('/')[1]:null;
    
    // Find seasons where athlete scored for the winning team
    const seasonClubs={};// season -> clubs they raced for
    raceHistory.forEach(r=>{
      const season=r.race?.season||(r.historical?r.season:null);
      if(season&&r.club){
        if(!seasonClubs[season])seasonClubs[season]=new Set();
        seasonClubs[season].add(r.club);
      }
    });
    
    // Check each season they participated in
    Object.entries(seasonClubs).forEach(([season,clubs])=>{
      const sd=seasonsData[season];
      if(!sd?.standings?.length)return;
      const champion=sd.standings[0].club;
      // Check if season is complete
      const isComplete=sd.historical||(sd.standings[0].m4!==null&&sd.standings[0].m4!==undefined);
      if(isComplete&&clubs.has(champion)){
        badges.push({type:'title_winner',season,year:getYear(season)});
      }
    });
    
    // Check for individual champion seasons
    Object.entries(seasonsData).forEach(([season,sd])=>{
      if(!sd?.individualRankings?.length)return;
      const champion=sd.individualRankings[0];
      if(namesMatch(champion.name,athleteData.name)){
        badges.push({type:'individual_champion',season,year:getYear(season)});
      }
    });
    
    return badges;
  },[raceHistory,seasonsData,athleteData.name]);
  
  const individualChampYears=computedBadges.filter(b=>b.type==='individual_champion').map(b=>b.year).filter(Boolean);
  const leagueWinnerYears=computedBadges.filter(b=>b.type==='title_winner').map(b=>b.year).filter(Boolean).sort();
  const staticBadges=athleteData.badges||[];
  const otherBadges=staticBadges.filter(b=>b.type!=='individual_champion'&&b.type!=='title_winner').map(b=>{
    if(b.type==='all_time_wins_leader')return{label:'#1 All-Time Wins'};
    if(b.type==='most_season_wins')return{label:`Most Wins in Single Season (${b.wins})`};
    if(b.type==='most_team_titles')return{label:`Most Team Titles (${b.count})`};
    return null;
  }).filter(Boolean);
  return<div className="max-w-4xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'athletes'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-8"><div className="flex items-start gap-3 mb-2"><div className="cursor-pointer" onClick={()=>setView({type:'club',club:athleteData.club})}><ClubShield club={athleteData.club} size={44}/></div><div><h1 className="text-2xl font-bold text-gray-900">{athleteData.name}</h1><p className="text-sm text-gray-500 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:athleteData.club})}>{CLUBS[athleteData.club]?.name||athleteData.club}{isHistOnly&&<span className="ml-2 text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">Historical</span>}</p></div></div><div className="flex flex-wrap gap-2 mt-3">{allTimeRank>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'athletes'})}><span className="text-xs text-gray-500 uppercase">SL Index üìà</span><span className="text-sm font-bold text-[#0077b6]">#{allTimeRank}</span></div>}{clubRankings.map(cr=><div key={cr.club} className="inline-flex items-center gap-1.5 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'club',club:cr.club})}><ClubShield club={cr.club} size={14}/><span className="text-xs text-gray-500">üêê</span><span className="text-sm font-bold text-[#0077b6]">#{cr.rank}</span></div>)}{otherBadges.map((b,i)=><div key={i} className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{b.label}</span></div>)}</div>{(individualChampYears.length>0||leagueWinnerYears.length>0)&&<div className="flex flex-wrap gap-2 mt-2">{individualChampYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">üèÖ Individual Champion</span><span className="text-sm font-medium text-gray-700">{individualChampYears.join(' ¬∑ ')}</span></div>}{leagueWinnerYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">üèÜ League Winner</span><span className="text-sm font-medium text-gray-700">{leagueWinnerYears.join(' ¬∑ ')}</span></div>}</div>}<div className="flex flex-wrap items-center gap-2 mt-3"><div className="relative inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">Compare to</span><input type="text" value={compareInput} onChange={e=>setCompareInput(e.target.value)} onFocus={()=>setCompareFocused(true)} onBlur={()=>setTimeout(()=>setCompareFocused(false),200)} placeholder="Search..." className="w-24 text-sm bg-transparent border-none outline-none placeholder-gray-400"/>{compareFocused&&compareInput.length>=2&&(()=>{const suggestions=athletes.filter(a=>!a.historical&&a.name.toLowerCase().includes(compareInput.toLowerCase())&&!namesMatch(a.name,athleteData.name)).slice(0,5);return suggestions.length>0?<div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10">{suggestions.map((a,i)=><div key={i} className="px-3 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2 text-sm" onClick={()=>{setView({type:'h2h',prefill:{athlete1:athleteData,athlete2:a}});}}><ClubShield club={a.club} size={14}/><span>{a.name}</span></div>)}</div>:null;})()}</div>{po10Url&&<a href={po10Url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-xs text-gray-500 hover:text-[#0077b6]"><span>Power of 10</span><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>}</div></div><div className="mb-8"><h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">Career Statistics</h2><div className="grid grid-cols-3 md:grid-cols-9 gap-2 md:gap-4">{stats.map(s=><div key={s.l} className="text-center"><div className={`text-xl md:text-2xl font-bold ${s.v>0?'text-gray-900':'text-gray-300'}`}>{s.v}</div><div className="text-[10px] md:text-xs text-gray-500 uppercase">{s.l}</div>{s.sub&&<div className="text-[10px] md:text-xs text-gray-400">{s.sub}</div>}</div>)}</div>{isHistOnly&&<p className="text-xs text-gray-400 mt-4">* Stats based on known race wins only (pre-2014 data)</p>}</div><div><h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">Race History</h2>{raceHistory.length>0?<table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th className="text-left py-2 pr-1 text-[10px] md:text-xs text-gray-500 uppercase">Date</th><th className="text-left py-2 px-1 text-[10px] md:text-xs text-gray-500 uppercase">Venue</th><th className="text-center py-2 px-1 text-[10px] md:text-xs text-gray-500 uppercase w-8 md:w-10">Club</th><th className="text-right py-2 px-1 text-[10px] md:text-xs text-gray-500 uppercase w-12 md:w-16">Pos</th><th className="text-right py-2 pl-1 text-[10px] md:text-xs text-gray-500 uppercase w-10 md:w-16" title="Team scoring position: A1-A10 = A team scorers, B1-B10 = B team scorers">Score</th></tr></thead><tbody className="divide-y divide-gray-100">{raceHistory.map((r,i)=>{const scoreNum=r.teamScore?parseInt(r.teamScore.slice(1)):0;const ordinal=scoreNum===1?'st':scoreNum===2?'nd':scoreNum===3?'rd':'th';const scoreTooltip=r.teamScore?`${CLUBS[r.club]?.name||r.club}'s ${scoreNum}${ordinal} scorer for ${r.teamScore[0]} team`:null;return<tr key={i} className={r.race&&!r.race.historical?'hover:bg-blue-50 cursor-pointer':''} onClick={()=>r.race&&!r.race.historical&&setView({type:'race',race:r.race})}><td className="py-2 pr-1 text-xs md:text-sm text-gray-500 whitespace-nowrap">{r.historical?r.season:formatDateMonthYear(r.date)}</td><td className="py-2 px-1 text-xs md:text-sm text-gray-900">{r.venue}</td><td className="py-2 px-1 text-center"><ClubShield club={r.club} size={14}/></td><td className="py-2 px-1 text-right"><span className={`text-xs md:text-sm font-medium ${r.pos===1?'text-[#0077b6]':r.pos<=3?'text-gray-900':'text-gray-600'}`}>{r.pos===1?'ü•á':r.pos===2?'ü•à':r.pos===3?'ü•â':r.pos}{showStar&&r.pos===bestPos&&' ‚≠ê'}</span></td><td className="py-2 pl-1 text-xs md:text-sm text-gray-600 text-right font-mono" title={scoreTooltip}>{r.teamScore||'-'}</td></tr>})}</tbody></table>:<p className="text-sm text-gray-500">No race history</p>}</div></div>;
};

const ClubsView=({setView,clubAllTime})=><div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><h1 className="text-2xl font-bold text-gray-900">Division 1 Clubs</h1></div><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4 text-xs text-gray-500 uppercase">Club</th><th className="text-right py-1.5 px-2 text-xs text-gray-500 uppercase w-16">Titles</th><th className="text-right py-1.5 px-2 text-xs text-gray-500 uppercase w-16">2nd</th><th className="text-right py-1.5 pl-2 text-xs text-gray-500 uppercase w-16">3rd</th></tr></thead><tbody>{clubAllTime.map((c,i)=><tr key={c.club} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-5 text-right">{i+1}</span><ClubShield club={c.club} size={14}/><ClubName club={c.club} className="text-sm text-gray-900"/></div></td><td className="text-right py-1.5 px-2 text-sm tabular-nums font-semibold text-gray-900">{c.titles||'-'}</td><td className="text-right py-1.5 px-2 text-sm tabular-nums text-gray-600">{c.runnerUp||'-'}</td><td className="text-right py-1.5 pl-2 text-sm tabular-nums text-gray-400">{c.third||'-'}</td></tr>)}</tbody></table></div>;

const ClubDetailView=({clubCode,setView,athletes,races,clubAllTime,clubMvps,seasonsData})=>{
  const[sort,setSort]=useState('aScores');const clubData=clubAllTime.find(c=>c.club===clubCode);const clubInfo=CLUBS[clubCode];
  
  // Compute championship years
  const{titleYears,secondYears,thirdYears}=useMemo(()=>{
    const titles=[],seconds=[],thirds=[];
    Object.entries(seasonsData||{}).forEach(([season,sd])=>{
      if(!sd?.standings?.[0])return;
      const isHist=sd.historical;
      const hasM4=sd.standings[0].m4!==null||isHist;
      if(!hasM4)return;
      const getYear=s=>'20'+s.split('/')[1];
      if(sd.standings[0]?.club===clubCode)titles.push(getYear(season));
      if(sd.standings[1]?.club===clubCode)seconds.push(getYear(season));
      if(sd.standings[2]?.club===clubCode)thirds.push(getYear(season));
    });
    return{titleYears:titles.sort().reverse(),secondYears:seconds.sort().reverse(),thirdYears:thirds.sort().reverse()};
  },[seasonsData,clubCode]);
  
  // Compute club-specific stats from race results
  const clubAthletes=useMemo(()=>{
    const athleteStats={};
    
    // Helper to ensure athlete entry exists
    const ensureAthlete=(name,club)=>{
      const nameKey=normalizeNameForCompare(name);
      if(!athleteStats[nameKey]){
        athleteStats[nameKey]={
          name:name,
          club:club,
          wins:0,top3:0,top5:0,top10:0,top20:0,top50:0,top100:0,
          races:0,aScores:0
        };
      }
      return athleteStats[nameKey];
    };
    
    // Go through all races and count stats only when athlete represented this club
    races.forEach(race=>{
      // Handle historical races (only have winner info)
      if(race.historical){
        // Handle dead heats (multiple winners) - each winner has their own club
        if(race.winners){
          race.winners.forEach(w=>{
            if(w.club===clubCode){
              const s=ensureAthlete(w.name,clubCode);
              s.wins++;
              s.top3++;
              s.top5++;
              s.top10++;
              s.races++;
              s.aScores++;
            }
          });
        }else if(race.winnerClub===clubCode){
          const s=ensureAthlete(race.winner,clubCode);
          s.wins++;
          s.top3++;
          s.top5++;
          s.top10++;
          s.races++;
          s.aScores++;
        }
        return;
      }
      
      if(!race.results)return;
      race.results.forEach((r,idx)=>{
        if(r.club!==clubCode)return;
        const s=ensureAthlete(r.name,clubCode);
        s.races++;
        if(r.pos===1)s.wins++;
        if(r.pos<=3)s.top3++;
        if(r.pos<=5)s.top5++;
        if(r.pos<=10)s.top10++;
        if(r.pos<=20)s.top20++;
        if(r.pos<=50)s.top50++;
        if(r.pos<=100)s.top100++;
        // Count A-team scores (first 10 finishers for this club in this race)
        const clubRunnersInRace=race.results.filter(x=>x.club===clubCode);
        const posInClub=clubRunnersInRace.findIndex(x=>namesMatch(x.name,r.name))+1;
        if(posInClub>=1&&posInClub<=10)s.aScores++;
      });
    });
    
    return Object.values(athleteStats).sort((a,b)=>{
      if(sort==='aScores'){
        if((b.aScores||0)!==(a.aScores||0))return(b.aScores||0)-(a.aScores||0);
        return(b.wins||0)-(a.wins||0);
      }
      if(b[sort]!==a[sort])return(b[sort]||0)-(a[sort]||0);
      if(b.wins!==a.wins)return(b.wins||0)-(a.wins||0);
      if(b.top3!==a.top3)return(b.top3||0)-(a.top3||0);
      return(b.races||0)-(a.races||0);
    });
  },[clubCode,sort,races]);
  
  const mvp=clubAthletes[0];
  const allTimeRank=clubAllTime.findIndex(c=>c.club===clubCode)+1;if(!clubData||!clubInfo)return<div className="max-w-4xl mx-auto px-4 py-8"><p>Club not found</p></div>;
  const cols=[{f:'aScores',l:'A',t:'A-team scores for this club'},{f:'wins',l:'W',t:'Race wins'},{f:'top3',l:'T3',t:'Top 3 finishes'},{f:'top5',l:'T5',t:'Top 5 finishes'},{f:'top10',l:'T10',t:'Top 10 finishes'},{f:'top20',l:'T20',t:'Top 20 finishes'},{f:'top50',l:'T50',t:'Top 50 finishes'},{f:'top100',l:'T100',t:'Top 100 finishes'},{f:'races',l:'R',t:'Total races'}];
  return<div className="max-w-5xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'clubs'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-8"><div className="flex items-center gap-4 mb-3"><ClubShield club={clubCode} size={48}/><div><h1 className="text-2xl font-bold text-gray-900">{clubInfo.name}</h1>{allTimeRank>0&&<p className="text-sm text-gray-500">#{allTimeRank} all-time</p>}</div></div><div className="flex flex-wrap gap-2">{titleYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{titleYears.length}√ó League Champions üèÜ</span><span className="text-sm font-medium text-gray-700">{titleYears.join(' ¬∑ ')}</span></div>}{secondYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{secondYears.length}√ó Runners-up ü•à</span><span className="text-sm font-medium text-gray-700">{secondYears.join(' ¬∑ ')}</span></div>}{thirdYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{thirdYears.length}√ó Third place ü•â</span><span className="text-sm font-medium text-gray-700">{thirdYears.join(' ¬∑ ')}</span></div>}</div>{mvp&&<p className="mt-3 text-sm text-gray-600">Club üêê: <span className="font-medium text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:mvp})}>{mvp.name}</span></p>}</div><div className="overflow-x-auto"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4"><span className="text-xs text-gray-500 uppercase">Athlete</span></th>{cols.map(c=><th key={c.f} className="text-right py-1.5 px-2 min-w-[2.5rem]"><button onClick={()=>setSort(c.f)} className={`text-xs uppercase ${sort===c.f?'text-[#0077b6] font-semibold':'text-gray-500'}`} data-tip={c.t}>{c.l}</button></th>)}</tr></thead><tbody>{clubAthletes.map((a,i)=><tr key={a.name} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-6 text-right">{i+1}</span><span className="text-sm text-gray-900">{a.name}</span></div></td>{cols.map(c=><td key={c.f} className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort===c.f?'font-semibold text-[#0077b6]':'text-gray-600'} ${a[c.f]===0?'text-gray-300':''}`}>{a[c.f]||'-'}</td>)}</tr>)}</tbody></table></div></div>;
};

const SeasonsView=({setView,seasonsData})=>{
  const[expanded,setExpanded]=useState(null);
  const seasons=useMemo(()=>Object.entries(seasonsData).sort((a,b)=>b[0].localeCompare(a[0])).map(([season,data])=>{
    const isHistorical=data.historical||false;
    // Historical seasons are complete even with 3 matches (cancelled races)
    // Modern seasons need m4 to be set
    const isComplete=isHistorical?true:(data.standings?.[0]?.m4!==null&&data.standings?.[0]?.m4!==undefined);
    return{season,isComplete,isHistorical,aTeam:isComplete?data.standings?.slice(0,3):[],bTeam:(isComplete&&!isHistorical)?data.bStandings?.slice(0,3):[],individual:(isComplete&&!isHistorical)?data.individualRankings?.slice(0,3):[]};
  }),[seasonsData]);
  const canExpand=(s)=>s.isComplete&&!s.isHistorical&&(s.bTeam.length>0||s.individual.length>0);
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><h1 className="text-2xl font-bold text-gray-900">Winners</h1><p className="text-sm text-gray-500">{seasons.filter(s=>s.isComplete).length} completed seasons since 1962</p></div><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="w-6"></th><th className="text-left py-1.5 pr-4 text-xs text-gray-500 uppercase">Season</th><th className="text-left py-1.5 px-4 text-xs text-gray-500 uppercase">A Team</th><th className="text-left py-1.5 px-4 text-xs text-gray-500 uppercase">B Team</th><th className="text-left py-1.5 pl-4 text-xs text-gray-500 uppercase">Individual</th></tr></thead><tbody>{seasons.map(s=><React.Fragment key={s.season}><tr className={`border-b border-gray-50 hover:bg-blue-50 ${canExpand(s)?'cursor-pointer':''}`} onClick={()=>canExpand(s)&&setExpanded(expanded===s.season?null:s.season)}><td className="py-1.5 pr-1">{canExpand(s)&&<span className="text-gray-400">{expanded===s.season?<ChevronUp className="w-4 h-4"/>:<ChevronDown className="w-4 h-4"/>}</span>}</td><td className="py-1.5 pr-4"><span className="text-sm text-gray-900">{s.season}</span></td><td className="py-1.5 px-4">{s.aTeam[0]?<div className="flex items-center gap-1.5"><ClubShield club={s.aTeam[0].club} size={14}/><span className="text-sm text-gray-900">{s.aTeam[0].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-4">{s.bTeam[0]?<div className="flex items-center gap-1.5"><ClubShield club={s.bTeam[0].club} size={14}/><span className="text-sm text-gray-900">{s.bTeam[0].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-4">{s.individual[0]?<div className="flex items-center gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={e=>{e.stopPropagation();setView({type:'athlete',athlete:{name:s.individual[0].name,club:s.individual[0].club}});}}><ClubShield club={s.individual[0].club} size={14}/><span className="text-sm text-gray-700">{s.individual[0].name}</span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr>{expanded===s.season&&<><tr className="bg-gray-50 border-b border-gray-100"><td className="py-1.5 pr-1"></td><td className="py-1.5 pr-4 text-sm text-gray-400">2nd</td><td className="py-1.5 px-4">{s.aTeam[1]?<div className="flex items-center gap-1.5"><ClubShield club={s.aTeam[1].club} size={14}/><span className="text-sm text-gray-600">{s.aTeam[1].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-4">{s.bTeam[1]?<div className="flex items-center gap-1.5"><ClubShield club={s.bTeam[1].club} size={14}/><span className="text-sm text-gray-600">{s.bTeam[1].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-4">{s.individual[1]?<div className="flex items-center gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:s.individual[1].name,club:s.individual[1].club}})}><ClubShield club={s.individual[1].club} size={14}/><span className="text-sm text-gray-600">{s.individual[1].name}</span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr><tr className="bg-gray-50 border-b border-gray-100"><td className="py-1.5 pr-1"></td><td className="py-1.5 pr-4 text-sm text-gray-400">3rd</td><td className="py-1.5 px-4">{s.aTeam[2]?<div className="flex items-center gap-1.5"><ClubShield club={s.aTeam[2].club} size={14}/><span className="text-sm text-gray-600">{s.aTeam[2].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-4">{s.bTeam[2]?<div className="flex items-center gap-1.5"><ClubShield club={s.bTeam[2].club} size={14}/><span className="text-sm text-gray-600">{s.bTeam[2].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-4">{s.individual[2]?<div className="flex items-center gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:s.individual[2].name,club:s.individual[2].club}})}><ClubShield club={s.individual[2].club} size={14}/><span className="text-sm text-gray-600">{s.individual[2].name}</span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr></>}</React.Fragment>)}</tbody></table></div>;
};

const SeasonAnalysis=({season,seasonData,races,standings,allSeasonsData,isComplete,data,setView,setSeason})=>{
  const insights=useMemo(()=>{
    const items=[];
    if(!seasonData||!standings?.length)return items;
    const matches=seasonData.matches||[];
    const seasonRaces=races.filter(r=>r.season===season);
    const currentSeason=data.seasons[0];
    const isCurrentSeason=season===currentSeason;
    const numTeams=standings.length;
    const winningTotal=standings[0]?.total;
    const margin=standings.length>=2&&standings[0].total&&standings[1].total?standings[1].total-standings[0].total:null;
    
    // Notable athletes with achievements
    const notableAthletes={
      'Alex Yee':{accolade:'future Olympic gold medalist',club:'KEN'},
      'Marc Scott':{accolade:'Olympic finalist',club:'RAN'}
    };
    
    // Confirmed brother pairs
    const brotherPairs=[
      {names:['Ed Mallett','George Mallet'],club:'H/W',surname:'Mallett'},
      {names:['Edward Mallett','George Mallet'],club:'H/W',surname:'Mallett'},
      {names:['Morgan Roberts','Harry Roberts'],club:'HHH',surname:'Roberts'}
    ];
    
    const findLastTitle=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort().reverse();
      for(const s of seasons){if(s>=season)continue;if(allSeasonsData[s]?.standings?.[0]?.club===club)return s;}
      return null;
    };
    
    const findLastInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort().reverse();
      for(const s of seasons){if(s>=season)continue;if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const findNextInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort();
      for(const s of seasons){if(s<=season)continue;if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const findFirstInDiv1=(club)=>{
      const seasons=Object.keys(allSeasonsData).sort();
      for(const s of seasons){if(allSeasonsData[s]?.standings?.some(t=>t.club===club))return s;}
      return null;
    };
    
    const countAllFourWins=()=>{
      let count=0;
      for(const[s,sd] of Object.entries(allSeasonsData)){
        if(s>=season)continue;
        const wins={};(sd.matches||[]).forEach(m=>{if(m.teamWinner)wins[m.teamWinner]=(wins[m.teamWinner]||0)+1;});
        if(Object.values(wins).some(v=>v===4))count++;
      }
      return count;
    };
    
    const hasAnyoneWonAll4=()=>{
      for(const[s,sd] of Object.entries(allSeasonsData)){
        const ms=sd.matches||[];if(ms.length<4)continue;
        const wins={};ms.forEach(m=>{if(m.winner)wins[m.winner]=(wins[m.winner]||0)+1;});
        if(Object.values(wins).some(v=>v===4))return true;
      }
      return false;
    };
    
    // Find closest/biggest margins and best totals up to this season
    const getMarginStats=()=>{
      let closest=null,biggest=null,bestTotal9=null,bestTotal10=null;
      for(const[s,sd] of Object.entries(allSeasonsData)){
        if(s>season||!sd?.standings?.length||sd.standings.length<2)continue;
        const st=sd.standings;
        const m=st[1].total&&st[0].total?st[1].total-st[0].total:null;
        const total=st[0].total;
        if(m!==null){
          if(!closest||m<closest.margin)closest={season:s,margin:m};
          if(!biggest||m>biggest.margin)biggest={season:s,margin:m};
        }
        if(total){
          if(st.length===9&&(!bestTotal9||total<bestTotal9.total))bestTotal9={season:s,total};
          if(st.length===10&&(!bestTotal10||total<bestTotal10.total))bestTotal10={season:s,total};
        }
      }
      return{closest,biggest,bestTotal9,bestTotal10};
    };
    
    const indWins={};matches.forEach(m=>{if(m.winner)indWins[m.winner]=(indWins[m.winner]||0)+1;});
    const maxIndWins=Math.max(...Object.values(indWins),0);
    const dominantInd=Object.keys(indWins).find(k=>indWins[k]===maxIndWins);
    const dominantIndClub=matches.find(m=>m.winner===dominantInd)?.winnerClub;
    
    const teamWins={};matches.forEach(m=>{if(m.teamWinner)teamWins[m.teamWinner]=(teamWins[m.teamWinner]||0)+1;});
    const maxTeamWins=Math.max(...Object.values(teamWins),0);
    const dominantTeam=Object.keys(teamWins).find(k=>teamWins[k]===maxTeamWins);
    const completedMatches=matches.filter(m=>m.winner).length;
    
    if(isCurrentSeason){
      if(maxIndWins>=3&&dominantInd&&!hasAnyoneWonAll4()){
        items.push({text:'could become the first athlete to win all 4 races in a single season',athlete:{name:dominantInd,club:dominantIndClub}});
      }else if(maxIndWins>=3&&dominantInd){
        items.push({text:'on course to win all 4 races this season',athlete:{name:dominantInd,club:dominantIndClub}});
      }
      
      const leader=standings[0]?.club;
      if(leader){
        const lastTitle=findLastTitle(leader);
        if(lastTitle&&parseInt(lastTitle.split('/')[0])<parseInt(season.split('/')[0])-5){
          items.push({text:'poised to win first title since',club:leader,linkSeason:lastTitle});
        }else if(!lastTitle){
          items.push({text:'on course for first ever league title',club:leader});
        }
      }
      
      if(standings.length>=2&&standings[0].total&&standings[1].total){
        const gap=standings[0].total-standings[1].total;
        const matchesLeft=4-completedMatches;
        if(gap<150*matchesLeft&&gap>0&&standings[1].club){
          items.push({text:`${gap} points behind with ${matchesLeft} match${matchesLeft>1?'es':''} to go`,club:standings[1].club});
        }
      }
      
      if(standings.length>=9){
        [standings[8],standings[9]].filter(Boolean).forEach(team=>{
          if(team&&items.length<5){
            const lastIn=findLastInDiv1(team.club);
            if(!lastIn||lastIn===season)items.push({text:'fighting to avoid first ever relegation from Div 1',club:team.club});
          }
        });
      }
      
      const biggestRace=seasonRaces.reduce((max,r)=>(r.finishers||0)>=(max?.finishers||0)?r:max,null);
      if(biggestRace?.finishers>=200){
        const allRacesByFinishers=races.filter(r=>r.finishers).sort((a,b)=>b.finishers-a.finishers);
        const rank=allRacesByFinishers.findIndex(r=>r.season===biggestRace.season&&r.match===biggestRace.match)+1;
        const ordinal=rank===1?'biggest ever':rank===2?'2nd biggest':rank===3?'3rd biggest':rank<=10?`${rank}th biggest`:null;
        if(ordinal)items.push({text:`was the ${ordinal} turnout on record (${biggestRace.finishers})`,race:biggestRace,venueName:biggestRace.venue});
      }
      
    }else if(isComplete){
      const champion=standings[0]?.club;
      const marginStats=getMarginStats();
      
      if(champion){
        const lastTitle=findLastTitle(champion);
        const titleCount=Object.entries(allSeasonsData).filter(([s,sd])=>s<=season&&sd?.standings?.[0]?.club===champion).length;
        if(lastTitle){
          const gap=parseInt(season.split('/')[0])-parseInt(lastTitle.split('/')[0]);
          if(gap>=5)items.push({text:`won first title in ${gap} years, since`,club:champion,linkSeason:lastTitle});
        }
        if(titleCount>1){
          const ordinal=['','','2nd','3rd','4th','5th','6th','7th','8th','9th','10th','11th','12th','13th','14th','15th','16th','17th'][titleCount]||`${titleCount}th`;
          items.push({text:`claimed their ${ordinal} league title`,club:champion});
        }
      }
      
      // Margin records
      if(margin!==null&&marginStats.closest?.season===season&&margin<=20){
        items.push({text:`Closest ever winning margin: just ${margin} points`});
      }else if(margin!==null&&margin<=20){
        items.push({text:`Title decided by just ${margin} points`});
      }
      
      if(margin!==null&&marginStats.biggest?.season===season&&margin>=200){
        items.push({text:`Biggest ever winning margin: ${margin} points`});
      }
      
      // Best totals - only show for current season as it's less meaningful historically
      if(isCurrentSeason&&winningTotal&&numTeams===9&&marginStats.bestTotal9?.season===season){
        items.push({text:`Best ever winning total in a 9-team season: ${winningTotal} points`,club:champion});
      }
      if(isCurrentSeason&&winningTotal&&numTeams===10&&marginStats.bestTotal10?.season===season){
        items.push({text:`Best ever winning total in a 10-team season: ${winningTotal} points`,club:champion});
      }
      
      if(maxIndWins>=3&&dominantInd)items.push({text:`won ${maxIndWins} of 4 races`,athlete:{name:dominantInd,club:dominantIndClub}});
      
      // Check for notable athletes winning races
      matches.forEach(match=>{
        if(match.winner&&notableAthletes[match.winner]){
          const notable=notableAthletes[match.winner];
          const race=seasonRaces.find(r=>r.match===match.num);
          if(race)items.push({text:`Match ${match.num} won by ${notable.accolade}`,athlete:{name:match.winner,club:notable.club},race});
        }
      });
      
      // Check for notable athletes in results (first to score when someone else won)
      seasonRaces.forEach(race=>{
        if(!race.results)return;
        const winner=race.results[0];
        if(winner&&!notableAthletes[winner.name]){
          // Winner isn't notable, check if a notable athlete scored
          race.results.slice(1,20).forEach(r=>{
            if(notableAthletes[r.name]){
              const notable=notableAthletes[r.name];
              items.push({text:`Race won by ${winner.name}; ${notable.accolade}`,athlete:{name:r.name,club:notable.club},textAfter:` was ${r.pos}${r.pos===2?'nd':r.pos===3?'rd':'th'}`,race,venueName:race.venue});
            }
          });
        }
      });
      
      // Check for brother pairs combined scores
      const findBrotherScores=(race)=>{
        if(!race.results)return null;
        for(const pair of brotherPairs){
          const found=pair.names.map(name=>race.results.find(r=>r.name.toLowerCase().includes(name.split(' ')[0].toLowerCase())&&r.name.toLowerCase().includes(name.split(' ')[1].toLowerCase()))).filter(Boolean);
          if(found.length>=2){
            const sorted=found.sort((a,b)=>a.pos-b.pos);
            return{combined:sorted[0].pos+sorted[1].pos,runner1:sorted[0],runner2:sorted[1],surname:pair.surname,club:pair.club};
          }
        }
        return null;
      };
      
      // Find best brother score in this season and all-time up to this season
      let bestThisSeason=null;
      seasonRaces.forEach(race=>{
        const score=findBrotherScores(race);
        if(score&&(!bestThisSeason||score.combined<bestThisSeason.combined)){
          bestThisSeason={...score,race};
        }
      });
      
      if(bestThisSeason){
        // Check if it's the all-time record up to this point
        let allTimeBest=bestThisSeason.combined;
        races.filter(r=>r.season<season).forEach(race=>{
          const score=findBrotherScores(race);
          if(score&&score.combined<allTimeBest)allTimeBest=score.combined;
        });
        
        if(bestThisSeason.combined<=allTimeBest&&bestThisSeason.combined<=50){
          items.push({
            text:`Match ${bestThisSeason.race.match} saw the lowest combined score of any two brothers on record:`,
            race:bestThisSeason.race,
            brothers:[
              {name:bestThisSeason.runner1.name,club:bestThisSeason.club,pos:bestThisSeason.runner1.pos},
              {name:bestThisSeason.runner2.name,club:bestThisSeason.club,pos:bestThisSeason.runner2.pos}
            ],
            brothersTotal:bestThisSeason.combined
          });
        }
      }
      
      if(maxTeamWins===4&&dominantTeam){
        const prevCount=countAllFourWins();
        items.push({text:prevCount===0?'became first club to win all 4 matches':`won all 4 matches ‚Äì only happened ${prevCount} time${prevCount>1?'s':''} before`,club:dominantTeam});
      }else if(maxTeamWins===3&&dominantTeam){
        items.push({text:'won 3 of 4 team races',club:dominantTeam});
      }
      
      const biggestRace=seasonRaces.reduce((max,r)=>(r.finishers||0)>=(max?.finishers||0)?r:max,null);
      if(biggestRace?.finishers>=200){
        const allRacesByFinishers=races.filter(r=>r.finishers&&r.season<=season).sort((a,b)=>b.finishers-a.finishers);
        const rank=allRacesByFinishers.findIndex(r=>r.season===biggestRace.season&&r.match===biggestRace.match)+1;
        if(rank===1){
          items.push({text:`set new league record with ${biggestRace.finishers} finishers`,race:biggestRace,venueName:biggestRace.venue});
        }else{
          const ordinal=rank===2?'2nd':rank===3?'3rd':`${rank}th`;
          if(rank<=10)items.push({text:`was the ${ordinal} biggest turnout on record (${biggestRace.finishers})`,race:biggestRace,venueName:biggestRace.venue});
        }
      }
      
      if(standings.length>=2&&standings[1].club){
        const runnerUp=standings[1].club;
        const prevSeason=data.seasons[data.seasons.indexOf(season)+1];
        const prevChamp=prevSeason&&allSeasonsData[prevSeason]?.standings?.[0]?.club;
        if(prevChamp===runnerUp)items.push({text:'were defending champions but finished 2nd',club:runnerUp});
      }
      
      // First/last appearances
      standings.forEach(team=>{
        if(items.length>=5)return;
        const firstSeason=findFirstInDiv1(team.club);
        const nextSeason=findNextInDiv1(team.club);
        
        // First season in Div 1
        if(firstSeason===season){
          items.push({text:`made their first appearance in Surrey League Div 1`,club:team.club});
        }
        
        // Last season in Div 1
        if(!nextSeason&&firstSeason!==season){
          items.push({textBefore:`This was the last season `,club:team.club,text:` appeared in Surrey League Div 1`});
        }
      });
    }
    
    return items.slice(0,5);
  },[season,seasonData,races,standings,allSeasonsData,isComplete,data]);
  
  if(!insights.length)return null;
  return<div className="hidden md:block mt-4 pt-4 border-t border-gray-100">
    <h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2">Analysis</h3>
    <ul className="space-y-1">{insights.map((item,i)=><li key={i} className="text-xs text-gray-600">‚Ä¢ {item.textBefore}{item.club&&!item.brothers&&!item.textBefore&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:item.club})}>{item.club}</span>}{item.textBefore&&item.club&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'club',club:item.club})}>{item.club}</span>}{item.athlete&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:item.athlete})}>{item.athlete.name}</span>}{item.venueName&&!item.brothers&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'race',race:item.race})}>{item.venueName}</span>}{(item.club||item.athlete||item.venueName)&&!item.brothers&&!item.textBefore?' ':''}{item.brothers&&<>{item.text} <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:item.brothers[0].name,club:item.brothers[0].club}})}>{item.brothers[0].name}</span> ({item.brothers[0].pos}) + <span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athlete',athlete:{name:item.brothers[1].name,club:item.brothers[1].club}})}>{item.brothers[1].name}</span> ({item.brothers[1].pos}) = {item.brothersTotal} pts</>}{!item.brothers&&item.text}{item.linkSeason&&<span className="text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setSeason(item.linkSeason)}> {item.linkSeason}</span>}</li>)}</ul>
  </div>;
};

const HomeView=({setView,data})=>{
  const[season,setSeason]=useState(data.seasons[0]);const seasonData=data.seasonsData[season];const topWinners=[...data.athletes].sort((a,b)=>b.wins-a.wins).filter(a=>a.wins>0).slice(0,5);
  const findRace=(num)=>data.races.find(r=>r.season===season&&r.match===num);const matches=seasonData?.matches||[];const standings=seasonData?.standings||[];
  const isHistorical=seasonData?.historical;const isComplete=isHistorical||(standings[0]?.m4!==null&&standings[0]?.m4!==undefined);
  const showRelegation=season>='2022/23';
  
  const StandingsTable=()=><div>
    <table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1 w-6 text-xs text-gray-500 uppercase">#</th><th className="text-left py-1.5 pr-1 w-5"></th><th className="text-left py-1.5 pr-2 text-xs text-gray-500 uppercase">Club</th><th className="text-right py-1.5 pr-1 text-xs text-gray-500 uppercase">Tot</th>{matches.map((m,i)=><th key={i} className="text-right py-1.5 px-0.5 w-9 text-xs text-gray-500 uppercase">M{m.num}</th>)}</tr></thead><tbody>{standings.map((team,i)=><tr key={team.club} className={`hover:bg-gray-50 ${showRelegation&&i===7?'border-b border-dashed border-gray-400':'border-b border-gray-100'}`}><td className="py-1.5 pr-1 w-6"><div className="flex items-center"><span className={`text-sm ${i===0?'font-bold':'text-gray-600'}`}>{i===0&&isComplete?'üèÜ':team.pos}</span><PositionChange change={team.change}/></div></td><td className="py-1.5 pr-1 w-5"><ClubShield club={team.club} size={16}/></td><td className="py-1.5 pr-2 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:team.club})}><ClubName club={team.club} className={`text-sm ${i===0?'font-semibold':''}`}/></td><td className="text-right py-1.5 pr-1"><span className={`text-sm tabular-nums ${i===0?'font-bold text-[#0077b6]':'font-semibold'}`}>{team.total}</span></td>{matches.map((m,mi)=><td key={mi} className="text-right py-1.5 px-0.5"><span className="text-sm text-gray-600 tabular-nums">{team[`m${m.num}`]||'-'}</span></td>)}</tr>)}</tbody></table>
    {isHistorical&&<p className="text-xs text-gray-400 mt-2 italic">* Only partial results in for this season</p>}
  </div>;
  
  const FixturesTable=()=><div>
    <table className="w-full text-sm">
      <thead><tr className="border-b border-gray-200">
        <th className="text-left py-1.5 pr-2 text-xs text-gray-500 uppercase">M</th>
        <th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase">Date</th>
        <th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase">Venue</th>
        <th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase">Winner</th>
        <th className="text-left py-1.5 pl-2 text-xs text-gray-500 uppercase">Team</th>
      </tr></thead>
      <tbody className="divide-y divide-gray-100">{matches.map(match=>{
        const race=findRace(match.num);const upcoming=!match.winner;
        return<tr key={match.num} className={`${upcoming?'opacity-50':'hover:bg-blue-50 cursor-pointer'}`} onClick={()=>!upcoming&&race&&setView({type:'race',race})}>
          <td className="py-1.5 pr-2 font-medium text-gray-900">{match.num}</td>
          <td className="py-1.5 px-2 text-gray-500">{match.date?.length<=3?match.date:formatDateShort(match.date)}</td>
          <td className="py-1.5 px-2 text-gray-900">{match.venue}</td>
          <td className="py-1.5 px-2">{upcoming?<span className="text-gray-400 italic">-</span>:<div className="flex items-center gap-1.5"><ClubShield club={match.winnerClub} size={14}/><span className="text-gray-700">{match.winner}</span></div>}</td>
          <td className="py-1.5 pl-2">{!upcoming&&match.teamWinner?<div className="flex items-center gap-1.5"><ClubShield club={match.teamWinner} size={14}/><span className="font-medium">{match.teamWinner}</span></div>:'-'}</td>
        </tr>;
      })}</tbody>
    </table>
    <SeasonAnalysis season={season} seasonData={seasonData} races={data.races} standings={standings} allSeasonsData={data.seasonsData} isComplete={isComplete} data={data} setView={setView} setSeason={setSeason}/>
  </div>;
  
  return<div className="max-w-5xl mx-auto px-4 py-8">
    <div className="mb-6 pb-4 border-b border-gray-200">
      <h1 className="text-2xl font-bold text-gray-900 mb-1">Surrey Cross Country League</h1>
      <p className="text-sm text-gray-500">Men's Division 1 ¬∑ Complete data 2014‚Äìpresent ¬∑ Partial data 1962‚Äì2014</p>
    </div>
    
    {seasonData?<div className="mb-8">
      <div className="flex items-center gap-2 mb-4"><SeasonSelector season={season} setSeason={setSeason} seasons={data.seasons}/></div>
      <div className="grid md:grid-cols-2 gap-8">
        <div className="overflow-x-auto"><StandingsTable/></div>
        <div><FixturesTable/></div>
      </div>
    </div>:<p className="text-sm text-gray-500 mb-10">No data</p>}
    
    <div className="border-t border-gray-200 mt-4"></div>
    <div className="grid md:grid-cols-2 gap-8 pt-6">
      <div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athletes'})}>All-Time Athletes ‚Üí</h2></th><th className="text-right py-1 px-1 text-gray-500 uppercase w-7">W</th><th className="text-right py-1 px-1 text-gray-500 uppercase w-7">T3</th><th className="text-right py-1 px-1 text-gray-500 uppercase w-7">T10</th><th className="text-right py-1 pl-1 text-gray-500 uppercase w-7">R</th></tr></thead><tbody className="divide-y divide-gray-100">{topWinners.map((a,i)=><tr key={a.name} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1 pr-1"><div className="flex items-center gap-1 whitespace-nowrap"><ClubShield club={a.club} size={12}/><span className="text-gray-900">{a.name}</span></div></td><td className="py-1 px-1 text-right font-semibold">{a.wins||'-'}</td><td className="py-1 px-1 text-right text-gray-600">{a.top3||'-'}</td><td className="py-1 px-1 text-right text-gray-600">{a.top10||'-'}</td><td className="py-1 pl-1 text-right text-gray-400">{a.races}</td></tr>)}</tbody></table></div>
      <div><table className="w-full text-xs"><thead><tr className="border-b border-gray-200"><th className="text-left py-1 pr-1" colSpan="2"><h2 className="text-xs font-semibold text-gray-900 uppercase tracking-wide cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'clubs'})}>All-Time Clubs ‚Üí</h2></th><th className="text-right py-1 px-1 text-gray-500 uppercase w-12">Titles</th><th className="text-right py-1 pl-1 text-gray-500 uppercase w-8">2nd</th></tr></thead><tbody className="divide-y divide-gray-100">{data.clubAllTime.slice(0,5).map((c,i)=><tr key={c.club} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1 pr-1"><div className="flex items-center gap-1"><ClubShield club={c.club} size={12}/><ClubName club={c.club} className="text-gray-900"/></div></td><td className="py-1 px-1 text-right font-semibold">{c.titles||'-'}</td><td className="py-1 pl-1 text-right text-gray-400">{c.runnerUp||'-'}</td></tr>)}</tbody></table></div>
    </div>
    
    {data.achievements&&<><div className="grid md:grid-cols-3 gap-6 mt-6"><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Most Wins in Season</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostWinsSeason?.map((a,i)=><tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}><div className="flex items-center gap-1"><ClubShield club={a.club} size={12}/><span className="truncate">{a.name}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{a.wins}</td></tr>)}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Consecutive Wins</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostConsecutiveWins?.map((a,i)=><tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}><div className="flex items-center gap-1"><ClubShield club={a.club} size={12}/><span className="truncate">{a.name}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{a.streak}</td></tr>)}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Consecutive Titles</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostConsecutiveTitles?.map((c,i)=><tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:c.club})}><div className="flex items-center gap-1"><ClubShield club={c.club} size={12}/><span>{c.club}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{c.streak}</td></tr>)}</tbody></table></div></div><div className="grid md:grid-cols-2 gap-6 mt-6"><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Biggest Races</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.biggestRaces?.map((r,i)=>{const race=data.races.find(x=>x.season===r.season&&x.match===r.match);const year=r.date?.slice(0,4);return<tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>race&&setView({type:'race',race})}><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1"><span>{r.venue} {year}</span></td><td className="py-1 text-right text-gray-500 w-10">{r.finishers}</td></tr>;})}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Best Turnout</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.biggestTurnouts?.map((t,i)=>{const race=data.races.find(x=>x.season===t.season&&x.match===t.match);const year=t.date?.slice(0,4);return<tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>race&&setView({type:'race',race})}><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1"><div className="flex items-center gap-1"><ClubShield club={t.club} size={12}/><span>{t.venue} {year}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{t.count}</td></tr>;})}</tbody></table></div></div></>}
  </div>;
};

const Footer=()=><footer className="border-t border-gray-200 mt-12 py-6 text-center text-xs text-gray-400">Unofficial Surrey League archive. Work in progress. Vibecoded by Steve.</footer>;

const parseUrlParams=()=>{
  const params=new URLSearchParams(window.location.search);
  if(params.get('athlete'))return{type:'athlete',athlete:{name:params.get('athlete')}};
  if(params.get('club'))return{type:'club',club:params.get('club')};
  if(params.get('race')){const[season,match]=params.get('race').split('-');return{type:'race',raceKey:{season,match:parseInt(match)}};}
  if(params.get('season'))return{type:'home',season:params.get('season')};
  if(params.get('view'))return{type:params.get('view')};
  return{type:'home'};
};

const updateUrl=(view)=>{
  let url=window.location.pathname;
  if(view.type==='athlete'&&view.athlete?.name)url+='?athlete='+encodeURIComponent(view.athlete.name);
  else if(view.type==='club'&&view.club)url+='?club='+encodeURIComponent(view.club);
  else if(view.type==='race'&&view.race)url+='?race='+encodeURIComponent(view.race.season+'-'+view.race.match);
  else if(view.type!=='home')url+='?view='+view.type;
  window.history.pushState({},'',url);
};

const AthleteInput=({value,onChange,onSelect,athletes,placeholder})=>{
  const[focused,setFocused]=useState(false);
  const[inputVal,setInputVal]=useState(value?.name||'');
  const suggestions=inputVal.length>=2?athletes.filter(a=>a.name.toLowerCase().includes(inputVal.toLowerCase())).slice(0,8):[];
  useEffect(()=>{setInputVal(value?.name||'');},[value]);
  return<div className="relative flex-1">
    <input type="text" value={inputVal} onChange={e=>{setInputVal(e.target.value);onChange(null);}} onFocus={()=>setFocused(true)} onBlur={()=>setTimeout(()=>setFocused(false),200)} placeholder={placeholder} className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0077b6] focus:border-transparent"/>
    {focused&&suggestions.length>0&&<div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 max-h-64 overflow-y-auto">
      {suggestions.map((a,i)=><div key={i} className="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2" onClick={()=>{onSelect(a);setInputVal(a.name);setFocused(false);}}>
        <ClubShield club={a.club} size={16}/><span className="text-sm text-gray-900">{a.name}</span><span className="text-xs text-gray-400">{CLUBS[a.club]?.name||a.club}</span>
      </div>)}
    </div>}
  </div>;
};

const H2HView=({athletes,races,setView,prefill})=>{
  const[athlete1,setAthlete1]=useState(prefill?.athlete1||null);
  const[athlete2,setAthlete2]=useState(prefill?.athlete2||null);
  
  const getStats=(a)=>{
    if(!a)return null;
    const found=athletes.find(x=>namesMatch(x.name,a.name))||a;
    const allTimeRank=athletes.filter(x=>!x.historical).sort((a,b)=>b.wins-a.wins).findIndex(x=>namesMatch(x.name,found.name))+1;
    const positions=[];
    let bestRace=null;
    let bestPos=Infinity;
    races.filter(r=>!r.historical).forEach(race=>{
      const result=race.results.find(r=>namesMatch(r.name,a.name));
      if(result){
        positions.push(result.pos);
        if(result.pos<bestPos){bestPos=result.pos;bestRace=race;}
      }
    });
    const avgPos=positions.length>0?positions.reduce((a,b)=>a+b,0)/positions.length:0;
    return{...found,allTimeRank,avgPos,bestPos:bestPos===Infinity?0:bestPos,bestRace};
  };
  
  const computeH2H=()=>{
    if(!athlete1||!athlete2)return null;
    let wins1=0,wins2=0,ties=0;
    const sharedRaces=[];
    races.filter(r=>!r.historical).forEach(race=>{
      const r1=race.results.find(r=>namesMatch(r.name,athlete1.name));
      const r2=race.results.find(r=>namesMatch(r.name,athlete2.name));
      if(r1&&r2){
        sharedRaces.push({race,pos1:r1.pos,pos2:r2.pos});
        if(r1.pos<r2.pos)wins1++;
        else if(r2.pos<r1.pos)wins2++;
        else ties++;
      }
    });
    return{wins1,wins2,ties,sharedRaces,total:sharedRaces.length};
  };
  
  const stats1=getStats(athlete1);
  const stats2=getStats(athlete2);
  const h2h=computeH2H();
  
  const StatRow=({label,val1,val2,better='lower',onClick1,onClick2})=>{
    const n1=typeof val1==='string'&&val1.startsWith('#')?parseInt(val1.slice(1)):parseFloat(val1);
    const n2=typeof val2==='string'&&val2.startsWith('#')?parseInt(val2.slice(1)):parseFloat(val2);
    const w1=better==='lower'?n1<n2:n1>n2;
    const w2=better==='lower'?n2<n1:n2>n1;
    const color1=w1?'text-green-600':w2?'text-red-500':'text-gray-600';
    const color2=w2?'text-green-600':w1?'text-red-500':'text-gray-600';
    return<tr className="border-b border-gray-100">
      <td className={`py-3 px-4 text-right text-lg font-semibold ${color1} ${onClick1?'cursor-pointer hover:underline':''}`} onClick={onClick1}>{val1}</td>
      <td className="py-3 px-4 text-center text-sm text-gray-500 bg-gray-50">{label}</td>
      <td className={`py-3 px-4 text-left text-lg font-semibold ${color2} ${onClick2?'cursor-pointer hover:underline':''}`} onClick={onClick2}>{val2}</td>
    </tr>;
  };
  
  return<div className="max-w-4xl mx-auto px-4 py-8">
    <h1 className="text-2xl font-bold text-gray-900 mb-6">Head to Head</h1>
    
    <div className="flex gap-4 mb-8">
      <AthleteInput value={athlete1} onChange={setAthlete1} onSelect={setAthlete1} athletes={athletes.filter(a=>!a.historical)} placeholder="Search athlete..."/>
      <div className="flex items-center text-gray-400 font-semibold">vs</div>
      <AthleteInput value={athlete2} onChange={setAthlete2} onSelect={setAthlete2} athletes={athletes.filter(a=>!a.historical)} placeholder="Search athlete..."/>
    </div>
    
    {stats1&&stats2&&h2h&&<div>
      <div className="mb-6 text-center">
        <div className="flex items-center justify-center gap-4 mb-2">
          <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:athlete1})}>
            <ClubShield club={stats1.club} size={24}/>
            <span className="text-lg font-semibold text-gray-900 hover:text-[#0077b6]">{stats1.name}</span>
          </div>
          <span className="text-2xl font-bold text-gray-400">vs</span>
          <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:athlete2})}>
            <span className="text-lg font-semibold text-gray-900 hover:text-[#0077b6]">{stats2.name}</span>
            <ClubShield club={stats2.club} size={24}/>
          </div>
        </div>
        <p className="text-sm text-gray-500">{h2h.total} shared races</p>
      </div>
      
      <table className="w-full mb-8">
        <tbody>
          <tr className="border-b-2 border-gray-200">
            <td className={`py-4 px-4 text-right text-3xl font-bold ${h2h.wins1>h2h.wins2?'text-green-600':h2h.wins1<h2h.wins2?'text-red-500':'text-gray-600'}`}>{h2h.wins1}</td>
            <td className="py-4 px-4 text-center text-sm text-gray-500 bg-gray-50 uppercase">H2H Wins</td>
            <td className={`py-4 px-4 text-left text-3xl font-bold ${h2h.wins2>h2h.wins1?'text-green-600':h2h.wins2<h2h.wins1?'text-red-500':'text-gray-600'}`}>{h2h.wins2}</td>
          </tr>
          <StatRow label="A-Team Scores" val1={stats1.aScores||0} val2={stats2.aScores||0} better="higher"/>
          <StatRow label="Avg Finish" val1={(stats1.avgPos||0).toFixed(1)} val2={(stats2.avgPos||0).toFixed(1)} better="lower"/>
          <StatRow label="Best Finish" val1={stats1.bestPos||'-'} val2={stats2.bestPos||'-'} better="lower" onClick1={stats1.bestRace?()=>setView({type:'race',race:stats1.bestRace}):null} onClick2={stats2.bestRace?()=>setView({type:'race',race:stats2.bestRace}):null}/>
          <StatRow label="Total Races" val1={stats1.races||0} val2={stats2.races||0} better="higher"/>
          <StatRow label="All-Time Rank" val1={stats1.allTimeRank>0?'#'+stats1.allTimeRank:'-'} val2={stats2.allTimeRank>0?'#'+stats2.allTimeRank:'-'} better="lower"/>
        </tbody>
      </table>
      
      {h2h.sharedRaces.length>0&&<div>
        <h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">Race by Race</h2>
        <table className="w-full">
          <thead><tr className="border-b border-gray-200">
            <th className="text-left py-2 text-xs text-gray-500 uppercase">Race</th>
            <th className="text-right py-2 px-2 text-xs text-gray-500 uppercase w-16">{stats1.name.split(' ')[0]}</th>
            <th className="text-right py-2 px-2 text-xs text-gray-500 uppercase w-16">{stats2.name.split(' ')[0]}</th>
          </tr></thead>
          <tbody className="divide-y divide-gray-100">
            {h2h.sharedRaces.slice().reverse().map((sr,i)=><tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'race',race:sr.race})}>
              <td className="py-2 text-sm text-gray-700">{formatDate(sr.race.date)} ¬∑ {sr.race.venue}</td>
              <td className={`py-2 px-2 text-sm text-right font-medium ${sr.pos1<sr.pos2?'text-green-600':sr.pos1>sr.pos2?'text-red-500':'text-gray-600'}`}>{sr.pos1}</td>
              <td className={`py-2 px-2 text-sm text-right font-medium ${sr.pos2<sr.pos1?'text-green-600':sr.pos2>sr.pos1?'text-red-500':'text-gray-600'}`}>{sr.pos2}</td>
            </tr>)}
          </tbody>
        </table>
      </div>}
    </div>}
    
    {(!athlete1||!athlete2)&&<div className="text-center py-12 text-gray-400">
      <p>Select two athletes to compare</p>
    </div>}
  </div>;
};

const AskView=({data,setView})=>{
  const[query,setQuery]=useState('');
  const[loading,setLoading]=useState(false);
  const[answer,setAnswer]=useState('');
  const[error,setError]=useState('');
  
  const exampleQueries=[
    "Which athlete improved their average position the most from one season to the next?",
    "Who has the best win rate (wins per race)?",
    "Which club has the most athletes with race wins?",
    "What's the closest team race in the database?",
    "Who are the top 5 most consistent athletes (lowest position variance)?",
    "Which venue has produced the most first-time winners?"
  ];
  
  const buildDataSummary=()=>{
    // Create a compact summary of the data for the AI
    const athletes=data.athletes.slice(0,100).map(a=>({
      name:a.name,club:a.club,wins:a.wins,top3:a.top3,top10:a.top10,races:a.races,aScores:a.aScores
    }));
    const seasons=Object.keys(data.seasonsData).sort().reverse();
    const recentRaces=data.races.slice(0,20).map(r=>({
      season:r.season,match:r.match,venue:r.venue,date:r.date,
      top10:r.results.slice(0,10).map(x=>({pos:x.pos,name:x.name,club:x.club}))
    }));
    return{
      stats:data.stats,
      seasons,
      topAthletes:athletes,
      recentRaces,
      clubHonours:data.clubAllTime,
      achievements:data.achievements
    };
  };
  
  const askQuestion=async()=>{
    if(!query.trim())return;
    setLoading(true);
    setError('');
    setAnswer('');
    
    try{
      // Build a summary since full data is too large
      const summary=buildDataSummary();
      
      // For deeper analysis, include race-by-race athlete positions
      const athleteSeasonStats={};
      data.races.forEach(race=>{
        const season=race.season;
        race.results.forEach(r=>{
          const key=r.name;
          if(!athleteSeasonStats[key])athleteSeasonStats[key]={};
          if(!athleteSeasonStats[key][season])athleteSeasonStats[key][season]={positions:[],club:r.club};
          athleteSeasonStats[key][season].positions.push(r.pos);
        });
      });
      
      // Calculate averages per season for each athlete
      const athleteSeasonAvg={};
      Object.entries(athleteSeasonStats).forEach(([name,seasons])=>{
        athleteSeasonAvg[name]={};
        Object.entries(seasons).forEach(([season,data])=>{
          const avg=data.positions.reduce((a,b)=>a+b,0)/data.positions.length;
          athleteSeasonAvg[name][season]={avg:Math.round(avg*10)/10,races:data.positions.length,club:data.club};
        });
      });
      
      const systemPrompt=`You are a helpful assistant analyzing Surrey Cross Country League data. Answer questions about race results, athlete performance, club standings, and statistics. Be specific and cite data. Format answers clearly. When referencing athletes or clubs, be precise with names.

The database contains:
- ${data.stats.totalRaces} races from ${data.stats.seasons} seasons (2014-present with full data)
- ${data.stats.totalAthletes} athletes
- ${data.stats.totalResults} individual results

Key data structures available:
1. Athletes: name, club, wins, top3, top5, top10, top20, races, aScores (A-team finishes)
2. Races: season, match number, venue, date, full results with positions
3. Season standings: club points per match, final standings
4. Club honours: titles, 2nd places, 3rd places all-time`;

      const response=await fetch('https://surrey-league-ai.stephendgardner.workers.dev',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          model:'claude-sonnet-4-20250514',
          max_tokens:1000,
          system:systemPrompt,
          messages:[{
            role:'user',
            content:`Here is a summary of the league data:

TOP 100 ATHLETES:
${JSON.stringify(summary.topAthletes,null,1)}

CLUB HONOURS (ALL-TIME):
${JSON.stringify(summary.clubHonours,null,1)}

ACHIEVEMENTS:
${JSON.stringify(summary.achievements,null,1)}

ATHLETE SEASON AVERAGES (for improvement analysis):
${JSON.stringify(Object.fromEntries(Object.entries(athleteSeasonAvg).filter(([k,v])=>Object.keys(v).length>=2).slice(0,200)),null,1)}

RECENT RACES (top 10 finishers each):
${JSON.stringify(summary.recentRaces,null,1)}

QUESTION: ${query}`
          }]
        })
      });
      
      const result=await response.json();
      if(result.error){
        setError(result.error.message||'API error');
      }else if(result.content&&result.content[0]){
        setAnswer(result.content[0].text);
      }
    }catch(e){
      setError(e.message||'Failed to get answer');
    }finally{
      setLoading(false);
    }
  };
  
  return<div className="max-w-3xl mx-auto px-4 py-8">
    <div className="mb-8">
      <div className="flex items-center gap-2 mb-2">
        <Sparkles className="w-6 h-6 text-[#0077b6]"/>
        <h1 className="text-2xl font-bold text-gray-900">Ask the Archive</h1>
      </div>
      <p className="text-sm text-gray-500">Ask questions about Surrey League history, athlete performance, club records, and more.</p>
    </div>
    
    <div className="mb-6">
      <div className="flex gap-2">
        <input
          type="text"
          value={query}
          onChange={e=>setQuery(e.target.value)}
          onKeyDown={e=>e.key==='Enter'&&!loading&&askQuestion()}
          placeholder="Ask a question about the league..."
          className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0077b6] focus:border-transparent"
        />
        <button
          onClick={askQuestion}
          disabled={loading||!query.trim()}
          className={`px-6 py-3 rounded-lg flex items-center gap-2 ${loading||!query.trim()?'bg-gray-200 text-gray-400':'bg-[#0077b6] text-white hover:bg-[#005f8a]'}`}
        >
          {loading?<span className="animate-pulse">Thinking...</span>:<><Send className="w-4 h-4"/>Ask</>}
        </button>
      </div>
    </div>
    
    {!answer&&!loading&&!error&&<div className="mb-8">
      <p className="text-xs text-gray-500 uppercase tracking-wide mb-3">Example questions</p>
      <div className="flex flex-wrap gap-2">
        {exampleQueries.map((q,i)=><button
          key={i}
          onClick={()=>setQuery(q)}
          className="text-sm px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700"
        >{q}</button>)}
      </div>
    </div>}
    
    {error&&<div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4">{error}</div>}
    
    {answer&&<div className="prose prose-sm max-w-none">
      <div className="p-6 bg-gray-50 rounded-lg border border-gray-200">
        <div className="whitespace-pre-wrap text-gray-800">{answer}</div>
      </div>
      <button onClick={()=>{setAnswer('');setQuery('');}} className="mt-4 text-sm text-[#0077b6] hover:underline">Ask another question</button>
    </div>}
  </div>;
};

// Normalize data to merge case-variant athlete names
const normalizeData=(data)=>{
  // Venue name mappings
  const venueMap={
    'Croyden':'Croydon',
    'Moden':'Morden Park',
    'Morden':'Morden Park',
    'Morden Pk':'Morden Park',
    'Beckenham':'Beckenham Place Park',
    'Beckenham Place':'Beckenham Place Park',
    'Brockwell':'Brockwell Park',
    'Richmond':'Richmond Park',
    'Richmond Pk':'Richmond Park',
    'G Richmond Pk':'Richmond Park',
    'Richmond Park (Sheen Rugby Fields)':'Richmond Park',
    'Wimbledon':'Wimbledon Common',
    'Wimbledon (race won by n/s R Dessaix-Chin, Belg)':'Wimbledon Common',
    'Hamlands':'Ham Lands',
    'Lloyd Park, Croydon':'Lloyd Park',
    'Mitcham':'Mitcham Common',
    'Streatham':'Streatham Common',
    'Epsom':'Epsom Downs',
    'Dorking (race won by n/s F Tickner, Wells)':'Dorking',
    'Pol Dorking':'Dorking',
    'Farthing Down, Coulsdon':'Farthing Downs',
    'West Horsley Place, Guildford':'West Horsley Place',
    'W Wickham':'West Wickham'
  };
  
  // Explicit name mappings (aliases to canonical names)
  const nameAliases={
    'jonathan gilbert':'John Gilbert',
    'r holt':'Bob Holt',
    'd holt':'Dave Holt',
    'dave ogden':'David Ogden',
    'tom austin':'Thomas Austin',
    // Historical abbreviated names - winners with multiple wins
    'g north':'Gerry North',
    'b ford':'Bernie Ford',
    'b whitby':'Benedict Whitby',
    'p owor':'Paskar Owor',
    'p wicks':'Phil Wicks',
    'j mcmullan':'James McMullan',
    'f tickner':'Frank Tickner',
    'g staines':'Gary Staines',
    's rayner':'Steve Rayner',
    'd clarke':'Dave Clarke',
    'j snowden':'John Snowden',
    'p adams':'Phil Adams',
    'r gevers':'Rene Gevers',
    'j roberts':'John Roberts',
    'i wheeler':'Ian Wheeler',
    'r richardson':'Ron Richardson',
    'd taylor':'Dave Taylor',
    'a black':'Alastair Black',
    'j thresher':'John Thresher',
    'j hogan':'John Hogan',
    'p carr-locke':'Peter Carr-Locke',
    'c smith':'Chris Smith',
    'm miles':'Martin Miles',
    'm hicken':'Malcolm Hicken',
    'c hensby':'Chris Hensby',
    'd murphy':'Declan Murphy',
    'k tadesse':'Kidane Tadesse',
    // Name variations to merge
    'steve sharp':'Steven Sharp',
    'will cockerell':'William Cockerell',
    'matt sharp':'Matthew Sharp',
    'mat sharp':'Matthew Sharp'
  };
  
  // Handle special dead heat cases - these races have two winners with their clubs
  const deadHeats={
    '1967/68-2':{winner:'Gerry North / Bob Holt',winners:[{name:'Gerry North',club:'BEL'},{name:'Bob Holt',club:'H/W'}]},
    '1969/70-3':{winner:'Bob Holt / Dave Holt',winners:[{name:'Bob Holt',club:'H/W'},{name:'Dave Holt',club:'H/W'}]},
    '1974/75-1':{winner:'Bernie Ford / Phil Adams',winners:[{name:'Bernie Ford',club:'AFD'},{name:'Phil Adams',club:'AFD'}]},
    '1997/98-4':{winner:'Kidane Tadesse / Gary Staines',winners:[{name:'Kidane Tadesse',club:'BEL'},{name:'Gary Staines',club:'BEL'}]}
  };
  
  // Pre-process races to handle dead heats and name fixes
  data.races.forEach(race=>{
    const raceKey=`${race.season}-${race.match}`;
    // Apply dead heat data
    if(deadHeats[raceKey]){
      race.winner=deadHeats[raceKey].winner;
      race.winners=deadHeats[raceKey].winners;
      race.deadHeat=true;
    }
    // Normalize winner name using aliases (for non-dead-heat races)
    if(race.winner&&!race.deadHeat){
      const winnerKey=normalizeNameForCompare(race.winner);
      if(nameAliases[winnerKey]){
        race.winner=nameAliases[winnerKey];
      }
    }
  });
  
  // Normalize venue names in races
  data.races.forEach(race=>{
    if(race.venue&&venueMap[race.venue]){
      race.venue=venueMap[race.venue];
    }
  });
  
  // Normalize venue names in seasonsData matches
  Object.values(data.seasonsData||{}).forEach(sd=>{
    (sd.matches||[]).forEach(m=>{
      if(m.venue&&venueMap[m.venue]){
        m.venue=venueMap[m.venue];
      }
    });
  });
  
  // Build a map of normalized name -> preferred display name (first occurrence)
  const nameMap={};
  
  // First, set up all the aliases
  Object.entries(nameAliases).forEach(([alias,canonical])=>{
    nameMap[alias]=canonical;
    // Also ensure the canonical name maps to itself
    const canonicalKey=normalizeNameForCompare(canonical);
    if(!nameMap[canonicalKey])nameMap[canonicalKey]=canonical;
  });
  
  // Then process athletes
  data.athletes.forEach(a=>{
    const key=normalizeNameForCompare(a.name);
    // Don't override if this is an alias or already set
    if(!nameMap[key]){
      nameMap[key]=a.name;
    }
  });
  
  // Also check race results for names not in athletes list
  data.races.forEach(race=>{
    (race.results||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(!nameMap[key])nameMap[key]=r.name;
    });
  });
  
  // Merge duplicate athletes
  const mergedAthletes={};
  data.athletes.forEach(a=>{
    let key=normalizeNameForCompare(a.name);
    // If this name has an alias, use the canonical name as the key
    if(nameAliases[key]){
      key=normalizeNameForCompare(nameAliases[key]);
    }
    if(!mergedAthletes[key]){
      mergedAthletes[key]={...a,name:nameMap[normalizeNameForCompare(a.name)]||a.name};
    }else{
      // Merge stats
      const m=mergedAthletes[key];
      m.wins=(m.wins||0)+(a.wins||0);
      m.top3=(m.top3||0)+(a.top3||0);
      m.top5=(m.top5||0)+(a.top5||0);
      m.top10=(m.top10||0)+(a.top10||0);
      m.top20=(m.top20||0)+(a.top20||0);
      m.top50=(m.top50||0)+(a.top50||0);
      m.top100=(m.top100||0)+(a.top100||0);
      m.races=(m.races||0)+(a.races||0);
      m.aScores=(m.aScores||0)+(a.aScores||0);
      // Merge clubs array
      if(!m.clubs)m.clubs=[m.club];
      if(a.club&&!m.clubs.includes(a.club))m.clubs.push(a.club);
    }
  });
  data.athletes=Object.values(mergedAthletes);
  
  // Normalize names in race results
  data.races.forEach(race=>{
    (race.results||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(nameMap[key])r.name=nameMap[key];
    });
  });
  
  // Normalize names in seasonsData individualRankings
  Object.values(data.seasonsData||{}).forEach(sd=>{
    (sd.individualRankings||[]).forEach(r=>{
      const key=normalizeNameForCompare(r.name);
      if(nameMap[key])r.name=nameMap[key];
    });
  });
  
  // Normalize names in clubMvps
  Object.keys(data.clubMvps||{}).forEach(club=>{
    data.clubMvps[club].forEach(m=>{
      const key=normalizeNameForCompare(m.name);
      if(nameMap[key])m.name=nameMap[key];
    });
  });
  
  return data;
};

function App(){
  const[view,setViewState]=useState(parseUrlParams());const[data,setData]=useState(null);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);
  const setView=(v)=>{setViewState(v);updateUrl(v);};
  useEffect(()=>{fetch('data.json').then(r=>r.json()).then(j=>{setData(normalizeData(j));setLoading(false);}).catch(e=>{setError(e.message);setLoading(false);});},[]);
  useEffect(()=>{const onPop=()=>setViewState(parseUrlParams());window.addEventListener('popstate',onPop);return()=>window.removeEventListener('popstate',onPop);},[]);
  useEffect(()=>{if(data&&view.raceKey){const race=data.races.find(r=>r.season===view.raceKey.season&&r.match===view.raceKey.match);if(race)setViewState({type:'race',race});}},[data,view.raceKey]);
  if(loading)return<div className="loading text-gray-500">Loading...</div>;if(error)return<div className="loading text-red-500">Error: {error}</div>;if(!data)return<div className="loading text-gray-500">No data</div>;
  return<div className="min-h-screen bg-white flex flex-col"><Nav setView={setView}/><main className="flex-1">{view.type==='home'&&<HomeView setView={setView} data={data}/>}{view.type==='race'&&<RaceDetailView race={view.race} setView={setView} seasonsData={data.seasonsData} clubMvps={data.clubMvps} races={data.races}/>}{view.type==='fixtures'&&<FixturesView setView={setView} races={data.races} seasonsData={data.seasonsData}/>}{view.type==='seasons'&&<SeasonsView setView={setView} seasonsData={data.seasonsData}/>}{view.type==='athletes'&&<AthletesView setView={setView} athletes={data.athletes}/>}{view.type==='athlete'&&<AthleteDetailView athlete={view.athlete} setView={setView} athletes={data.athletes} races={data.races} clubMvps={data.clubMvps} seasonsData={data.seasonsData}/>}{view.type==='clubs'&&<ClubsView setView={setView} clubAllTime={data.clubAllTime}/>}{view.type==='club'&&<ClubDetailView clubCode={view.club} setView={setView} athletes={data.athletes} races={data.races} clubAllTime={data.clubAllTime} clubMvps={data.clubMvps} seasonsData={data.seasonsData}/>}{view.type==='h2h'&&<H2HView athletes={data.athletes} races={data.races} setView={setView} prefill={view.prefill}/>}</main><Footer/></div>;
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
