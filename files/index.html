<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unofficial Surrey League archive</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path d='M6 6L26 26M26 6L6 26' stroke='%2322c55e' stroke-width='5' stroke-linecap='round'/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}.loading{display:flex;align-items:center;justify-content:center;height:100vh}</style>
</head>
<body>
<div id="root"><div class="loading">Loading...</div></div>
<script type="text/babel">
const{useState,useMemo,useEffect}=React;
const CLUBS={'BEL':{name:'Belgrave Harriers'},'KEN':{name:'Kent AC'},'THH':{name:'Thames Hare & Hounds'},'HHH':{name:'Herne Hill Harriers'},'H/W':{name:'Hercules Wimbledon'},'SLH':{name:'South London Harriers'},'G&G':{name:'Guildford & Godalming'},'RAN':{name:'Ranelagh Harriers'},'C/C':{name:'Clapham Chasers'},'DUL':{name:'Dulwich Runners'},'HOL':{name:'Holland Sports'},'WAL':{name:'Walton AC'},'CRO':{name:'Croydon Harriers'},'WOK':{name:'Woking AC'},'E&E':{name:'Epsom & Ewell'},'FUL':{name:'Fulham RC'},'SOC':{name:'Striders of Croydon'},'BOX':{name:'Boxhill Racers'},'BOH':{name:'Borough of Hounslow'},'AFD':{name:'Aldershot Farnham & District'},'SUR':{name:'Surrey AC'},'MIT':{name:'Mitcham AC'},'REI':{name:'Reigate Priory AC'},'DMV':{name:'Dorking & Mole Valley'}};

const ClubVest=({club,size=20})=>{
  const id=`v-${club}-${Math.random().toString(36).substr(2,5)}`;
  const p="M3 0 L7 0 L8 3 L12 3 L13 0 L17 0 L17 20 L3 20 Z";
  const r=()=>{switch(club){
    case'KEN':return<><path d={p} fill="#2a4d7a"/><path d="M13 5 L15 5.5 L15 7.5 C15 8.5 14 9 13 9.5 C12 9 11 8.5 11 7.5 L11 5.5 Z" fill="#dc2626"/></>;
    case'H/W':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,0 6,0 20,20 14,20" fill="#c41e3a"/></g></>;
    case'THH':return<><path d={p} fill="#fff"/><line x1="6" y1="5" x2="14" y2="15" stroke="#1a1a1a" strokeWidth="2"/><line x1="14" y1="5" x2="6" y2="15" stroke="#1a1a1a" strokeWidth="2"/></>;
    case'BEL':return<><path d={p} fill="#7A001D"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="7" width="20" height="4" fill="#CCAD6A"/></g></>;
    case'HHH':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g></>;
    case'G&G':return<path d={p} fill="#228b22"/>;
    case'SLH':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="13" y="0" width="4" height="20" fill="#800020"/></g></>;
    case'DUL':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="2" fill="#1e3a8a"/><rect x="0" y="12" width="20" height="2" fill="#1e3a8a"/></g></>;
    case'HOL':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#fff"/></g></>;
    case'RAN':return<><path d={p} fill="#1e3a8a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'C/C':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="10" width="20" height="10" fill="#1e3a8a"/><rect x="0" y="9" width="20" height="2" fill="#228b22"/></g></>;
    case'WAL':return<><path d={p} fill="#1a1a1a"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="6" width="20" height="2" fill="#f4c430"/><rect x="0" y="8" width="20" height="2" fill="#dc2626"/><rect x="0" y="10" width="20" height="2" fill="#f4c430"/></g></>;
    case'CRO':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="5" width="20" height="2" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="2" fill="#1a1a1a"/></g></>;
    case'WOK':return<><path d={p} fill="#ff6600"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#32CD32"/></g></>;
    case'E&E':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="8" width="20" height="3" fill="#f4c430"/></g></>;
    case'FUL':return<><path d={p} fill="#fff"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="0" y="0" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="6" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="12" width="20" height="3" fill="#1a1a1a"/><rect x="0" y="18" width="20" height="3" fill="#1a1a1a"/></g></>;
    case'SOC':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#228b22"/><rect x="14" y="0" width="3" height="20" fill="#228b22"/></g></>;
    case'BOX':return<><path d={p} fill="#f4c430"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g></>;
    case'BOH':return<><path d={p} fill="#87CEEB"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#dc2626"/><rect x="14" y="0" width="3" height="20" fill="#dc2626"/></g></>;
    case'AFD':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="14" y="0" width="3" height="20" fill="#fff"/><rect x="0" y="6" width="20" height="3" fill="#228b22"/></g></>;
    case'SUR':return<path d={p} fill="#f4c430"/>;
    case'DMV':return<><path d={p} fill="#A52A2A"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><rect x="3" y="0" width="3" height="20" fill="#fff"/><rect x="14" y="0" width="3" height="20" fill="#fff"/></g></>;
    case'REI':return<><path d={p} fill="#dc2626"/><clipPath id={id}><path d={p}/></clipPath><g clipPath={`url(#${id})`}><polygon points="0,0 6,0 20,14 20,20 14,20 0,6" fill="#87CEEB"/></g></>;
    default:return<path d={p} fill="#9ca3af"/>;
  }};
  return<svg width={size} height={size} viewBox="0 0 20 20" className="shrink-0">{r()}<path d={p} fill="none" stroke="#374151" strokeWidth="0.5"/></svg>;
};
const ClubShield=ClubVest;
const PositionChange=({change})=>{if(change===0||change===null||change===undefined)return<span className="w-4 text-center text-gray-300 text-xs">‚Äì</span>;if(change>0)return<span className="w-4 text-center text-green-600 text-xs font-bold">‚Üë</span>;return<span className="w-4 text-center text-red-600 text-xs font-bold">‚Üì</span>;};
const ClubName=({club,className=''})=><><span className={`md:hidden ${className}`}>{club}</span><span className={`hidden md:inline ${className}`}>{CLUBS[club]?.name||club}</span></>;
const ChevronLeft=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 18l-6-6 6-6"/></svg>;
const ChevronRight=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>;
const ArrowLeft=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>;
const X=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>;
const ChevronDown=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9l6 6 6-6"/></svg>;
const ChevronUp=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 15l-6-6-6 6"/></svg>;
const Sparkles=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 3v1m0 16v1m-8-9h1m16 0h1m-2.636-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>;
const Send=({className})=><svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>;
const formatDate=(d)=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
const formatDateShort=(d)=>new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
const formatDateMonthYear=(d)=>new Date(d).toLocaleDateString('en-GB',{month:'short',year:'numeric'});

const Nav=({setView})=><nav className="border-b border-gray-200 bg-white sticky top-0 z-50"><div className="max-w-6xl mx-auto px-4 flex items-center justify-between h-12"><div className="cursor-pointer hidden md:block" onClick={()=>setView({type:'home'})}><span className="text-base font-semibold text-gray-900">Surrey League</span><span className="text-xs text-gray-400 ml-2">Archive</span></div><div className="flex gap-1 text-sm w-full md:w-auto justify-between md:justify-end"><button onClick={()=>setView({type:'home'})} className="px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Standings</button><button onClick={()=>setView({type:'fixtures'})} className="px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Fixtures</button><button onClick={()=>setView({type:'seasons'})} className="px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Winners</button><button onClick={()=>setView({type:'athletes'})} className="px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Athletes</button><button onClick={()=>setView({type:'clubs'})} className="px-3 py-1.5 rounded text-gray-500 hover:text-gray-900 hover:bg-gray-50">Clubs</button><button onClick={()=>setView({type:'ask'})} className="px-3 py-1.5 rounded text-[#0077b6] hover:bg-blue-50 flex items-center gap-1"><Sparkles className="w-4 h-4"/>Ask</button></div></div></nav>;

const SeasonSelector=({season,setSeason,seasons})=>{const idx=seasons.indexOf(season);return<div className="flex items-center"><button onClick={()=>idx<seasons.length-1&&setSeason(seasons[idx+1])} className={`p-0.5 rounded ${idx<seasons.length-1?'hover:bg-gray-100 text-gray-600':'text-gray-300'}`}><ChevronLeft className="w-5 h-5"/></button><span className="text-lg font-semibold text-gray-900 min-w-[5.5rem] text-center">{season}</span><button onClick={()=>idx>0&&setSeason(seasons[idx-1])} className={`p-0.5 rounded ${idx>0?'hover:bg-gray-100 text-gray-600':'text-gray-300'}`}><ChevronRight className="w-5 h-5"/></button></div>;};

const TeamResultsTable=({results,startPos=1,count=10})=>{
  const teams=useMemo(()=>{
    const clubScores={};
    const clubScoringCounts={};
    // For A team (startPos=1): count runners with pts, take first 10
    // For B team (startPos=11): count runners with b_pts, take first 10
    const isATeam = startPos === 1;
    results.forEach(r=>{
      const hasPts = isATeam ? (r.pts != null) : (r.b_pts != null);
      const pts = isATeam ? r.pts : r.b_pts;
      if(!clubScoringCounts[r.club]) clubScoringCounts[r.club] = 0;
      if(!clubScores[r.club]) clubScores[r.club] = [];
      if(hasPts) {
        clubScoringCounts[r.club]++;
        if(clubScoringCounts[r.club] <= count) {
          clubScores[r.club].push(pts);
        }
      }
    });
    return Object.entries(clubScores).map(([club,scores])=>({club,points:scores.reduce((a,b)=>a+b,0),scores,complete:scores.length>=count})).filter(t=>t.scores.length>0).sort((a,b)=>{if(a.complete&&!b.complete)return-1;if(!a.complete&&b.complete)return 1;return a.points-b.points;}).map((t,i)=>({...t,pos:i+1}));
  },[results,startPos,count]);
  return<div><table className="w-full"><thead><tr className="border-b-2 border-[#0077b6] bg-gray-50"><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-12">Pos</th><th className="w-8"></th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase">Club</th><th className="text-right py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-20">Points</th><th className="text-left py-2 px-4 text-xs font-semibold text-[#0077b6] uppercase">Scores</th></tr></thead><tbody className="divide-y divide-gray-100">{teams.map(team=><tr key={team.club} className="hover:bg-gray-50"><td className="py-2 px-2 text-sm text-gray-700">{team.pos}</td><td className="py-2 px-1"><ClubShield club={team.club} size={20}/></td><td className="py-2 px-2 text-sm font-medium text-gray-900">{team.club}</td><td className="py-2 px-2 text-sm font-bold text-gray-900 text-right">{team.points}</td><td className="py-2 px-4"><div className="flex flex-wrap gap-1.5">{team.scores.map((s,i)=><span key={i} className="text-xs text-gray-400 tabular-nums">{s}</span>)}{!team.complete&&<span className="text-xs text-gray-300 italic ml-1">incomplete</span>}</div></td></tr>)}</tbody></table></div>;
};

const IndividualResultsTable=({results,clubFilter,setClubFilter,setView,clubMvps})=>{
  const filtered=clubFilter?results.filter(r=>r.club===clubFilter):results;
  const isClubGoat=(name,club)=>{const mvps=clubMvps?.[club];return mvps&&mvps[0]?.name===name;};
  return<div>{clubFilter&&<div className="mb-4 flex items-center gap-2 text-sm"><span className="text-gray-500">Showing:</span><span className="flex items-center gap-2 bg-gray-100 px-2 py-1 rounded"><ClubShield club={clubFilter} size={16}/><span className="font-medium">{CLUBS[clubFilter]?.name||clubFilter}</span><button onClick={()=>setClubFilter(null)} className="text-gray-400 hover:text-gray-600"><X className="w-4 h-4"/></button></span></div>}<table className="w-full"><thead><tr className="border-b-2 border-[#0077b6] bg-gray-50"><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-12">Pos</th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-12">Pts</th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-20">Club</th><th className="text-left py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase">Name</th><th className="text-right py-2 px-2 text-xs font-semibold text-[#0077b6] uppercase w-16">Time</th></tr></thead><tbody className="divide-y divide-gray-100">{filtered.map((r,i)=><tr key={i} className="hover:bg-blue-50"><td className="py-1.5 px-2 text-sm text-gray-700">{r.pos}</td><td className="py-1.5 px-2 text-sm text-gray-500">{r.pts||'-'}</td><td className="py-1.5 px-2"><span className="flex items-center gap-1 cursor-pointer" onClick={()=>setClubFilter(r.club)}><ClubShield club={r.club} size={14}/><span className="text-xs text-gray-500">{r.club}</span></span></td><td className="py-1.5 px-2"><span className="text-sm text-gray-900 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:r.name,club:r.club}})}>{r.name}{isClubGoat(r.name,r.club)&&' üêê'}{r.ns&&<span className="text-gray-400 ml-1">(N/S)</span>}{r.secondClaim&&<span className="text-gray-400 ml-1">(2C)</span>}</span></td><td className="py-1.5 px-2 text-sm text-gray-700 text-right font-mono">{r.time}</td></tr>)}</tbody></table></div>;
};

const RaceDetailView=({race,setView,seasonsData,clubMvps})=>{
  const[tab,setTab]=useState('individual');const[clubFilter,setClubFilter]=useState(null);if(!race)return null;
  const seasonData=seasonsData[race.season];const matchData=seasonData?.matches?.find(m=>m.num===race.match);const teamWinner=matchData?.teamWinner||race.teamWinner;
  return<div className="max-w-5xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'home'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-6"><div className="text-sm text-gray-500 mb-1">{formatDate(race.date)} ¬∑ {race.season} ¬∑ Match {race.match}</div><h1 className="text-2xl font-bold text-gray-900">{race.venue}</h1>{teamWinner&&<p className="text-sm text-gray-700 mt-1 flex items-center gap-2"><ClubShield club={teamWinner} size={16}/><span className="font-medium">{CLUBS[teamWinner]?.name||teamWinner}</span><span className="text-gray-500">win the match</span></p>}</div><div className="flex gap-4 mb-6 border-b border-gray-200">{[{id:'individual',label:'Individual'},{id:'a-teams',label:'A Teams'},{id:'b-teams',label:'B Teams'}].map(t=><button key={t.id} onClick={()=>{setTab(t.id);setClubFilter(null);}} className={`pb-2 text-sm font-medium border-b-2 -mb-px transition-colors ${tab===t.id?'border-[#0077b6] text-[#0077b6]':'border-transparent text-gray-500 hover:text-gray-700'}`}>{t.label}</button>)}</div>{tab==='a-teams'&&<TeamResultsTable results={race.results} startPos={1} count={10}/>}{tab==='b-teams'&&<TeamResultsTable results={race.results} startPos={11} count={10}/>}{tab==='individual'&&<IndividualResultsTable results={race.results} clubFilter={clubFilter} setClubFilter={setClubFilter} setView={setView} clubMvps={clubMvps}/>}</div>;
};

const FixturesView=({setView,races,seasonsData})=>{
  const allFixtures=useMemo(()=>[...races].sort((a,b)=>{if(a.season!==b.season)return b.season.localeCompare(a.season);return a.match-b.match;}),[races]);let lastSeason=null;
  const getChampion=(season)=>{const sd=seasonsData[season];if(!sd?.standings?.[0])return null;const isHist=sd.historical;const hasM4=sd.standings[0].m4!==null||isHist;return hasM4?sd.standings[0].club:null;};
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><h1 className="text-2xl font-bold text-gray-900">Fixtures</h1><p className="text-sm text-gray-500">{allFixtures.length} matches since 1962</p></div><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-2 text-xs text-gray-500 uppercase w-20">Date</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase">Venue</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase w-44">Winner</th><th className="text-left py-1.5 pl-2 text-xs text-gray-500 uppercase w-24">Team</th></tr></thead><tbody>{allFixtures.map((race,i)=>{const show=race.season!==lastSeason;const champ=show?getChampion(race.season):null;lastSeason=race.season;const isHist=race.historical;return<React.Fragment key={`${race.season}-${race.match}`}>{show&&<tr><td colSpan={4} className="pt-6 pb-2"><div className="flex items-center gap-2 text-xs font-semibold text-gray-400 uppercase tracking-wide border-b border-gray-200 pb-1"><span>{race.season}</span>{champ&&<><span className="text-amber-500">üèÜ</span><ClubShield club={champ} size={14}/><span className="text-gray-600 normal-case font-medium">{champ}</span></>}</div></td></tr>}<tr className={`border-b border-gray-50 ${isHist?'':'hover:bg-blue-50 cursor-pointer'}`} onClick={()=>!isHist&&setView({type:'race',race})}><td className="py-1.5 pr-2 text-sm text-gray-500">{race.date?.length<=3?race.date:formatDateShort(race.date)}</td><td className="py-1.5 px-2 text-sm text-gray-900">{race.venue}</td><td className="py-1.5 px-2"><div className="flex items-center gap-1.5"><ClubShield club={race.winnerClub} size={14}/><span className="text-sm text-gray-700">{race.winner}</span></div></td><td className="py-1.5 pl-2">{race.teamWinner&&<div className="flex items-center gap-1.5"><ClubShield club={race.teamWinner} size={14}/><span className="text-sm font-medium text-gray-900">{race.teamWinner}</span></div>}</td></tr></React.Fragment>;})}</tbody></table></div>;
};

const AthletesView=({setView,athletes})=>{
  const[sort,setSort]=useState('wins');const[search,setSearch]=useState('');const[limit,setLimit]=useState(100);
  const filtered=useMemo(()=>{const s=search.toLowerCase();return athletes.filter(a=>!s||a.name.toLowerCase().includes(s)||a.club?.toLowerCase().includes(s));},[athletes,search]);
  const sorted=useMemo(()=>[...filtered].sort((a,b)=>b[sort]-a[sort]),[filtered,sort]);
  const cols=[{f:'wins',l:'W'},{f:'top3',l:'T3'},{f:'top5',l:'T5'},{f:'top10',l:'T10'},{f:'top20',l:'T20'},{f:'top50',l:'T50'},{f:'top100',l:'T100'},{f:'races',l:'R'}];
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"><div><h1 className="text-2xl font-bold text-gray-900">Athletes</h1><p className="text-sm text-gray-500">{filtered.length.toLocaleString()} athletes{search&&` matching "${search}"`}</p></div><input type="text" placeholder="Search athletes..." value={search} onChange={e=>{setSearch(e.target.value);setLimit(100);}} className="px-3 py-1.5 border border-gray-300 rounded text-sm w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-[#0077b6]"/></div><div className="overflow-x-auto"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4"><span className="text-xs text-gray-500 uppercase">Athlete</span></th>{cols.map(c=><th key={c.f} className="text-right py-1.5 px-2 min-w-[2.5rem]"><button onClick={()=>setSort(c.f)} className={`text-xs uppercase ${sort===c.f?'text-[#0077b6] font-semibold':'text-gray-500'}`}>{c.l}</button></th>)}</tr></thead><tbody>{sorted.slice(0,limit).map((a,i)=><tr key={a.name} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-6 text-right">{i+1}</span><ClubShield club={a.club} size={14}/><span className="text-sm text-gray-900">{a.name}</span></div></td>{cols.map(c=><td key={c.f} className={`text-right py-1.5 px-2 text-sm tabular-nums ${sort===c.f?'font-semibold text-[#0077b6]':'text-gray-600'} ${a[c.f]===0?'text-gray-300':''}`}>{a[c.f]||'-'}</td>)}</tr>)}</tbody></table></div>{sorted.length>limit&&<div className="mt-4 text-center"><button onClick={()=>setLimit(l=>l+100)} className="px-4 py-2 bg-[#0077b6] text-white rounded text-sm hover:bg-[#005f8a]">Show more ({sorted.length-limit} remaining)</button></div>}</div>;
};

const AthleteDetailView=({athlete,setView,athletes,races,clubMvps})=>{
  const athleteData=athletes.find(a=>a.name===athlete?.name)||athlete;const sortedByWins=[...athletes].sort((a,b)=>b.wins-a.wins);const allTimeRank=sortedByWins.findIndex(a=>a.name===athleteData?.name)+1;
  // Calculate Club MVP rank from clubMvps data
  const clubMvpRank=useMemo(()=>{
    if(!athleteData?.club||!clubMvps)return 0;
    const clubList=clubMvps[athleteData.club]||[];
    const idx=clubList.findIndex(a=>a.name===athleteData.name);
    return idx>=0?idx+1:0;
  },[athleteData?.club,athleteData?.name,clubMvps]);
  const po10Url=useMemo(()=>{if(!athleteData?.name)return null;const parts=athleteData.name.split(' ');if(parts.length<2)return null;const firstname=parts[0];const surname=parts.slice(1).join(' ');return`https://www.thepowerof10.info/athletes/athleteslookup.aspx?surname=${encodeURIComponent(surname)}&firstname=${encodeURIComponent(firstname)}`;},[athleteData?.name]);
  const raceHistory=useMemo(()=>{
    const h=[];
    races.forEach(race=>{
      const result=race.results?.find(r=>r.name===athleteData?.name);
      if(result){
        // Calculate team scoring position
        let teamScore='';
        if(result.club&&race.results){
          const clubRunners=race.results.filter(r=>r.club===result.club);
          const posInClub=clubRunners.findIndex(r=>r.name===result.name)+1;
          if(posInClub>=1&&posInClub<=10)teamScore=`A${posInClub}`;
          else if(posInClub>=11&&posInClub<=20)teamScore=`B${posInClub-10}`;
        }
        h.push({date:race.date,venue:race.venue,pos:result.pos,time:result.time,club:result.club,race,historical:false,teamScore});
      }
    });
    if(athleteData?.historicalRaces){
      athleteData.historicalRaces.forEach(hr=>{
        const race=races.find(r=>r.season===hr.season&&r.match===hr.match);
        h.push({date:race?.date||hr.season,venue:hr.venue,pos:hr.pos,time:'-',club:hr.club,race,historical:true,season:hr.season,teamScore:hr.pos===1?'A1':''});
      });
    }
    return h.sort((a,b)=>{const aKey=a.historical?a.season:a.date;const bKey=b.historical?b.season:b.date;return bKey.localeCompare(aKey);});
  },[athleteData?.name,athleteData?.historicalRaces,races]);
  const bestPos=useMemo(()=>raceHistory.length>0?Math.min(...raceHistory.map(r=>r.pos)):null,[raceHistory]);
  const showStar=bestPos&&bestPos>1;
  if(!athleteData)return<div className="max-w-4xl mx-auto px-4 py-8"><p>Athlete not found</p></div>;
  const histWins=athleteData.historicalWins||0;const modernWins=(athleteData.wins||0)-histWins;const isHistOnly=athleteData.historicalOnly;
  const stats=[{l:'Wins',v:athleteData.wins,sub:histWins>0?`(${modernWins}+${histWins} hist)`:null},{l:'Top 3',v:athleteData.top3},{l:'Top 5',v:athleteData.top5},{l:'Top 10',v:athleteData.top10},{l:'Top 20',v:athleteData.top20},{l:'Top 50',v:athleteData.top50},{l:'Top 100',v:athleteData.top100},{l:'A Scores',v:athleteData.aScores},{l:'Races',v:athleteData.races}];
  const clubsList=athleteData.clubs&&athleteData.clubs.length>1?athleteData.clubs.map(c=>CLUBS[c]?.name||c).join(', '):null;
  const badges=athleteData.badges||[];
  const getYear=(season)=>season?'20'+season.split('/')[1]:null;
  const individualChampYears=badges.filter(b=>b.type==='individual_champion').map(b=>getYear(b.season)).filter(Boolean);
  const leagueWinnerYears=badges.filter(b=>b.type==='title_winner').map(b=>getYear(b.season)).filter(Boolean);
  const otherBadges=badges.filter(b=>b.type!=='individual_champion'&&b.type!=='title_winner').map(b=>{
    if(b.type==='all_time_wins_leader')return{label:'#1 All-Time Wins'};
    if(b.type==='most_season_wins')return{label:`Most Wins in Single Season (${b.wins})`};
    if(b.type==='most_team_titles')return{label:`Most Team Titles (${b.count})`};
    return null;
  }).filter(Boolean);
  return<div className="max-w-4xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'athletes'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-8"><div className="flex items-center gap-3 mb-2"><div className="cursor-pointer" onClick={()=>setView({type:'club',club:athleteData.club})}><ClubShield club={athleteData.club} size={32}/></div><div><h1 className="text-2xl font-bold text-gray-900">{athleteData.name}</h1><p className="text-sm text-gray-500 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:athleteData.club})}>{CLUBS[athleteData.club]?.name||athleteData.club}{isHistOnly&&<span className="ml-2 text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">Historical</span>}</p>{clubsList&&<p className="text-xs text-gray-400 mt-1">Also represented: {clubsList}</p>}</div></div><div className="flex flex-wrap gap-2 mt-3">{allTimeRank>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">All-time wins</span><span className="text-sm font-bold text-[#0077b6]">#{allTimeRank}</span></div>}{clubMvpRank>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-200" onClick={()=>setView({type:'club',club:athleteData.club})}><span className="text-xs text-gray-500 uppercase">Club üêê</span><span className="text-sm font-bold text-[#0077b6]">#{clubMvpRank}</span></div>}{otherBadges.map((b,i)=><div key={i} className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">{b.label}</span></div>)}</div>{(individualChampYears.length>0||leagueWinnerYears.length>0)&&<div className="flex flex-wrap gap-2 mt-2">{individualChampYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">üèÖ Individual Champion</span><span className="text-sm font-medium text-gray-700">{individualChampYears.join(' | ')}</span></div>}{leagueWinnerYears.length>0&&<div className="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full"><span className="text-xs text-gray-500 uppercase">üèÜ League Winner</span><span className="text-sm font-medium text-gray-700">{leagueWinnerYears.join(' | ')}</span></div>}</div>}{po10Url&&<a href={po10Url} target="_blank" rel="noopener noreferrer" className="mt-3 ml-2 inline-flex items-center gap-1 text-xs text-gray-500 hover:text-[#0077b6]"><span>Power of 10</span><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>}</div><div className="mb-8"><h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">Career Statistics</h2><div className="grid grid-cols-4 md:grid-cols-8 gap-4">{stats.map(s=><div key={s.l} className="text-center"><div className={`text-2xl font-bold ${s.v>0?'text-gray-900':'text-gray-300'}`}>{s.v}</div><div className="text-xs text-gray-500 uppercase">{s.l}</div>{s.sub&&<div className="text-xs text-gray-400">{s.sub}</div>}</div>)}</div>{isHistOnly&&<p className="text-xs text-gray-400 mt-4">* Stats based on known race wins only (pre-2014 data)</p>}</div><div><h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">Race History</h2>{raceHistory.length>0?<table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-2 pr-2 text-xs text-gray-500 uppercase">Date</th><th className="text-left py-2 px-2 text-xs text-gray-500 uppercase">Venue</th><th className="text-center py-2 px-2 text-xs text-gray-500 uppercase w-10">Club</th><th className="text-right py-2 px-2 text-xs text-gray-500 uppercase w-16">Pos</th><th className="text-right py-2 pl-2 text-xs text-gray-500 uppercase w-16" title="Team scoring position: A1-A10 = A team scorers, B1-B10 = B team scorers">Score</th></tr></thead><tbody className="divide-y divide-gray-100">{raceHistory.map((r,i)=>{const scoreNum=r.teamScore?parseInt(r.teamScore.slice(1)):0;const ordinal=scoreNum===1?'st':scoreNum===2?'nd':scoreNum===3?'rd':'th';const scoreTooltip=r.teamScore?`${CLUBS[r.club]?.name||r.club}'s ${scoreNum}${ordinal} scorer for ${r.teamScore[0]} team`:null;return<tr key={i} className={r.race&&!r.race.historical?'hover:bg-blue-50 cursor-pointer':''} onClick={()=>r.race&&!r.race.historical&&setView({type:'race',race:r.race})}><td className="py-2.5 pr-2 text-sm text-gray-500">{r.historical?r.season:formatDateMonthYear(r.date)}</td><td className="py-2.5 px-2 text-sm text-gray-900">{r.venue}</td><td className="py-2.5 px-2 text-center"><ClubShield club={r.club} size={16}/></td><td className="py-2.5 px-2 text-right"><span className={`text-sm font-medium ${r.pos===1?'text-[#0077b6]':r.pos<=3?'text-gray-900':'text-gray-600'}`}>{r.pos}{r.pos===1&&' ü•á'}{r.pos===2&&' ü•à'}{r.pos===3&&' ü•â'}{showStar&&r.pos===bestPos&&' ‚≠ê'}</span></td><td className="py-2.5 pl-2 text-sm text-gray-600 text-right font-mono" title={scoreTooltip}>{r.teamScore||'-'}</td></tr>})}</tbody></table>:<p className="text-sm text-gray-500">No race history</p>}</div></div>;
};

const ClubsView=({setView,clubAllTime})=><div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><h1 className="text-2xl font-bold text-gray-900">Clubs</h1></div><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-4 text-xs text-gray-500 uppercase">Club</th><th className="text-right py-1.5 px-2 text-xs text-gray-500 uppercase w-16">Titles</th><th className="text-right py-1.5 px-2 text-xs text-gray-500 uppercase w-16">2nd</th><th className="text-right py-1.5 pl-2 text-xs text-gray-500 uppercase w-16">3rd</th></tr></thead><tbody>{clubAllTime.map((c,i)=><tr key={c.club} className="border-b border-gray-50 hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-5 text-right">{i+1}</span><ClubShield club={c.club} size={14}/><ClubName club={c.club} className="text-sm text-gray-900"/></div></td><td className="text-right py-1.5 px-2 text-sm tabular-nums font-semibold text-gray-900">{c.titles||'-'}</td><td className="text-right py-1.5 px-2 text-sm tabular-nums text-gray-600">{c.runnerUp||'-'}</td><td className="text-right py-1.5 pl-2 text-sm tabular-nums text-gray-400">{c.third||'-'}</td></tr>)}</tbody></table></div>;

const ClubDetailView=({clubCode,setView,athletes,clubAllTime,clubMvps})=>{
  const[sort,setSort]=useState('aScores');const clubData=clubAllTime.find(c=>c.club===clubCode);const clubInfo=CLUBS[clubCode];
  const clubAthletes=useMemo(()=>{
    const mvpList=clubMvps?.[clubCode]||[];
    return athletes.filter(a=>a.club===clubCode).map(a=>{
      const mvpEntry=mvpList.find(m=>m.name===a.name);
      return{...a,mvpRank:mvpEntry?.mvpRank||999};
    }).sort((a,b)=>{
    // MVP sort: first by aScores desc, then by sum of scores (lower is better for ties)
    if(sort==='aScores'){
      if((b.aScores||0)!==(a.aScores||0))return(b.aScores||0)-(a.aScores||0);
      // For ties, would need actual score sum - for now just use wins as tiebreaker
      return(b.wins||0)-(a.wins||0);
    }
    if(b[sort]!==a[sort])return(b[sort]||0)-(a[sort]||0);
    if(b.wins!==a.wins)return(b.wins||0)-(a.wins||0);
    if(b.top3!==a.top3)return(b.top3||0)-(a.top3||0);
    return(b.races||0)-(a.races||0);
  });},[clubCode,sort,athletes,clubMvps]);
  const mvp=clubAthletes[0];
  const allTimeRank=clubAllTime.findIndex(c=>c.club===clubCode)+1;if(!clubData||!clubInfo)return<div className="max-w-4xl mx-auto px-4 py-8"><p>Club not found</p></div>;
  const cols=[{f:'aScores',l:'A'},{f:'wins',l:'W'},{f:'top3',l:'T3'},{f:'top10',l:'T10'},{f:'races',l:'R'}];
  return<div className="max-w-5xl mx-auto px-4 py-8"><button onClick={()=>setView({type:'clubs'})} className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4"/>Back</button><div className="mb-8"><div className="flex items-center gap-4 mb-4"><ClubShield club={clubCode} size={48}/><div><h1 className="text-2xl font-bold text-gray-900">{clubInfo.name}</h1>{allTimeRank>0&&<p className="text-sm text-gray-500">#{allTimeRank} all-time</p>}</div></div><div className="grid grid-cols-3 gap-4 max-w-md"><div className="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200"><div className="text-3xl font-bold text-yellow-600">{clubData.titles}</div><div className="text-xs text-yellow-700 uppercase">Titles</div></div><div className="text-center p-4 bg-gray-100 rounded-lg border border-gray-200"><div className="text-3xl font-bold text-gray-600">{clubData.runnerUp}</div><div className="text-xs text-gray-500 uppercase">2nd</div></div><div className="text-center p-4 bg-orange-50 rounded-lg border border-orange-200"><div className="text-3xl font-bold text-orange-600">{clubData.third}</div><div className="text-xs text-orange-700 uppercase">3rd</div></div></div>{mvp&&<p className="mt-4 text-sm text-gray-600">Club üêê: <span className="font-medium text-[#0077b6] cursor-pointer hover:underline" onClick={()=>setView({type:'athlete',athlete:mvp})}>{mvp.name}</span></p>}</div><div><h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-4 pb-2 border-b border-gray-200">Athletes ({clubAthletes.length})</h2>{clubAthletes.length>0?<table className="w-full"><thead><tr className="border-b-2 border-[#0077b6]"><th className="text-left py-2 pr-4"><span className="text-xs text-gray-500 uppercase">Athlete</span></th>{cols.map(c=><th key={c.f} className="text-right py-2 px-2"><button onClick={()=>setSort(c.f)} className={`text-xs uppercase ${sort===c.f?'text-[#0077b6] font-semibold':'text-gray-500'}`} title={c.f==='aScores'?'A Team Scores':c.l}>{c.l}</button></th>)}</tr></thead><tbody className="divide-y divide-gray-100">{clubAthletes.map((a,i)=><tr key={a.name} className="hover:bg-blue-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-2 pr-4"><div className="flex items-center gap-2"><span className="text-gray-400 text-sm w-5 text-right">{i+1}</span><span className="font-medium text-gray-900">{a.name}</span></div></td>{cols.map(c=><td key={c.f} className={`text-right py-2 px-2 text-sm tabular-nums ${sort===c.f?'font-semibold text-[#0077b6]':'text-gray-600'}`}>{a[c.f]||'-'}</td>)}</tr>)}</tbody></table>:<p className="text-sm text-gray-500">No athletes</p>}</div></div>;
};

const SeasonsView=({setView,seasonsData})=>{
  const[expanded,setExpanded]=useState(null);
  const seasons=useMemo(()=>Object.entries(seasonsData).sort((a,b)=>b[0].localeCompare(a[0])).map(([season,data])=>{
    const isHistorical=data.historical||false;
    // Historical seasons are complete even with 3 matches (cancelled races)
    // Modern seasons need m4 to be set
    const isComplete=isHistorical?true:(data.standings?.[0]?.m4!==null&&data.standings?.[0]?.m4!==undefined);
    return{season,isComplete,isHistorical,aTeam:isComplete?data.standings?.slice(0,3):[],bTeam:(isComplete&&!isHistorical)?data.bStandings?.slice(0,3):[],individual:(isComplete&&!isHistorical)?data.individualRankings?.slice(0,3):[]};
  }),[seasonsData]);
  const canExpand=(s)=>s.isComplete&&!s.isHistorical&&(s.bTeam.length>0||s.individual.length>0);
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-6"><h1 className="text-2xl font-bold text-gray-900">Winners</h1><p className="text-sm text-gray-500">{seasons.filter(s=>s.isComplete).length} completed seasons since 1962</p></div><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="w-6"></th><th className="text-left py-1.5 pr-4 text-xs text-gray-500 uppercase">Season</th><th className="text-left py-1.5 px-4 text-xs text-gray-500 uppercase">A Team</th><th className="text-left py-1.5 px-4 text-xs text-gray-500 uppercase">B Team</th><th className="text-left py-1.5 pl-4 text-xs text-gray-500 uppercase">Individual</th></tr></thead><tbody>{seasons.map(s=><React.Fragment key={s.season}><tr className={`border-b border-gray-50 hover:bg-blue-50 ${canExpand(s)?'cursor-pointer':''}`} onClick={()=>canExpand(s)&&setExpanded(expanded===s.season?null:s.season)}><td className="py-1.5 pr-1">{canExpand(s)&&<span className="text-gray-400">{expanded===s.season?<ChevronUp className="w-4 h-4"/>:<ChevronDown className="w-4 h-4"/>}</span>}</td><td className="py-1.5 pr-4"><div className="flex items-center gap-2"><span className="text-sm text-gray-900">{s.season}</span>{!s.isComplete&&<span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">In progress</span>}</div></td><td className="py-1.5 px-4">{s.aTeam[0]?<div className="flex items-center gap-1.5"><ClubShield club={s.aTeam[0].club} size={14}/><span className="text-sm text-gray-900">{s.aTeam[0].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-4">{s.bTeam[0]?<div className="flex items-center gap-1.5"><ClubShield club={s.bTeam[0].club} size={14}/><span className="text-sm text-gray-900">{s.bTeam[0].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-4">{s.individual[0]?<div className="flex items-center gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={e=>{e.stopPropagation();setView({type:'athlete',athlete:{name:s.individual[0].name,club:s.individual[0].club}});}}><ClubShield club={s.individual[0].club} size={14}/><span className="text-sm text-gray-700">{s.individual[0].name}</span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr>{expanded===s.season&&<><tr className="bg-gray-50 border-b border-gray-100"><td className="py-1.5 pr-1"></td><td className="py-1.5 pr-4 text-sm text-gray-400">2nd</td><td className="py-1.5 px-4">{s.aTeam[1]?<div className="flex items-center gap-1.5"><ClubShield club={s.aTeam[1].club} size={14}/><span className="text-sm text-gray-600">{s.aTeam[1].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-4">{s.bTeam[1]?<div className="flex items-center gap-1.5"><ClubShield club={s.bTeam[1].club} size={14}/><span className="text-sm text-gray-600">{s.bTeam[1].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-4">{s.individual[1]?<div className="flex items-center gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:s.individual[1].name,club:s.individual[1].club}})}><ClubShield club={s.individual[1].club} size={14}/><span className="text-sm text-gray-600">{s.individual[1].name}</span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr><tr className="bg-gray-50 border-b border-gray-100"><td className="py-1.5 pr-1"></td><td className="py-1.5 pr-4 text-sm text-gray-400">3rd</td><td className="py-1.5 px-4">{s.aTeam[2]?<div className="flex items-center gap-1.5"><ClubShield club={s.aTeam[2].club} size={14}/><span className="text-sm text-gray-600">{s.aTeam[2].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 px-4">{s.bTeam[2]?<div className="flex items-center gap-1.5"><ClubShield club={s.bTeam[2].club} size={14}/><span className="text-sm text-gray-600">{s.bTeam[2].club}</span></div>:<span className="text-sm text-gray-400">-</span>}</td><td className="py-1.5 pl-4">{s.individual[2]?<div className="flex items-center gap-1.5 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:s.individual[2].name,club:s.individual[2].club}})}><ClubShield club={s.individual[2].club} size={14}/><span className="text-sm text-gray-600">{s.individual[2].name}</span></div>:<span className="text-sm text-gray-400">-</span>}</td></tr></>}</React.Fragment>)}</tbody></table></div>;
};

const HomeView=({setView,data})=>{
  const[season,setSeason]=useState(data.seasons[0]);const seasonData=data.seasonsData[season];const topWinners=[...data.athletes].sort((a,b)=>b.wins-a.wins).filter(a=>a.wins>0).slice(0,5);
  const findRace=(num)=>data.races.find(r=>r.season===season&&r.match===num);const matches=seasonData?.matches||[];const standings=seasonData?.standings||[];
  const isHistorical=seasonData?.historical;const isComplete=isHistorical||(standings[0]?.m4!==null&&standings[0]?.m4!==undefined);
  return<div className="max-w-5xl mx-auto px-4 py-8"><div className="mb-8 pb-6 border-b border-gray-200"><h1 className="text-2xl font-bold text-gray-900 mb-1">Surrey Cross Country League</h1><p className="text-sm text-gray-500">Men's Division 1 ¬∑ Complete data 2014‚Äìpresent ¬∑ Partial data 1962‚Äì2014</p></div><div className="flex items-center gap-3 mb-6"><h2 className="text-lg font-semibold text-gray-900">Div 1</h2><SeasonSelector season={season} setSeason={setSeason} seasons={data.seasons}/></div>{seasonData?<><div className="overflow-x-auto mb-8"><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-2 pr-2 w-8"><span className="text-xs text-gray-500 uppercase">Pos</span></th><th className="text-left py-2 pr-2 w-6"></th><th className="text-left py-2 pr-4"><span className="text-xs text-gray-500 uppercase">Club</span></th><th className="text-right py-2 pr-4"><span className="text-xs text-gray-500 uppercase font-semibold">Total</span></th>{matches.map((m,i)=><th key={i} className="text-right py-2 px-2 min-w-[3.5rem]"><span className="text-xs text-gray-500 uppercase">M{m.num}</span></th>)}</tr></thead><tbody className="divide-y divide-gray-100">{standings.map((team,i)=><tr key={team.club} className="hover:bg-gray-50"><td className="py-1.5 pr-2"><div className="flex items-center gap-1"><span className={`text-sm ${i===0?'font-bold':'text-gray-600'}`}>{i===0&&isComplete?'üèÜ':team.pos}</span><PositionChange change={team.change}/></div></td><td className="py-1.5 pr-2"><ClubShield club={team.club} size={18}/></td><td className="py-1.5 pr-4 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:team.club})}><ClubName club={team.club} className={`text-sm ${i===0?'font-semibold':''}`}/></td><td className="text-right py-1.5 pr-4"><span className={`text-sm tabular-nums ${i===0?'font-bold text-[#0077b6]':'font-semibold'}`}>{team.total}</span></td>{matches.map((m,mi)=><td key={mi} className="text-right py-1.5 px-2"><span className="text-sm text-gray-600 tabular-nums">{team[`m${m.num}`]||'-'}</span></td>)}</tr>)}</tbody></table></div><div className="mb-10"><div className="flex items-baseline justify-between mb-3 pb-2 border-b border-gray-200"><h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide">{season} Fixtures</h2></div><table className="w-full"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-2 text-xs text-gray-500 uppercase w-14">Match</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase w-20">Date</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase">Venue</th><th className="text-left py-1.5 px-2 text-xs text-gray-500 uppercase w-40">Winner</th><th className="text-left py-1.5 pl-2 text-xs text-gray-500 uppercase w-24">Team</th></tr></thead><tbody className="divide-y divide-gray-100">{matches.map(match=>{const race=findRace(match.num);const upcoming=!match.winner;return<tr key={match.num} className={`transition-colors ${upcoming?'opacity-60':'hover:bg-blue-50 cursor-pointer'}`} onClick={()=>!upcoming&&race&&setView({type:'race',race})}><td className="py-1.5 pr-2 text-sm font-medium text-gray-900">M{match.num}</td><td className="py-1.5 px-2 text-sm text-gray-500">{formatDateShort(match.date)}</td><td className="py-1.5 px-2 text-sm text-gray-900">{match.venue}</td><td className="py-1.5 px-2">{upcoming?<span className="text-sm text-gray-400 italic">Upcoming</span>:<div className="flex items-center gap-1.5"><ClubShield club={match.winnerClub} size={14}/><span className="text-sm text-gray-700">{match.winner}</span></div>}</td><td className="py-1.5 pl-2">{!upcoming&&match.teamWinner&&<div className="flex items-center gap-1.5"><ClubShield club={match.teamWinner} size={14}/><span className="text-sm font-medium text-gray-900">{match.teamWinner}</span></div>}</td></tr>;})}</tbody></table></div></>:<p className="text-sm text-gray-500 mb-10">No data</p>}<div className="grid md:grid-cols-2 gap-8 pt-8 border-t border-gray-200"><div><h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">All-Time Individuals</h2><table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-1 text-xs text-gray-500 uppercase w-5"></th><th className="text-left py-1.5 pr-1 text-xs text-gray-500 uppercase">Athlete</th><th className="text-right py-1.5 px-1 text-xs text-gray-500 uppercase w-7">W</th><th className="text-right py-1.5 px-1 text-xs text-gray-500 uppercase w-7">T3</th><th className="text-right py-1.5 px-1 text-xs text-gray-500 uppercase w-7">T10</th><th className="text-right py-1.5 pl-1 text-xs text-gray-500 uppercase w-7">R</th></tr></thead><tbody className="divide-y divide-gray-100">{topWinners.map((a,i)=><tr key={a.name} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'athlete',athlete:a})}><td className="py-1.5 pr-1 text-gray-400">{i+1}</td><td className="py-1.5 pr-1"><div className="flex items-center gap-1.5 whitespace-nowrap"><ClubShield club={a.club} size={14}/><span className="text-gray-900">{a.name}</span></div></td><td className="py-1.5 px-1 text-right font-semibold">{a.wins||'-'}</td><td className="py-1.5 px-1 text-right text-gray-600">{a.top3||'-'}</td><td className="py-1.5 px-1 text-right text-gray-600">{a.top10||'-'}</td><td className="py-1.5 pl-1 text-right text-gray-400">{a.races}</td></tr>)}</tbody></table><div className="mt-2 text-xs text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'athletes'})}>View all ‚Üí</div></div><div><h2 className="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">All-Time Club Honours</h2><table className="w-full text-sm"><thead><tr className="border-b border-gray-200"><th className="text-left py-1.5 pr-2 text-xs text-gray-500 uppercase w-6"></th><th className="text-left py-1.5 pr-2 text-xs text-gray-500 uppercase">Club</th><th className="text-right py-1.5 px-1 text-xs text-gray-500 uppercase w-12">Titles</th><th className="text-right py-1.5 pl-1 text-xs text-gray-500 uppercase w-12">2nd</th></tr></thead><tbody className="divide-y divide-gray-100">{data.clubAllTime.slice(0,5).map((c,i)=><tr key={c.club} className="hover:bg-gray-50 cursor-pointer" onClick={()=>setView({type:'club',club:c.club})}><td className="py-1.5 pr-2 text-gray-400">{i+1}</td><td className="py-1.5 pr-2"><div className="flex items-center gap-1.5"><ClubShield club={c.club} size={14}/><ClubName club={c.club} className="text-gray-900"/></div></td><td className="py-1.5 px-1 text-right font-semibold">{c.titles||'-'}</td><td className="py-1.5 pl-1 text-right text-gray-400">{c.runnerUp||'-'}</td></tr>)}</tbody></table><div className="mt-2 text-xs text-[#0077b6] hover:underline cursor-pointer" onClick={()=>setView({type:'clubs'})}>View all ‚Üí</div></div></div>{data.achievements&&<><div className="grid md:grid-cols-3 gap-6 mt-8 pt-8 border-t border-gray-200"><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Most Wins in Season</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostWinsSeason?.map((a,i)=><tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}><div className="flex items-center gap-1"><ClubShield club={a.club} size={12}/><span className="truncate">{a.name}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{a.wins}</td></tr>)}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Consecutive Wins</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostConsecutiveWins?.map((a,i)=><tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'athlete',athlete:{name:a.name,club:a.club}})}><div className="flex items-center gap-1"><ClubShield club={a.club} size={12}/><span className="truncate">{a.name}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{a.streak}</td></tr>)}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Consecutive Titles</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.mostConsecutiveTitles?.map((c,i)=><tr key={i} className="hover:bg-gray-50"><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1 cursor-pointer hover:text-[#0077b6]" onClick={()=>setView({type:'club',club:c.club})}><div className="flex items-center gap-1"><ClubShield club={c.club} size={12}/><span>{c.club}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{c.streak}</td></tr>)}</tbody></table></div></div><div className="grid md:grid-cols-2 gap-6 mt-6"><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Biggest Races</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.biggestRaces?.map((r,i)=>{const race=data.races.find(x=>x.season===r.season&&x.match===r.match);const year=r.date?.slice(0,4);return<tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>race&&setView({type:'race',race})}><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1"><span>{r.venue} {year}</span></td><td className="py-1 text-right text-gray-500 w-10">{r.finishers}</td></tr>;})}</tbody></table></div><div><h3 className="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2 pb-1 border-b border-gray-200">Best Turnout</h3><table className="w-full text-xs"><tbody className="divide-y divide-gray-100">{data.achievements.biggestTurnouts?.map((t,i)=>{const race=data.races.find(x=>x.season===t.season&&x.match===t.match);const year=t.date?.slice(0,4);return<tr key={i} className="hover:bg-gray-50 cursor-pointer" onClick={()=>race&&setView({type:'race',race})}><td className="py-1 pr-1 text-gray-400 w-4">{i+1}</td><td className="py-1"><div className="flex items-center gap-1"><ClubShield club={t.club} size={12}/><span>{t.venue} {year}</span></div></td><td className="py-1 text-right text-gray-500 w-8">{t.count}</td></tr>;})}</tbody></table></div></div></>}</div>;
};

const Footer=()=><footer className="border-t border-gray-200 mt-12 py-6 text-center text-xs text-gray-400">Unofficial Surrey League archive. Work in progress. Vibecoded by Steve.</footer>;

const parseUrlParams=()=>{
  const params=new URLSearchParams(window.location.search);
  if(params.get('athlete'))return{type:'athlete',athlete:{name:params.get('athlete')}};
  if(params.get('club'))return{type:'club',club:params.get('club')};
  if(params.get('race')){const[season,match]=params.get('race').split('-');return{type:'race',raceKey:{season,match:parseInt(match)}};}
  if(params.get('season'))return{type:'home',season:params.get('season')};
  if(params.get('view'))return{type:params.get('view')};
  return{type:'home'};
};

const updateUrl=(view)=>{
  let url=window.location.pathname;
  if(view.type==='athlete'&&view.athlete?.name)url+='?athlete='+encodeURIComponent(view.athlete.name);
  else if(view.type==='club'&&view.club)url+='?club='+encodeURIComponent(view.club);
  else if(view.type==='race'&&view.race)url+='?race='+encodeURIComponent(view.race.season+'-'+view.race.match);
  else if(view.type!=='home')url+='?view='+view.type;
  window.history.pushState({},'',url);
};

const AskView=({data,setView})=>{
  const[query,setQuery]=useState('');
  const[loading,setLoading]=useState(false);
  const[answer,setAnswer]=useState('');
  const[error,setError]=useState('');
  
  const exampleQueries=[
    "Which athlete improved their average position the most from one season to the next?",
    "Who has the best win rate (wins per race)?",
    "Which club has the most athletes with race wins?",
    "What's the closest team race in the database?",
    "Who are the top 5 most consistent athletes (lowest position variance)?",
    "Which venue has produced the most first-time winners?"
  ];
  
  const buildDataSummary=()=>{
    // Create a compact summary of the data for the AI
    const athletes=data.athletes.slice(0,100).map(a=>({
      name:a.name,club:a.club,wins:a.wins,top3:a.top3,top10:a.top10,races:a.races,aScores:a.aScores
    }));
    const seasons=Object.keys(data.seasonsData).sort().reverse();
    const recentRaces=data.races.slice(0,20).map(r=>({
      season:r.season,match:r.match,venue:r.venue,date:r.date,
      top10:r.results.slice(0,10).map(x=>({pos:x.pos,name:x.name,club:x.club}))
    }));
    return{
      stats:data.stats,
      seasons,
      topAthletes:athletes,
      recentRaces,
      clubHonours:data.clubAllTime,
      achievements:data.achievements
    };
  };
  
  const askQuestion=async()=>{
    if(!query.trim())return;
    setLoading(true);
    setError('');
    setAnswer('');
    
    try{
      // Build a summary since full data is too large
      const summary=buildDataSummary();
      
      // For deeper analysis, include race-by-race athlete positions
      const athleteSeasonStats={};
      data.races.forEach(race=>{
        const season=race.season;
        race.results.forEach(r=>{
          const key=r.name;
          if(!athleteSeasonStats[key])athleteSeasonStats[key]={};
          if(!athleteSeasonStats[key][season])athleteSeasonStats[key][season]={positions:[],club:r.club};
          athleteSeasonStats[key][season].positions.push(r.pos);
        });
      });
      
      // Calculate averages per season for each athlete
      const athleteSeasonAvg={};
      Object.entries(athleteSeasonStats).forEach(([name,seasons])=>{
        athleteSeasonAvg[name]={};
        Object.entries(seasons).forEach(([season,data])=>{
          const avg=data.positions.reduce((a,b)=>a+b,0)/data.positions.length;
          athleteSeasonAvg[name][season]={avg:Math.round(avg*10)/10,races:data.positions.length,club:data.club};
        });
      });
      
      const systemPrompt=`You are a helpful assistant analyzing Surrey Cross Country League data. Answer questions about race results, athlete performance, club standings, and statistics. Be specific and cite data. Format answers clearly. When referencing athletes or clubs, be precise with names.

The database contains:
- ${data.stats.totalRaces} races from ${data.stats.seasons} seasons (2014-present with full data)
- ${data.stats.totalAthletes} athletes
- ${data.stats.totalResults} individual results

Key data structures available:
1. Athletes: name, club, wins, top3, top5, top10, top20, races, aScores (A-team finishes)
2. Races: season, match number, venue, date, full results with positions
3. Season standings: club points per match, final standings
4. Club honours: titles, 2nd places, 3rd places all-time`;

      const response=await fetch('https://surrey-league-ai.stephendgardner.workers.dev',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          model:'claude-sonnet-4-20250514',
          max_tokens:1000,
          system:systemPrompt,
          messages:[{
            role:'user',
            content:`Here is a summary of the league data:

TOP 100 ATHLETES:
${JSON.stringify(summary.topAthletes,null,1)}

CLUB HONOURS (ALL-TIME):
${JSON.stringify(summary.clubHonours,null,1)}

ACHIEVEMENTS:
${JSON.stringify(summary.achievements,null,1)}

ATHLETE SEASON AVERAGES (for improvement analysis):
${JSON.stringify(Object.fromEntries(Object.entries(athleteSeasonAvg).filter(([k,v])=>Object.keys(v).length>=2).slice(0,200)),null,1)}

RECENT RACES (top 10 finishers each):
${JSON.stringify(summary.recentRaces,null,1)}

QUESTION: ${query}`
          }]
        })
      });
      
      const result=await response.json();
      if(result.error){
        setError(result.error.message||'API error');
      }else if(result.content&&result.content[0]){
        setAnswer(result.content[0].text);
      }
    }catch(e){
      setError(e.message||'Failed to get answer');
    }finally{
      setLoading(false);
    }
  };
  
  return<div className="max-w-3xl mx-auto px-4 py-8">
    <div className="mb-8">
      <div className="flex items-center gap-2 mb-2">
        <Sparkles className="w-6 h-6 text-[#0077b6]"/>
        <h1 className="text-2xl font-bold text-gray-900">Ask the Archive</h1>
      </div>
      <p className="text-sm text-gray-500">Ask questions about Surrey League history, athlete performance, club records, and more.</p>
    </div>
    
    <div className="mb-6">
      <div className="flex gap-2">
        <input
          type="text"
          value={query}
          onChange={e=>setQuery(e.target.value)}
          onKeyDown={e=>e.key==='Enter'&&!loading&&askQuestion()}
          placeholder="Ask a question about the league..."
          className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0077b6] focus:border-transparent"
        />
        <button
          onClick={askQuestion}
          disabled={loading||!query.trim()}
          className={`px-6 py-3 rounded-lg flex items-center gap-2 ${loading||!query.trim()?'bg-gray-200 text-gray-400':'bg-[#0077b6] text-white hover:bg-[#005f8a]'}`}
        >
          {loading?<span className="animate-pulse">Thinking...</span>:<><Send className="w-4 h-4"/>Ask</>}
        </button>
      </div>
    </div>
    
    {!answer&&!loading&&!error&&<div className="mb-8">
      <p className="text-xs text-gray-500 uppercase tracking-wide mb-3">Example questions</p>
      <div className="flex flex-wrap gap-2">
        {exampleQueries.map((q,i)=><button
          key={i}
          onClick={()=>setQuery(q)}
          className="text-sm px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700"
        >{q}</button>)}
      </div>
    </div>}
    
    {error&&<div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4">{error}</div>}
    
    {answer&&<div className="prose prose-sm max-w-none">
      <div className="p-6 bg-gray-50 rounded-lg border border-gray-200">
        <div className="whitespace-pre-wrap text-gray-800">{answer}</div>
      </div>
      <button onClick={()=>{setAnswer('');setQuery('');}} className="mt-4 text-sm text-[#0077b6] hover:underline">Ask another question</button>
    </div>}
  </div>;
};

function App(){
  const[view,setViewState]=useState(parseUrlParams());const[data,setData]=useState(null);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);
  const setView=(v)=>{setViewState(v);updateUrl(v);};
  useEffect(()=>{fetch('data.json').then(r=>r.json()).then(j=>{setData(j);setLoading(false);}).catch(e=>{setError(e.message);setLoading(false);});},[]);
  useEffect(()=>{const onPop=()=>setViewState(parseUrlParams());window.addEventListener('popstate',onPop);return()=>window.removeEventListener('popstate',onPop);},[]);
  useEffect(()=>{if(data&&view.raceKey){const race=data.races.find(r=>r.season===view.raceKey.season&&r.match===view.raceKey.match);if(race)setViewState({type:'race',race});}},[data,view.raceKey]);
  if(loading)return<div className="loading text-gray-500">Loading...</div>;if(error)return<div className="loading text-red-500">Error: {error}</div>;if(!data)return<div className="loading text-gray-500">No data</div>;
  return<div className="min-h-screen bg-white flex flex-col"><Nav setView={setView}/><main className="flex-1">{view.type==='home'&&<HomeView setView={setView} data={data}/>}{view.type==='race'&&<RaceDetailView race={view.race} setView={setView} seasonsData={data.seasonsData} clubMvps={data.clubMvps}/>}{view.type==='fixtures'&&<FixturesView setView={setView} races={data.races} seasonsData={data.seasonsData}/>}{view.type==='seasons'&&<SeasonsView setView={setView} seasonsData={data.seasonsData}/>}{view.type==='athletes'&&<AthletesView setView={setView} athletes={data.athletes}/>}{view.type==='athlete'&&<AthleteDetailView athlete={view.athlete} setView={setView} athletes={data.athletes} races={data.races} clubMvps={data.clubMvps}/>}{view.type==='clubs'&&<ClubsView setView={setView} clubAllTime={data.clubAllTime}/>}{view.type==='club'&&<ClubDetailView clubCode={view.club} setView={setView} athletes={data.athletes} clubAllTime={data.clubAllTime} clubMvps={data.clubMvps}/>}{view.type==='ask'&&<AskView data={data} setView={setView}/>}</main><Footer/></div>;
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
